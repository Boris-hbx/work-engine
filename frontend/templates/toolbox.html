{% extends "base.html" %}

{% block title %}Â∑•ÂÖ∑ÁÆ± - Work Engine{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">Â∑•ÂÖ∑ÁÆ±</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">Êç¢‰∏Ä‰∏™</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="toolbox-layout">
        <!-- Â∑¶‰æßÔºöÂ∑•ÂÖ∑ÈÄâÊã©Âô® -->
        <div class="toolbox-nav">
            <div class="tool-item active" data-tool="bubble" onclick="switchTool('bubble')">
                <span class="tool-icon">üìä</span>
                <span class="tool-name">Ê∞îÊ≥°Âõæ</span>
            </div>
            <div class="tool-item" data-tool="expense" onclick="switchTool('expense')">
                <span class="tool-icon">üí∞</span>
                <span class="tool-name">Êä•ÈîÄÂ∞èËÉΩÊâã</span>
            </div>
            <div class="tool-item" data-tool="ppt" onclick="switchTool('ppt')">
                <span class="tool-icon">üé¨</span>
                <span class="tool-name">PPTÁîüÊàêÂô®</span>
            </div>
            <div class="tool-item" data-tool="ppt-translator" onclick="switchTool('ppt-translator')">
                <span class="tool-icon">üåê</span>
                <span class="tool-name">PPTÁøªËØë</span>
            </div>
            <div class="tool-item" data-tool="harmonyos-lab" onclick="switchTool('harmonyos-lab')">
                <span class="tool-icon">üì±</span>
                <span class="tool-name">È∏øËíôËØïÈ™åÁî∞</span>
            </div>
            <div class="tool-item" data-tool="calendar" onclick="switchTool('calendar')">
                <span class="tool-icon">üìÖ</span>
                <span class="tool-name">Êó•Á®ãÁÆ°ÁêÜ</span>
            </div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="toolbox-content">
            <!-- Ê∞îÊ≥°ÂõæÂ∑•ÂÖ∑ -->
            <div class="tool-panel" id="tool-bubble">
                <div class="bubble-main-layout">
                    <!-- Â∑¶‰æßÔºöÂéÜÂè≤ÁâàÊú¨ÂàóË°® -->
                    <div class="bubble-sidebar">
                        <div class="sidebar-header">
                            <h3>ÊàëÁöÑÂõæË°®</h3>
                            <button class="btn-new" onclick="createNew()">+ Êñ∞Âª∫</button>
                        </div>
                        <div class="saved-list" id="saved-list"></div>
                    </div>

                    <!-- Âè≥‰æßÔºö‰∏ªÁºñËæëÂå∫ -->
                    <div class="bubble-editor">
                        <div class="bubble-meta">
                            <div class="meta-row">
                                <input type="text" class="chart-title-input" id="chart-title" placeholder="ËæìÂÖ•ÂõæË°®Ê†áÈ¢ò..." value="Êú™ÂëΩÂêçÂõæË°®">
                                <div class="meta-actions">
                                    <button class="btn-action btn-save" onclick="saveChart()" title="‰øùÂ≠ò">
                                        <span class="btn-icon">üíæ</span> ‰øùÂ≠ò
                                    </button>
                                    <button class="btn-action btn-duplicate" onclick="duplicateChart()" title="Â§çÂà∂" id="btn-duplicate" style="display:none;">
                                        <span class="btn-icon">üìã</span> Â§çÂà∂
                                    </button>
                                    <button class="btn-action btn-delete-chart" onclick="deleteChart()" title="Âà†Èô§" id="btn-delete" style="display:none;">
                                        <span class="btn-icon">üóëÔ∏è</span> Âà†Èô§
                                    </button>
                                </div>
                            </div>
                            <textarea class="chart-desc-input" id="chart-desc" placeholder="Ê∑ªÂä†ÂõæË°®ÁÆÄ‰ªãÔºàÂèØÈÄâÔºâ..." rows="2"></textarea>
                            <div class="chart-info" id="chart-info" style="display:none;">
                                <span class="info-item" id="chart-created"></span>
                                <span class="info-item" id="chart-updated"></span>
                            </div>
                        </div>

                        <div class="bubble-container">
                            <div class="bubble-panel data-panel">
                                <div class="panel-header">
                                    <h3>Êï∞ÊçÆËæìÂÖ•</h3>
                                    <div class="panel-actions">
                                        <button class="btn-small" onclick="addRow()">+ Ê∑ªÂä†</button>
                                        <button class="btn-small btn-secondary" onclick="loadExample()">Âä†ËΩΩÁ§∫‰æã</button>
                                        <button class="btn-small btn-secondary" onclick="clearAll()">Ê∏ÖÁ©∫</button>
                                    </div>
                                </div>
                                <div class="data-table-wrapper">
                                    <table class="data-table" id="data-table">
                                        <thead>
                                            <tr>
                                                <th>ÂêçÁß∞</th>
                                                <th>XËΩ¥ÂÄº</th>
                                                <th>YËΩ¥ÂÄº</th>
                                                <th>Ê∞îÊ≥°Â§ßÂ∞è</th>
                                                <th>È¢úËâ≤</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-body"></tbody>
                                    </table>
                                </div>
                                <div class="axis-labels">
                                    <div class="axis-input">
                                        <label>XËΩ¥Ê†áÁ≠æÔºö</label>
                                        <input type="text" id="x-axis-label" value="ÊäïÂÖ•ÊàêÊú¨" onchange="updateChart()">
                                    </div>
                                    <div class="axis-input">
                                        <label>YËΩ¥Ê†áÁ≠æÔºö</label>
                                        <input type="text" id="y-axis-label" value="ÊÅ¢Â§çÊïàÊûú" onchange="updateChart()">
                                    </div>
                                </div>
                            </div>

                            <div class="bubble-panel chart-panel">
                                <div class="panel-header">
                                    <h3>Ê∞îÊ≥°ÂõæÈ¢ÑËßà</h3>
                                    <div class="panel-actions">
                                        <button class="btn-small" onclick="downloadChart()">‰∏ãËΩΩÂõæÁâá</button>
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="bubble-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- ËØÑÂàÜÁª¥Â∫¶ÈÖçÁΩÆÔºàÂèØÊäòÂè†Ôºâ -->
                        <div class="bubble-panel scoring-panel">
                            <div class="panel-header collapsible" onclick="toggleScoring()">
                                <h3>ËØÑÂàÜÁª¥Â∫¶ÈÖçÁΩÆÔºàÂèØÈÄâÔºâ</h3>
                                <span class="collapse-icon" id="scoring-icon">‚ñº</span>
                            </div>
                            <div class="scoring-content" id="scoring-content" style="display: none;">
                                <div class="scoring-columns">
                                    <div class="scoring-column">
                                        <h4>XËΩ¥ËØÑÂàÜÁª¥Â∫¶</h4>
                                        <div id="x-dimensions">
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="ÂáÜÂ§áÊó∂Èó¥">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="5" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="Â±ïÂºÄÊó∂Èó¥">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="30" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="Â≠¶‰π†ÊàêÊú¨">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="15" min="0">
                                            </div>
                                        </div>
                                        <button class="btn-tiny" onclick="addDimension('x')">+ Ê∑ªÂä†Áª¥Â∫¶</button>
                                    </div>
                                    <div class="scoring-column">
                                        <h4>YËΩ¥ËØÑÂàÜÁª¥Â∫¶</h4>
                                        <div id="y-dimensions">
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="Á≤æÂäõÊÅ¢Â§çÁ®≥ÂÆö">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="30" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="ÊÉÖÁª™Ë∞ÉËäÇ">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="20" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="ÁºìËß£ÂéãÂäõ">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="20" min="0">
                                            </div>
                                        </div>
                                        <button class="btn-tiny" onclick="addDimension('y')">+ Ê∑ªÂä†Áª¥Â∫¶</button>
                                    </div>
                                    <div class="scoring-column">
                                        <h4>Ê∞îÊ≥°Â§ßÂ∞èÁª¥Â∫¶</h4>
                                        <div id="size-dimensions">
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="‰∏äËÇ¢ÊøÄÊ¥ª">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="15" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="‰∏ãËÇ¢ÊøÄÊ¥ª">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="20" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞" value="ÂÖ®Ë∫´ÊøÄÊ¥ª">
                                                <input type="number" placeholder="Êª°ÂàÜ" value="20" min="0">
                                            </div>
                                        </div>
                                        <button class="btn-tiny" onclick="addDimension('size')">+ Ê∑ªÂä†Áª¥Â∫¶</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êä•ÈîÄÂ∞èËÉΩÊâãÂ∑•ÂÖ∑ -->
            <div class="tool-panel" id="tool-expense" style="display: none;">
                <div class="expense-layout">
                    <!-- Â∑¶‰æßÔºöÊä•ÈîÄ‰∫ã‰ª∂ÂàóË°® -->
                    <div class="expense-sidebar">
                        <div class="sidebar-header">
                            <h3>Êä•ÈîÄ‰∫ãÈ°π</h3>
                            <button class="btn-new" onclick="createExpense()">+ Êñ∞Âª∫</button>
                        </div>
                        <div class="expense-list" id="expense-list"></div>
                    </div>

                    <!-- Âè≥‰æßÔºöÊä•ÈîÄËØ¶ÊÉÖ -->
                    <div class="expense-editor" id="expense-editor">
                        <div class="expense-empty" id="expense-empty">
                            <div class="empty-icon">üí∞</div>
                            <p>ÈÄâÊã©ÊàñÊñ∞Âª∫‰∏Ä‰∏™Êä•ÈîÄ‰∫ãÈ°π</p>
                        </div>

                        <div class="expense-detail" id="expense-detail" style="display: none;">
                            <!-- Âø´ÈÄüÊ®°ÊùøÊåâÈíÆ -->
                            <div class="expense-templates" id="expense-templates">
                                <span class="template-label">Âø´ÈÄüÊ®°ÊùøÔºö</span>
                                <button class="template-btn" onclick="applyTemplate('Âá∫Â∑Æ')">üöó Âá∫Â∑Æ</button>
                                <button class="template-btn" onclick="applyTemplate('‰ºöËÆÆ')">üìã ‰ºöËÆÆ</button>
                                <button class="template-btn" onclick="applyTemplate('ÂüπËÆ≠')">üìö ÂüπËÆ≠</button>
                                <button class="template-btn" onclick="applyTemplate('ÂäûÂÖ¨')">üñäÔ∏è ÂäûÂÖ¨</button>
                                <button class="template-btn" onclick="applyTemplate('ÊãõÂæÖ')">üçΩÔ∏è ÊãõÂæÖ</button>
                            </div>

                            <div class="expense-header">
                                <input type="text" class="expense-event-input" id="expense-event" placeholder="Êä•ÈîÄ‰∫ã‰ª∂ÂêçÁß∞..." oninput="onEventNameChange()">
                                <div class="expense-actions">
                                    <button class="btn-action btn-save" onclick="saveExpense()">
                                        <span class="btn-icon">üíæ</span> ‰øùÂ≠ò
                                    </button>
                                    <button class="btn-action btn-delete-expense" onclick="deleteExpense()">
                                        <span class="btn-icon">üóëÔ∏è</span> Âà†Èô§
                                    </button>
                                </div>
                            </div>

                            <div class="expense-form">
                                <!-- Á±ªÂà´ÈÄâÊã©Ë°å -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Êä•ÈîÄÁ±ªÂà´</label>
                                        <select id="expense-category" onchange="onCategoryChange()">
                                            <option value="Â∑ÆÊóÖË¥π">Â∑ÆÊóÖË¥π</option>
                                            <option value="‰ºöËÆÆË¥π">‰ºöËÆÆË¥π</option>
                                            <option value="ÂüπËÆ≠Ë¥π">ÂüπËÆ≠Ë¥π</option>
                                            <option value="ÂäûÂÖ¨Ë¥π">ÂäûÂÖ¨Ë¥π</option>
                                            <option value="ÊãõÂæÖË¥π">ÊãõÂæÖË¥π</option>
                                            <option value="ÂÖ∂‰ªñË¥πÁî®">ÂÖ∂‰ªñË¥πÁî®</option>
                                        </select>
                                    </div>
                                    <div class="form-group sub-category-group">
                                        <label>Ë¥πÁî®ÊòéÁªÜ</label>
                                        <div class="sub-categories" id="sub-categories">
                                            <!-- Âä®ÊÄÅÁîüÊàê -->
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ëµ∑ÂßãÊó•Êúü</label>
                                        <input type="date" id="expense-start-date">
                                    </div>
                                    <div class="form-group">
                                        <label>ÁªìÊùüÊó•Êúü</label>
                                        <input type="date" id="expense-end-date">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group location-group">
                                        <label>Âú∞ÁÇπ</label>
                                        <div class="location-input-wrapper">
                                            <input type="text" id="expense-location" placeholder="ËæìÂÖ•ÊàñÈÄâÊã©Âú∞ÁÇπ">
                                            <div class="location-suggestions" id="location-suggestions"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Â§áÊ≥®</label>
                                    <textarea id="expense-notes" rows="2" placeholder="Ê∑ªÂä†Â§áÊ≥®..."></textarea>
                                </div>

                                <!-- ÁîüÊàêÊä•ÈîÄËØ¥Êòé -->
                                <div class="expense-summary-section">
                                    <button class="btn-generate-summary" onclick="generateSummary()">
                                        üìã ÁîüÊàêÊä•ÈîÄËØ¥Êòé
                                    </button>
                                    <div class="summary-output" id="summary-output" style="display: none;">
                                        <pre id="summary-text"></pre>
                                        <button class="btn-copy-summary" onclick="copySummary()">Â§çÂà∂</button>
                                    </div>
                                </div>
                            </div>

                            <div class="expense-files-section">
                                <div class="section-header">
                                    <h4>Êä•ÈîÄÂá≠ËØÅ</h4>
                                    <span class="file-count" id="file-count">0 ‰∏™Êñá‰ª∂</span>
                                </div>

                                <!-- Êñá‰ª∂ÊãñÊãΩÂå∫Âüü -->
                                <div class="file-drop-zone" id="file-drop-zone">
                                    <div class="drop-icon">üìÅ</div>
                                    <p>ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ‰∏ä‰º†</p>
                                    <span class="drop-hint">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</span>
                                    <input type="file" id="file-input" multiple style="display: none;">
                                </div>

                                <!-- Êñá‰ª∂ÂàóË°® -->
                                <div class="file-list" id="file-list"></div>

                                <!-- Âà†Èô§Á°ÆËÆ§ÂûÉÂúæÊ°∂ -->
                                <div class="trash-zone" id="trash-zone">
                                    <span class="trash-icon">üóëÔ∏è</span>
                                    <span>ÊãñÂà∞ËøôÈáåÂà†Èô§</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PPTÁîüÊàêÂô®Â∑•ÂÖ∑ -->
            <div class="tool-panel" id="tool-ppt" style="display: none;">
                <div class="ppt-layout">
                    <!-- Â∑¶‰æßÔºöPPTÂàóË°® -->
                    <div class="ppt-sidebar">
                        <div class="sidebar-header">
                            <h3>ÊàëÁöÑ PPT</h3>
                            <button class="btn-new" onclick="createPPT()">+ Êñ∞Âª∫</button>
                        </div>
                        <div class="ppt-list" id="ppt-list"></div>
                    </div>

                    <!-- Âè≥‰æßÔºöPPTÁºñËæëÂå∫ -->
                    <div class="ppt-editor" id="ppt-editor">
                        <div class="ppt-empty" id="ppt-empty">
                            <div class="empty-icon">üé¨</div>
                            <p>ÈÄâÊã©ÊàñÊñ∞Âª∫‰∏Ä‰∏™ PPT</p>
                        </div>

                        <div class="ppt-detail" id="ppt-detail" style="display: none;">
                            <!-- Ê†áÈ¢òÂíåÊìç‰Ωú -->
                            <div class="ppt-header">
                                <input type="text" class="ppt-title-input" id="ppt-title" placeholder="PPT Ê†áÈ¢ò...">
                                <div class="ppt-actions">
                                    <button class="btn-action btn-preview" onclick="previewPPT()" title="È¢ÑËßà">
                                        <span class="btn-icon">üëÅÔ∏è</span> È¢ÑËßà
                                    </button>
                                    <button class="btn-action btn-save" onclick="savePPT()">
                                        <span class="btn-icon">üíæ</span> ‰øùÂ≠ò
                                    </button>
                                    <button class="btn-action btn-download" onclick="downloadPPT()">
                                        <span class="btn-icon">üì•</span> ‰∏ãËΩΩ
                                    </button>
                                    <button class="btn-action btn-delete-ppt" onclick="deletePPT()" id="btn-delete-ppt" style="display:none;">
                                        <span class="btn-icon">üóëÔ∏è</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Ê®°ÊùøÈÄâÊã© -->
                            <div class="ppt-template-section">
                                <label>ÈÄâÊã©È£éÊ†ºÔºö</label>
                                <div class="template-options" id="template-options">
                                    <div class="template-option active" data-template="dark-statement" onclick="selectTemplate('dark-statement')">
                                        <div class="template-preview dark"></div>
                                        <span>Ê∑±Ëâ≤ÂÆ£Ë®Ä</span>
                                    </div>
                                    <div class="template-option" data-template="dark-columns" onclick="selectTemplate('dark-columns')">
                                        <div class="template-preview dark-cols"></div>
                                        <span>‰∏âÊ†èÂØπÊØî</span>
                                    </div>
                                    <div class="template-option" data-template="light-diagram" onclick="selectTemplate('light-diagram')">
                                        <div class="template-preview light"></div>
                                        <span>ÊµÖËâ≤ÊµÅÁ®ã</span>
                                    </div>
                                    <div class="template-option" data-template="dark-icon" onclick="selectTemplate('dark-icon')">
                                        <div class="template-preview dark-icon"></div>
                                        <span>ÂõæÊ†áË¶ÅÁÇπ</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂÜÖÂÆπÁºñËæëÂå∫ -->
                            <div class="ppt-content-editor">
                                <div class="editor-section">
                                    <label>‰∏ªÊ†áÈ¢ò</label>
                                    <input type="text" id="ppt-main-title" placeholder="ËæìÂÖ•‰∏ªÊ†áÈ¢ò..." onchange="updatePPTPreview()">
                                </div>

                                <div class="editor-section">
                                    <label>ÂâØÊ†áÈ¢ò / ËØ¥Êòé</label>
                                    <input type="text" id="ppt-subtitle" placeholder="ËæìÂÖ•ÂâØÊ†áÈ¢òÔºàÂèØÈÄâÔºâ..." onchange="updatePPTPreview()">
                                </div>

                                <div class="editor-section">
                                    <label>Ê†∏ÂøÉÂÜÖÂÆπÂùó</label>
                                    <div class="content-blocks" id="content-blocks">
                                        <!-- Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂÜÖÂÆπÂùó -->
                                    </div>
                                    <button class="btn-add-block" onclick="addContentBlock()">+ Ê∑ªÂä†ÂÜÖÂÆπÂùó</button>
                                </div>

                                <div class="editor-section">
                                    <label>Â∫ïÈÉ®ÈáëÂè•ÔºàÂèØÈÄâÔºâ</label>
                                    <input type="text" id="ppt-footer" placeholder="ËæìÂÖ•Â∫ïÈÉ®ÊÄªÁªìÊàñÈáëÂè•..." onchange="updatePPTPreview()">
                                </div>
                            </div>

                            <!-- ÂÆûÊó∂È¢ÑËßà -->
                            <div class="ppt-preview-section">
                                <div class="preview-header">
                                    <h4>ÂÆûÊó∂È¢ÑËßà</h4>
                                    <span class="preview-hint">ÁÇπÂáª"È¢ÑËßà"ÂèØÂÖ®Â±èÊü•Áúã</span>
                                </div>
                                <div class="preview-container" id="preview-container">
                                    <div class="preview-placeholder">ÁºñËæëÂÜÖÂÆπÂêéÊòæÁ§∫È¢ÑËßà</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PPTÁøªËØëÂ∑•ÂÖ∑ -->
            <div class="tool-panel" id="tool-ppt-translator" style="display: none;">
                <div class="ppt-translator-layout">
                    <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
                    <div class="translator-toolbar">
                        <div class="toolbar-left">
                            <div class="upload-zone" id="ppt-upload-zone">
                                <span class="upload-icon">üìÇ</span>
                                <span>ÊãñÊãΩ PDF Êñá‰ª∂Âà∞Ê≠§Â§ÑÔºåÊàñÁÇπÂáª‰∏ä‰º†</span>
                                <small style="color:var(--text-muted);font-size:0.75rem;margin-top:4px;">PPTËØ∑ÂÖàÂØºÂá∫‰∏∫PDF</small>
                                <input type="file" id="ppt-file-input" accept=".pdf" style="display:none">
                            </div>
                            <span class="file-name" id="ppt-file-name"></span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn-screenshot" id="btn-screenshot" onclick="toggleScreenshotMode()" title="Êà™ÂõæÁøªËØë">
                                <span>‚úÇÔ∏è</span> Êà™ÂõæÁøªËØë
                            </button>
                            <button class="btn-action btn-export" onclick="exportTranslatedPPT()" id="btn-export-ppt" style="display:none">
                                <span>üì•</span> ÂØºÂá∫
                            </button>
                            <button class="btn-action btn-settings" onclick="openTranslatorSettings()" title="ËÆæÁΩÆ">
                                <span>‚öôÔ∏è</span>
                            </button>
                        </div>
                    </div>

                    <!-- ÂèåÊ†èÈ¢ÑËßàÂå∫ -->
                    <div class="translator-content" id="translator-content" style="display:none">
                        <div class="translator-pane left-pane">
                            <div class="pane-header">
                                <span class="pane-title">ÂéüÊñá (ÂæÖÁøªËØë)</span>
                                <span class="page-info" id="left-page-info">Á¨¨ 1 / 1 È°µ</span>
                            </div>
                            <div class="pane-body" id="left-pane-body">
                                <canvas id="left-canvas"></canvas>
                                <!-- Êà™ÂõæÈÄâÂå∫Ë¶ÜÁõñÂ±Ç -->
                                <div class="screenshot-overlay" id="screenshot-overlay" style="display:none"></div>
                            </div>
                        </div>

                        <!-- ‰∏≠Èó¥ÁøªÈ°µÊéßÂà∂ -->
                        <div class="translator-nav">
                            <button class="nav-btn" id="btn-prev-page" onclick="goToPrevPage()" title="‰∏ä‰∏ÄÈ°µ">
                                <span>‚ñ≤</span>
                            </button>
                            <div class="page-indicator">
                                <input type="number" id="page-input" min="1" value="1" onchange="goToPage(this.value)">
                                <span class="page-separator">/</span>
                                <span id="total-pages">1</span>
                            </div>
                            <button class="nav-btn" id="btn-next-page" onclick="goToNextPage()" title="‰∏ã‰∏ÄÈ°µ">
                                <span>‚ñº</span>
                            </button>
                        </div>

                        <div class="translator-pane right-pane">
                            <div class="pane-header">
                                <span class="pane-title">ËØëÊñá</span>
                                <span class="page-info" id="right-page-info">Á¨¨ 1 / 1 È°µ</span>
                            </div>
                            <div class="pane-body" id="right-pane-body">
                                <canvas id="right-canvas"></canvas>
                                <!-- ÁøªËØëÊñáÂ≠óË¶ÜÁõñÂ±Ç -->
                                <div class="translation-overlays" id="translation-overlays"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Á©∫Áä∂ÊÄÅ -->
                    <div class="translator-empty" id="translator-empty">
                        <div class="empty-icon">üåê</div>
                        <p>‰∏ä‰º† PDF Êñá‰ª∂ÂºÄÂßãÁøªËØë</p>
                        <p class="empty-hint">PPT ËØ∑ÂÖàÂØºÂá∫‰∏∫ PDF Ê†ºÂºè</p>
                    </div>
                </div>
            </div>

            <!-- È∏øËíôÊâãÊú∫ËØïÈ™åÁî∞ -->
            <div class="tool-panel" id="tool-harmonyos-lab" style="display: none;">
                <div class="harmonyos-lab-layout">
                    <!-- Â∑¶‰æßÔºöÂäüËÉΩÂØºËà™ -->
                    <div class="lab-sidebar">
                        <div class="sidebar-header">
                            <h3>ËØïÈ™åÁî∞</h3>
                        </div>
                        <div class="lab-nav">
                            <div class="lab-nav-item active" data-section="simulator" onclick="switchLabSection('simulator')">
                                <span class="nav-icon">üì±</span>
                                <span class="nav-text">Ê®°ÊãüÂô®</span>
                            </div>
                            <div class="lab-nav-item" data-section="apps" onclick="switchLabSection('apps')">
                                <span class="nav-icon">üì¶</span>
                                <span class="nav-text">Â∫îÁî®ÁÆ°ÁêÜ</span>
                            </div>
                            <div class="lab-nav-item" data-section="components" onclick="switchLabSection('components')">
                                <span class="nav-icon">üß©</span>
                                <span class="nav-text">ÁªÑ‰ª∂Â∫ì</span>
                            </div>
                            <div class="lab-nav-item" data-section="plugins" onclick="switchLabSection('plugins')">
                                <span class="nav-icon">üîå</span>
                                <span class="nav-text">Êèí‰ª∂Á≥ªÁªü</span>
                            </div>
                            <div class="lab-nav-item" data-section="themes" onclick="switchLabSection('themes')">
                                <span class="nav-icon">üé®</span>
                                <span class="nav-text">‰∏ªÈ¢òÂÆöÂà∂</span>
                            </div>
                            <div class="lab-nav-item" data-section="scripts" onclick="switchLabSection('scripts')">
                                <span class="nav-icon">üìù</span>
                                <span class="nav-text">ËÑöÊú¨ÊéßÂà∂</span>
                            </div>
                            <div class="lab-nav-item" data-section="logs" onclick="switchLabSection('logs')">
                                <span class="nav-icon">üìã</span>
                                <span class="nav-text">ËøêË°åÊó•Âøó</span>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏≠Èó¥ÔºöÊâãÊú∫Ê®°ÊãüÂô® -->
                    <div class="lab-simulator">
                        <div class="phone-frame">
                            <div class="phone-notch"></div>
                            <div class="phone-screen" id="phone-screen">
                                <!-- Áä∂ÊÄÅÊ†è -->
                                <div class="phone-statusbar" id="phone-statusbar">
                                    <span class="status-time" id="phone-time">12:00</span>
                                    <div class="status-icons">
                                        <span class="status-signal">üì∂</span>
                                        <span class="status-wifi">üì°</span>
                                        <span class="status-battery">üîã<small id="battery-level">91</small></span>
                                    </div>
                                </div>

                                <!-- ÊéßÂà∂‰∏≠ÂøÉÔºà‰∏ãÊãâÊòæÁ§∫Ôºâ -->
                                <div class="control-center" id="control-center">
                                    <div class="control-center-handle"></div>
                                    <div class="control-grid">
                                        <div class="control-toggle active" data-control="wifi">
                                            <span class="control-icon">üì∂</span>
                                            <span class="control-label">WLAN</span>
                                        </div>
                                        <div class="control-toggle active" data-control="bluetooth">
                                            <span class="control-icon">üîµ</span>
                                            <span class="control-label">ËìùÁâô</span>
                                        </div>
                                        <div class="control-toggle" data-control="data">
                                            <span class="control-icon">üì±</span>
                                            <span class="control-label">Êï∞ÊçÆ</span>
                                        </div>
                                        <div class="control-toggle" data-control="airplane">
                                            <span class="control-icon">‚úàÔ∏è</span>
                                            <span class="control-label">È£ûË°å</span>
                                        </div>
                                        <div class="control-toggle active" data-control="location">
                                            <span class="control-icon">üìç</span>
                                            <span class="control-label">ÂÆö‰Ωç</span>
                                        </div>
                                        <div class="control-toggle" data-control="flashlight">
                                            <span class="control-icon">üî¶</span>
                                            <span class="control-label">ÊâãÁîµ</span>
                                        </div>
                                    </div>
                                    <div class="brightness-slider">
                                        <span>‚òÄÔ∏è</span>
                                        <input type="range" min="0" max="100" value="70" id="brightness-range">
                                        <span>üåü</span>
                                    </div>
                                    <div class="volume-slider">
                                        <span>üîà</span>
                                        <input type="range" min="0" max="100" value="50" id="volume-range">
                                        <span>üîä</span>
                                    </div>
                                </div>

                                <!-- Ê°åÈù¢ÂÜÖÂÆπÂå∫ -->
                                <div class="desktop-container" id="desktop-container">
                                    <!-- È°µÈù¢ÂÆπÂô®ÔºàÂèØÂ∑¶Âè≥ÊªëÂä®Ôºâ -->
                                    <div class="desktop-pages" id="desktop-pages">
                                        <!-- Á¨¨‰∏ÄÈ°µÔºöÂ∞èÈÉ®‰ª∂+Â∫îÁî® -->
                                        <div class="desktop-page" data-page="0">
                                            <!-- Êó∂ÈíüÂ∞èÈÉ®‰ª∂ -->
                                            <div class="widget widget-clock widget-4x2" data-widget="clock">
                                                <div class="clock-cities">
                                                    <div class="clock-city">
                                                        <div class="clock-face" id="clock-beijing">
                                                            <div class="clock-hand hour"></div>
                                                            <div class="clock-hand minute"></div>
                                                            <div class="clock-center"></div>
                                                        </div>
                                                        <div class="clock-info">
                                                            <span class="city-name">Âåó‰∫¨</span>
                                                            <span class="city-date" id="date-beijing">1Êúà1Êó•</span>
                                                        </div>
                                                    </div>
                                                    <div class="clock-city">
                                                        <div class="clock-face" id="clock-toronto">
                                                            <div class="clock-hand hour"></div>
                                                            <div class="clock-hand minute"></div>
                                                            <div class="clock-center"></div>
                                                        </div>
                                                        <div class="clock-info">
                                                            <span class="city-name">Â§ö‰º¶Â§ö</span>
                                                            <span class="city-date" id="date-toronto">12Êúà31Êó•</span>
                                                        </div>
                                                    </div>
                                                    <div class="clock-city">
                                                        <div class="clock-face" id="clock-vancouver">
                                                            <div class="clock-hand hour"></div>
                                                            <div class="clock-hand minute"></div>
                                                            <div class="clock-center"></div>
                                                        </div>
                                                        <div class="clock-info">
                                                            <span class="city-name">Ê∏©Âì•Âçé</span>
                                                            <span class="city-date" id="date-vancouver">12Êúà31Êó•</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Â§©Ê∞îÂ∞èÈÉ®‰ª∂ -->
                                            <div class="widget widget-weather widget-2x1" data-widget="weather">
                                                <div class="weather-content">
                                                    <span class="weather-location">üìç ÊªëÈìÅÂç¢</span>
                                                    <span class="weather-temp">ÊòéÂ§© -10/-12¬∞C ‚ùÑÔ∏è</span>
                                                </div>
                                            </div>

                                            <!-- Â∫îÁî®Êñá‰ª∂Â§π -->
                                            <div class="app-folder touch-icon" data-folder="frequent" data-label="Â∏∏Áî®">
                                                <div class="folder-preview">
                                                    <span>ÊîØ</span><span>‚öôÔ∏è</span><span>üìß</span>
                                                    <span>üéß</span><span>üè¶</span><span>üí¨</span>
                                                    <span>üìù</span><span>üîÑ</span><span>üõí</span>
                                                </div>
                                                <span class="name">Â∏∏Áî®</span>
                                            </div>

                                            <!-- Âçï‰∏™Â∫îÁî®ÂõæÊ†á -->
                                            <div class="touch-icon" data-app="doubao" data-label="Ë±ÜÂåÖ">
                                                <span class="icon app-icon-doubao">ü§ñ</span>
                                                <span class="name">Ë±ÜÂåÖ</span>
                                            </div>
                                            <div class="touch-icon" data-app="messages" data-label="‰ø°ÊÅØ">
                                                <span class="icon app-icon-messages">üí¨</span>
                                                <span class="name">‰ø°ÊÅØ</span>
                                            </div>

                                            <!-- Èü≥‰πêÊí≠ÊîæÂô®Â∞èÈÉ®‰ª∂ -->
                                            <div class="widget widget-music widget-2x2" data-widget="music">
                                                <div class="music-cover">üéµ</div>
                                                <div class="music-info">
                                                    <span class="music-title">Â¢®ÁºòÔºàÂüôÁâàÔºâ</span>
                                                    <span class="music-artist">...</span>
                                                </div>
                                                <div class="music-controls">
                                                    <button class="music-btn">‚ù§Ô∏è</button>
                                                    <button class="music-btn music-play">‚ñ∂Ô∏è</button>
                                                    <button class="music-btn">‚è≠Ô∏è</button>
                                                </div>
                                            </div>

                                            <!-- ÊâìÂç°/Èü≥‰πêÂç°Áâá -->
                                            <div class="touch-icon" data-app="checkin" data-label="ÊâìÂç°">
                                                <span class="icon app-icon-checkin">‚úÖ</span>
                                                <span class="name">ÊâìÂç°</span>
                                            </div>
                                            <div class="widget widget-music-card widget-2x1" data-widget="music-card">
                                                <div class="music-card-content">
                                                    <span class="music-card-icon">üéµ</span>
                                                    <span class="music-card-text">5È¢òÂ∫ì‰∫î</span>
                                                    <span class="music-card-actions">‚ñ∂ ‚ô°</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Á¨¨‰∫åÈ°µÔºöÊõ¥Â§öÂ∫îÁî® -->
                                        <div class="desktop-page" data-page="1">
                                            <div class="launcher-grid" id="launcher-grid">
                                                <div class="touch-icon" data-app="dingding" data-label="ÈíâÈíâ">
                                                    <span class="icon app-icon-dingding">üì≤</span>
                                                    <span class="app-badge">99+</span>
                                                    <span class="name">ÈíâÈíâ</span>
                                                </div>
                                                <div class="touch-icon" data-app="map" data-label="Âú∞Âõæ">
                                                    <span class="icon app-icon-map">üó∫Ô∏è</span>
                                                    <span class="name">Âú∞Âõæ</span>
                                                </div>
                                                <div class="touch-icon" data-app="chatgpt" data-label="ChatGPT">
                                                    <span class="icon app-icon-chatgpt">üß†</span>
                                                    <span class="name">ChatGPT</span>
                                                </div>
                                                <div class="touch-icon" data-app="todo" data-label="Todo">
                                                    <span class="icon app-icon-todo">‚úÖ</span>
                                                    <span class="name">Todo</span>
                                                </div>
                                                <div class="touch-icon" data-app="gallery" data-label="ÂõæÂ∫ì">
                                                    <span class="icon app-icon-gallery">üñºÔ∏è</span>
                                                    <span class="name">ÂõæÂ∫ì</span>
                                                </div>
                                                <div class="touch-icon" data-app="settings" data-label="ËÆæÁΩÆ">
                                                    <span class="icon">‚öôÔ∏è</span>
                                                    <span class="name">ËÆæÁΩÆ</span>
                                                </div>
                                                <div class="touch-icon" data-app="camera" data-label="Áõ∏Êú∫">
                                                    <span class="icon">üì∑</span>
                                                    <span class="name">Áõ∏Êú∫</span>
                                                </div>
                                                <div class="touch-icon" data-app="calendar" data-label="Êó•ÂéÜ">
                                                    <span class="icon">üìÖ</span>
                                                    <span class="name">Êó•ÂéÜ</span>
                                                </div>
                                                <div class="touch-icon" data-app="notes" data-label="Â§áÂøòÂΩï">
                                                    <span class="icon">üìù</span>
                                                    <span class="name">Â§áÂøòÂΩï</span>
                                                </div>
                                                <div class="touch-icon" data-app="music" data-label="Èü≥‰πê">
                                                    <span class="icon">üéµ</span>
                                                    <span class="name">Èü≥‰πê</span>
                                                </div>
                                                <div class="touch-icon" data-app="video" data-label="ËßÜÈ¢ë">
                                                    <span class="icon">üé¨</span>
                                                    <span class="name">ËßÜÈ¢ë</span>
                                                </div>
                                                <div class="touch-icon" data-app="files" data-label="Êñá‰ª∂">
                                                    <span class="icon">üìÅ</span>
                                                    <span class="name">Êñá‰ª∂</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- È°µÈù¢ÊåáÁ§∫Âô® -->
                                    <div class="page-indicators" id="page-indicators">
                                        <span class="page-dot active" data-page="0"></span>
                                        <span class="page-dot" data-page="1"></span>
                                    </div>
                                </div>

                                <!-- Dock Ê†è -->
                                <div class="phone-dock" id="phone-dock">
                                    <div class="touch-icon dock-icon" data-app="phone" data-label="ÁîµËØù">
                                        <span class="icon app-icon-phone">üìû</span>
                                    </div>
                                    <div class="touch-icon dock-icon" data-app="welink" data-label="WeLink">
                                        <span class="icon app-icon-welink">üîó</span>
                                    </div>
                                    <div class="touch-icon dock-icon" data-app="wechat" data-label="ÂæÆ‰ø°">
                                        <span class="icon app-icon-wechat">üí¨</span>
                                        <span class="app-badge">56</span>
                                    </div>
                                    <div class="touch-icon dock-icon" data-app="camera" data-label="Áõ∏Êú∫">
                                        <span class="icon app-icon-camera">üì∏</span>
                                    </div>
                                </div>

                                <!-- Â∫ïÈÉ®ÂØºËà™Êù° -->
                                <div class="phone-navbar">
                                    <div class="navbar-indicator"></div>
                                </div>

                                <!-- ÈïøÊåâ‰∏ä‰∏ãÊñáËèúÂçï -->
                                <div class="context-menu" id="context-menu">
                                    <div class="context-menu-item" data-action="open">
                                        <span class="menu-icon">üìÇ</span>
                                        <span>ÊâìÂºÄ</span>
                                    </div>
                                    <div class="context-menu-item" data-action="uninstall">
                                        <span class="menu-icon">üóëÔ∏è</span>
                                        <span>Âç∏ËΩΩ</span>
                                    </div>
                                    <div class="context-menu-item" data-action="info">
                                        <span class="menu-icon">‚ÑπÔ∏è</span>
                                        <span>Â∫îÁî®‰ø°ÊÅØ</span>
                                    </div>
                                    <div class="context-menu-item" data-action="widget">
                                        <span class="menu-icon">üß©</span>
                                        <span>Ê∑ªÂä†Âç°Áâá</span>
                                    </div>
                                </div>

                                <!-- Êñá‰ª∂Â§πÂ±ïÂºÄËßÜÂõæ -->
                                <div class="folder-overlay" id="folder-overlay">
                                    <div class="folder-expanded" id="folder-expanded">
                                        <div class="folder-header">
                                            <input type="text" class="folder-title" value="Â∏∏Áî®" id="folder-title">
                                        </div>
                                        <div class="folder-grid" id="folder-grid">
                                            <!-- Êñá‰ª∂Â§πÂÜÖÂ∫îÁî®Âä®ÊÄÅÁîüÊàê -->
                                        </div>
                                    </div>
                                </div>
                                <!-- Ëß¶Â±è‰∫§‰∫íÂ±Ç -->
                                <div class="touch-layer" id="touch-layer">
                                    <!-- Ëß¶Êë∏ÊåáÁ§∫Âô®ÔºàÊâãÊåáÂ∞èÁêÉÔºâ -->
                                    <div class="touch-indicator" id="touch-indicator">
                                        <div class="touch-core"></div>
                                        <div class="touch-glow"></div>
                                    </div>
                                    <!-- ÁÇπÂáªÊ∂üÊº™ÂÆπÂô® -->
                                    <div class="ripple-container" id="ripple-container"></div>
                                    <!-- ÈïøÊåâËÉΩÈáèÊïàÊûú -->
                                    <div class="press-energy" id="press-energy">
                                        <div class="energy-ring ring-1"></div>
                                        <div class="energy-ring ring-2"></div>
                                        <div class="energy-ring ring-3"></div>
                                        <div class="energy-sparks" id="energy-sparks"></div>
                                    </div>
                                </div>

                                <!-- ÂΩóÊòüÂ∞æËøπÁîªÂ∏ÉÔºàÁã¨Á´ã‰∫éÂ∞èÁêÉÔºâ -->
                                <canvas class="comet-trail" id="comet-trail"></canvas>

                                <!-- ÂΩóÊòüÂ∞èÁêÉ -->
                                <div class="comet-ball" id="comet-ball">
                                    <div class="comet-core"></div>
                                    <div class="comet-glow"></div>
                                </div>
                            </div>
                        </div>
                        <div class="simulator-controls">
                            <button class="sim-btn" onclick="rotatePhone()" title="ÊóãËΩ¨">üîÑ</button>
                            <button class="sim-btn" onclick="screenshotPhone()" title="Êà™Âõæ">üì∑</button>
                            <button class="sim-btn" onclick="restartPhone()" title="ÈáçÂêØ">‚ö°</button>
                            <button class="sim-btn" onclick="restartCometBall()" title="ÈáçÁΩÆÂ∞èÁêÉ">üîÆ</button>
                            <button class="sim-btn" onclick="clearTouchEvents()" title="Ê∏ÖÁ©∫‰∫ã‰ª∂">üóëÔ∏è</button>
                        </div>
                        <!-- Ëß¶Â±è‰∫ã‰ª∂Êó•Âøó -->
                        <div class="touch-event-log" id="touch-event-log">
                            <div class="log-header">Ëß¶Â±è‰∫ã‰ª∂ÊµÅ</div>
                            <div class="log-content" id="touch-log-content"></div>
                        </div>
                    </div>

                    <!-- Âè≥‰æßÔºöÂäüËÉΩÈù¢Êùø -->
                    <div class="lab-panel">
                        <!-- Ê®°ÊãüÂô®ÊéßÂà∂Èù¢Êùø -->
                        <div class="lab-section" id="lab-section-simulator">
                            <div class="section-header">
                                <h4>Ê®°ÊãüÂô®ÊéßÂà∂</h4>
                            </div>
                            <div class="section-content">
                                <div class="control-group">
                                    <label>ËÆæÂ§áÂûãÂè∑</label>
                                    <select id="device-model">
                                        <option value="phone">HarmonyOS Phone</option>
                                        <option value="tablet">HarmonyOS Tablet</option>
                                        <option value="watch">HarmonyOS Watch</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label>Â±èÂπïÂ∞∫ÂØ∏</label>
                                    <select id="screen-size">
                                        <option value="360x780">360 x 780 (Ê†áÂáÜ)</option>
                                        <option value="375x812">375 x 812 (Â§ßÂ±è)</option>
                                        <option value="320x568">320 x 568 (Â∞èÂ±è)</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label>Á≥ªÁªüÁâàÊú¨</label>
                                    <select id="os-version">
                                        <option value="4.0">HarmonyOS 4.0</option>
                                        <option value="3.0">HarmonyOS 3.0</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Â∫îÁî®ÁÆ°ÁêÜÈù¢Êùø -->
                        <div class="lab-section" id="lab-section-apps" style="display:none">
                            <div class="section-header">
                                <h4>Â∫îÁî®ÁÆ°ÁêÜ</h4>
                                <button class="btn-sm" onclick="createNewApp()">+ Êñ∞Âª∫Â∫îÁî®</button>
                            </div>
                            <div class="section-content">
                                <div class="app-list" id="lab-app-list">
                                    <div class="empty-hint">ÊöÇÊó†Â∫îÁî®ÔºåÁÇπÂáª"Êñ∞Âª∫Â∫îÁî®"ÂºÄÂßã</div>
                                </div>
                            </div>
                        </div>

                        <!-- ÁªÑ‰ª∂Â∫ìÈù¢Êùø -->
                        <div class="lab-section" id="lab-section-components" style="display:none">
                            <div class="section-header">
                                <h4>ÁªÑ‰ª∂Â∫ì</h4>
                            </div>
                            <div class="section-content">
                                <div class="component-grid">
                                    <div class="component-item" data-component="button">
                                        <span class="component-icon">üîò</span>
                                        <span class="component-name">Button</span>
                                    </div>
                                    <div class="component-item" data-component="input">
                                        <span class="component-icon">üìù</span>
                                        <span class="component-name">Input</span>
                                    </div>
                                    <div class="component-item" data-component="list">
                                        <span class="component-icon">üìã</span>
                                        <span class="component-name">List</span>
                                    </div>
                                    <div class="component-item" data-component="card">
                                        <span class="component-icon">üÉè</span>
                                        <span class="component-name">Card</span>
                                    </div>
                                    <div class="component-item" data-component="modal">
                                        <span class="component-icon">ü™ü</span>
                                        <span class="component-name">Modal</span>
                                    </div>
                                    <div class="component-item" data-component="tabs">
                                        <span class="component-icon">üìë</span>
                                        <span class="component-name">Tabs</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Êèí‰ª∂Á≥ªÁªüÈù¢Êùø -->
                        <div class="lab-section" id="lab-section-plugins" style="display:none">
                            <div class="section-header">
                                <h4>Êèí‰ª∂Á≥ªÁªü</h4>
                                <button class="btn-sm" onclick="installPlugin()">+ ÂÆâË£ÖÊèí‰ª∂</button>
                            </div>
                            <div class="section-content">
                                <div class="plugin-list" id="lab-plugin-list">
                                    <div class="empty-hint">ÊöÇÊó†Êèí‰ª∂</div>
                                </div>
                            </div>
                        </div>

                        <!-- ‰∏ªÈ¢òÂÆöÂà∂Èù¢Êùø -->
                        <div class="lab-section" id="lab-section-themes" style="display:none">
                            <div class="section-header">
                                <h4>‰∏ªÈ¢òÂÆöÂà∂</h4>
                            </div>
                            <div class="section-content">
                                <div class="theme-list">
                                    <div class="theme-item active" data-theme="default">
                                        <div class="theme-preview default"></div>
                                        <span>ÈªòËÆ§</span>
                                    </div>
                                    <div class="theme-item" data-theme="dark">
                                        <div class="theme-preview dark"></div>
                                        <span>ÊöóËâ≤</span>
                                    </div>
                                    <div class="theme-item" data-theme="light">
                                        <div class="theme-preview light"></div>
                                        <span>ÊµÖËâ≤</span>
                                    </div>
                                </div>
                                <div class="theme-colors">
                                    <h5>Ëá™ÂÆö‰πâÈ¢úËâ≤</h5>
                                    <div class="color-picker-group">
                                        <label>‰∏ªËâ≤Ë∞É</label>
                                        <input type="color" id="theme-primary" value="#007AFF">
                                    </div>
                                    <div class="color-picker-group">
                                        <label>ËÉåÊôØËâ≤</label>
                                        <input type="color" id="theme-background" value="#F2F2F7">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ËÑöÊú¨ÊéßÂà∂Èù¢Êùø -->
                        <div class="lab-section" id="lab-section-scripts" style="display:none">
                            <div class="section-header">
                                <h4>ËÑöÊú¨ÊéßÂà∂</h4>
                                <button class="btn-sm" onclick="runLabScript()">‚ñ∂ ËøêË°å</button>
                            </div>
                            <div class="section-content">
                                <textarea class="script-editor" id="lab-script-editor" placeholder="# Âú®ËøôÈáåÁºñÂÜôËÑöÊú¨
# ÂèØÁî® API: device, ui, apps, storage

device.get_info()
ui.click(100, 200)
print('Hello HarmonyOS!')
"></textarea>
                                <div class="script-output" id="lab-script-output"></div>
                            </div>
                        </div>

                        <!-- ËøêË°åÊó•ÂøóÈù¢Êùø -->
                        <div class="lab-section" id="lab-section-logs" style="display:none">
                            <div class="section-header">
                                <h4>ËøêË°åÊó•Âøó</h4>
                                <button class="btn-sm" onclick="clearLabLogs()">Ê∏ÖÁ©∫</button>
                            </div>
                            <div class="section-content">
                                <div class="log-viewer" id="lab-log-viewer">
                                    <div class="log-empty">ÊöÇÊó†Êó•Âøó</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êó•Á®ãÁÆ°ÁêÜÂ∑•ÂÖ∑ -->
            <div class="tool-panel" id="tool-calendar" style="display: none;">
                <style>
                .calendar-layout {
                    display: flex;
                    gap: 20px;
                    height: calc(100vh - 200px);
                }
                .calendar-sidebar {
                    width: 280px;
                    background: var(--card-bg, #fff);
                    border-radius: 12px;
                    padding: 16px;
                    display: flex;
                    flex-direction: column;
                }
                .calendar-main {
                    flex: 1;
                    background: var(--card-bg, #fff);
                    border-radius: 12px;
                    padding: 20px;
                    display: flex;
                    flex-direction: column;
                }
                .mini-calendar {
                    margin-bottom: 16px;
                }
                .mini-calendar-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                }
                .mini-calendar-nav {
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 18px;
                    padding: 4px 8px;
                    border-radius: 4px;
                }
                .mini-calendar-nav:hover {
                    background: var(--hover-bg, #f3f4f6);
                }
                .mini-calendar-grid {
                    display: grid;
                    grid-template-columns: repeat(7, 1fr);
                    gap: 2px;
                    text-align: center;
                }
                .mini-calendar-weekday {
                    font-size: 12px;
                    color: var(--text-muted, #6b7280);
                    padding: 4px;
                }
                .mini-calendar-day {
                    padding: 6px;
                    font-size: 13px;
                    border-radius: 50%;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .mini-calendar-day:hover {
                    background: var(--hover-bg, #f3f4f6);
                }
                .mini-calendar-day.today {
                    background: var(--accent-color, #4f46e5);
                    color: white;
                }
                .mini-calendar-day.selected {
                    border: 2px solid var(--accent-color, #4f46e5);
                }
                .mini-calendar-day.has-events {
                    position: relative;
                }
                .mini-calendar-day.has-events::after {
                    content: '';
                    position: absolute;
                    bottom: 2px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 4px;
                    height: 4px;
                    background: var(--accent-color, #4f46e5);
                    border-radius: 50%;
                }
                .outlook-sync {
                    padding: 12px;
                    background: var(--bg-secondary, #f9fafb);
                    border-radius: 8px;
                    margin-bottom: 16px;
                }
                .outlook-sync-header {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 8px;
                }
                .outlook-sync-status {
                    font-size: 13px;
                    color: var(--text-muted, #6b7280);
                }
                .outlook-sync-status.connected {
                    color: #10b981;
                }
                .outlook-sync-header {
                    position: relative;
                }
                .outlook-config-btn {
                    position: absolute;
                    right: 0;
                    top: 0;
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 14px;
                    opacity: 0.6;
                    transition: opacity 0.2s;
                }
                .outlook-config-btn:hover {
                    opacity: 1;
                }
                .outlook-user-info {
                    font-size: 12px;
                    color: var(--text-muted, #6b7280);
                    margin-bottom: 8px;
                    padding: 6px 8px;
                    background: var(--bg-tertiary, #f3f4f6);
                    border-radius: 4px;
                }
                .btn-logout {
                    margin-top: 6px;
                    border-style: solid !important;
                    border-color: #ef4444 !important;
                    color: #ef4444 !important;
                    font-size: 12px !important;
                    padding: 6px !important;
                }
                .btn-logout:hover {
                    background: #fef2f2 !important;
                }
                .outlook-config-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                }
                .outlook-config-content {
                    background: var(--card-bg, #fff);
                    border-radius: 12px;
                    width: 90%;
                    max-width: 500px;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
                }
                .outlook-config-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 16px 20px;
                    border-bottom: 1px solid var(--border-color, #e5e7eb);
                }
                .outlook-config-header h3 {
                    margin: 0;
                    font-size: 16px;
                }
                .outlook-config-header button {
                    background: none;
                    border: none;
                    font-size: 18px;
                    cursor: pointer;
                    color: var(--text-muted, #6b7280);
                }
                .outlook-config-body {
                    padding: 20px;
                }
                .config-hint {
                    font-size: 13px;
                    color: var(--text-muted, #6b7280);
                    margin-bottom: 16px;
                }
                .config-hint a {
                    color: #3b82f6;
                }
                .config-field {
                    margin-bottom: 16px;
                }
                .config-field label {
                    display: block;
                    font-size: 13px;
                    font-weight: 500;
                    margin-bottom: 6px;
                }
                .config-field .required {
                    color: #ef4444;
                }
                .config-field input {
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid var(--border-color, #e5e7eb);
                    border-radius: 6px;
                    font-size: 14px;
                    box-sizing: border-box;
                }
                .config-field input:focus {
                    outline: none;
                    border-color: #3b82f6;
                }
                .config-actions {
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                    margin-top: 20px;
                }
                .config-actions button {
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    cursor: pointer;
                }
                .btn-cancel {
                    background: var(--bg-secondary, #f3f4f6);
                    border: 1px solid var(--border-color, #e5e7eb);
                    color: var(--text-color, #374151);
                }
                .btn-save {
                    background: #3b82f6;
                    border: none;
                    color: white;
                }
                .btn-save:hover {
                    background: #2563eb;
                }
                .btn-sync {
                    width: 100%;
                    padding: 10px;
                    border: 1px dashed var(--border-color, #e5e7eb);
                    background: transparent;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 13px;
                    color: var(--text-muted, #6b7280);
                    transition: all 0.2s;
                }
                .btn-sync:hover {
                    border-color: var(--accent-color, #4f46e5);
                    color: var(--accent-color, #4f46e5);
                }
                .upcoming-events {
                    flex: 1;
                    overflow-y: auto;
                }
                .upcoming-header {
                    font-size: 14px;
                    font-weight: 600;
                    margin-bottom: 12px;
                    color: var(--text-color, #1f2937);
                }
                .event-item {
                    padding: 12px;
                    background: var(--bg-secondary, #f9fafb);
                    border-radius: 8px;
                    margin-bottom: 8px;
                    border-left: 3px solid var(--accent-color, #4f46e5);
                }
                .event-time {
                    font-size: 12px;
                    color: var(--text-muted, #6b7280);
                    margin-bottom: 4px;
                }
                .event-title {
                    font-size: 14px;
                    font-weight: 500;
                    color: var(--text-color, #1f2937);
                }
                .calendar-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                }
                .calendar-title {
                    font-size: 20px;
                    font-weight: 600;
                }
                .calendar-actions {
                    display: flex;
                    gap: 8px;
                }
                .btn-add-event {
                    padding: 8px 16px;
                    background: var(--accent-color, #4f46e5);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }
                .btn-add-event:hover {
                    background: var(--accent-hover, #4338ca);
                }
                .day-schedule {
                    flex: 1;
                    overflow-y: auto;
                }
                .hour-row {
                    display: flex;
                    border-bottom: 1px solid var(--border-color, #e5e7eb);
                    min-height: 60px;
                }
                .hour-label {
                    width: 60px;
                    padding: 8px;
                    font-size: 12px;
                    color: var(--text-muted, #6b7280);
                    text-align: right;
                    flex-shrink: 0;
                }
                .hour-content {
                    flex: 1;
                    padding: 4px 8px;
                    position: relative;
                }
                .schedule-event {
                    position: absolute;
                    left: 8px;
                    right: 8px;
                    background: var(--accent-color, #4f46e5);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                }
                .no-events-hint {
                    text-align: center;
                    padding: 40px;
                    color: var(--text-muted, #6b7280);
                }
                /* Ê∑ªÂä†‰∫ã‰ª∂Ê®°ÊÄÅÊ°Ü */
                .event-modal {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    align-items: center;
                    justify-content: center;
                }
                .event-modal.visible {
                    display: flex;
                }
                .event-modal-content {
                    background: var(--card-bg, #fff);
                    border-radius: 12px;
                    padding: 24px;
                    width: 400px;
                    max-width: 90%;
                }
                .event-form-group {
                    margin-bottom: 16px;
                }
                .event-form-group label {
                    display: block;
                    font-size: 14px;
                    font-weight: 500;
                    margin-bottom: 6px;
                }
                .event-form-group input,
                .event-form-group textarea {
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid var(--border-color, #e5e7eb);
                    border-radius: 8px;
                    font-size: 14px;
                }
                .event-form-row {
                    display: flex;
                    gap: 12px;
                }
                .event-form-row .event-form-group {
                    flex: 1;
                }
                </style>

                <div class="calendar-layout">
                    <!-- Â∑¶‰æßËæπÊ†è -->
                    <div class="calendar-sidebar">
                        <!-- Ëø∑‰Ω†Êó•ÂéÜ -->
                        <div class="mini-calendar">
                            <div class="mini-calendar-header">
                                <button class="mini-calendar-nav" onclick="calendarPrevMonth()">‚óÄ</button>
                                <span id="mini-calendar-month">2026Âπ¥1Êúà</span>
                                <button class="mini-calendar-nav" onclick="calendarNextMonth()">‚ñ∂</button>
                            </div>
                            <div class="mini-calendar-grid" id="mini-calendar-grid">
                                <!-- Êó•ÂéÜÁΩëÊ†ºÁî±JSÁîüÊàê -->
                            </div>
                        </div>

                        <!-- Outlook ÂêåÊ≠• -->
                        <div class="outlook-sync">
                            <div class="outlook-sync-header">
                                <span>üìß</span>
                                <span>Outlook ÈõÜÊàê</span>
                                <button class="outlook-config-btn" id="btn-outlook-config" onclick="showOutlookConfig()" title="ÈÖçÁΩÆ">‚öôÔ∏è</button>
                            </div>
                            <div class="outlook-sync-status" id="outlook-status">Ê£ÄÊü•‰∏≠...</div>
                            <div class="outlook-user-info" id="outlook-user-info" style="display:none;"></div>
                            <button class="btn-sync" id="btn-outlook-sync" onclick="syncOutlook()" style="display:none;">
                                üîÑ ÂêåÊ≠•Êó•Á®ã
                            </button>
                            <button class="btn-sync" id="btn-outlook-login" onclick="loginOutlook()" style="display:none;">
                                üîê ÁôªÂΩï Microsoft
                            </button>
                            <button class="btn-sync btn-logout" id="btn-outlook-logout" onclick="logoutOutlook()" style="display:none;">
                                ÈÄÄÂá∫ÁôªÂΩï
                            </button>
                        </div>

                        <!-- Outlook ÈÖçÁΩÆÂºπÁ™ó -->
                        <div class="outlook-config-modal" id="outlook-config-modal" style="display:none;">
                            <div class="outlook-config-content">
                                <div class="outlook-config-header">
                                    <h3>ÈÖçÁΩÆ Microsoft Graph API</h3>
                                    <button onclick="hideOutlookConfig()">‚úï</button>
                                </div>
                                <div class="outlook-config-body">
                                    <p class="config-hint">ËØ∑Âú® <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure Portal</a> Ê≥®ÂÜåÂ∫îÁî®ÂêéÂ°´ÂÖ•‰ª•‰∏ã‰ø°ÊÅØÔºö</p>
                                    <div class="config-field">
                                        <label>Application (client) ID <span class="required">*</span></label>
                                        <input type="text" id="outlook-client-id" placeholder="‰æãÂ¶Ç: 12345678-1234-1234-1234-123456789abc">
                                    </div>
                                    <div class="config-field">
                                        <label>Client SecretÔºàÂèØÈÄâÔºâ</label>
                                        <input type="password" id="outlook-client-secret" placeholder="Â¶ÇÊûúÊòØÂÖ¨ÂÖ±ÂÆ¢Êà∑Á´ØÂèØÁïôÁ©∫">
                                    </div>
                                    <div class="config-field">
                                        <label>Tenant IDÔºàÂèØÈÄâÔºâ</label>
                                        <input type="text" id="outlook-tenant-id" placeholder="ÈªòËÆ§: commonÔºàÊîØÊåÅ‰∏™‰∫∫ÂíåÂ∑•‰ΩúË¥¶Êà∑Ôºâ">
                                    </div>
                                    <div class="config-actions">
                                        <button class="btn-cancel" onclick="hideOutlookConfig()">ÂèñÊ∂à</button>
                                        <button class="btn-save" onclick="saveOutlookConfig()">‰øùÂ≠òÈÖçÁΩÆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Âç≥Â∞ÜÂà∞Êù•ÁöÑ‰∫ã‰ª∂ -->
                        <div class="upcoming-events">
                            <div class="upcoming-header">Âç≥Â∞ÜÂà∞Êù•</div>
                            <div id="upcoming-list">
                                <div class="no-events-hint">ÊöÇÊó†Êó•Á®ã</div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ªÊó•ÂéÜÂå∫Âüü -->
                    <div class="calendar-main">
                        <div class="calendar-header">
                            <div class="calendar-title" id="calendar-date-title">2026Âπ¥1Êúà1Êó• Âë®‰∏â</div>
                            <div class="calendar-actions">
                                <button class="btn-add-event" onclick="showAddEventModal()">
                                    <span>+</span> Ê∑ªÂä†Êó•Á®ã
                                </button>
                            </div>
                        </div>

                        <div class="day-schedule" id="day-schedule">
                            <!-- ÊØèÂ∞èÊó∂Ë°åÁî±JSÁîüÊàê -->
                        </div>
                    </div>
                </div>

                <!-- Ê∑ªÂä†‰∫ã‰ª∂Ê®°ÊÄÅÊ°Ü -->
                <div class="event-modal" id="event-modal">
                    <div class="event-modal-content">
                        <h3 style="margin:0 0 20px 0;">Ê∑ªÂä†Êó•Á®ã</h3>
                        <form id="event-form" onsubmit="saveEvent(event)">
                            <div class="event-form-group">
                                <label>Ê†áÈ¢ò</label>
                                <input type="text" id="event-title" placeholder="‰ºöËÆÆÊ†áÈ¢ò" required>
                            </div>
                            <div class="event-form-row">
                                <div class="event-form-group">
                                    <label>ÂºÄÂßãÊó∂Èó¥</label>
                                    <input type="time" id="event-start" required>
                                </div>
                                <div class="event-form-group">
                                    <label>ÁªìÊùüÊó∂Èó¥</label>
                                    <input type="time" id="event-end" required>
                                </div>
                            </div>
                            <div class="event-form-group">
                                <label>Â§áÊ≥®</label>
                                <textarea id="event-notes" rows="3" placeholder="ÂèØÈÄâÂ§áÊ≥®..."></textarea>
                            </div>
                            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
                                <button type="button" class="btn-secondary" onclick="hideEventModal()">ÂèñÊ∂à</button>
                                <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Êà™ÂõæÁøªËØëÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="screenshot-modal" style="display:none">
        <div class="modal-content screenshot-modal-content">
            <div class="modal-header">
                <h3>Êà™ÂõæÁøªËØë</h3>
                <button class="modal-close" onclick="closeScreenshotModal()">&times;</button>
            </div>
            <div class="screenshot-compare">
                <div class="screenshot-left">
                    <h4>ÂéüÊñáÊà™Âõæ</h4>
                    <div class="screenshot-preview" id="screenshot-preview"></div>
                    <div class="ocr-result">
                        <h4>ËØÜÂà´ÊñáÂ≠ó <small>(ÂèØÁºñËæë)</small></h4>
                        <textarea class="ocr-text" id="ocr-text" placeholder="ËØÜÂà´‰∏≠..."></textarea>
                    </div>
                </div>
                <div class="screenshot-center">
                    <div class="lang-switch" onclick="toggleTranslateDirection()">
                        <span class="lang-from" id="lang-from">‰∏≠Êñá</span>
                        <span class="lang-arrow">‚áÑ</span>
                        <span class="lang-to" id="lang-to">Ëã±Êñá</span>
                    </div>
                    <div class="model-select">
                        <label>Ê®°Âûã</label>
                        <select id="translate-model" onchange="onTranslateModelChange()">
                            <option value="deepseek">ÂÖçË¥πOCR + DeepSeek</option>
                            <option value="doubao">Ë±ÜÂåÖËßÜËßâ(Áõ¥Êé•ÁøªËØë)</option>
                        </select>
                    </div>
                    <button class="btn-translate" id="btn-translate" onclick="translateOcrText()">ÁøªËØë</button>
                </div>
                <div class="screenshot-right">
                    <div class="translation-header">
                        <h4>ÁøªËØëÁªìÊûú</h4>
                    </div>
                    <textarea id="screenshot-translation" placeholder="ÁÇπÂáª"ÁøªËØë"ÊåâÈíÆËé∑ÂèñÁøªËØëÁªìÊûú"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeScreenshotModal()">ÂèñÊ∂à</button>
                <button class="btn-primary" onclick="saveScreenshotTranslation()">‰øùÂ≠òÂà∞ËØëÊñá</button>
            </div>
        </div>
    </div>

    <!-- Âà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <h3>Á°ÆËÆ§Âà†Èô§</h3>
            <p id="delete-modal-message">Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ</p>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeDeleteModal()">ÂèñÊ∂à</button>
                <button class="btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">Âà†Èô§</button>
            </div>
        </div>
    </div>

    <!-- ÁøªËØëËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="translator-settings-modal" style="display:none">
        <div class="modal-content settings-modal-content">
            <div class="modal-header">
                <h3>ÁøªËØëËÆæÁΩÆ</h3>
                <button class="modal-close" onclick="closeTranslatorSettings()">&times;</button>
            </div>
            <div class="settings-form">
                <div class="settings-section">
                    <h4>DeepSeek ÈÖçÁΩÆ</h4>
                    <div class="setting-group">
                        <label for="deepseek-key">API Key</label>
                        <div class="api-key-wrapper">
                            <input type="password" id="deepseek-key" placeholder="sk-...">
                            <button class="btn-toggle-key" onclick="toggleKeyVisibility('deepseek-key')" title="ÊòæÁ§∫/ÈöêËóè">üëÅÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Ë±ÜÂåÖ (ÁÅ´Â±±ÂºïÊìé) ÈÖçÁΩÆ</h4>
                    <div class="setting-group">
                        <label for="doubao-key">API Key</label>
                        <div class="api-key-wrapper">
                            <input type="password" id="doubao-key" placeholder="ÁÅ´Â±±ÂºïÊìé API Key">
                            <button class="btn-toggle-key" onclick="toggleKeyVisibility('doubao-key')" title="ÊòæÁ§∫/ÈöêËóè">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label for="doubao-endpoint">Êé•ÂÖ•ÁÇπ ID (Endpoint ID)</label>
                        <input type="text" id="doubao-endpoint" placeholder="ep-2024xxxxxxxxxx-xxxxx">
                        <small class="setting-hint">Âú®ÁÅ´Â±±ÂºïÊìéÊéßÂà∂Âè∞ ‚Üí Ê®°ÂûãÊé®ÁêÜ ‚Üí Êé•ÂÖ•ÁÇπÁÆ°ÁêÜ ‰∏≠Ëé∑Âèñ</small>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeTranslatorSettings()">ÂèñÊ∂à</button>
                <button class="btn-primary" onclick="saveTranslatorSettings()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============ Â∑•ÂÖ∑ÂàáÊç¢ ============
        let currentTool = 'bubble';

        function switchTool(tool) {
            currentTool = tool;

            // Êõ¥Êñ∞ÂØºËà™Ê†∑Âºè
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tool === tool);
            });

            // ÂàáÊç¢Èù¢Êùø
            document.querySelectorAll('.tool-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            document.getElementById('tool-' + tool).style.display = 'block';

            // ÂàùÂßãÂåñÂØπÂ∫îÂ∑•ÂÖ∑
            if (tool === 'bubble') {
                loadBubbles();
            } else if (tool === 'expense') {
                loadExpenses();
            } else if (tool === 'ppt') {
                loadPPTs();
            } else if (tool === 'ppt-translator') {
                // PPTÁøªËØëÂ∑•ÂÖ∑ÂàùÂßãÂåñÂú® initPPTTranslator ‰∏≠ÂÆåÊàê
            } else if (tool === 'harmonyos-lab') {
                initHarmonyOSLab();
            }
        }

        // ============ Toast ÈÄöÁü• ============
        function showToast(message, type = 'success') {
            AppUtils.showToast(message, type);
        }

        // ============ Ê∞îÊ≥°ÂõæÂäüËÉΩ ============
        let bubbleChart = null;
        let currentBubbleId = null;
        let bubbleData = [];

        const defaultColors = [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)'
        ];

        // Ëá™ÂÆö‰πâÊèí‰ª∂ÔºöÂú®Ê∞îÊ≥°‰∏äÊòæÁ§∫ÊñáÂ≠óÊ†áÁ≠æÔºàÊô∫ËÉΩÈÅøËÆ©ÁÆóÊ≥ïÔºâ
        const bubbleLabelPlugin = {
            id: 'bubbleLabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                ctx.save();
                ctx.font = 'bold 11px Arial';

                const chartArea = chart.chartArea;
                const placedLabels = []; // Â∑≤ÊîæÁΩÆÁöÑÊ†áÁ≠æËæπÁïåÊ°Ü

                // Êî∂ÈõÜÊâÄÊúâÊ∞îÊ≥°‰ø°ÊÅØ
                const bubbles = [];
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    if (!meta.hidden && bubbleData[datasetIndex]) {
                        const element = meta.data[0];
                        bubbles.push({
                            x: element.x,
                            y: element.y,
                            r: element.options.radius || 10,
                            name: bubbleData[datasetIndex].name,
                            dataX: bubbleData[datasetIndex].x,
                            dataY: bubbleData[datasetIndex].y,
                            index: datasetIndex
                        });
                    }
                });

                // ÊåâÊ∞îÊ≥°Â§ßÂ∞èÊéíÂ∫èÔºåÂ§ßÁöÑ‰ºòÂÖàÊîæÁΩÆÊ†áÁ≠æ
                bubbles.sort((a, b) => b.r - a.r);

                // 8‰∏™ÂèØÈÄâÊñπÂêë
                const directions = [
                    { name: 'right', dx: 1, dy: 0, alignX: 'left' },
                    { name: 'left', dx: -1, dy: 0, alignX: 'right' },
                    { name: 'top', dx: 0, dy: -1, alignX: 'center' },
                    { name: 'bottom', dx: 0, dy: 1, alignX: 'center' },
                    { name: 'top-right', dx: 0.7, dy: -0.7, alignX: 'left' },
                    { name: 'top-left', dx: -0.7, dy: -0.7, alignX: 'right' },
                    { name: 'bottom-right', dx: 0.7, dy: 0.7, alignX: 'left' },
                    { name: 'bottom-left', dx: -0.7, dy: 0.7, alignX: 'right' }
                ];

                // Ê†πÊçÆÊ∞îÊ≥°‰ΩçÁΩÆËé∑ÂèñÈ¶ñÈÄâÊñπÂêë
                function getPreferredDirections(bubble) {
                    const relX = (bubble.x - chartArea.left) / (chartArea.right - chartArea.left);
                    const relY = (bubble.y - chartArea.top) / (chartArea.bottom - chartArea.top);

                    let preferred = [];

                    // Ê†πÊçÆ‰ΩçÁΩÆÈÄâÊã©È¶ñÈÄâÊñπÂêë
                    if (relX > 0.7) {
                        // Ê∞îÊ≥°Âú®Âè≥‰æßÔºåÊ†áÁ≠æÊîæÂ∑¶Ëæπ
                        preferred.push(directions[1], directions[5], directions[7]); // left, top-left, bottom-left
                    } else if (relX < 0.3) {
                        // Ê∞îÊ≥°Âú®Â∑¶‰æßÔºåÊ†áÁ≠æÊîæÂè≥Ëæπ
                        preferred.push(directions[0], directions[4], directions[6]); // right, top-right, bottom-right
                    }

                    if (relY > 0.7) {
                        // Ê∞îÊ≥°Âú®‰∏ãÊñπÔºåÊ†áÁ≠æÊîæ‰∏äËæπ
                        preferred.push(directions[2], directions[4], directions[5]); // top, top-right, top-left
                    } else if (relY < 0.3) {
                        // Ê∞îÊ≥°Âú®‰∏äÊñπÔºåÊ†áÁ≠æÊîæ‰∏ãËæπ
                        preferred.push(directions[3], directions[6], directions[7]); // bottom, bottom-right, bottom-left
                    }

                    // Ê∑ªÂä†Ââ©‰ΩôÊñπÂêë‰Ωú‰∏∫Â§áÈÄâ
                    directions.forEach(dir => {
                        if (!preferred.includes(dir)) preferred.push(dir);
                    });

                    return preferred;
                }

                // ËÆ°ÁÆóÊ†áÁ≠æËæπÁïåÊ°Ü
                function getLabelBounds(x, y, width, height, dir) {
                    let left, right, top, bottom;

                    if (dir.alignX === 'left') {
                        left = x;
                        right = x + width;
                    } else if (dir.alignX === 'right') {
                        left = x - width;
                        right = x;
                    } else {
                        left = x - width / 2;
                        right = x + width / 2;
                    }

                    if (dir.name.includes('top')) {
                        bottom = y;
                        top = y - height;
                    } else if (dir.name.includes('bottom')) {
                        top = y;
                        bottom = y + height;
                    } else {
                        top = y - height / 2;
                        bottom = y + height / 2;
                    }

                    return { left, right, top, bottom, width, height };
                }

                // Ê£ÄÊü•ÊòØÂê¶‰∏éÊ∞îÊ≥°ÈáçÂè†
                function overlapsWithBubbles(labelX, labelY, width, height, currentBubble) {
                    for (const b of bubbles) {
                        if (b.index === currentBubble.index) continue;
                        const dist = Math.sqrt(Math.pow(labelX - b.x, 2) + Math.pow(labelY - b.y, 2));
                        if (dist < b.r + 8) return true;
                    }
                    return false;
                }

                // Ê£ÄÊü•ÊòØÂê¶‰∏éÂ∑≤ÊîæÁΩÆÊ†áÁ≠æÈáçÂè†
                function overlapsWithLabels(bounds) {
                    for (const placed of placedLabels) {
                        if (!(bounds.right < placed.left - 2 || bounds.left > placed.right + 2 ||
                              bounds.bottom < placed.top - 2 || bounds.top > placed.bottom + 2)) {
                            return true;
                        }
                    }
                    return false;
                }

                // ‰∏∫ÊØè‰∏™Ê∞îÊ≥°ËÆ°ÁÆóÊúÄ‰Ω≥Ê†áÁ≠æ‰ΩçÁΩÆ
                bubbles.forEach(bubble => {
                    const textWidth = ctx.measureText(bubble.name).width;
                    const textHeight = 12;
                    const offset = bubble.r + 6;

                    const preferredDirs = getPreferredDirections(bubble);
                    let bestPos = null;
                    let bestDir = null;

                    for (const dir of preferredDirs) {
                        const labelX = bubble.x + dir.dx * offset;
                        const labelY = bubble.y + dir.dy * offset;
                        const bounds = getLabelBounds(labelX, labelY, textWidth, textHeight, dir);

                        // ËæπÁïåÊ£ÄÊü•
                        if (bounds.left < chartArea.left - 5 || bounds.right > chartArea.right + 5 ||
                            bounds.top < chartArea.top - 5 || bounds.bottom > chartArea.bottom + 5) {
                            continue;
                        }

                        // Ê£ÄÊü•‰∏éÊ∞îÊ≥°ÈáçÂè†
                        if (overlapsWithBubbles(labelX, labelY, textWidth, textHeight, bubble)) {
                            continue;
                        }

                        // Ê£ÄÊü•‰∏éÂ∑≤ÊîæÁΩÆÊ†áÁ≠æÈáçÂè†
                        if (overlapsWithLabels(bounds)) {
                            continue;
                        }

                        // ÊâæÂà∞ÂêàÈÄÇ‰ΩçÁΩÆ
                        bestPos = { x: labelX, y: labelY, bounds };
                        bestDir = dir;
                        break;
                    }

                    // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÂÆåÁæé‰ΩçÁΩÆÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™È¶ñÈÄâÊñπÂêë
                    if (!bestPos) {
                        const dir = preferredDirs[0];
                        const labelX = bubble.x + dir.dx * offset;
                        const labelY = bubble.y + dir.dy * offset;
                        bestPos = {
                            x: labelX,
                            y: labelY,
                            bounds: getLabelBounds(labelX, labelY, textWidth, textHeight, dir)
                        };
                        bestDir = dir;
                    }

                    // ËÆ∞ÂΩïÊ†áÁ≠æ‰ΩçÁΩÆ
                    placedLabels.push(bestPos.bounds);

                    // ËÆ°ÁÆóÁªòÂà∂ÂùêÊ†á
                    let drawX = bestPos.x;
                    let drawY = bestPos.y;

                    if (bestDir.alignX === 'center') {
                        drawX -= textWidth / 2;
                    } else if (bestDir.alignX === 'right') {
                        drawX -= textWidth;
                    }

                    if (bestDir.name.includes('top')) {
                        drawY -= 2;
                    } else if (bestDir.name.includes('bottom')) {
                        drawY += textHeight;
                    } else {
                        drawY += textHeight / 2 - 2;
                    }

                    // ÁªòÂà∂ÊñáÂ≠óÔºàÊó†ËæπÊ°ÜÔºåÁ∫ØÊñáÂ≠óÔºâ
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(bubble.name, drawX, drawY);
                });

                ctx.restore();
            }
        };

        function initBubbleChart() {
            const ctx = document.getElementById('bubble-chart').getContext('2d');
            bubbleChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'ÊäïÂÖ•ÊàêÊú¨' },
                            min: 0, max: 100
                        },
                        y: {
                            title: { display: true, text: 'ÊÅ¢Â§çÊïàÊûú' },
                            min: 0, max: 100
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const data = bubbleData[context.datasetIndex];
                                    return data ? `${data.name}: (${data.x}, ${data.y}) Â§ßÂ∞è:${data.r}` : '';
                                }
                            }
                        }
                    }
                },
                plugins: [bubbleLabelPlugin]
            });
            addRow();
        }

        function addRow(data = null) {
            const tbody = document.getElementById('data-body');
            const row = document.createElement('tr');
            const colorIndex = tbody.children.length % defaultColors.length;

            row.innerHTML = `
                <td><input type="text" class="input-name" value="${data?.name || ''}" onchange="updateChart()"></td>
                <td><input type="number" class="input-x" value="${data?.x || 50}" min="0" max="100" onchange="updateChart()"></td>
                <td><input type="number" class="input-y" value="${data?.y || 50}" min="0" max="100" onchange="updateChart()"></td>
                <td><input type="number" class="input-r" value="${data?.r || 20}" min="5" max="50" onchange="updateChart()"></td>
                <td><input type="color" class="input-color" value="${data?.color || rgbaToHex(defaultColors[colorIndex])}" onchange="updateChart()"></td>
                <td><button class="btn-delete-row" onclick="deleteRow(this)">√ó</button></td>
            `;
            tbody.appendChild(row);
            updateChart();
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            updateChart();
        }

        function rgbaToHex(rgba) {
            const match = rgba.match(/\d+/g);
            if (match) {
                return '#' + match.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
            }
            return '#3498db';
        }

        function hexToRgba(hex, alpha = 0.7) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function updateChart() {
            bubbleData = [];
            const rows = document.querySelectorAll('#data-body tr');

            rows.forEach(row => {
                const name = row.querySelector('.input-name').value || 'Êú™ÂëΩÂêç';
                const x = parseFloat(row.querySelector('.input-x').value) || 0;
                const y = parseFloat(row.querySelector('.input-y').value) || 0;
                const r = parseFloat(row.querySelector('.input-r').value) || 10;
                const color = row.querySelector('.input-color').value;

                bubbleData.push({ name, x, y, r, color: hexToRgba(color) });
            });

            const datasets = bubbleData.map((item, i) => ({
                label: item.name,
                data: [{ x: item.x, y: item.y, r: item.r }],
                backgroundColor: item.color,
                borderColor: item.color.replace('0.7', '1')
            }));

            bubbleChart.data.datasets = datasets;
            bubbleChart.options.scales.x.title.text = document.getElementById('x-axis-label').value;
            bubbleChart.options.scales.y.title.text = document.getElementById('y-axis-label').value;
            bubbleChart.update();
        }

        function clearAll() {
            document.getElementById('data-body').innerHTML = '';
            addRow();
        }

        function loadExample() {
            const examples = [
                { name: 'Áù°Áú†', x: 10, y: 95, r: 30 },
                { name: 'ÂÜ•ÊÉ≥', x: 20, y: 85, r: 25 },
                { name: 'ËøêÂä®', x: 40, y: 80, r: 28 },
                { name: 'ÈòÖËØª', x: 30, y: 70, r: 22 },
                { name: 'Ê∏∏Êàè', x: 60, y: 50, r: 35 }
            ];
            document.getElementById('data-body').innerHTML = '';
            examples.forEach((item, i) => {
                item.color = rgbaToHex(defaultColors[i % defaultColors.length]);
                addRow(item);
            });
        }

        async function loadBubbles() {
            try {
                const res = await fetch('/api/bubbles');
                const data = await res.json();
                renderBubbleList(data.bubbles || []);
            } catch (e) {
                console.error('Load bubbles error:', e);
            }
        }

        function renderBubbleList(bubbles) {
            const list = document.getElementById('saved-list');
            if (bubbles.length === 0) {
                list.innerHTML = '<div class="empty-list">ÊöÇÊó†‰øùÂ≠òÁöÑÂõæË°®</div>';
                return;
            }

            list.innerHTML = bubbles.map(b => `
                <div class="saved-item ${b.id === currentBubbleId ? 'active' : ''}" onclick="loadBubble('${b.id}')">
                    <div class="item-title">${b.title}</div>
                    <div class="item-date">${formatDate(b.updated_at)}</div>
                </div>
            `).join('');
        }

        async function loadBubble(id) {
            try {
                const res = await fetch(`/api/bubbles/${id}`);
                const data = await res.json();
                if (data.success) {
                    const b = data.bubble;
                    currentBubbleId = b.id;
                    document.getElementById('chart-title').value = b.title;
                    document.getElementById('chart-desc').value = b.description || '';
                    document.getElementById('x-axis-label').value = b.x_label;
                    document.getElementById('y-axis-label').value = b.y_label;
                    document.getElementById('btn-duplicate').style.display = '';
                    document.getElementById('btn-delete').style.display = '';
                    document.getElementById('chart-info').style.display = '';
                    document.getElementById('chart-created').textContent = 'ÂàõÂª∫: ' + formatDate(b.created_at);
                    document.getElementById('chart-updated').textContent = 'Êõ¥Êñ∞: ' + formatDate(b.updated_at);

                    document.getElementById('data-body').innerHTML = '';
                    (b.data || []).forEach(item => addRow(item));
                    if (b.data.length === 0) addRow();

                    loadBubbles();
                }
            } catch (e) {
                showToast('Âä†ËΩΩÂ§±Ë¥•', 'error');
            }
        }

        function createNew() {
            currentBubbleId = null;
            document.getElementById('chart-title').value = 'Êú™ÂëΩÂêçÂõæË°®';
            document.getElementById('chart-desc').value = '';
            document.getElementById('x-axis-label').value = 'ÊäïÂÖ•ÊàêÊú¨';
            document.getElementById('y-axis-label').value = 'ÊÅ¢Â§çÊïàÊûú';
            document.getElementById('btn-duplicate').style.display = 'none';
            document.getElementById('btn-delete').style.display = 'none';
            document.getElementById('chart-info').style.display = 'none';
            clearAll();
            document.querySelectorAll('.saved-item').forEach(i => i.classList.remove('active'));
        }

        async function saveChart() {
            const chartData = {
                title: document.getElementById('chart-title').value || 'Êú™ÂëΩÂêçÂõæË°®',
                description: document.getElementById('chart-desc').value,
                x_label: document.getElementById('x-axis-label').value,
                y_label: document.getElementById('y-axis-label').value,
                data: bubbleData.map(d => ({ ...d, color: d.color }))
            };

            try {
                const url = currentBubbleId ? `/api/bubbles/${currentBubbleId}` : '/api/bubbles';
                const method = currentBubbleId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chartData)
                });
                const data = await res.json();
                if (data.success) {
                    currentBubbleId = data.bubble.id;
                    showToast('‰øùÂ≠òÊàêÂäü');
                    loadBubbles();
                    document.getElementById('btn-duplicate').style.display = '';
                    document.getElementById('btn-delete').style.display = '';
                }
            } catch (e) {
                showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        async function deleteChart() {
            if (!currentBubbleId) return;
            window.AppUtils.showConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂõæË°®ÂêóÔºü', async function() {
                try {
                    await fetch(`/api/bubbles/${currentBubbleId}`, { method: 'DELETE' });
                    showToast('Â∑≤Âà†Èô§');
                    createNew();
                    loadBubbles();
                } catch (e) {
                    showToast('Âà†Èô§Â§±Ë¥•', 'error');
                }
            }, { confirmText: 'Âà†Èô§', danger: true });
        }

        async function duplicateChart() {
            if (!currentBubbleId) return;
            try {
                const res = await fetch(`/api/bubbles/${currentBubbleId}/duplicate`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('Â∑≤Â§çÂà∂');
                    loadBubble(data.bubble.id);
                }
            } catch (e) {
                showToast('Â§çÂà∂Â§±Ë¥•', 'error');
            }
        }

        function downloadChart() {
            const link = document.createElement('a');
            link.download = (document.getElementById('chart-title').value || 'bubble-chart') + '.png';
            link.href = document.getElementById('bubble-chart').toDataURL();
            link.click();
        }

        function toggleScoring() {
            const content = document.getElementById('scoring-content');
            const icon = document.getElementById('scoring-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function addDimension(axis) {
            const container = document.getElementById(axis + '-dimensions');
            const div = document.createElement('div');
            div.className = 'dimension-item';
            div.innerHTML = `
                <input type="text" placeholder="Áª¥Â∫¶ÂêçÁß∞">
                <input type="number" placeholder="Êª°ÂàÜ" value="10" min="0">
                <button class="btn-delete-small" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }

        // ============ Êä•ÈîÄÂ∞èËÉΩÊâãÂäüËÉΩ ============
        let currentExpenseId = null;
        let expenses = [];
        let commonLocations = [];
        let expenseCategories = {};
        let expenseTemplates = {};
        let deleteTarget = null;

        async function loadExpenses() {
            try {
                const res = await fetch('/api/expenses');
                const data = await res.json();
                expenses = data.expenses || [];
                commonLocations = data.common_locations || [];
                expenseCategories = data.categories || {};
                expenseTemplates = data.templates || {};
                renderExpenseList();
                renderLocationSuggestions();
                // ÂàùÂßãÂåñÊãñÊãΩÂå∫Âüü
                initDropZone();
            } catch (e) {
                console.error('Load expenses error:', e);
            }
        }

        function renderExpenseList() {
            const list = document.getElementById('expense-list');
            if (expenses.length === 0) {
                list.innerHTML = '<div class="empty-list">ÊöÇÊó†Êä•ÈîÄ‰∫ãÈ°π</div>';
                return;
            }

            list.innerHTML = expenses.map(e => `
                <div class="expense-item ${e.id === currentExpenseId ? 'active' : ''}" onclick="loadExpenseItem('${e.id}')">
                    <div class="expense-item-header">
                        <span class="expense-item-event">${e.event || 'Êú™ÂëΩÂêç'}</span>
                        <span class="expense-item-files">${(e.files || []).length} Êñá‰ª∂</span>
                    </div>
                    <div class="expense-item-info">
                        <span class="expense-item-location">${e.location || '-'}</span>
                        <span class="expense-item-date">${e.start_date || ''} ~ ${e.end_date || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderLocationSuggestions() {
            const container = document.getElementById('location-suggestions');
            container.innerHTML = commonLocations.map(loc =>
                `<div class="location-chip" onclick="selectLocation('${loc}')">${loc}</div>`
            ).join('');
        }

        function selectLocation(loc) {
            document.getElementById('expense-location').value = loc;
        }

        async function loadExpenseItem(id) {
            currentExpenseId = id;
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('expense-empty').style.display = 'none';
            document.getElementById('expense-detail').style.display = 'block';

            document.getElementById('expense-event').value = expense.event || '';
            document.getElementById('expense-start-date').value = expense.start_date || '';
            document.getElementById('expense-end-date').value = expense.end_date || '';
            document.getElementById('expense-location').value = expense.location || '';
            document.getElementById('expense-notes').value = expense.notes || '';

            // Âä†ËΩΩÁ±ªÂà´
            const category = expense.category || 'ÂÖ∂‰ªñË¥πÁî®';
            document.getElementById('expense-category').value = category;
            updateSubCategories(category, expense.sub_categories || []);

            // ÈöêËóèÊä•ÈîÄËØ¥Êòé
            document.getElementById('summary-output').style.display = 'none';

            renderExpenseFiles(expense.files || []);
            renderExpenseList();
        }

        function renderExpenseFiles(files) {
            const list = document.getElementById('file-list');
            document.getElementById('file-count').textContent = files.length + ' ‰∏™Êñá‰ª∂';

            if (files.length === 0) {
                list.innerHTML = '<div class="empty-files">ÊöÇÊó†Êñá‰ª∂ÔºåÊãñÊãΩ‰∏ä‰º†</div>';
                return;
            }

            list.innerHTML = files.map(f => `
                <div class="file-item" draggable="true" data-file-id="${f.id}"
                     ondragstart="startDragFile(event, '${f.id}')"
                     ondragend="endDragFile(event)">
                    <div class="file-icon">${getFileIcon(f.type)}</div>
                    <div class="file-info">
                        <div class="file-name">${f.filename}</div>
                        <div class="file-meta">
                            <span class="file-size">${f.size_readable}</span>
                            <span class="file-category">${f.analysis?.category || ''}</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-file-action" onclick="viewFile('${f.id}')" title="Êü•Áúã">üëÅÔ∏è</button>
                        <button class="btn-file-action btn-delete-file" onclick="prepareDeleteFile('${f.id}')" title="Âà†Èô§">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(type) {
            const icons = {
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'webp': 'üñºÔ∏è',
                'pdf': 'üìÑ', 'doc': 'üìù', 'docx': 'üìù',
                'xls': 'üìä', 'xlsx': 'üìä', 'csv': 'üìä'
            };
            return icons[type] || 'üìé';
        }

        function createExpense() {
            currentExpenseId = null;
            document.getElementById('expense-empty').style.display = 'none';
            document.getElementById('expense-detail').style.display = 'block';
            document.getElementById('expense-event').value = '';
            document.getElementById('expense-start-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-end-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-location').value = '';
            document.getElementById('expense-notes').value = '';
            document.getElementById('expense-category').value = 'ÂÖ∂‰ªñË¥πÁî®';
            updateSubCategories('ÂÖ∂‰ªñË¥πÁî®', []);
            document.getElementById('summary-output').style.display = 'none';
            document.getElementById('file-list').innerHTML = '<div class="empty-files">‰øùÂ≠òÂêéÂèØ‰∏ä‰º†Êñá‰ª∂</div>';
            document.getElementById('file-count').textContent = '0 ‰∏™Êñá‰ª∂';
            document.querySelectorAll('.expense-item').forEach(i => i.classList.remove('active'));
        }

        async function saveExpense() {
            // Êî∂ÈõÜÈÄâ‰∏≠ÁöÑÂ≠êÁ±ªÂà´
            const subCategories = [];
            document.querySelectorAll('#sub-categories input[type="checkbox"]:checked').forEach(cb => {
                subCategories.push(cb.value);
            });

            const expenseData = {
                event: document.getElementById('expense-event').value,
                location: document.getElementById('expense-location').value,
                start_date: document.getElementById('expense-start-date').value,
                end_date: document.getElementById('expense-end-date').value,
                notes: document.getElementById('expense-notes').value,
                category: document.getElementById('expense-category').value,
                sub_categories: subCategories
            };

            try {
                const url = currentExpenseId ? `/api/expenses/${currentExpenseId}` : '/api/expenses';
                const method = currentExpenseId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });
                const data = await res.json();
                if (data.success) {
                    currentExpenseId = data.expense.id;
                    showToast('‰øùÂ≠òÊàêÂäü');
                    loadExpenses();
                    loadExpenseItem(currentExpenseId);
                }
            } catch (e) {
                showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        async function deleteExpense() {
            if (!currentExpenseId) return;
            window.AppUtils.showConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êä•ÈîÄ‰∫ãÈ°πÂèäÂÖ∂ÊâÄÊúâÊñá‰ª∂ÂêóÔºü', async function() {
                try {
                    await fetch(`/api/expenses/${currentExpenseId}`, { method: 'DELETE' });
                    showToast('Â∑≤Âà†Èô§');
                    currentExpenseId = null;
                    document.getElementById('expense-empty').style.display = 'block';
                    document.getElementById('expense-detail').style.display = 'none';
                    loadExpenses();
                } catch (e) {
                    showToast('Âà†Èô§Â§±Ë¥•', 'error');
                }
            }, { confirmText: 'Âà†Èô§', danger: true });
        }

        // ============ Êä•ÈîÄÁ±ªÂà´ÂíåÊ®°ÊùøÂäüËÉΩ ============

        // Êõ¥Êñ∞Â≠êÁ±ªÂà´Â§çÈÄâÊ°Ü
        function updateSubCategories(category, selectedSubs = []) {
            const container = document.getElementById('sub-categories');
            const catInfo = expenseCategories[category];
            if (!catInfo) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = catInfo.sub_categories.map(sub => {
                const checked = selectedSubs.includes(sub) ? 'checked' : '';
                const checkedClass = selectedSubs.includes(sub) ? 'checked' : '';
                return `<label class="sub-category-checkbox ${checkedClass}">
                    <input type="checkbox" value="${sub}" ${checked} onchange="toggleSubCategory(this)">
                    ${sub}
                </label>`;
            }).join('');
        }

        // ÂàáÊç¢Â≠êÁ±ªÂà´ÈÄâ‰∏≠Áä∂ÊÄÅ
        function toggleSubCategory(checkbox) {
            const label = checkbox.parentElement;
            if (checkbox.checked) {
                label.classList.add('checked');
            } else {
                label.classList.remove('checked');
            }
        }

        // Á±ªÂà´ÂèòÂåñÊó∂Êõ¥Êñ∞Â≠êÁ±ªÂà´
        function onCategoryChange() {
            const category = document.getElementById('expense-category').value;
            updateSubCategories(category, []);
        }

        // ‰∫ã‰ª∂ÂêçÁß∞ÂèòÂåñÊó∂Êô∫ËÉΩÊé®ËçêÁ±ªÂà´
        async function onEventNameChange() {
            const event = document.getElementById('expense-event').value;
            const location = document.getElementById('expense-location').value;

            if (event.length < 2) return;

            try {
                const res = await fetch('/api/expenses/guess-category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event, location })
                });
                const data = await res.json();
                if (data.success && data.category) {
                    const categorySelect = document.getElementById('expense-category');
                    if (categorySelect.value === 'ÂÖ∂‰ªñË¥πÁî®') {
                        categorySelect.value = data.category;
                        onCategoryChange();
                    }
                }
            } catch (e) {
                console.error('Guess category error:', e);
            }
        }

        // Â∫îÁî®Ê®°Êùø
        function applyTemplate(templateName) {
            const template = expenseTemplates[templateName];
            if (!template) return;

            document.getElementById('expense-event').value = template.event_prefix;
            document.getElementById('expense-category').value = template.category;
            document.getElementById('expense-notes').value = template.notes_template;
            updateSubCategories(template.category, template.sub_categories);

            showToast(`Â∑≤Â∫îÁî®„Äå${templateName}„ÄçÊ®°Êùø`);
        }

        // ÁîüÊàêÊä•ÈîÄËØ¥Êòé
        async function generateSummary() {
            if (!currentExpenseId) {
                showToast('ËØ∑ÂÖà‰øùÂ≠òÊä•ÈîÄ‰∫ãÈ°π', 'error');
                return;
            }

            try {
                const res = await fetch(`/api/expenses/${currentExpenseId}/summary`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('summary-text').textContent = data.summary;
                    document.getElementById('summary-output').style.display = 'block';
                    showToast('Êä•ÈîÄËØ¥ÊòéÂ∑≤ÁîüÊàê');
                }
            } catch (e) {
                showToast('ÁîüÊàêÂ§±Ë¥•', 'error');
            }
        }

        // Â§çÂà∂Êä•ÈîÄËØ¥Êòé
        function copySummary() {
            const text = document.getElementById('summary-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            });
        }

        // Êñá‰ª∂ÊãñÊãΩ‰∏ä‰º† - ÂàùÂßãÂåñÂáΩÊï∞
        let dropZoneInitialized = false;
        function initDropZone() {
            if (dropZoneInitialized) return;

            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('file-input');

            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', () => handleFiles(fileInput.files));

            dropZoneInitialized = true;
            console.log('Drop zone initialized');
        }

        async function handleFiles(files) {
            if (!currentExpenseId) {
                showToast('ËØ∑ÂÖà‰øùÂ≠òÊä•ÈîÄ‰∫ãÈ°π', 'error');
                return;
            }

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch(`/api/expenses/${currentExpenseId}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`${file.name} ‰∏ä‰º†ÊàêÂäü`);
                    } else {
                        showToast(`${file.name} ‰∏ä‰º†Â§±Ë¥•: ${data.error}`, 'error');
                    }
                } catch (e) {
                    showToast(`${file.name} ‰∏ä‰º†Â§±Ë¥•`, 'error');
                }
            }
            loadExpenses();
            loadExpenseItem(currentExpenseId);
        }

        // Êñá‰ª∂ÊãñÊãΩÂà†Èô§
        function startDragFile(e, fileId) {
            e.dataTransfer.setData('text/plain', fileId);
            document.getElementById('trash-zone').classList.add('show');
        }

        function endDragFile(e) {
            document.getElementById('trash-zone').classList.remove('show');
        }

        const trashZone = document.getElementById('trash-zone');
        trashZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            trashZone.classList.add('drag-over');
        });

        trashZone?.addEventListener('dragleave', () => {
            trashZone.classList.remove('drag-over');
        });

        trashZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            const fileId = e.dataTransfer.getData('text/plain');
            trashZone.classList.remove('drag-over', 'show');
            prepareDeleteFile(fileId);
        });

        function prepareDeleteFile(fileId) {
            deleteTarget = { type: 'file', id: fileId };
            document.getElementById('delete-modal-message').textContent = 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ';
            document.getElementById('delete-modal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('show');
            deleteTarget = null;
        }

        async function confirmDelete() {
            if (!deleteTarget) return;

            if (deleteTarget.type === 'file') {
                try {
                    await fetch(`/api/expenses/${currentExpenseId}/files/${deleteTarget.id}`, { method: 'DELETE' });
                    showToast('Êñá‰ª∂Â∑≤Âà†Èô§');
                    loadExpenses();
                    loadExpenseItem(currentExpenseId);
                } catch (e) {
                    showToast('Âà†Èô§Â§±Ë¥•', 'error');
                }
            }
            closeDeleteModal();
        }

        function viewFile(fileId) {
            window.open(`/api/expenses/${currentExpenseId}/file/${fileId}/view`, '_blank');
        }

        // ============ PPT ÁîüÊàêÂô®ÂäüËÉΩ ============
        let currentPPTId = null;
        let currentTemplate = 'dark-statement';
        let ppts = [];

        async function loadPPTs() {
            try {
                const res = await fetch('/api/ppt');
                const data = await res.json();
                ppts = data.ppts || [];
                renderPPTList();
            } catch (e) {
                console.error('Load PPTs error:', e);
            }
        }

        function renderPPTList() {
            const list = document.getElementById('ppt-list');
            if (ppts.length === 0) {
                list.innerHTML = '<div class="empty-list">ÊöÇÊó† PPTÔºåÁÇπÂáªÊñ∞Âª∫</div>';
                return;
            }

            list.innerHTML = ppts.map(p => `
                <div class="ppt-item ${p.id === currentPPTId ? 'active' : ''}" onclick="loadPPTItem('${p.id}')">
                    <div class="ppt-item-title">${p.title}</div>
                    <div class="ppt-item-meta">
                        <span>${p.template || 'dark-statement'}</span>
                        <span>${formatDate(p.updated_at)}</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadPPTItem(id) {
            try {
                const res = await fetch(`/api/ppt/${id}`);
                const data = await res.json();
                if (data.success) {
                    const ppt = data.ppt;
                    currentPPTId = ppt.id;

                    document.getElementById('ppt-empty').style.display = 'none';
                    document.getElementById('ppt-detail').style.display = 'flex';
                    document.getElementById('btn-delete-ppt').style.display = '';

                    document.getElementById('ppt-title').value = ppt.title || '';
                    document.getElementById('ppt-main-title').value = ppt.main_title || '';
                    document.getElementById('ppt-subtitle').value = ppt.subtitle || '';
                    document.getElementById('ppt-footer').value = ppt.footer || '';

                    // Set template
                    selectTemplate(ppt.template || 'dark-statement');

                    // Render content blocks
                    const blocksContainer = document.getElementById('content-blocks');
                    blocksContainer.innerHTML = '';
                    (ppt.content_blocks || []).forEach(block => {
                        addContentBlock(block);
                    });

                    renderPPTList();
                    updatePPTPreview();
                }
            } catch (e) {
                showToast('Âä†ËΩΩÂ§±Ë¥•', 'error');
            }
        }

        function createPPT() {
            currentPPTId = null;
            document.getElementById('ppt-empty').style.display = 'none';
            document.getElementById('ppt-detail').style.display = 'flex';
            document.getElementById('btn-delete-ppt').style.display = 'none';

            document.getElementById('ppt-title').value = 'Êú™ÂëΩÂêç PPT';
            document.getElementById('ppt-main-title').value = '';
            document.getElementById('ppt-subtitle').value = '';
            document.getElementById('ppt-footer').value = '';

            selectTemplate('dark-statement');
            document.getElementById('content-blocks').innerHTML = '';
            addContentBlock();

            document.querySelectorAll('.ppt-item').forEach(i => i.classList.remove('active'));
            updatePPTPreview();
        }

        function selectTemplate(template) {
            currentTemplate = template;
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.template === template);
            });
            updatePPTPreview();
        }

        function addContentBlock(data = null) {
            const container = document.getElementById('content-blocks');
            const block = document.createElement('div');
            block.className = 'content-block';
            block.innerHTML = `
                <button class="btn-remove-block" onclick="this.parentElement.remove(); updatePPTPreview();">√ó</button>
                <div class="content-block-header">
                    <input type="text" class="block-title" placeholder="Ê†áÈ¢ò..." value="${data?.title || ''}" onchange="updatePPTPreview()">
                    <select class="block-type" onchange="updatePPTPreview()">
                        <option value="text" ${data?.type === 'text' ? 'selected' : ''}>ÊñáÊú¨</option>
                        <option value="highlight" ${data?.type === 'highlight' ? 'selected' : ''}>È´ò‰∫ÆÊ°Ü</option>
                        <option value="list" ${data?.type === 'list' ? 'selected' : ''}>ÂàóË°®</option>
                    </select>
                </div>
                <textarea class="block-content" placeholder="ÂÜÖÂÆπÔºàÂàóË°®Á±ªÂûãÊØèË°å‰∏ÄÈ°πÔºâ..." onchange="updatePPTPreview()">${data?.content || ''}</textarea>
            `;
            container.appendChild(block);
        }

        function getContentBlocks() {
            const blocks = [];
            document.querySelectorAll('.content-block').forEach(block => {
                blocks.push({
                    title: block.querySelector('.block-title').value,
                    type: block.querySelector('.block-type').value,
                    content: block.querySelector('.block-content').value
                });
            });
            return blocks;
        }

        async function savePPT() {
            const pptData = {
                title: document.getElementById('ppt-title').value || 'Êú™ÂëΩÂêç PPT',
                template: currentTemplate,
                main_title: document.getElementById('ppt-main-title').value,
                subtitle: document.getElementById('ppt-subtitle').value,
                content_blocks: getContentBlocks(),
                footer: document.getElementById('ppt-footer').value
            };

            try {
                const url = currentPPTId ? `/api/ppt/${currentPPTId}` : '/api/ppt';
                const method = currentPPTId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pptData)
                });
                const data = await res.json();
                if (data.success) {
                    currentPPTId = data.ppt.id;
                    showToast('‰øùÂ≠òÊàêÂäü');
                    loadPPTs();
                    document.getElementById('btn-delete-ppt').style.display = '';
                }
            } catch (e) {
                showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        async function deletePPT() {
            if (!currentPPTId) return;
            window.AppUtils.showConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ PPT ÂêóÔºü', async function() {
                try {
                    await fetch(`/api/ppt/${currentPPTId}`, { method: 'DELETE' });
                    showToast('Â∑≤Âà†Èô§');
                    currentPPTId = null;
                    document.getElementById('ppt-empty').style.display = 'flex';
                    document.getElementById('ppt-detail').style.display = 'none';
                    loadPPTs();
                } catch (e) {
                    showToast('Âà†Èô§Â§±Ë¥•', 'error');
                }
            }, { confirmText: 'Âà†Èô§', danger: true });
        }

        function updatePPTPreview() {
            const mainTitle = document.getElementById('ppt-main-title').value || '‰∏ªÊ†áÈ¢ò';
            const subtitle = document.getElementById('ppt-subtitle').value;
            const footer = document.getElementById('ppt-footer').value;
            const blocks = getContentBlocks();

            let blocksHtml = '';
            blocks.forEach(block => {
                if (block.type === 'highlight') {
                    blocksHtml += `<div style="background:rgba(233,69,96,0.15);border-left:4px solid #e94560;padding:15px;border-radius:0 8px 8px 0;margin:10px 0;">
                        <div style="color:#e94560;font-size:12px;font-weight:600;margin-bottom:4px;">${block.title}</div>
                        <div style="color:#fff;font-size:14px;">${block.content}</div>
                    </div>`;
                } else if (block.type === 'list') {
                    const items = block.content.split('\n').filter(i => i.trim());
                    const itemsHtml = items.map(i => `<li style="color:rgba(255,255,255,0.85);font-size:11px;margin:4px 0;">${i}</li>`).join('');
                    blocksHtml += `<div style="margin:10px 0;">
                        <div style="color:#4facfe;font-size:12px;font-weight:600;margin-bottom:4px;">${block.title}</div>
                        <ul style="list-style:disc;padding-left:20px;">${itemsHtml}</ul>
                    </div>`;
                } else {
                    blocksHtml += `<div style="margin:10px 0;">
                        <div style="color:#4facfe;font-size:12px;font-weight:600;margin-bottom:4px;">${block.title}</div>
                        <div style="color:rgba(255,255,255,0.85);font-size:11px;">${block.content}</div>
                    </div>`;
                }
            });

            const previewHtml = `
                <div style="width:100%;height:100%;padding:20px;display:flex;flex-direction:column;">
                    <div style="margin-bottom:15px;">
                        <div style="font-size:18px;font-weight:700;background:linear-gradient(90deg,#fff,#4facfe);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${mainTitle}</div>
                        ${subtitle ? `<div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;">${subtitle}</div>` : ''}
                    </div>
                    <div style="flex:1;overflow:auto;">${blocksHtml}</div>
                    ${footer ? `<div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;font-size:9px;color:rgba(255,255,255,0.4);font-style:italic;">${footer}</div>` : ''}
                </div>
            `;

            const container = document.getElementById('preview-container');
            container.innerHTML = previewHtml;
        }

        function previewPPT() {
            if (!currentPPTId) {
                showToast('ËØ∑ÂÖà‰øùÂ≠ò PPT', 'error');
                return;
            }

            fetch(`/api/ppt/${currentPPTId}/export`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const win = window.open('', '_blank');
                        win.document.write(data.html);
                        win.document.close();
                    }
                });
        }

        function downloadPPT() {
            if (!currentPPTId) {
                showToast('ËØ∑ÂÖà‰øùÂ≠ò PPT', 'error');
                return;
            }

            fetch(`/api/ppt/${currentPPTId}/export`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const blob = new Blob([data.html], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = (document.getElementById('ppt-title').value || 'ppt') + '.html';
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('‰∏ãËΩΩÊàêÂäü');
                    }
                });
        }

        // ============ Â∑•ÂÖ∑ÂáΩÊï∞ ============
        function formatDate(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            return d.toLocaleDateString('zh-CN');
        }

        function shuffleQuote() {
            fetch('/api/quote/random')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('quote-text').textContent = data.quote;
                });
        }

        // ============ PPTÁøªËØëÂ∑•ÂÖ∑ ============
        let translatorState = {
            pages: [],           // ÂéüÂßãPPTÈ°µÈù¢ÂõæÁâá
            translatedPages: [], // ÁøªËØëÂêéÁöÑÈ°µÈù¢
            currentPage: 1,
            totalPages: 0,
            screenshotMode: false,
            translations: [],    // ‰øùÂ≠òÁöÑÁøªËØëÂùó
            currentSelection: null
        };

        // ÂàùÂßãÂåñPPTÁøªËØëÂ∑•ÂÖ∑
        function initPPTTranslator() {
            const uploadZone = document.getElementById('ppt-upload-zone');
            const fileInput = document.getElementById('ppt-file-input');

            if (!uploadZone || !fileInput) return;

            // ÁÇπÂáª‰∏ä‰º†
            uploadZone.addEventListener('click', () => fileInput.click());

            // ÊãñÊãΩ‰∏ä‰º†
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handlePPTFile(files[0]);
                }
            });

            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePPTFile(e.target.files[0]);
                }
            });

            // ÂàùÂßãÂåñÊà™ÂõæÂäüËÉΩ
            initScreenshotFeature();
        }

        // Â§ÑÁêÜPPTÊñá‰ª∂‰∏ä‰º†
        async function handlePPTFile(file) {
            const ext = file.name.toLowerCase().match(/\.[^.]+$/)?.[0];

            if (ext !== '.pdf') {
                showToast('ËØ∑‰∏ä‰º† PDF Êñá‰ª∂ÔºàPPTËØ∑ÂÖàÂØºÂá∫‰∏∫PDFÔºâ', 'error');
                return;
            }

            document.getElementById('ppt-file-name').textContent = file.name;
            showToast('Ê≠£Âú®Ëß£ÊûêÊñá‰ª∂...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/ppt-translator/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    translatorState.pages = data.pages;
                    translatorState.translatedPages = data.pages.slice(); // ÂàùÂßãÂ§çÂà∂
                    translatorState.totalPages = data.pages.length;
                    translatorState.currentPage = 1;
                    translatorState.translations = [];

                    showTranslatorContent();
                    renderPage(1);
                    updatePageNav();
                    showToast('Êñá‰ª∂Ëß£ÊûêÊàêÂäü', 'success');
                } else {
                    showToast('Ëß£ÊûêÂ§±Ë¥•: ' + data.error, 'error');
                }
            } catch (err) {
                showToast('‰∏ä‰º†Â§±Ë¥•: ' + err.message, 'error');
            }
        }

        // ÊòæÁ§∫ÁøªËØëÂÜÖÂÆπÂå∫Âüü
        function showTranslatorContent() {
            document.getElementById('translator-empty').style.display = 'none';
            document.getElementById('translator-content').style.display = 'flex';
            document.getElementById('btn-export-ppt').style.display = 'inline-flex';
        }

        // Ê∏≤ÊüìÈ°µÈù¢
        function renderPage(pageNum) {
            translatorState.currentPage = pageNum;

            // Â∑¶‰æßÂéüÊñá
            const leftCanvas = document.getElementById('left-canvas');
            const leftCtx = leftCanvas.getContext('2d');
            const leftImg = new Image();
            leftImg.onload = () => {
                leftCanvas.width = leftImg.width;
                leftCanvas.height = leftImg.height;
                leftCtx.drawImage(leftImg, 0, 0);
            };
            leftImg.src = translatorState.pages[pageNum - 1];

            // Âè≥‰æßËØëÊñá
            const rightCanvas = document.getElementById('right-canvas');
            const rightCtx = rightCanvas.getContext('2d');
            const rightImg = new Image();
            rightImg.onload = () => {
                rightCanvas.width = rightImg.width;
                rightCanvas.height = rightImg.height;
                rightCtx.drawImage(rightImg, 0, 0);
                renderTranslationBlocks(pageNum);
            };
            rightImg.src = translatorState.translatedPages[pageNum - 1];

            // Êõ¥Êñ∞È°µÁ†ÅÊòæÁ§∫
            document.getElementById('left-page-info').textContent = `Á¨¨ ${pageNum} / ${translatorState.totalPages} È°µ`;
            document.getElementById('right-page-info').textContent = `Á¨¨ ${pageNum} / ${translatorState.totalPages} È°µ`;

            // Êõ¥Êñ∞È°µÁ†ÅËæìÂÖ•Ê°Ü
            document.getElementById('page-input').value = pageNum;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('btn-prev-page').disabled = (pageNum <= 1);
            document.getElementById('btn-next-page').disabled = (pageNum >= translatorState.totalPages);
        }

        // Ê∏≤ÊüìÁøªËØëÂùó
        function renderTranslationBlocks(pageNum) {
            const container = document.getElementById('translation-overlays');
            const rightCanvas = document.getElementById('right-canvas');
            container.innerHTML = '';

            if (!rightCanvas) return;

            // ËÆ°ÁÆó canvas ÁöÑÊòæÁ§∫Â∞∫ÂØ∏‰∏éÂÆûÈôÖÂ∞∫ÂØ∏ÁöÑÊØî‰æã
            const displayWidth = rightCanvas.offsetWidth;
            const displayHeight = rightCanvas.offsetHeight;
            const actualWidth = rightCanvas.width;
            const actualHeight = rightCanvas.height;

            const scaleX = displayWidth / actualWidth;
            const scaleY = displayHeight / actualHeight;

            const pageTranslations = translatorState.translations.filter(t => t.page === pageNum);
            pageTranslations.forEach(t => {
                const block = document.createElement('div');
                block.className = 'translation-block';
                // ËΩ¨Êç¢‰∏∫ÊòæÁ§∫ÂùêÊ†á
                block.style.left = (t.x * scaleX) + 'px';
                block.style.top = (t.y * scaleY) + 'px';
                block.style.width = (t.width * scaleX) + 'px';
                block.style.height = (t.height * scaleY) + 'px';
                block.textContent = t.text;
                container.appendChild(block);
            });
        }

        // Êõ¥Êñ∞È°µÈù¢ÂØºËà™
        function updatePageNav() {
            document.getElementById('page-input').value = 1;
            document.getElementById('page-input').max = translatorState.totalPages;
            document.getElementById('total-pages').textContent = translatorState.totalPages;
            document.getElementById('btn-prev-page').disabled = true;
            document.getElementById('btn-next-page').disabled = (translatorState.totalPages <= 1);
        }

        // ‰∏ä‰∏ÄÈ°µ
        function goToPrevPage() {
            if (translatorState.currentPage > 1) {
                renderPage(translatorState.currentPage - 1);
            }
        }

        // ‰∏ã‰∏ÄÈ°µ
        function goToNextPage() {
            if (translatorState.currentPage < translatorState.totalPages) {
                renderPage(translatorState.currentPage + 1);
            }
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µ
        function goToPage(value) {
            let page = parseInt(value);
            if (isNaN(page) || page < 1) page = 1;
            if (page > translatorState.totalPages) page = translatorState.totalPages;
            renderPage(page);
        }

        // ÂàáÊç¢Êà™ÂõæÊ®°Âºè
        function toggleScreenshotMode() {
            translatorState.screenshotMode = !translatorState.screenshotMode;
            const btn = document.getElementById('btn-screenshot');
            const overlay = document.getElementById('screenshot-overlay');

            if (translatorState.screenshotMode) {
                btn.classList.add('active');
                overlay.style.display = 'block';
                showToast('Êà™ÂõæÊ®°ÂºèÂ∑≤ÂºÄÂêØÔºåÂú®Â∑¶‰æßÊ°ÜÈÄâÂå∫Âüü', 'info');
            } else {
                btn.classList.remove('active');
                overlay.style.display = 'none';
            }
        }

        // ÂàùÂßãÂåñÊà™ÂõæÂäüËÉΩ
        function initScreenshotFeature() {
            const overlay = document.getElementById('screenshot-overlay');
            if (!overlay) return;

            let isSelecting = false;
            let startX, startY;
            let selectionDiv = null;

            overlay.addEventListener('mousedown', (e) => {
                isSelecting = true;
                const rect = overlay.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;

                selectionDiv = document.createElement('div');
                selectionDiv.className = 'screenshot-selection';
                selectionDiv.style.left = startX + 'px';
                selectionDiv.style.top = startY + 'px';
                overlay.appendChild(selectionDiv);
            });

            overlay.addEventListener('mousemove', (e) => {
                if (!isSelecting || !selectionDiv) return;

                const rect = overlay.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                const left = Math.min(currentX, startX);
                const top = Math.min(currentY, startY);

                selectionDiv.style.left = left + 'px';
                selectionDiv.style.top = top + 'px';
                selectionDiv.style.width = width + 'px';
                selectionDiv.style.height = height + 'px';
            });

            overlay.addEventListener('mouseup', (e) => {
                if (!isSelecting || !selectionDiv) return;
                isSelecting = false;

                const rect = overlay.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;

                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);

                if (width > 10 && height > 10) {
                    const left = Math.min(endX, startX);
                    const top = Math.min(endY, startY);

                    captureAndTranslate(left, top, width, height);
                }

                selectionDiv.remove();
                selectionDiv = null;
            });
        }

        // Êà™ÂõæÂπ∂ÁøªËØë
        async function captureAndTranslate(x, y, width, height) {
            const canvas = document.getElementById('left-canvas');
            const scaleX = canvas.width / canvas.offsetWidth;
            const scaleY = canvas.height / canvas.offsetHeight;

            // ÂàõÂª∫Êà™Âõæcanvas
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = width * scaleX;
            cropCanvas.height = height * scaleY;
            const cropCtx = cropCanvas.getContext('2d');

            cropCtx.drawImage(
                canvas,
                x * scaleX, y * scaleY, width * scaleX, height * scaleY,
                0, 0, cropCanvas.width, cropCanvas.height
            );

            const imageData = cropCanvas.toDataURL('image/png');

            // ‰øùÂ≠òÈÄâÂå∫‰ø°ÊÅØÔºàÂåÖÂê´ÂõæÁâáÊï∞ÊçÆ‰æõË±ÜÂåÖÁõ¥Êé•ÁøªËØëÁî®Ôºâ
            translatorState.currentSelection = {
                x: x * scaleX,
                y: y * scaleY,
                width: width * scaleX,
                height: height * scaleY,
                page: translatorState.currentPage,
                imageData: imageData  // ‰øùÂ≠òÂõæÁâáÊï∞ÊçÆ
            };

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('screenshot-preview').innerHTML = `<img src="${imageData}">`;
            document.getElementById('screenshot-translation').value = '';
            document.getElementById('screenshot-modal').style.display = 'flex';

            // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã
            const selectedModel = document.getElementById('translate-model').value;

            if (selectedModel === 'doubao') {
                // Ë±ÜÂåÖÊ®°ÂºèÔºö‰∏çÈúÄË¶Å OCRÔºåÁõ¥Êé•ÁøªËØëÂõæÁâá
                document.getElementById('ocr-text').value = '(Ë±ÜÂåÖÊ®°ÂºèÔºöÁÇπÂáªÁøªËØëÁõ¥Êé•ËØÜÂà´Âπ∂ÁøªËØëÂõæÁâá)';
                document.getElementById('btn-translate').disabled = false;
            } else {
                // ÂÖçË¥πÊ®°ÂºèÔºöÂÖà OCR ËØÜÂà´ÊñáÂ≠ó
                document.getElementById('ocr-text').value = 'Ê≠£Âú®ËØÜÂà´ÊñáÂ≠ó...';
                document.getElementById('btn-translate').disabled = true;

                try {
                    const response = await fetch('/api/ppt-translator/ocr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageData, model: 'free' })
                    });

                    const data = await response.json();

                    if (data.success) {
                        document.getElementById('ocr-text').value = data.text || '';
                    } else {
                        document.getElementById('ocr-text').value = '';
                        showToast('OCRËØÜÂà´Â§±Ë¥•: ' + data.error + 'ÔºåÂèØÊâãÂä®ËæìÂÖ•ÊñáÂ≠ó', 'error');
                    }
                    document.getElementById('btn-translate').disabled = false;
                } catch (err) {
                    document.getElementById('ocr-text').value = '';
                    document.getElementById('btn-translate').disabled = false;
                    showToast('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂèØÊâãÂä®ËæìÂÖ•ÊñáÂ≠ó', 'error');
                }
            }
        }

        // ÁøªËØëÊñπÂêëÁä∂ÊÄÅ: 'zh2en' Êàñ 'en2zh'
        let translateDirection = 'en2zh';

        // ÂàáÊç¢ÁøªËØëÊñπÂêë
        function toggleTranslateDirection() {
            if (translateDirection === 'en2zh') {
                translateDirection = 'zh2en';
                document.getElementById('lang-from').textContent = 'Ëã±Êñá';
                document.getElementById('lang-to').textContent = '‰∏≠Êñá';
            } else {
                translateDirection = 'en2zh';
                document.getElementById('lang-from').textContent = '‰∏≠Êñá';
                document.getElementById('lang-to').textContent = 'Ëã±Êñá';
            }
        }

        // Ê®°ÂûãÂàáÊç¢
        function onTranslateModelChange() {
            const model = document.getElementById('translate-model').value;
            // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Ê®°ÂûãÁõ∏ÂÖ≥ÁöÑÊèêÁ§∫
        }

        // ÁøªËØë OCR ÊñáÂ≠ó
        async function translateOcrText() {
            const btn = document.getElementById('btn-translate');
            const model = document.getElementById('translate-model').value;
            const targetLang = translateDirection === 'en2zh' ? 'zh' : 'en';

            btn.disabled = true;
            btn.textContent = 'ÁøªËØë‰∏≠...';
            document.getElementById('screenshot-translation').value = 'Ê≠£Âú®ÁøªËØë...';

            try {
                let response, data;

                if (model === 'doubao') {
                    // Ë±ÜÂåÖÊ®°ÂºèÔºöÁõ¥Êé•ÂèëÈÄÅÂõæÁâáÔºå‰∏ÄÊ≠•ÂÆåÊàê OCR + ÁøªËØë
                    const imageData = translatorState.currentSelection?.imageData;
                    if (!imageData) {
                        throw new Error('Ê≤°ÊúâÊà™ÂõæÊï∞ÊçÆ');
                    }

                    response = await fetch('/api/ppt-translator/doubao-direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: imageData,
                            target_lang: targetLang
                        })
                    });

                    data = await response.json();

                    if (data.success) {
                        // ÂêåÊó∂ÊòæÁ§∫ËØÜÂà´ÁöÑÂéüÊñá
                        if (data.original_text) {
                            document.getElementById('ocr-text').value = data.original_text;
                        }
                        document.getElementById('screenshot-translation').value = data.translation;
                    } else {
                        document.getElementById('screenshot-translation').value = 'ÁøªËØëÂ§±Ë¥•: ' + data.error;
                    }
                } else {
                    // DeepSeek Ê®°ÂºèÔºöÁøªËØëÂ∑≤ËØÜÂà´ÁöÑÊñáÂ≠ó
                    const text = document.getElementById('ocr-text').value.trim();
                    if (!text) {
                        showToast('Ê≤°ÊúâÂèØÁøªËØëÁöÑÊñáÂ≠ó', 'error');
                        btn.disabled = false;
                        btn.textContent = 'ÁøªËØë';
                        return;
                    }

                    response = await fetch('/api/ppt-translator/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            model: 'deepseek',
                            target_lang: targetLang
                        })
                    });

                    data = await response.json();

                    if (data.success) {
                        document.getElementById('screenshot-translation').value = data.translation;
                    } else {
                        document.getElementById('screenshot-translation').value = 'ÁøªËØëÂ§±Ë¥•: ' + data.error;
                    }
                }
            } catch (err) {
                document.getElementById('screenshot-translation').value = 'ËØ∑Ê±ÇÂ§±Ë¥•: ' + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ÁøªËØë';
            }
        }

        // ÂÖ≥Èó≠Êà™ÂõæÊ®°ÊÄÅÊ°Ü
        function closeScreenshotModal() {
            document.getElementById('screenshot-modal').style.display = 'none';
            translatorState.currentSelection = null;
        }

        // ‰øùÂ≠òÊà™ÂõæÁøªËØë
        function saveScreenshotTranslation() {
            const text = document.getElementById('screenshot-translation').value.trim();
            if (!text || !translatorState.currentSelection) {
                showToast('ËØ∑ËæìÂÖ•ÁøªËØëÂÜÖÂÆπ', 'error');
                return;
            }

            const sel = translatorState.currentSelection;

            // Ê∑ªÂä†Âà∞ÁøªËØëÂàóË°®
            translatorState.translations.push({
                page: sel.page,
                x: sel.x,
                y: sel.y,
                width: sel.width,
                height: sel.height,
                text: text
            });

            // ÈáçÊñ∞Ê∏≤ÊüìÁøªËØëÂùó
            renderTranslationBlocks(sel.page);

            closeScreenshotModal();
            showToast('ÁøªËØëÂ∑≤‰øùÂ≠ò', 'success');
        }

        // ÂØºÂá∫ÁøªËØëÂêéÁöÑPPT
        async function exportTranslatedPPT() {
            showToast('Ê≠£Âú®ÁîüÊàêÂØºÂá∫Êñá‰ª∂...', 'info');

            try {
                const response = await fetch('/api/ppt-translator/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        translations: translatorState.translations,
                        pages: translatorState.pages
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'translated_ppt.pdf';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('ÂØºÂá∫ÊàêÂäü', 'success');
                } else {
                    showToast('ÂØºÂá∫Â§±Ë¥•', 'error');
                }
            } catch (err) {
                showToast('ÂØºÂá∫Â§±Ë¥•: ' + err.message, 'error');
            }
        }

        // ============ ÁøªËØëËÆæÁΩÆ ============
        let translatorSettings = {
            deepseekKey: '',
            doubaoKey: '',
            doubaoEndpoint: ''
        };

        // Âä†ËΩΩËÆæÁΩÆ
        function loadTranslatorSettings() {
            const saved = localStorage.getItem('translatorSettings');
            if (saved) {
                try {
                    translatorSettings = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to parse settings:', e);
                }
            }
        }

        // ÊâìÂºÄËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function openTranslatorSettings() {
            loadTranslatorSettings();
            document.getElementById('deepseek-key').value = translatorSettings.deepseekKey || '';
            document.getElementById('doubao-key').value = translatorSettings.doubaoKey || '';
            document.getElementById('doubao-endpoint').value = translatorSettings.doubaoEndpoint || '';
            document.getElementById('translator-settings-modal').style.display = 'flex';
        }

        // ÂÖ≥Èó≠ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function closeTranslatorSettings() {
            document.getElementById('translator-settings-modal').style.display = 'none';
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        async function saveTranslatorSettings() {
            const deepseekKey = document.getElementById('deepseek-key').value.trim();
            const doubaoKey = document.getElementById('doubao-key').value.trim();
            const doubaoEndpoint = document.getElementById('doubao-endpoint').value.trim();

            if (!deepseekKey && !doubaoKey) {
                showToast('ËØ∑Ëá≥Â∞ëÈÖçÁΩÆ‰∏Ä‰∏™Ê®°ÂûãÁöÑ API Key', 'error');
                return;
            }

            translatorSettings = { deepseekKey, doubaoKey, doubaoEndpoint };
            localStorage.setItem('translatorSettings', JSON.stringify(translatorSettings));

            // ÂêåÊ≠•Âà∞ÊúçÂä°Âô®
            try {
                await fetch('/api/ppt-translator/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deepseek_api_key: deepseekKey,
                        doubao_api_key: doubaoKey,
                        doubao_endpoint_id: doubaoEndpoint
                    })
                });
                showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
                closeTranslatorSettings();
            } catch (err) {
                showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        // ÂàáÊç¢ API Key ÂèØËßÅÊÄß
        function toggleKeyVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñËÆæÁΩÆ
        loadTranslatorSettings();

        // ============ È∏øËíôÊâãÊú∫ËØïÈ™åÁî∞ ============
        const harmonyOSLab = {
            currentSection: 'simulator',
            apps: [],
            plugins: [],
            logs: [],
            phoneState: {
                isRotated: false,
                currentApp: null,
                runningApps: []
            }
        };

        // ============ Ëß¶Â±è‰∫§‰∫íÊ®°ÊãüÁ≥ªÁªü ============
        const TouchSimulator = {
            // Áä∂ÊÄÅÊûö‰∏æ
            STATE: {
                IDLE: 'idle',
                HOVER: 'hover',
                TAP: 'tap',
                PRESS: 'press'
            },

            // ÂΩìÂâçÁä∂ÊÄÅ
            currentState: 'idle',
            previousState: 'idle',

            // DOM ÂÖÉÁ¥†ÂºïÁî®
            phoneScreen: null,
            touchIndicator: null,
            pressEnergy: null,
            rippleContainer: null,
            energySparks: null,
            logContent: null,

            // ‰ΩçÁΩÆÂíåËÆ°Êó∂
            position: { x: 0, y: 0 },
            pressStartTime: null,
            pressTimer: null,
            sparkTimer: null,
            pressThreshold: 300, // ÈïøÊåâÈòàÂÄºÔºàÊØ´ÁßíÔºâ

            // ÂΩìÂâçËß¶Êë∏ÁöÑÁõÆÊ†áÂÖÉÁ¥†
            currentTarget: null,

            // ‰∫ã‰ª∂ÂéÜÂè≤ËÆ∞ÂΩïÔºàÁªìÊûÑÂåñÊï∞ÊçÆÔºâ
            eventHistory: [],

            // ÂàùÂßãÂåñ
            init() {
                this.phoneScreen = document.getElementById('phone-screen');
                this.touchIndicator = document.getElementById('touch-indicator');
                this.pressEnergy = document.getElementById('press-energy');
                this.rippleContainer = document.getElementById('ripple-container');
                this.energySparks = document.getElementById('energy-sparks');
                this.logContent = document.getElementById('touch-log-content');

                if (!this.phoneScreen) return;

                this.bindEvents();
                this.setState(this.STATE.IDLE);
                console.log('[TouchSimulator] ÂàùÂßãÂåñÂÆåÊàê');
            },

            // ÁªëÂÆö‰∫ã‰ª∂
            bindEvents() {
                const screen = this.phoneScreen;

                // Èº†Ê†áËøõÂÖ•Â±èÂπïÂå∫Âüü
                screen.addEventListener('mouseenter', (e) => {
                    screen.classList.add('touch-active');
                    this.touchIndicator.classList.add('visible');
                    this.setState(this.STATE.HOVER);
                    this.updatePosition(e);
                });

                // Èº†Ê†áÁ¶ªÂºÄÂ±èÂπïÂå∫Âüü
                screen.addEventListener('mouseleave', (e) => {
                    screen.classList.remove('touch-active');
                    this.touchIndicator.classList.remove('visible');
                    this.clearTarget();
                    this.endPress();
                    this.setState(this.STATE.IDLE);
                });

                // Èº†Ê†áÁßªÂä®
                screen.addEventListener('mousemove', (e) => {
                    this.updatePosition(e);
                    this.detectTarget(e);
                });

                // Èº†Ê†áÊåâ‰∏ã
                screen.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return; // Âè™ÂìçÂ∫îÂ∑¶ÈîÆ
                    e.preventDefault();
                    this.startPress(e);
                });

                // Èº†Ê†áÈáäÊîæ
                screen.addEventListener('mouseup', (e) => {
                    if (e.button !== 0) return;
                    this.endPress(e);
                });

                // Èò≤Ê≠¢Âè≥ÈîÆËèúÂçï
                screen.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
            },

            // Êõ¥Êñ∞‰ΩçÁΩÆ
            updatePosition(e) {
                const rect = this.phoneScreen.getBoundingClientRect();
                this.position.x = e.clientX - rect.left;
                this.position.y = e.clientY - rect.top;

                // Êõ¥Êñ∞Ëß¶Êë∏ÊåáÁ§∫Âô®‰ΩçÁΩÆ
                this.touchIndicator.style.left = this.position.x + 'px';
                this.touchIndicator.style.top = this.position.y + 'px';

                // Êõ¥Êñ∞ÈïøÊåâËÉΩÈáèÊïàÊûú‰ΩçÁΩÆ
                this.pressEnergy.style.left = this.position.x + 'px';
                this.pressEnergy.style.top = this.position.y + 'px';
            },

            // Ê£ÄÊµãÂΩìÂâçÁõÆÊ†áÂÖÉÁ¥†
            detectTarget(e) {
                const target = document.elementFromPoint(e.clientX, e.clientY);

                // Êü•ÊâæÊúÄËøëÁöÑÂèØ‰∫§‰∫íÂÖÉÁ¥†
                const touchIcon = target?.closest('.touch-icon');
                const touchNav = target?.closest('.touch-nav');
                const newTarget = touchIcon || touchNav || null;

                // Ê∏ÖÈô§‰πãÂâçÁöÑÁõÆÊ†áÈ´ò‰∫Æ
                if (this.currentTarget && this.currentTarget !== newTarget) {
                    this.currentTarget.classList.remove('touch-target');
                }

                // ËÆæÁΩÆÊñ∞ÁõÆÊ†á
                if (newTarget && newTarget !== this.currentTarget) {
                    newTarget.classList.add('touch-target');
                    this.currentTarget = newTarget;
                } else if (!newTarget) {
                    this.currentTarget = null;
                }
            },

            // Ê∏ÖÈô§ÁõÆÊ†áÈ´ò‰∫Æ
            clearTarget() {
                if (this.currentTarget) {
                    this.currentTarget.classList.remove('touch-target');
                    this.currentTarget = null;
                }
            },

            // ÂºÄÂßãÊåâÂéã
            startPress(e) {
                this.pressStartTime = Date.now();

                // ÂÖàËß¶Âèë TAP Áä∂ÊÄÅ
                this.setState(this.STATE.TAP);
                this.createRipple();

                // ËÆæÁΩÆÈïøÊåâÊ£ÄÊµãÂÆöÊó∂Âô®
                this.pressTimer = setTimeout(() => {
                    this.setState(this.STATE.PRESS);
                    this.startPressEffect();
                }, this.pressThreshold);
            },

            // ÁªìÊùüÊåâÂéã
            endPress(e) {
                const pressDuration = this.pressStartTime ? Date.now() - this.pressStartTime : 0;

                // Ê∏ÖÈô§ÂÆöÊó∂Âô®
                if (this.pressTimer) {
                    clearTimeout(this.pressTimer);
                    this.pressTimer = null;
                }

                // ÂÅúÊ≠¢ÈïøÊåâÊïàÊûú
                this.stopPressEffect();

                // ËÆ∞ÂΩï‰∫ã‰ª∂
                if (this.currentState === this.STATE.PRESS) {
                    this.logEvent('release', this.getTargetInfo(), { duration: pressDuration });
                }

                // ÊÅ¢Â§ç‰∏∫ÊÇ¨ÊµÆÁä∂ÊÄÅ
                this.setState(this.STATE.HOVER);
                this.pressStartTime = null;
            },

            // ÂàõÂª∫ÁÇπÂáªÊ∂üÊº™
            createRipple() {
                const ripple = document.createElement('div');
                ripple.className = 'tap-ripple';
                ripple.style.left = this.position.x + 'px';
                ripple.style.top = this.position.y + 'px';
                ripple.style.width = '100px';
                ripple.style.height = '100px';

                this.rippleContainer.appendChild(ripple);

                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            },

            // ÂºÄÂßãÈïøÊåâÊïàÊûú
            startPressEffect() {
                this.pressEnergy.classList.add('active');

                // ÂºÄÂßãÁîüÊàêÁÅ´Ëä±
                this.sparkTimer = setInterval(() => {
                    this.createSpark();
                }, 100);
            },

            // ÂÅúÊ≠¢ÈïøÊåâÊïàÊûú
            stopPressEffect() {
                this.pressEnergy.classList.remove('active');

                if (this.sparkTimer) {
                    clearInterval(this.sparkTimer);
                    this.sparkTimer = null;
                }

                // Ê∏ÖÈô§ÁÅ´Ëä±
                this.energySparks.innerHTML = '';
            },

            // ÂàõÂª∫ÁÅ´Ëä±
            createSpark() {
                const spark = document.createElement('div');
                spark.className = 'energy-spark';

                // ÈöèÊú∫ÊñπÂêë
                const angle = Math.random() * Math.PI * 2;
                const distance = 30 + Math.random() * 40;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                spark.style.left = '50%';
                spark.style.top = '50%';
                spark.style.setProperty('--tx', tx + 'px');
                spark.style.setProperty('--ty', ty + 'px');

                this.energySparks.appendChild(spark);

                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§
                setTimeout(() => {
                    spark.remove();
                }, 800);
            },

            // ËÆæÁΩÆÁä∂ÊÄÅ
            setState(newState) {
                if (this.currentState === newState) return;

                this.previousState = this.currentState;
                this.currentState = newState;

                // Êõ¥Êñ∞ÊåáÁ§∫Âô®Ê†∑Âºè
                this.touchIndicator.className = 'touch-indicator visible';
                if (newState !== this.STATE.IDLE) {
                    this.touchIndicator.classList.add('state-' + newState);
                }

                // ËÆ∞ÂΩïÁä∂ÊÄÅÂèòÂåñ‰∫ã‰ª∂
                if (newState !== this.STATE.IDLE) {
                    this.logEvent(newState, this.getTargetInfo());
                }

                // Ëß¶ÂèëÁä∂ÊÄÅÂèòÂåñÂõûË∞É
                this.onStateChange(newState, this.previousState);
            },

            // Ëé∑ÂèñÁõÆÊ†á‰ø°ÊÅØ
            getTargetInfo() {
                if (!this.currentTarget) {
                    return { type: 'screen', label: 'Â±èÂπïÁ©∫ÁôΩÂå∫Âüü' };
                }

                const app = this.currentTarget.dataset.app;
                const action = this.currentTarget.dataset.action;
                const label = this.currentTarget.dataset.label ||
                             this.currentTarget.textContent.trim();

                if (app) {
                    return { type: 'app', id: app, label: label };
                } else if (action) {
                    return { type: 'nav', action: action, label: label };
                }

                return { type: 'element', label: label };
            },

            // ËÆ∞ÂΩï‰∫ã‰ª∂
            logEvent(state, target, extra = {}) {
                const timestamp = Date.now();
                const timeStr = new Date().toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 2
                }).replace(',', '.');

                const event = {
                    timestamp,
                    state,
                    position: { ...this.position },
                    target,
                    ...extra
                };

                // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                this.eventHistory.push(event);

                // ‰øùÊåÅÊúÄÂ§ö 100 Êù°ËÆ∞ÂΩï
                if (this.eventHistory.length > 100) {
                    this.eventHistory.shift();
                }

                // Êõ¥Êñ∞Êó•ÂøóÊòæÁ§∫
                this.renderLogEntry(timeStr, state, target);

                // ËæìÂá∫ÁªìÊûÑÂåñÊï∞ÊçÆÂà∞ÊéßÂà∂Âè∞
                console.log('[TouchEvent]', JSON.stringify(event, null, 2));
            },

            // Ê∏≤ÊüìÊó•ÂøóÊù°ÁõÆ
            renderLogEntry(time, state, target) {
                if (!this.logContent) return;

                const entry = document.createElement('div');
                entry.className = 'touch-log-entry';
                entry.innerHTML = `
                    <span class="log-time">${time}</span>
                    <span class="log-state ${state}">${state.toUpperCase()}</span>
                    <span class="log-target">${target.label}</span>
                `;

                this.logContent.insertBefore(entry, this.logContent.firstChild);

                // ‰øùÊåÅÊúÄÂ§ö 20 Êù°ÊòæÁ§∫
                while (this.logContent.children.length > 20) {
                    this.logContent.removeChild(this.logContent.lastChild);
                }
            },

            // Áä∂ÊÄÅÂèòÂåñÂõûË∞ÉÔºàÂèØË¢´Â§ñÈÉ®Ë¶ÜÁõñÔºâ
            onStateChange(newState, oldState) {
                // ÂèØÊâ©Â±ïÔºö‰æõ AI/Agent Êé•ÂÖ•
            },

            // Ëé∑Âèñ‰∫ã‰ª∂ÂéÜÂè≤Ôºà‰æõÂ§ñÈÉ®ËØªÂèñÔºâ
            getEventHistory() {
                return [...this.eventHistory];
            },

            // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™‰∫ã‰ª∂
            getLastEvent() {
                return this.eventHistory[this.eventHistory.length - 1] || null;
            },

            // Ê∏ÖÁ©∫‰∫ã‰ª∂ÂéÜÂè≤
            clearHistory() {
                this.eventHistory = [];
                if (this.logContent) {
                    this.logContent.innerHTML = '';
                }
            }
        };

        // Ê∏ÖÁ©∫Ëß¶Â±è‰∫ã‰ª∂
        function clearTouchEvents() {
            TouchSimulator.clearHistory();
            showToast('‰∫ã‰ª∂Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫', 'success');
        }

        // ============ HarmonyOS Ê°åÈù¢ÁÆ°ÁêÜÂô® ============
        const DesktopManager = {
            currentPage: 0,
            totalPages: 2,
            isDragging: false,
            dragStartX: 0,
            currentTranslate: 0,

            // ÂàùÂßãÂåñ
            init() {
                this.bindPageSwipe();
                this.bindControlCenter();
                this.bindFolders();
                this.bindContextMenu();
                this.bindDragAndDrop();
                this.updateClocks();
                setInterval(() => this.updateClocks(), 1000);
            },

            // È°µÈù¢ÊªëÂä®ÁªëÂÆö
            bindPageSwipe() {
                const container = document.getElementById('desktop-container');
                const pages = document.getElementById('desktop-pages');
                if (!container || !pages) return;

                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                container.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.widget, .touch-icon, .app-folder')) return;
                    isDragging = true;
                    startX = e.clientX;
                    pages.style.transition = 'none';
                });

                container.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    currentX = e.clientX;
                    const diff = currentX - startX;
                    const translate = -this.currentPage * 100 + (diff / container.offsetWidth * 100);
                    pages.style.transform = `translateX(${translate}%)`;
                });

                container.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    pages.style.transition = 'transform 0.3s ease';

                    const diff = currentX - startX;
                    const threshold = container.offsetWidth * 0.2;

                    if (diff < -threshold && this.currentPage < this.totalPages - 1) {
                        this.goToPage(this.currentPage + 1);
                    } else if (diff > threshold && this.currentPage > 0) {
                        this.goToPage(this.currentPage - 1);
                    } else {
                        this.goToPage(this.currentPage);
                    }
                });

                container.addEventListener('mouseleave', () => {
                    if (isDragging) {
                        isDragging = false;
                        pages.style.transition = 'transform 0.3s ease';
                        this.goToPage(this.currentPage);
                    }
                });

                // È°µÈù¢ÊåáÁ§∫Âô®ÁÇπÂáª
                document.querySelectorAll('.page-dot').forEach(dot => {
                    dot.addEventListener('click', () => {
                        const page = parseInt(dot.dataset.page);
                        this.goToPage(page);
                    });
                });
            },

            // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µÈù¢
            goToPage(page) {
                this.currentPage = page;
                const pages = document.getElementById('desktop-pages');
                if (pages) {
                    pages.style.transform = `translateX(-${page * 100}%)`;
                }

                // Êõ¥Êñ∞ÊåáÁ§∫Âô®
                document.querySelectorAll('.page-dot').forEach(dot => {
                    dot.classList.toggle('active', parseInt(dot.dataset.page) === page);
                });

                // ËÆ∞ÂΩï‰∫ã‰ª∂
                TouchSimulator.logEvent('page_change', { type: 'page', label: `Á¨¨${page + 1}È°µ` });
            },

            // ÊéßÂà∂‰∏≠ÂøÉÁªëÂÆö
            bindControlCenter() {
                const statusbar = document.getElementById('phone-statusbar');
                const controlCenter = document.getElementById('control-center');
                if (!statusbar || !controlCenter) return;

                let startY = 0;
                let isDragging = false;

                statusbar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startY = e.clientY;
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const diff = e.clientY - startY;
                    if (diff > 30) {
                        controlCenter.classList.add('visible');
                        isDragging = false;
                        TouchSimulator.logEvent('swipe_down', { type: 'gesture', label: 'ÊéßÂà∂‰∏≠ÂøÉ' });
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
                controlCenter.addEventListener('click', (e) => {
                    if (e.target === controlCenter || e.target.classList.contains('control-center-handle')) {
                        controlCenter.classList.remove('visible');
                    }
                });

                // ÊéßÂà∂ÂºÄÂÖ≥
                controlCenter.querySelectorAll('.control-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        const control = toggle.dataset.control;
                        TouchSimulator.logEvent('toggle', {
                            type: 'control',
                            label: control,
                            active: toggle.classList.contains('active')
                        });
                    });
                });
            },

            // Êñá‰ª∂Â§πÁªëÂÆö
            bindFolders() {
                const folderOverlay = document.getElementById('folder-overlay');

                // ÁÇπÂáªÊñá‰ª∂Â§πÊâìÂºÄ
                document.querySelectorAll('.app-folder').forEach(folder => {
                    folder.addEventListener('click', () => {
                        const folderId = folder.dataset.folder;
                        this.openFolder(folderId);
                    });
                });

                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
                if (folderOverlay) {
                    folderOverlay.addEventListener('click', (e) => {
                        if (e.target === folderOverlay) {
                            this.closeFolder();
                        }
                    });
                }
            },

            // ÊâìÂºÄÊñá‰ª∂Â§π
            openFolder(folderId) {
                const folderOverlay = document.getElementById('folder-overlay');
                const folderGrid = document.getElementById('folder-grid');
                const folderTitle = document.getElementById('folder-title');

                if (!folderOverlay || !folderGrid) return;

                // Ê®°ÊãüÊñá‰ª∂Â§πÂÜÖÂÆπ
                const folderApps = {
                    frequent: [
                        { icon: 'ÊîØ', name: 'ÊîØ‰ªòÂÆù', app: 'alipay' },
                        { icon: '‚öôÔ∏è', name: 'ËÆæÁΩÆ', app: 'settings' },
                        { icon: 'üìß', name: 'ÈÇÆÁÆ±', app: 'mail' },
                        { icon: 'üéß', name: 'ËÄ≥Êú∫', app: 'earphones' },
                        { icon: 'üè¶', name: 'Èì∂Ë°å', app: 'bank' },
                        { icon: 'üí¨', name: 'Ê∂àÊÅØ', app: 'message' },
                        { icon: 'üìù', name: 'Á¨îËÆ∞', app: 'notes' },
                        { icon: 'üîÑ', name: 'ÂêåÊ≠•', app: 'sync' },
                        { icon: 'üõí', name: 'ÁæéÂõ¢', app: 'meituan' }
                    ]
                };

                const apps = folderApps[folderId] || [];

                folderGrid.innerHTML = apps.map(app => `
                    <div class="touch-icon" data-app="${app.app}" data-label="${app.name}">
                        <span class="icon">${app.icon}</span>
                        <span class="name">${app.name}</span>
                    </div>
                `).join('');

                if (folderTitle) {
                    folderTitle.value = folderId === 'frequent' ? 'Â∏∏Áî®' : folderId;
                }

                folderOverlay.classList.add('visible');
                TouchSimulator.logEvent('folder_open', { type: 'folder', label: folderId });
            },

            // ÂÖ≥Èó≠Êñá‰ª∂Â§π
            closeFolder() {
                const folderOverlay = document.getElementById('folder-overlay');
                if (folderOverlay) {
                    folderOverlay.classList.remove('visible');
                    TouchSimulator.logEvent('folder_close', { type: 'folder', label: 'ÂÖ≥Èó≠' });
                }
            },

            // ‰∏ä‰∏ãÊñáËèúÂçïÁªëÂÆö
            bindContextMenu() {
                const contextMenu = document.getElementById('context-menu');
                const screen = document.getElementById('phone-screen');
                if (!contextMenu || !screen) return;

                let pressTimer = null;
                let targetApp = null;

                // ÈïøÊåâÊòæÁ§∫ËèúÂçïÔºàÈõÜÊàêÂà∞ TouchSimulatorÔºâ
                const originalOnStateChange = TouchSimulator.onStateChange.bind(TouchSimulator);
                TouchSimulator.onStateChange = (newState, oldState) => {
                    originalOnStateChange(newState, oldState);

                    if (newState === 'press' && TouchSimulator.currentTarget) {
                        const app = TouchSimulator.currentTarget.dataset.app;
                        if (app) {
                            targetApp = TouchSimulator.currentTarget;
                            this.showContextMenu(TouchSimulator.position.x, TouchSimulator.position.y);
                        }
                    }
                };

                // ËèúÂçïÈ°πÁÇπÂáª
                contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleContextAction(action, targetApp);
                        this.hideContextMenu();
                    });
                });

                // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠
                screen.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu')) {
                        this.hideContextMenu();
                    }
                });
            },

            // ÊòæÁ§∫‰∏ä‰∏ãÊñáËèúÂçï
            showContextMenu(x, y) {
                const contextMenu = document.getElementById('context-menu');
                if (!contextMenu) return;

                // Á°Æ‰øùËèúÂçï‰∏çË∂ÖÂá∫Â±èÂπï
                const maxX = 264 - 140; // phone width - menu width
                const maxY = 560 - 150; // phone height - menu height

                contextMenu.style.left = Math.min(x, maxX) + 'px';
                contextMenu.style.top = Math.min(y, maxY) + 'px';
                contextMenu.classList.add('visible');
            },

            // ÈöêËóè‰∏ä‰∏ãÊñáËèúÂçï
            hideContextMenu() {
                const contextMenu = document.getElementById('context-menu');
                if (contextMenu) {
                    contextMenu.classList.remove('visible');
                }
            },

            // Â§ÑÁêÜ‰∏ä‰∏ãÊñáËèúÂçïÂä®‰Ωú
            handleContextAction(action, target) {
                const appId = target?.dataset?.app;
                const appLabel = target?.dataset?.label || appId;

                TouchSimulator.logEvent('context_action', {
                    type: 'menu',
                    action: action,
                    app: appId,
                    label: `${action}: ${appLabel}`
                });

                switch (action) {
                    case 'open':
                        showToast(`ÊâìÂºÄ ${appLabel}`, 'info');
                        break;
                    case 'uninstall':
                        showToast(`Âç∏ËΩΩ ${appLabel}`, 'warning');
                        break;
                    case 'info':
                        showToast(`${appLabel} Â∫îÁî®‰ø°ÊÅØ`, 'info');
                        break;
                    case 'widget':
                        showToast(`Ê∑ªÂä† ${appLabel} Âç°Áâá`, 'success');
                        break;
                }
            },

            // Êõ¥Êñ∞Êó∂Èíü
            updateClocks() {
                const now = new Date();

                // Êó∂Âå∫ÂÅèÁßªÔºàÂ∞èÊó∂Ôºâ
                const timezones = {
                    beijing: 8,
                    toronto: -5,
                    vancouver: -8
                };

                Object.keys(timezones).forEach(city => {
                    const offset = timezones[city];
                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                    const cityTime = new Date(utc + (3600000 * offset));

                    const hours = cityTime.getHours();
                    const minutes = cityTime.getMinutes();

                    // Êõ¥Êñ∞ÊåáÈíà
                    const clockFace = document.getElementById(`clock-${city}`);
                    if (clockFace) {
                        const hourHand = clockFace.querySelector('.hour');
                        const minuteHand = clockFace.querySelector('.minute');

                        if (hourHand) {
                            const hourDeg = (hours % 12) * 30 + minutes * 0.5;
                            hourHand.style.transform = `rotate(${hourDeg}deg)`;
                        }
                        if (minuteHand) {
                            const minuteDeg = minutes * 6;
                            minuteHand.style.transform = `rotate(${minuteDeg}deg)`;
                        }
                    }

                    // Êõ¥Êñ∞Êó•Êúü
                    const dateEl = document.getElementById(`date-${city}`);
                    if (dateEl) {
                        const month = cityTime.getMonth() + 1;
                        const day = cityTime.getDate();
                        const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
                        const weekday = weekdays[cityTime.getDay()];
                        dateEl.textContent = `${month}Êúà${day}Êó•${weekday}`;
                    }
                });
            },

            // ÊãñÊãΩÁÆ°ÁêÜ
            draggedElement: null,
            dragGhost: null,

            // ÁªëÂÆöÊãñÊãΩ
            bindDragAndDrop() {
                const pages = document.querySelectorAll('.desktop-page');

                pages.forEach(page => {
                    const icons = page.querySelectorAll('.touch-icon:not(.dock-icon)');

                    icons.forEach(icon => {
                        icon.setAttribute('draggable', 'true');

                        icon.addEventListener('dragstart', (e) => {
                            this.draggedElement = icon;
                            icon.classList.add('dragging');

                            // ÂàõÂª∫ÊãñÊãΩÈ¢ÑËßà
                            const ghost = icon.cloneNode(true);
                            ghost.style.position = 'absolute';
                            ghost.style.opacity = '0';
                            document.body.appendChild(ghost);
                            e.dataTransfer.setDragImage(ghost, 24, 24);
                            setTimeout(() => ghost.remove(), 0);

                            TouchSimulator.logEvent('drag_start', {
                                type: 'drag',
                                label: icon.dataset.label || icon.dataset.app
                            });
                        });

                        icon.addEventListener('dragend', (e) => {
                            icon.classList.remove('dragging');
                            this.draggedElement = null;

                            // ÁßªÈô§ÊâÄÊúâ drag-over Áä∂ÊÄÅ
                            document.querySelectorAll('.drag-over').forEach(el => {
                                el.classList.remove('drag-over');
                            });

                            TouchSimulator.logEvent('drag_end', {
                                type: 'drag',
                                label: icon.dataset.label || icon.dataset.app
                            });
                        });

                        icon.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            if (this.draggedElement && this.draggedElement !== icon) {
                                icon.classList.add('drag-over');
                            }
                        });

                        icon.addEventListener('dragleave', (e) => {
                            icon.classList.remove('drag-over');
                        });

                        icon.addEventListener('drop', (e) => {
                            e.preventDefault();
                            icon.classList.remove('drag-over');

                            if (this.draggedElement && this.draggedElement !== icon) {
                                // ‰∫§Êç¢‰ΩçÁΩÆ
                                const parent = icon.parentNode;
                                const draggedParent = this.draggedElement.parentNode;

                                const iconIndex = Array.from(parent.children).indexOf(icon);
                                const draggedIndex = Array.from(draggedParent.children).indexOf(this.draggedElement);

                                if (parent === draggedParent) {
                                    // Âêå‰∏ÄÈ°µÈù¢ÂÜÖ‰∫§Êç¢
                                    if (draggedIndex < iconIndex) {
                                        parent.insertBefore(this.draggedElement, icon.nextSibling);
                                    } else {
                                        parent.insertBefore(this.draggedElement, icon);
                                    }
                                } else {
                                    // Ë∑®È°µÈù¢ÁßªÂä®
                                    parent.insertBefore(this.draggedElement, icon);
                                }

                                TouchSimulator.logEvent('drag_drop', {
                                    type: 'drag',
                                    from: this.draggedElement.dataset.label,
                                    to: icon.dataset.label,
                                    label: `ÁßªÂä®Âà∞ ${icon.dataset.label} ÊóÅ`
                                });
                            }
                        });
                    });
                });
            }
        };

        // ============ ÂΩóÊòüÂ∞èÁêÉÁ≥ªÁªüÔºàË°å‰∏∫Ê®°ÂºèÁâàÔºâ ============
        const CometBall = {
            // ===== Ë°å‰∏∫Ê®°Âºè =====
            BEHAVIOR: {
                LAZY: 'lazy',           // ÊáíÊï£ÔºöÂåÄÈÄüÊÖ¢Ê∏∏ÔºåÊó†ËßÑÂæã
                CURIOUS: 'curious',     // Â•ΩÂ•áÔºöÈù†ËøëUIÂÖÉÁ¥†ÔºåÂÅ∂Â∞îÁéØÁªï
                PLAYFUL: 'playful',     // Ê¥ªÊ≥ºÔºöÂø´ÈÄüÁßªÂä®ÔºåÂºπË∑≥
                SLEEPY: 'sleepy',       // Âõ∞ÂÄ¶ÔºöÂá†‰πéÈùôÊ≠¢ÔºåÂÅ∂Â∞îÁßªÂä®
                EXPLORER: 'explorer'    // Êé¢Á¥¢Ôºö‰∏ìËµ∞Á©∫ÈöôÔºåÈÅøÂºÄËâ≤Âùó
            },

            // ÂΩìÂâçË°å‰∏∫Ê®°Âºè
            currentBehavior: 'lazy',
            behaviorTime: 0,            // ÂΩìÂâçÊ®°ÂºèÊåÅÁª≠Êó∂Èó¥
            behaviorDuration: 0,        // Ê®°ÂºèËÆ°ÂàíÊåÅÁª≠Êó∂Èó¥

            // Ë°å‰∏∫Ê®°ÂºèÈÖçÁΩÆÔºàÈÄüÂ∫¶ÊèêÂçáÁâàÔºâ
            behaviorConfig: {
                lazy: {
                    speed: 1.2,           // ÊèêÈÄü
                    maxSpeed: 2.0,
                    wanderStrength: 0.02,
                    friction: 0.995,
                    duration: [5000, 10000]
                },
                curious: {
                    speed: 1.8,           // ÊèêÈÄü
                    maxSpeed: 3.0,
                    wanderStrength: 0.06,
                    friction: 0.992,
                    duration: [4000, 8000]
                },
                playful: {
                    speed: 3.0,           // ÊèêÈÄü
                    maxSpeed: 5.0,
                    wanderStrength: 0.12,
                    friction: 0.985,
                    duration: [2000, 5000]
                },
                sleepy: {
                    speed: 0.5,           // ÊèêÈÄü
                    maxSpeed: 1.0,
                    wanderStrength: 0.01,
                    friction: 0.998,
                    duration: [6000, 12000]
                },
                explorer: {
                    speed: 1.5,           // ÊèêÈÄü
                    maxSpeed: 2.5,
                    wanderStrength: 0.04,
                    friction: 0.993,
                    avoidColors: true,
                    duration: [4000, 8000]
                }
            },

            // DOM ÂÖÉÁ¥†
            element: null,
            trailCanvas: null,
            trailCtx: null,
            screen: null,

            // Â±èÂπïËæπÁïå
            bounds: { left: 10, top: 50, right: 254, bottom: 450 },

            // Áâ©ÁêÜÁä∂ÊÄÅ
            x: 130,
            y: 200,
            vx: 0.5,
            vy: 0.3,

            // Â∞æËøπÔºàÂä†ÈïøÔºåÂßãÁªàÂèØËßÅÔºâ
            trail: [],
            trailLength: 20,

            // ÂèòËâ≤ÈæôÊïàÊûú
            chameleon: {
                baseColor: { r: 96, g: 165, b: 250 },  // #60a5fa
                currentColor: { r: 96, g: 165, b: 250 },
                targetColor: { r: 96, g: 165, b: 250 },
                alpha: 0.85,
                targetAlpha: 0.85,
                isOverColor: false,
                blendSpeed: 0.03
            },

            // ÈÖçÁΩÆÔºàËΩÆÂªìËøΩË∏™‰ºòÂÖàÔºâ
            config: {
                baseSpeed: 1.5,             // Âü∫Á°ÄÈÄüÂ∫¶
                bounceDecay: 0.75,
                bounceRandom: 0.3,
                orbitDistance: 15,          // Ë¥¥ËøëËæπÁºò
                orbitSpeed: 0.06,           // ÁéØÁªïÈÄüÂ∫¶
                orbitDetectRange: 120,      // Ê£ÄÊµãËåÉÂõ¥Êõ¥Â§ß
                orbitMinLoops: 0.8,         // Ëá≥Â∞ëÁªï0.8Âúà
                orbitMaxLoops: 1.5,         // ÊúÄÂ§ö1.5Âúà
                orbitChance: 0.9,           // 90%Ê¶ÇÁéáÂºÄÂßãÁéØÁªï
                seekUIChance: 0.85,         // 85%Êó∂Èó¥ÂØªÊâæUIÂÖÉÁ¥†Ôºà‰ºòÂÖàËΩÆÂªìÔºâ
                darkBounceChance: 0.7,      // Ê∑±Ëâ≤ËæπÁºò70%ÂèçÂºπ
                lightBounceChance: 0.4      // ÊµÖËâ≤ËæπÁºò40%ÂèçÂºπ
            },

            // Êº´Ê∏∏
            wanderAngle: 0,
            time: 0,

            // Áä∂ÊÄÅÂ∏∏Èáè
            STATE: {
                IDLE: 'idle',
                ORBIT: 'orbit',
                BOUNCE: 'bounce'
            },

            // Áä∂ÊÄÅ
            currentState: 'idle',
            isSquashing: false,
            squashAxis: null,
            squashTime: 0,

            // ÁéØÁªïÁä∂ÊÄÅ
            orbit: {
                active: false,
                target: null,
                type: 'circular',
                angle: 0,
                startAngle: 0,
                totalAngle: 0,
                targetLoops: 1,
                direction: 1,
                centerX: 0, centerY: 0,
                radiusX: 0, radiusY: 0,
                rectProgress: 0,
                corners: [],
                currentCorner: 0,
                easeIn: 0, easeOut: 0
            },

            // Áî®Êà∑‰∫§‰∫í
            lastInteraction: 0,
            presence: 1.0,

            // Âä®Áîª
            running: false,
            lastFrame: 0,

            // UIÂÖÉÁ¥†ÁºìÂ≠ò
            uiElements: [],
            colorRegions: [],
            lastUIUpdate: 0,

            // ÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
            initialized: false,

            // ===== ÂàùÂßãÂåñ =====
            init() {
                // Èò≤Ê≠¢ÈáçÂ§çÂàùÂßãÂåñÂØºËá¥ÈóÆÈ¢ò
                if (this.initialized && this.running) {
                    console.log('[CometBall] Â∑≤Âú®ËøêË°å‰∏≠');
                    return;
                }

                // ÂÅúÊ≠¢‰πãÂâçÁöÑÂä®ÁîªÂæ™ÁéØ
                this.running = false;

                this.element = document.getElementById('comet-ball');
                this.trailCanvas = document.getElementById('comet-trail');
                this.screen = document.getElementById('phone-screen');

                if (!this.element || !this.trailCanvas || !this.screen) {
                    console.warn('[CometBall] ÂÖÉÁ¥†Êú™ÊâæÂà∞');
                    return;
                }

                // Ê£ÄÊü•Â±èÂπïÊòØÂê¶ÂèØËßÅÔºàÂ∞∫ÂØ∏‰∏ç‰∏∫0Ôºâ
                const rect = this.screen.getBoundingClientRect();
                if (rect.width === 0 || rect.height === 0) {
                    console.log('[CometBall] Â±èÂπï‰∏çÂèØËßÅÔºåÂª∂ËøüÂàùÂßãÂåñ...');
                    setTimeout(() => this.init(), 200);
                    return;
                }

                this.setupCanvas();

                // Ê∏ÖÁ©∫Â∞æËøπ
                this.trail = [];

                // ÈöèÊú∫ÂàùÂßã‰ΩçÁΩÆÔºàÂú®ËæπÁïåÂÜÖÔºâ
                const bw = this.bounds.right - this.bounds.left;
                const bh = this.bounds.bottom - this.bounds.top;
                this.x = this.bounds.left + 20 + Math.random() * (bw - 40);
                this.y = this.bounds.top + 20 + Math.random() * (bh - 40);
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * 1.0;
                this.vy = Math.sin(angle) * 1.0;
                this.wanderAngle = angle;

                console.log('[CometBall] ÂàùÂßã‰ΩçÁΩÆ:', this.x.toFixed(1), this.y.toFixed(1));

                // ÈáçÁΩÆÂèòËâ≤ÈæôÁä∂ÊÄÅ
                this.chameleon.currentColor = { ...this.chameleon.baseColor };
                this.chameleon.targetColor = { ...this.chameleon.baseColor };
                this.chameleon.alpha = 0.85;

                // ÂàùÂßãË°å‰∏∫Ê®°Âºè
                this.switchBehavior('lazy');

                // Âè™Âú®Á¨¨‰∏ÄÊ¨°ÂàùÂßãÂåñÊó∂ÁªëÂÆö‰∫§‰∫í
                if (!this.initialized) {
                    this.bindInteractions();
                }

                // ÂêØÂä®
                this.initialized = true;
                this.running = true;
                this.lastFrame = performance.now();

                // ‰ΩøÁî® setTimeout Á°Æ‰øùÁä∂ÊÄÅÂÆåÂÖ®ÈáçÁΩÆÂêéÂÜçÂêØÂä®
                setTimeout(() => {
                    if (this.running) {
                        this.animate();
                    }
                }, 50);

                console.log('[CometBall] ÂàùÂßãÂåñÂÆåÊàêÔºåË°å‰∏∫Ê®°ÂºèÁ≥ªÁªüÂ∑≤ÂêØÁî®');
            },

            // ËÆæÁΩÆÁîªÂ∏É
            setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                // Ëé∑ÂèñÂÆûÈôÖÂ±èÂπïÂ∞∫ÂØ∏
                const screenRect = this.screen.getBoundingClientRect();
                const width = screenRect.width || 264;
                const height = screenRect.height || 560;

                // ÈáçÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏ÔºàËøô‰ºöËá™Âä®Ê∏ÖÈô§ÁîªÂ∏ÉÂÜÖÂÆπÂíåÂèòÊç¢Ôºâ
                this.trailCanvas.width = width * dpr;
                this.trailCanvas.height = height * dpr;
                this.trailCanvas.style.width = width + 'px';
                this.trailCanvas.style.height = height + 'px';
                this.trailCtx = this.trailCanvas.getContext('2d');
                this.trailCtx.scale(dpr, dpr);

                // Êõ¥Êñ∞ËæπÁïå
                this.bounds = {
                    left: 10,
                    top: 50,
                    right: width - 10,
                    bottom: height - 110  // ÁïôÂá∫dockÂå∫Âüü
                };

                // Â≠òÂÇ®Â∞∫ÂØ∏‰æõÊ∏≤Êüì‰ΩøÁî®
                this.canvasWidth = width;
                this.canvasHeight = height;

                console.log('[CometBall] CanvasÂ∞∫ÂØ∏:', width, 'x', height);
            },

            // ===== Ë°å‰∏∫Ê®°ÂºèÂàáÊç¢ =====
            switchBehavior(newBehavior) {
                if (!this.behaviorConfig[newBehavior]) return;

                this.currentBehavior = newBehavior;
                this.behaviorTime = 0;
                const cfg = this.behaviorConfig[newBehavior];
                this.behaviorDuration = cfg.duration[0] +
                    Math.random() * (cfg.duration[1] - cfg.duration[0]);

                console.log(`[CometBall] ÂàáÊç¢Ë°å‰∏∫: ${newBehavior}, ÊåÅÁª≠ ${(this.behaviorDuration/1000).toFixed(1)}s`);
            },

            // ÈöèÊú∫ÈÄâÊã©‰∏ã‰∏Ä‰∏™Ë°å‰∏∫
            pickNextBehavior() {
                const behaviors = Object.keys(this.BEHAVIOR);
                // ÊùÉÈáçÔºölazyÊõ¥Â∏∏ËßÅ
                const weights = {
                    lazy: 3,
                    curious: 2,
                    playful: 1,
                    sleepy: 2,
                    explorer: 2
                };

                const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
                let rand = Math.random() * totalWeight;

                for (const b of behaviors) {
                    rand -= weights[b] || 1;
                    if (rand <= 0) {
                        this.switchBehavior(b);
                        return;
                    }
                }
                this.switchBehavior('lazy');
            },

            // ===== ‰∏ªÂä®ÁîªÂæ™ÁéØ =====
            animate() {
                if (!this.running) return;

                const now = performance.now();
                const dt = Math.min((now - this.lastFrame) / 16.67, 3);
                this.lastFrame = now;
                this.time += dt;

                // Êõ¥Êñ∞Ë°å‰∏∫Êó∂Èó¥
                this.behaviorTime += dt * 16.67;
                if (this.behaviorTime >= this.behaviorDuration) {
                    this.pickNextBehavior();
                }

                // Êõ¥Êñ∞Áâ©ÁêÜ
                this.update(dt);

                // Êõ¥Êñ∞ÂèòËâ≤ÈæôÊïàÊûú
                this.updateChameleon(dt);

                // Ê∏≤Êüì
                this.render();

                requestAnimationFrame(() => this.animate());
            },

            // ===== Áâ©ÁêÜÊõ¥Êñ∞ =====
            update(dt) {
                // Êõ¥Êñ∞Áî®Êà∑Ê¥ªÂä®Áä∂ÊÄÅ
                const timeSinceInteraction = Date.now() - this.lastInteraction;
                if (timeSinceInteraction < 1500) {
                    this.presence = Math.max(0.4, this.presence - 0.02);
                } else {
                    this.presence = Math.min(1.0, this.presence + 0.008);
                }

                // Êõ¥Êñ∞UIÂÖÉÁ¥†ÁºìÂ≠òÔºàÊØè500msÔºâ
                if (Date.now() - this.lastUIUpdate > 500) {
                    this.updateUIElements();
                    this.updateColorRegions();
                    this.lastUIUpdate = Date.now();
                }

                // ËΩÆÂªìËøΩË∏™‰∏∫‰∏ªÔºà70%Êó∂Èó¥ÂØªÊâæUIÂπ∂ÁéØÁªïÔºâ
                if (this.orbit.active) {
                    this.updateOrbit(dt);
                } else {
                    // ‰∏ªÂä®ÂØªÊâæUIÂÖÉÁ¥†Âπ∂ÁéØÁªï
                    const shouldSeekUI = Math.random() < this.config.seekUIChance;
                    if (shouldSeekUI && this.presence > 0.6) {
                        this.seekAndOrbit(dt);
                    }
                    // Â∏∏ËßÑË°å‰∏∫
                    this.updateByBehavior(dt);
                }

                // Êõ¥Êñ∞Êå§ÂéãÂä®Áîª
                if (this.isSquashing) {
                    this.squashTime += dt;
                    if (this.squashTime > 15) {
                        this.isSquashing = false;
                        this.squashTime = 0;
                    }
                }

                // ËÆ∞ÂΩïÂ∞æËøπ
                this.trail.push({ x: this.x, y: this.y });
                while (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
            },

            // ===== Ê†πÊçÆË°å‰∏∫Ê®°ÂºèÊõ¥Êñ∞ =====
            updateByBehavior(dt) {
                const cfg = this.behaviorConfig[this.currentBehavior];

                switch(this.currentBehavior) {
                    case 'lazy':
                        this.updateLazy(dt, cfg);
                        break;
                    case 'curious':
                        this.updateCurious(dt, cfg);
                        break;
                    case 'playful':
                        this.updatePlayful(dt, cfg);
                        break;
                    case 'sleepy':
                        this.updateSleepy(dt, cfg);
                        break;
                    case 'explorer':
                        this.updateExplorer(dt, cfg);
                        break;
                    default:
                        this.updateLazy(dt, cfg);
                }
            },

            // ===== ÊáíÊï£Ê®°ÂºèÔºöÂåÄÈÄüÊÖ¢Ê∏∏ =====
            updateLazy(dt, cfg) {
                // ÈùûÂ∏∏ÁºìÊÖ¢ÁöÑÊñπÂêëÂèòÂåñ
                this.wanderAngle += (Math.random() - 0.5) * cfg.wanderStrength * dt;

                // ‰øùÊåÅÊÅíÂÆöÈÄüÂ∫¶
                const targetSpeed = cfg.speed * this.presence;
                const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);

                if (currentSpeed < targetSpeed * 0.8) {
                    this.vx += Math.cos(this.wanderAngle) * 0.02 * dt;
                    this.vy += Math.sin(this.wanderAngle) * 0.02 * dt;
                }

                // ËΩªÂæÆÊë©Êì¶
                this.vx *= cfg.friction;
                this.vy *= cfg.friction;

                // ÈÄüÂ∫¶ÈôêÂà∂
                if (currentSpeed > cfg.maxSpeed) {
                    const scale = cfg.maxSpeed / currentSpeed;
                    this.vx *= scale;
                    this.vy *= scale;
                }

                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.checkBounds();
            },

            // ===== Â•ΩÂ•áÊ®°ÂºèÔºöÈù†ËøëUIÂÖÉÁ¥† =====
            updateCurious(dt, cfg) {
                // Ê≠£Â∏∏Êº´Ê∏∏
                this.wanderAngle += (Math.random() - 0.5) * cfg.wanderStrength * dt;

                // ÂØªÊâæÊúÄËøëÁöÑUIÂÖÉÁ¥†Âπ∂Èù†Ëøë
                let nearestUI = null;
                let minDist = Infinity;
                for (const ui of this.uiElements) {
                    const dx = ui.cx - this.x;
                    const dy = ui.cy - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < minDist && dist > 30) {
                        minDist = dist;
                        nearestUI = ui;
                    }
                }

                if (nearestUI && minDist < 150) {
                    // ËΩªÂæÆÂÅèÂêëUIÂÖÉÁ¥†
                    const attractAngle = Math.atan2(nearestUI.cy - this.y, nearestUI.cx - this.x);
                    this.wanderAngle += (attractAngle - this.wanderAngle) * 0.02 * dt;
                }

                // Â∞ùËØïÁéØÁªï
                if (Math.random() < (cfg.orbitChance || 0.02) * dt && this.presence > 0.7) {
                    this.tryStartOrbit();
                }

                this.vx += Math.cos(this.wanderAngle) * 0.03 * dt;
                this.vy += Math.sin(this.wanderAngle) * 0.03 * dt;
                this.vx *= cfg.friction;
                this.vy *= cfg.friction;

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > cfg.maxSpeed) {
                    this.vx *= cfg.maxSpeed / speed;
                    this.vy *= cfg.maxSpeed / speed;
                }

                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.checkBounds();
            },

            // ===== Ê¥ªÊ≥ºÊ®°ÂºèÔºöÂø´ÈÄüÁßªÂä® =====
            updatePlayful(dt, cfg) {
                // Âø´ÈÄüÊñπÂêëÂèòÂåñ
                this.wanderAngle += (Math.random() - 0.5) * cfg.wanderStrength * dt;
                this.wanderAngle += Math.sin(this.time * 0.1) * 0.05 * dt;

                // Âº∫ÂäõÊé®Ëøõ
                this.vx += Math.cos(this.wanderAngle) * 0.08 * dt;
                this.vy += Math.sin(this.wanderAngle) * 0.08 * dt;
                this.vx *= cfg.friction;
                this.vy *= cfg.friction;

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed < cfg.speed * 0.5) {
                    // Âä†ÈÄü
                    this.vx += Math.cos(this.wanderAngle) * 0.1 * dt;
                    this.vy += Math.sin(this.wanderAngle) * 0.1 * dt;
                } else if (speed > cfg.maxSpeed) {
                    this.vx *= cfg.maxSpeed / speed;
                    this.vy *= cfg.maxSpeed / speed;
                }

                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.checkBounds();
            },

            // ===== Âõ∞ÂÄ¶Ê®°ÂºèÔºöÂá†‰πéÈùôÊ≠¢ =====
            updateSleepy(dt, cfg) {
                // ÂÅ∂Â∞îÂæÆÂæÆÁßªÂä®
                if (Math.random() < 0.01 * dt) {
                    this.wanderAngle += (Math.random() - 0.5) * 0.5;
                    this.vx += Math.cos(this.wanderAngle) * 0.1;
                    this.vy += Math.sin(this.wanderAngle) * 0.1;
                }

                // Âº∫Êë©Êì¶‰ΩøÂÖ∂Âø´ÈÄüÂÅú‰∏ã
                this.vx *= cfg.friction;
                this.vy *= cfg.friction;

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > cfg.maxSpeed) {
                    this.vx *= cfg.maxSpeed / speed;
                    this.vy *= cfg.maxSpeed / speed;
                }

                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.checkBounds();
            },

            // ===== Êé¢Á¥¢Ê®°ÂºèÔºöËµ∞Á©∫ÈöôÔºåÈÅøËâ≤Âùó =====
            updateExplorer(dt, cfg) {
                this.wanderAngle += (Math.random() - 0.5) * cfg.wanderStrength * dt;

                // ÈÅøÂºÄÊúâÈ¢úËâ≤ÁöÑÂå∫Âüü
                for (const region of this.colorRegions) {
                    const dx = this.x - region.cx;
                    const dy = this.y - region.cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < region.radius + 30) {
                        // ÂÅèÁ¶ªËâ≤ÂùóÂå∫Âüü
                        const repelAngle = Math.atan2(dy, dx);
                        const force = (region.radius + 30 - dist) / 30 * 0.1;
                        this.vx += Math.cos(repelAngle) * force * dt;
                        this.vy += Math.sin(repelAngle) * force * dt;
                    }
                }

                this.vx += Math.cos(this.wanderAngle) * 0.03 * dt;
                this.vy += Math.sin(this.wanderAngle) * 0.03 * dt;
                this.vx *= cfg.friction;
                this.vy *= cfg.friction;

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > cfg.maxSpeed) {
                    this.vx *= cfg.maxSpeed / speed;
                    this.vy *= cfg.maxSpeed / speed;
                }

                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.checkBounds();
            },

            // ===== Êõ¥Êñ∞È¢úËâ≤Âå∫ÂüüÁºìÂ≠ò =====
            updateColorRegions() {
                if (!this.screen) return;

                const screenRect = this.screen.getBoundingClientRect();
                const coloredElements = this.screen.querySelectorAll('.widget, .control-center, .status-bar, .dock, .app-folder-expanded');

                this.colorRegions = [];
                coloredElements.forEach(el => {
                    const rect = el.getBoundingClientRect();
                    const style = window.getComputedStyle(el);
                    const bgColor = style.backgroundColor;

                    // Ëß£ÊûêÈ¢úËâ≤
                    const rgb = this.parseColor(bgColor);
                    if (rgb && (rgb.r > 50 || rgb.g > 50 || rgb.b > 50)) {
                        this.colorRegions.push({
                            cx: rect.left - screenRect.left + rect.width / 2,
                            cy: rect.top - screenRect.top + rect.height / 2,
                            width: rect.width,
                            height: rect.height,
                            radius: Math.max(rect.width, rect.height) / 2,
                            color: rgb
                        });
                    }
                });
            },

            // Ëß£ÊûêÈ¢úËâ≤Â≠óÁ¨¶‰∏≤
            parseColor(colorStr) {
                if (!colorStr || colorStr === 'transparent') return null;
                const match = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (match) {
                    return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
                }
                return null;
            },

            // ===== ÂèòËâ≤ÈæôÊïàÊûú =====
            updateChameleon(dt) {
                const c = this.chameleon;

                // Ê£ÄÊµãÊòØÂê¶Âú®Ëâ≤ÂùóÂå∫Âüü‰∏ä
                let isOver = false;
                let blendColor = null;

                for (const region of this.colorRegions) {
                    const dx = this.x - region.cx;
                    const dy = this.y - region.cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < region.radius) {
                        isOver = true;
                        blendColor = region.color;
                        break;
                    }
                }

                if (isOver && blendColor) {
                    c.isOverColor = true;
                    // ÁõÆÊ†áÈ¢úËâ≤Ôºö‰∏éËÉåÊôØËâ≤Ê∑∑Âêà
                    c.targetColor = {
                        r: Math.floor(c.baseColor.r * 0.3 + blendColor.r * 0.7),
                        g: Math.floor(c.baseColor.g * 0.3 + blendColor.g * 0.7),
                        b: Math.floor(c.baseColor.b * 0.3 + blendColor.b * 0.7)
                    };
                    c.targetAlpha = 0.4;  // ÂçäÈÄèÊòé
                } else {
                    c.isOverColor = false;
                    c.targetColor = { ...c.baseColor };
                    c.targetAlpha = 0.85;
                }

                // Âπ≥ÊªëËøáÊ∏°
                c.currentColor.r += (c.targetColor.r - c.currentColor.r) * c.blendSpeed * dt;
                c.currentColor.g += (c.targetColor.g - c.currentColor.g) * c.blendSpeed * dt;
                c.currentColor.b += (c.targetColor.b - c.currentColor.b) * c.blendSpeed * dt;
                c.alpha += (c.targetAlpha - c.alpha) * c.blendSpeed * dt;
            },

            // Êõ¥Êñ∞UIÂÖÉÁ¥†ÁºìÂ≠ò
            updateUIElements() {
                if (!this.screen) return;

                const screenRect = this.screen.getBoundingClientRect();
                const elements = this.screen.querySelectorAll('.widget, .app-folder, .touch-icon:not(.dock-icon)');

                this.uiElements = [];
                elements.forEach(el => {
                    const rect = el.getBoundingClientRect();
                    const cx = rect.left - screenRect.left + rect.width / 2;
                    const cy = rect.top - screenRect.top + rect.height / 2;
                    const w = rect.width;
                    const h = rect.height;

                    // Âà§Êñ≠ÂΩ¢Áä∂Á±ªÂûã
                    const isLarge = w > 80 || h > 80;
                    const aspectRatio = w / h;
                    const isRectangular = aspectRatio > 1.5 || aspectRatio < 0.67;

                    this.uiElements.push({
                        element: el,
                        cx: cx,
                        cy: cy,
                        width: w,
                        height: h,
                        radius: Math.max(w, h) / 2,
                        type: isLarge && isRectangular ? 'rectangular' : 'circular',
                        isWidget: el.classList.contains('widget')
                    });
                });
            },

            // Â∞ùËØïÂºÄÂßãÁéØÁªï
            // ===== ‰∏ªÂä®ÂØªÊâæUIÂÖÉÁ¥†Âπ∂ÁéØÁªï =====
            seekAndOrbit(dt) {
                if (this.uiElements.length === 0) return;

                // ÊâæÂà∞ÊúÄËøëÁöÑUIÂÖÉÁ¥†
                let nearestUI = null;
                let minDist = Infinity;

                for (const ui of this.uiElements) {
                    const dx = this.x - ui.cx;
                    const dy = this.y - ui.cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < minDist) {
                        minDist = dist;
                        nearestUI = ui;
                    }
                }

                if (!nearestUI) return;

                const detectRange = this.config.orbitDetectRange;

                // Â¶ÇÊûúÂú®Ê£ÄÊµãËåÉÂõ¥ÂÜÖÔºå80%Ê¶ÇÁéáÂºÄÂßãÁéØÁªï
                if (minDist < detectRange + nearestUI.radius) {
                    if (Math.random() < this.config.orbitChance) {
                        this.startOrbit(nearestUI);
                        return;
                    }
                }

                // Âê¶ÂàôÔºåÊúùÊúÄËøëÁöÑUIÂÖÉÁ¥†ÁßªÂä®
                if (minDist > 30) {
                    const attractAngle = Math.atan2(nearestUI.cy - this.y, nearestUI.cx - this.x);
                    // ÂÅèÂêëUIÂÖÉÁ¥†
                    this.wanderAngle += (attractAngle - this.wanderAngle) * 0.05 * dt;
                }
            },

            tryStartOrbit() {
                const detectRange = this.config.orbitDetectRange;

                for (const ui of this.uiElements) {
                    const dx = this.x - ui.cx;
                    const dy = this.y - ui.cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Âú®Ê£ÄÊµãËåÉÂõ¥ÂÜÖÔºå80%Ê¶ÇÁéáÁéØÁªï
                    if (dist < detectRange + ui.radius) {
                        if (Math.random() < this.config.orbitChance) {
                            this.startOrbit(ui);
                            return;
                        }
                    }
                }
            },

            // ÂºÄÂßãÁéØÁªï
            startOrbit(uiElement) {
                const o = this.orbit;
                o.active = true;
                o.target = uiElement;
                o.type = uiElement.type;
                // 80%È°∫Êó∂ÈíàÔºå20%ÈÄÜÊó∂Èíà
                o.direction = Math.random() < 0.8 ? 1 : -1;
                o.targetLoops = this.config.orbitMinLoops +
                    Math.random() * (this.config.orbitMaxLoops - this.config.orbitMinLoops);
                o.totalAngle = 0;
                o.easeIn = 0;
                o.easeOut = 0;

                // ËÆ°ÁÆóËµ∑ÂßãËßíÂ∫¶Ôºà‰ªéÂΩìÂâç‰ΩçÁΩÆÂà∞‰∏≠ÂøÉÁöÑËßíÂ∫¶Ôºâ
                const dx = this.x - uiElement.cx;
                const dy = this.y - uiElement.cy;
                o.startAngle = Math.atan2(dy, dx);
                o.angle = o.startAngle;

                o.centerX = uiElement.cx;
                o.centerY = uiElement.cy;

                if (o.type === 'circular') {
                    // ÂúÜÂΩ¢/Ê§≠ÂúÜÁéØÁªï
                    o.radiusX = uiElement.width / 2 + this.config.orbitDistance;
                    o.radiusY = uiElement.height / 2 + this.config.orbitDistance;
                } else {
                    // Áü©ÂΩ¢ÁéØÁªï - ËÆ°ÁÆóÂõõ‰∏™Ëßí
                    const padding = this.config.orbitDistance;
                    const hw = uiElement.width / 2 + padding;
                    const hh = uiElement.height / 2 + padding;
                    const cx = uiElement.cx;
                    const cy = uiElement.cy;

                    // ÂúÜËßíÂçäÂæÑ
                    const cornerRadius = 15;

                    o.corners = [
                        { x: cx - hw, y: cy - hh }, // Â∑¶‰∏ä
                        { x: cx + hw, y: cy - hh }, // Âè≥‰∏ä
                        { x: cx + hw, y: cy + hh }, // Âè≥‰∏ã
                        { x: cx - hw, y: cy + hh }  // Â∑¶‰∏ã
                    ];
                    o.cornerRadius = cornerRadius;
                    o.rectWidth = hw * 2;
                    o.rectHeight = hh * 2;

                    // ÊâæÂà∞ÊúÄËøëÁöÑËßíÂºÄÂßã
                    let minDist = Infinity;
                    let startCorner = 0;
                    o.corners.forEach((c, i) => {
                        const d = Math.sqrt((this.x - c.x) ** 2 + (this.y - c.y) ** 2);
                        if (d < minDist) {
                            minDist = d;
                            startCorner = i;
                        }
                    });
                    o.currentCorner = startCorner;
                    o.rectProgress = 0;
                    o.rectPhase = 0; // 0=Ëæπ, 1=Ëßí
                }

                this.currentState = this.STATE.ORBIT;
                console.log('[CometBall] ÂºÄÂßãÁéØÁªï:', o.type, 'ÁõÆÊ†áÂúàÊï∞:', o.targetLoops.toFixed(1));
            },

            // Êõ¥Êñ∞ÁéØÁªïËøêÂä®
            updateOrbit(dt) {
                const o = this.orbit;
                const speed = this.config.orbitSpeed * this.presence * 1.5;  // Âä†Âø´ÁéØÁªïÈÄüÂ∫¶

                // Âø´ÈÄüÊ∏êÂÖ•
                if (o.easeIn < 1) {
                    o.easeIn = Math.min(1, o.easeIn + dt * 0.1);
                }

                // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê
                const targetAngle = o.targetLoops * Math.PI * 2;
                if (o.totalAngle >= targetAngle) {
                    o.easeOut = Math.min(1, o.easeOut + dt * 0.1);
                    if (o.easeOut >= 1) {
                        this.endOrbit();
                        return;
                    }
                }

                const easeFactor = o.easeIn * (1 - o.easeOut * 0.5);

                if (o.type === 'circular') {
                    this.updateCircularOrbit(dt, speed, easeFactor);
                } else {
                    this.updateRectangularOrbit(dt, speed, easeFactor);
                }

                o.totalAngle += speed * dt * easeFactor;

                // ‰øùÊåÅÂú®ËæπÁïåÂÜÖ
                this.x = Math.max(this.bounds.left, Math.min(this.bounds.right, this.x));
                this.y = Math.max(this.bounds.top, Math.min(this.bounds.bottom, this.y));
            },

            // ÂúÜÂΩ¢ÁéØÁªïÊõ¥Êñ∞
            updateCircularOrbit(dt, speed, easeFactor) {
                const o = this.orbit;

                // Êõ¥Êñ∞ËßíÂ∫¶
                o.angle += speed * o.direction * dt * easeFactor;

                // ËÆ°ÁÆóÁõÆÊ†á‰ΩçÁΩÆ
                const targetX = o.centerX + Math.cos(o.angle) * o.radiusX;
                const targetY = o.centerY + Math.sin(o.angle) * o.radiusY;

                // Âø´ÈÄüÂπ≥ÊªëÁßªÂä®Âà∞ÁõÆÊ†á‰ΩçÁΩÆ
                const smoothness = 0.25 * easeFactor;  // ÊèêÈ´òË∑üË∏™ÈÄüÂ∫¶
                const prevX = this.x;
                const prevY = this.y;

                this.x += (targetX - this.x) * smoothness;
                this.y += (targetY - this.y) * smoothness;

                // Êõ¥Êñ∞ÈÄüÂ∫¶ÔºàÁî®‰∫éÂ∞æËøπËÆ°ÁÆóÔºâ
                this.vx = (this.x - prevX) / dt;
                this.vy = (this.y - prevY) / dt;

                // Êõ¥Êñ∞Êº´Ê∏∏ËßíÂ∫¶ÔºàÂπ≥ÊªëËøáÊ∏°Ôºâ
                this.wanderAngle = o.angle + (o.direction > 0 ? Math.PI / 2 : -Math.PI / 2);
            },

            // Áü©ÂΩ¢ÁéØÁªïÊõ¥Êñ∞
            updateRectangularOrbit(dt, speed, easeFactor) {
                const o = this.orbit;

                // ËÆ°ÁÆóÂë®ÈïøÔºàÁî®‰∫éÂΩí‰∏ÄÂåñÈÄüÂ∫¶Ôºâ
                const perimeter = o.rectWidth * 2 + o.rectHeight * 2;
                const progressSpeed = speed * 80 / perimeter * easeFactor;  // Âä†Âø´Ê≤øËæπÈÄüÂ∫¶

                o.rectProgress += progressSpeed * dt;

                // ÂΩìÂâçËæπÂíå‰∏ã‰∏Ä‰∏™Ëßí
                const currentCorner = o.currentCorner;
                const nextCorner = (currentCorner + o.direction + 4) % 4;

                const c1 = o.corners[currentCorner];
                const c2 = o.corners[nextCorner];

                // Ê≤øËæπÁßªÂä®
                if (o.rectProgress >= 1) {
                    o.rectProgress = 0;
                    o.currentCorner = nextCorner;
                }

                // ËÆ°ÁÆóÁõÆÊ†á‰ΩçÁΩÆÔºàÂ∏¶ÂúÜËßíÔºâ
                const t = o.rectProgress;
                const cornerT = 0.15; // ËßíËêΩËøáÊ∏°Âå∫Âüü

                let targetX, targetY;

                if (t < cornerT) {
                    // Á¶ªÂºÄËßíËêΩÁöÑÂúÜÂºß
                    const arcT = t / cornerT;
                    const arcAngle = this.getCornerAngle(currentCorner, o.direction, arcT);
                    const arcCenterX = c1.x + (c2.x > c1.x ? 1 : c2.x < c1.x ? -1 : 0) * o.cornerRadius;
                    const arcCenterY = c1.y + (c2.y > c1.y ? 1 : c2.y < c1.y ? -1 : 0) * o.cornerRadius;
                    targetX = c1.x + (arcCenterX - c1.x) * (1 - Math.cos(arcT * Math.PI / 2));
                    targetY = c1.y + (arcCenterY - c1.y) * (1 - Math.cos(arcT * Math.PI / 2));
                } else if (t > 1 - cornerT) {
                    // ËøõÂÖ•ËßíËêΩÁöÑÂúÜÂºß
                    const arcT = (t - (1 - cornerT)) / cornerT;
                    targetX = c1.x + (c2.x - c1.x) * (1 - (1 - arcT) * 0.1);
                    targetY = c1.y + (c2.y - c1.y) * (1 - (1 - arcT) * 0.1);
                } else {
                    // Áõ¥Á∫øÊÆµ
                    const lineT = (t - cornerT) / (1 - 2 * cornerT);
                    targetX = c1.x + (c2.x - c1.x) * lineT;
                    targetY = c1.y + (c2.y - c1.y) * lineT;
                }

                // Âø´ÈÄüÂπ≥ÊªëÁßªÂä®
                const smoothness = 0.3 * easeFactor;  // ÊèêÈ´òË∑üË∏™ÈÄüÂ∫¶
                const prevX = this.x;
                const prevY = this.y;

                this.x += (targetX - this.x) * smoothness;
                this.y += (targetY - this.y) * smoothness;

                // Êõ¥Êñ∞ÈÄüÂ∫¶
                this.vx = (this.x - prevX) / dt;
                this.vy = (this.y - prevY) / dt;

                // Êõ¥Êñ∞Êº´Ê∏∏ËßíÂ∫¶
                this.wanderAngle = Math.atan2(this.vy, this.vx);
            },

            // Ëé∑ÂèñËßíËêΩÁöÑÂºßÁ∫øËßíÂ∫¶
            getCornerAngle(corner, direction, t) {
                const baseAngles = [Math.PI * 1.25, Math.PI * 1.75, Math.PI * 0.25, Math.PI * 0.75];
                const base = baseAngles[corner];
                return base + direction * t * Math.PI / 2;
            },

            // ÁªìÊùüÁéØÁªï
            endOrbit() {
                const o = this.orbit;
                o.active = false;
                o.target = null;

                // ÊÅ¢Â§çÊº´Ê∏∏ÈÄüÂ∫¶
                const speed = this.config.baseSpeed;
                this.vx = Math.cos(this.wanderAngle) * speed;
                this.vy = Math.sin(this.wanderAngle) * speed;

                this.currentState = this.STATE.IDLE;
                console.log('[CometBall] ÁéØÁªïÁªìÊùü');
            },

            // ËæπÁïåÊ£ÄÊµãÔºàÂê´È¢úËâ≤Âà§Êñ≠ÂèçÂºπÔºâ
            checkBounds() {
                let bounced = false;

                // Â∑¶ËæπÁïå
                if (this.x < this.bounds.left) {
                    this.x = this.bounds.left;
                    if (this.shouldBounceAtEdge('left')) {
                        this.bounceX();
                        bounced = true;
                    } else {
                        this.slideAlongEdge('left');
                    }
                }
                // Âè≥ËæπÁïå
                if (this.x > this.bounds.right) {
                    this.x = this.bounds.right;
                    if (this.shouldBounceAtEdge('right')) {
                        this.bounceX();
                        bounced = true;
                    } else {
                        this.slideAlongEdge('right');
                    }
                }
                // ‰∏äËæπÁïå
                if (this.y < this.bounds.top) {
                    this.y = this.bounds.top;
                    if (this.shouldBounceAtEdge('top')) {
                        this.bounceY();
                        bounced = true;
                    } else {
                        this.slideAlongEdge('top');
                    }
                }
                // ‰∏ãËæπÁïå
                if (this.y > this.bounds.bottom) {
                    this.y = this.bounds.bottom;
                    if (this.shouldBounceAtEdge('bottom')) {
                        this.bounceY();
                        bounced = true;
                    } else {
                        this.slideAlongEdge('bottom');
                    }
                }

                // UIÂÖÉÁ¥†ËæπÁºòÁ¢∞ÊíûÊ£ÄÊµã
                this.checkUICollision();

                return bounced;
            },

            // Âà§Êñ≠ÊòØÂê¶Â∫îËØ•ÂèçÂºπÔºàÂü∫‰∫éËæπÁºòÈ¢úËâ≤Ôºâ
            shouldBounceAtEdge(edge) {
                // Ê£ÄÊµãÂΩìÂâç‰ΩçÁΩÆÈôÑËøëÊòØÂê¶ÊúâÈ¢úËâ≤Âå∫Âüü
                const nearbyColor = this.getColorAtPosition(this.x, this.y);

                if (nearbyColor) {
                    // ËÆ°ÁÆó‰∫ÆÂ∫¶ (0-255)
                    const brightness = (nearbyColor.r + nearbyColor.g + nearbyColor.b) / 3;
                    // Ê∑±Ëâ≤ < 100, ÊµÖËâ≤ >= 100
                    if (brightness < 100) {
                        // Ê∑±Ëâ≤ËæπÁºòÔºö70%ÂèçÂºπ
                        return Math.random() < this.config.darkBounceChance;
                    } else {
                        // ÊµÖËâ≤ËæπÁºòÔºö40%ÂèçÂºπ
                        return Math.random() < this.config.lightBounceChance;
                    }
                }
                // ÈªòËÆ§ÂèçÂºπ
                return true;
            },

            // Ëé∑ÂèñÊåáÂÆö‰ΩçÁΩÆÁöÑÈ¢úËâ≤
            getColorAtPosition(x, y) {
                for (const region of this.colorRegions) {
                    const dx = x - region.cx;
                    const dy = y - region.cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < region.radius + 20) {
                        return region.color;
                    }
                }
                return null;
            },

            // Ê≤øËæπÁºòÊªëÂä®Ôºà‰∏çÂèçÂºπÊó∂Ôºâ
            slideAlongEdge(edge) {
                const slideSpeed = 0.8;
                if (edge === 'left' || edge === 'right') {
                    this.vx *= 0.1;  // Â§ßÂπÖÂáèÈÄüX
                    // ‰øùÊåÅYÊñπÂêëËøêÂä®
                } else {
                    this.vy *= 0.1;  // Â§ßÂπÖÂáèÈÄüY
                    // ‰øùÊåÅXÊñπÂêëËøêÂä®
                }
            },

            // UIÂÖÉÁ¥†ËæπÁºòÁ¢∞Êíû
            checkUICollision() {
                for (const ui of this.uiElements) {
                    const dx = this.x - ui.cx;
                    const dy = this.y - ui.cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const edgeDist = ui.radius + 5;

                    // Á¢∞Âà∞UIËæπÁºò
                    if (dist < edgeDist && dist > edgeDist - 15) {
                        // Âà§Êñ≠ÊòØÊ∑±Ëâ≤ËøòÊòØÊµÖËâ≤
                        const color = this.getColorAtPosition(ui.cx, ui.cy);
                        let bounceChance = 0.5;

                        if (color) {
                            const brightness = (color.r + color.g + color.b) / 3;
                            bounceChance = brightness < 100
                                ? this.config.darkBounceChance
                                : this.config.lightBounceChance;
                        }

                        if (Math.random() < bounceChance) {
                            // ÂèçÂºπÔºöËøúÁ¶ªUI‰∏≠ÂøÉ
                            const angle = Math.atan2(dy, dx);
                            const pushForce = 0.5;
                            this.vx += Math.cos(angle) * pushForce;
                            this.vy += Math.sin(angle) * pushForce;
                        }
                        // ‰∏çÂèçÂºπÊó∂ÔºöÁªßÁª≠Ê≤øËæπÁºòÁßªÂä®ÔºàÁî±orbitÂ§ÑÁêÜÔºâ
                    }
                }
            },

            // XËΩ¥ÂèçÂºπ
            bounceX() {
                this.vx = -this.vx * this.config.bounceDecay;
                this.vy += (Math.random() - 0.5) * this.config.bounceRandom * Math.abs(this.vx);
                this.wanderAngle = Math.atan2(this.vy, this.vx);
                this.startSquash('x');
                this.disturbTrail();
            },

            // YËΩ¥ÂèçÂºπ
            bounceY() {
                this.vy = -this.vy * this.config.bounceDecay;
                this.vx += (Math.random() - 0.5) * this.config.bounceRandom * Math.abs(this.vy);
                this.wanderAngle = Math.atan2(this.vy, this.vx);
                this.startSquash('y');
                this.disturbTrail();
            },

            // ÂºÄÂßãÊå§ÂéãÂä®Áîª
            startSquash(axis) {
                this.isSquashing = true;
                this.squashAxis = axis;
                this.squashTime = 0;
            },

            // Â∞æËøπÊâ∞Âä®
            disturbTrail() {
                for (let i = 0; i < this.trail.length; i++) {
                    const factor = 1 - i / this.trail.length;
                    this.trail[i].x += (Math.random() - 0.5) * 4 * factor;
                    this.trail[i].y += (Math.random() - 0.5) * 4 * factor;
                }
            },

            // Ê∏≤Êüì
            render() {
                // Ê∏≤ÊüìÂ∞æËøπ
                this.renderTrail();

                // Êõ¥Êñ∞Â∞èÁêÉ‰ΩçÁΩÆ
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';

                // Êå§ÂéãÂèòÂΩ¢
                let scaleX = 1, scaleY = 1;
                if (this.isSquashing) {
                    const t = this.squashTime / 15;
                    const squash = Math.sin(t * Math.PI) * 0.3;
                    if (this.squashAxis === 'x') {
                        scaleX = 1 - squash;
                        scaleY = 1 + squash * 0.6;
                    } else {
                        scaleX = 1 + squash * 0.6;
                        scaleY = 1 - squash;
                    }
                }

                // ÈÄüÂ∫¶Êãâ‰º∏
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                const stretch = Math.min(speed / 3, 0.15);
                const angle = Math.atan2(this.vy, this.vx);

                this.element.style.transform = `translate(-50%, -50%) scale(${scaleX}, ${scaleY})`;
                this.element.style.opacity = 0.5 + this.presence * 0.5;
            },

            // Ê∏≤ÊüìÂ∞æËøπ - ÂèòËâ≤ÈæôÈ£éÊ†ºÔºàÂßãÁªàÂèØËßÅÔºâ
            renderTrail() {
                const ctx = this.trailCtx;
                const w = this.canvasWidth || 264;
                const h = this.canvasHeight || 560;
                ctx.clearRect(0, 0, w, h);

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                // Â§¥ÈÉ®Â§ßÂ∞èÔºöÊúÄÂ∞è5pxÔºåÈöèÈÄüÂ∫¶Â¢ûÂ§ß
                const headRadius = Math.max(5, 4 + speed * 0.6);

                // ‰ΩøÁî®ÂèòËâ≤ÈæôÈ¢úËâ≤
                const c = this.chameleon;
                const color = `rgb(${Math.floor(c.currentColor.r)}, ${Math.floor(c.currentColor.g)}, ${Math.floor(c.currentColor.b)})`;
                const baseAlpha = c.alpha * this.presence;

                // ===== ÁªòÂà∂Â∞æÂ∑¥ÔºàÂßãÁªàÂèØËßÅÁöÑÈÄíÂáèÂúÜÂΩ¢Ôºâ =====
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length; i++) {
                        const t = this.trail[i];
                        const progress = (i + 1) / this.trail.length;
                        // Â∞∫ÂØ∏ÔºöÊúÄÂ∞è1pxÔºå‰øùËØÅÂ∞æÂ∑¥ÂßãÁªàÂèØËßÅ
                        const size = Math.max(1, headRadius * progress * 0.85);
                        // ÈÄèÊòéÂ∫¶ÔºöÂ∞æÁ´Ø‰πü‰øùÊåÅ‰∏ÄÂÆöÂèØËßÅÂ∫¶
                        const alpha = Math.max(0.1, baseAlpha * progress * progress * 0.6);

                        ctx.beginPath();
                        ctx.arc(t.x, t.y, size, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.globalAlpha = alpha;
                        ctx.fill();
                    }
                }
                ctx.globalAlpha = 1;

                // ===== ÁªòÂà∂Â§¥ÈÉ®ÔºàÂèëÂÖâÁöÑÁêÉ‰ΩìÔºâ =====
                ctx.beginPath();
                ctx.arc(this.x, this.y, headRadius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.globalAlpha = baseAlpha;
                ctx.shadowColor = color;
                ctx.shadowBlur = c.isOverColor ? 6 : 12;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1;
            },

            // ÁªëÂÆö‰∫§‰∫í
            bindInteractions() {
                // Áî®Êà∑Ê¥ªÂä®Ê£ÄÊµã
                this.screen.addEventListener('mousedown', () => {
                    this.lastInteraction = Date.now();
                });
                this.screen.addEventListener('click', (e) => {
                    this.lastInteraction = Date.now();
                    // Ë¢´ÁÇπÂáª‰ΩçÁΩÆÂºπÂºÄ
                    const rect = this.screen.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const clickY = e.clientY - rect.top;
                    this.pushAwayFrom(clickX, clickY, 8, 80);
                });

                // ÁõëÂê¨Â∫îÁî®ÊâìÂºÄ‰∫ã‰ª∂ - ÂºπÂºÄÂ∞èÁêÉ
                this.screen.addEventListener('click', (e) => {
                    const target = e.target.closest('.touch-icon, .app-folder, .widget');
                    if (target) {
                        const rect = target.getBoundingClientRect();
                        const screenRect = this.screen.getBoundingClientRect();
                        const centerX = rect.left - screenRect.left + rect.width / 2;
                        const centerY = rect.top - screenRect.top + rect.height / 2;
                        // Âº∫ÂäõÂºπÂºÄ
                        setTimeout(() => {
                            this.pushAwayFrom(centerX, centerY, 12, 120);
                        }, 50);
                    }
                });
            },

            // ‰ªéÊüêÁÇπÂºπÂºÄ
            pushAwayFrom(px, py, strength, radius) {
                const dx = this.x - px;
                const dy = this.y - py;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < radius && dist > 0) {
                    const force = strength * (1 - dist / radius);
                    this.vx += (dx / dist) * force;
                    this.vy += (dy / dist) * force;
                    this.wanderAngle = Math.atan2(this.vy, this.vx);

                    // Êå§ÂéãÊïàÊûú
                    if (Math.abs(dx) > Math.abs(dy)) {
                        this.startSquash('x');
                    } else {
                        this.startSquash('y');
                    }
                }
            },

            // ============ ÂÖ¨ÂºÄ API ============
            getState() {
                return {
                    position: { x: this.x, y: this.y },
                    velocity: { x: this.vx, y: this.vy },
                    speed: Math.sqrt(this.vx * this.vx + this.vy * this.vy),
                    state: this.currentState,
                    presence: this.presence
                };
            },

            setPosition(x, y) {
                this.x = Math.max(this.bounds.left, Math.min(this.bounds.right, x));
                this.y = Math.max(this.bounds.top, Math.min(this.bounds.bottom, y));
            },

            applyForce(fx, fy) {
                this.vx += fx;
                this.vy += fy;
            },

            hide() {
                this.element.style.display = 'none';
                this.trailCanvas.style.display = 'none';
            },

            show() {
                this.element.style.display = '';
                this.trailCanvas.style.display = '';
            },

            // Âº∫Âà∂ÈáçÂêØÂ∞èÁêÉ
            restart() {
                console.log('[CometBall] Âº∫Âà∂ÈáçÂêØ...');
                this.running = false;
                this.initialized = false;
                // Âª∂ËøüÈáçÊñ∞ÂàùÂßãÂåñÔºåÁ°Æ‰øùÂä®ÁîªÂæ™ÁéØÂ∑≤ÂÅúÊ≠¢
                setTimeout(() => {
                    this.init();
                }, 100);
            }
        };

        // ÈáçÂêØÂΩóÊòüÂ∞èÁêÉ
        function restartCometBall() {
            CometBall.restart();
            showToast('ÂΩóÊòüÂ∞èÁêÉÂ∑≤ÈáçÁΩÆ', 'success');
        }

        // ÂàùÂßãÂåñÈ∏øËíôËØïÈ™åÁî∞
        function initHarmonyOSLab() {
            updatePhoneTime();
            setInterval(updatePhoneTime, 60000);
            loadLabData();
            // ÂàùÂßãÂåñËß¶Â±èÊ®°ÊãüÂô®
            TouchSimulator.init();
            // ÂàùÂßãÂåñÊ°åÈù¢ÁÆ°ÁêÜÂô®
            DesktopManager.init();
            // ÂàùÂßãÂåñÂΩóÊòüÂ∞èÁêÉ
            CometBall.init();
        }

        // Êõ¥Êñ∞ÊâãÊú∫Êó∂Èó¥
        function updatePhoneTime() {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                           now.getMinutes().toString().padStart(2, '0');
            const phoneTime = document.getElementById('phone-time');
            if (phoneTime) {
                phoneTime.textContent = timeStr;
            }
        }

        // Âä†ËΩΩËØïÈ™åÁî∞Êï∞ÊçÆ
        async function loadLabData() {
            try {
                const response = await fetch('/api/harmonyos-lab/data');
                if (response.ok) {
                    const data = await response.json();
                    harmonyOSLab.apps = data.installedApps || [];
                    harmonyOSLab.logs = data.logs || [];
                    renderLauncherGrid();
                    renderLabLogs();
                }
            } catch (err) {
                console.log('Lab data not loaded:', err);
            }
        }

        // ÂàáÊç¢ËØïÈ™åÁî∞ÂäüËÉΩÂå∫
        function switchLabSection(section) {
            harmonyOSLab.currentSection = section;

            // Êõ¥Êñ∞ÂØºËà™Ê†∑Âºè
            document.querySelectorAll('.lab-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });

            // ÂàáÊç¢Èù¢Êùø
            document.querySelectorAll('.lab-section').forEach(panel => {
                panel.style.display = 'none';
            });
            const sectionPanel = document.getElementById('lab-section-' + section);
            if (sectionPanel) {
                sectionPanel.style.display = 'block';
            }
        }

        // Ê∏≤ÊüìÂ∫îÁî®ÂêØÂä®Âô®
        function renderLauncherGrid() {
            const grid = document.getElementById('launcher-grid');
            if (!grid) return;

            if (harmonyOSLab.apps.length === 0) {
                grid.innerHTML = `
                    <div class="launcher-empty">
                        <p>ÊöÇÊó†Â∫îÁî®</p>
                        <small>Âú®"Â∫îÁî®ÁÆ°ÁêÜ"‰∏≠Ê∑ªÂä†Â∫îÁî®</small>
                    </div>
                `;
                return;
            }

            grid.innerHTML = harmonyOSLab.apps.map(app => `
                <div class="app-icon" onclick="launchApp('${app.id}')" title="${app.name}">
                    <span class="icon">${app.icon || 'üì±'}</span>
                    <span class="name">${app.name}</span>
                </div>
            `).join('');
        }

        // ÂêØÂä®Â∫îÁî®
        function launchApp(appId) {
            const app = harmonyOSLab.apps.find(a => a.id === appId);
            if (!app) return;

            harmonyOSLab.phoneState.currentApp = app;
            addLabLog('info', `ÂêØÂä®Â∫îÁî®: ${app.name}`);

            const content = document.getElementById('phone-content');
            content.innerHTML = `
                <div class="app-view">
                    <div class="app-header">
                        <span class="app-title">${app.name}</span>
                    </div>
                    <div class="app-body" id="app-body-${appId}">
                        ${app.content || '<p>Â∫îÁî®ÂÜÖÂÆπÂå∫Âüü</p>'}
                    </div>
                </div>
            `;
        }

        // ÊâãÊú∫ÂØºËà™ÔºöËøîÂõû
        function phoneNavBack() {
            if (harmonyOSLab.phoneState.currentApp) {
                phoneNavHome();
            }
        }

        // ÊâãÊú∫ÂØºËà™Ôºö‰∏ªÈ°µ
        function phoneNavHome() {
            harmonyOSLab.phoneState.currentApp = null;
            const content = document.getElementById('phone-content');
            content.innerHTML = `
                <div class="launcher-grid" id="launcher-grid"></div>
            `;
            renderLauncherGrid();
        }

        // ÊâãÊú∫ÂØºËà™ÔºöÊúÄËøëÂ∫îÁî®
        function phoneNavRecent() {
            addLabLog('info', 'ÊâìÂºÄÊúÄËøëÂ∫îÁî®');
            showToast('ÊúÄËøëÂ∫îÁî®ÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
        }

        // ÊóãËΩ¨ÊâãÊú∫
        function rotatePhone() {
            const frame = document.querySelector('.phone-frame');
            harmonyOSLab.phoneState.isRotated = !harmonyOSLab.phoneState.isRotated;
            frame.classList.toggle('rotated', harmonyOSLab.phoneState.isRotated);
            addLabLog('info', harmonyOSLab.phoneState.isRotated ? 'Ê®™Â±èÊ®°Âºè' : 'Á´ñÂ±èÊ®°Âºè');
        }

        // Êà™ÂõæÊâãÊú∫
        function screenshotPhone() {
            addLabLog('info', 'Êà™ÂõæÂ∑≤‰øùÂ≠ò');
            showToast('Êà™ÂõæÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
        }

        // ÈáçÂêØÊâãÊú∫
        function restartPhone() {
            addLabLog('warning', 'Ê®°ÊãüÂô®ÈáçÂêØ‰∏≠...');
            const screen = document.getElementById('phone-screen');
            screen.classList.add('restarting');
            setTimeout(() => {
                screen.classList.remove('restarting');
                phoneNavHome();
                addLabLog('success', 'Ê®°ÊãüÂô®Â∑≤ÈáçÂêØ');
            }, 1500);
        }

        // ÂàõÂª∫Êñ∞Â∫îÁî®
        function createNewApp() {
            const name = prompt('ËØ∑ËæìÂÖ•Â∫îÁî®ÂêçÁß∞Ôºö');
            if (!name) return;

            const newApp = {
                id: 'app_' + Date.now(),
                name: name,
                icon: 'üì±',
                version: '1.0.0',
                content: '<p>Êñ∞Â∫îÁî®ÂÜÖÂÆπ</p>'
            };

            harmonyOSLab.apps.push(newApp);
            renderLauncherGrid();
            renderAppList();
            addLabLog('success', `ÂàõÂª∫Â∫îÁî®: ${name}`);
            saveLabData();
        }

        // Ê∏≤ÊüìÂ∫îÁî®ÂàóË°®
        function renderAppList() {
            const list = document.getElementById('lab-app-list');
            if (!list) return;

            if (harmonyOSLab.apps.length === 0) {
                list.innerHTML = '<div class="empty-hint">ÊöÇÊó†Â∫îÁî®ÔºåÁÇπÂáª"Êñ∞Âª∫Â∫îÁî®"ÂºÄÂßã</div>';
                return;
            }

            list.innerHTML = harmonyOSLab.apps.map(app => `
                <div class="app-list-item">
                    <span class="app-icon">${app.icon}</span>
                    <span class="app-name">${app.name}</span>
                    <span class="app-version">${app.version}</span>
                    <button class="btn-sm btn-danger" onclick="deleteApp('${app.id}')">Âà†Èô§</button>
                </div>
            `).join('');
        }

        // Âà†Èô§Â∫îÁî®
        function deleteApp(appId) {
            const index = harmonyOSLab.apps.findIndex(a => a.id === appId);
            if (index > -1) {
                const app = harmonyOSLab.apps[index];
                harmonyOSLab.apps.splice(index, 1);
                renderLauncherGrid();
                renderAppList();
                addLabLog('warning', `Âà†Èô§Â∫îÁî®: ${app.name}`);
                saveLabData();
            }
        }

        // ÂÆâË£ÖÊèí‰ª∂
        function installPlugin() {
            showToast('Êèí‰ª∂ÂïÜÂ∫óÂºÄÂèë‰∏≠', 'info');
        }

        // ËøêË°åËÑöÊú¨
        async function runLabScript() {
            const editor = document.getElementById('lab-script-editor');
            const output = document.getElementById('lab-script-output');
            const script = editor.value;

            if (!script.trim()) {
                showToast('ËØ∑ËæìÂÖ•ËÑöÊú¨ÂÜÖÂÆπ', 'error');
                return;
            }

            output.innerHTML = '<div class="running">ËøêË°å‰∏≠...</div>';
            addLabLog('info', 'ÊâßË°åËÑöÊú¨');

            try {
                const response = await fetch('/api/harmonyos-lab/run-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script: script })
                });

                const result = await response.json();

                if (result.success) {
                    output.innerHTML = result.log.map(line =>
                        `<div class="log-line">${line}</div>`
                    ).join('') || '<div class="success">ËÑöÊú¨ÊâßË°åÊàêÂäü</div>';
                    addLabLog('success', 'ËÑöÊú¨ÊâßË°åÂÆåÊàê');
                } else {
                    output.innerHTML = `<div class="error">ÈîôËØØ: ${result.error}</div>`;
                    addLabLog('error', `ËÑöÊú¨ÈîôËØØ: ${result.error}`);
                }
            } catch (err) {
                output.innerHTML = `<div class="error">ËØ∑Ê±ÇÂ§±Ë¥•: ${err.message}</div>`;
                addLabLog('error', `ËØ∑Ê±ÇÂ§±Ë¥•: ${err.message}`);
            }
        }

        // Ê∑ªÂä†Êó•Âøó
        function addLabLog(level, message) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');
            harmonyOSLab.logs.unshift({
                time: timeStr,
                level: level,
                message: message
            });

            // ‰øùÊåÅÊúÄÂ§ö100Êù°Êó•Âøó
            if (harmonyOSLab.logs.length > 100) {
                harmonyOSLab.logs = harmonyOSLab.logs.slice(0, 100);
            }

            renderLabLogs();
        }

        // Ê∏≤ÊüìÊó•Âøó
        function renderLabLogs() {
            const viewer = document.getElementById('lab-log-viewer');
            if (!viewer) return;

            if (harmonyOSLab.logs.length === 0) {
                viewer.innerHTML = '<div class="log-empty">ÊöÇÊó†Êó•Âøó</div>';
                return;
            }

            viewer.innerHTML = harmonyOSLab.logs.map(log => `
                <div class="log-entry ${log.level}">
                    <span class="log-time">${log.time}</span>
                    <span class="log-level">${log.level.toUpperCase()}</span>
                    <span class="log-message">${log.message}</span>
                </div>
            `).join('');
        }

        // Ê∏ÖÁ©∫Êó•Âøó
        function clearLabLogs() {
            harmonyOSLab.logs = [];
            renderLabLogs();
            showToast('Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫', 'success');
        }

        // ‰øùÂ≠òËØïÈ™åÁî∞Êï∞ÊçÆ
        async function saveLabData() {
            try {
                await fetch('/api/harmonyos-lab/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        installedApps: harmonyOSLab.apps,
                        logs: harmonyOSLab.logs
                    })
                });
            } catch (err) {
                console.error('Failed to save lab data:', err);
            }
        }

        // ============ Êó•Á®ãÁÆ°ÁêÜÂ∑•ÂÖ∑ ============
        let calendarState = {
            currentDate: new Date(),
            selectedDate: new Date(),
            events: [],
            outlookConnected: false
        };

        // ÂàùÂßãÂåñÊó•ÂéÜ
        function initCalendar() {
            renderMiniCalendar();
            renderDaySchedule();
            loadEvents();
        }

        // Ê∏≤ÊüìËø∑‰Ω†Êó•ÂéÜ
        function renderMiniCalendar() {
            const grid = document.getElementById('mini-calendar-grid');
            if (!grid) return;

            const year = calendarState.currentDate.getFullYear();
            const month = calendarState.currentDate.getMonth();
            const today = new Date();

            document.getElementById('mini-calendar-month').textContent =
                `${year}Âπ¥${month + 1}Êúà`;

            // ÊòüÊúüÂ§¥
            const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            let html = weekdays.map(d =>
                `<div class="mini-calendar-weekday">${d}</div>`
            ).join('');

            // Ëé∑ÂèñÊúà‰ªΩÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startOffset = firstDay.getDay();

            // Â°´ÂÖÖÁ©∫ÁôΩ
            for (let i = 0; i < startOffset; i++) {
                html += '<div class="mini-calendar-day"></div>';
            }

            // Â°´ÂÖÖÊó•Êúü
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = year === today.getFullYear() &&
                               month === today.getMonth() &&
                               day === today.getDate();
                const isSelected = year === calendarState.selectedDate.getFullYear() &&
                                  month === calendarState.selectedDate.getMonth() &&
                                  day === calendarState.selectedDate.getDate();
                const hasEvents = calendarState.events.some(e => {
                    const eDate = new Date(e.date);
                    return eDate.getFullYear() === year &&
                           eDate.getMonth() === month &&
                           eDate.getDate() === day;
                });

                let classes = 'mini-calendar-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (hasEvents) classes += ' has-events';

                html += `<div class="${classes}" onclick="selectCalendarDate(${year}, ${month}, ${day})">${day}</div>`;
            }

            grid.innerHTML = html;
        }

        function calendarPrevMonth() {
            calendarState.currentDate.setMonth(calendarState.currentDate.getMonth() - 1);
            renderMiniCalendar();
        }

        function calendarNextMonth() {
            calendarState.currentDate.setMonth(calendarState.currentDate.getMonth() + 1);
            renderMiniCalendar();
        }

        function selectCalendarDate(year, month, day) {
            calendarState.selectedDate = new Date(year, month, day);
            renderMiniCalendar();
            renderDaySchedule();
        }

        // Ê∏≤ÊüìÊó•Á®ãËßÜÂõæ
        function renderDaySchedule() {
            const container = document.getElementById('day-schedule');
            const titleEl = document.getElementById('calendar-date-title');
            if (!container) return;

            const date = calendarState.selectedDate;
            const weekDays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            titleEl.textContent = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${weekDays[date.getDay()]}`;

            // ÁîüÊàê24Â∞èÊó∂Êó∂Èó¥ËΩ¥
            let html = '';
            for (let hour = 0; hour < 24; hour++) {
                const hourStr = hour.toString().padStart(2, '0') + ':00';
                html += `
                    <div class="hour-row" data-hour="${hour}">
                        <div class="hour-label">${hourStr}</div>
                        <div class="hour-content" id="hour-${hour}"></div>
                    </div>
                `;
            }
            container.innerHTML = html;

            // Ê∏≤ÊüìÂΩìÂ§©‰∫ã‰ª∂
            renderEventsOnSchedule();
        }

        function renderEventsOnSchedule() {
            const date = calendarState.selectedDate;
            const dateStr = date.toISOString().split('T')[0];

            const dayEvents = calendarState.events.filter(e => e.date === dateStr);

            dayEvents.forEach(event => {
                const startHour = parseInt(event.start.split(':')[0]);
                const startMin = parseInt(event.start.split(':')[1]);
                const endHour = parseInt(event.end.split(':')[0]);
                const endMin = parseInt(event.end.split(':')[1]);

                const hourContainer = document.getElementById('hour-' + startHour);
                if (hourContainer) {
                    const topOffset = (startMin / 60) * 60;
                    const duration = ((endHour * 60 + endMin) - (startHour * 60 + startMin)) / 60 * 60;

                    const eventEl = document.createElement('div');
                    eventEl.className = 'schedule-event';
                    eventEl.style.top = topOffset + 'px';
                    eventEl.style.height = Math.max(duration - 4, 20) + 'px';
                    eventEl.textContent = event.title;
                    eventEl.onclick = () => showEventDetail(event);
                    hourContainer.appendChild(eventEl);
                }
            });

            // Êõ¥Êñ∞Âç≥Â∞ÜÂà∞Êù•
            renderUpcomingEvents();
        }

        function renderUpcomingEvents() {
            const container = document.getElementById('upcoming-list');
            if (!container) return;

            const now = new Date();
            const upcoming = calendarState.events
                .filter(e => new Date(e.date + 'T' + e.start) >= now)
                .sort((a, b) => new Date(a.date + 'T' + a.start) - new Date(b.date + 'T' + b.start))
                .slice(0, 5);

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="no-events-hint">ÊöÇÊó†Êó•Á®ã</div>';
                return;
            }

            container.innerHTML = upcoming.map(e => `
                <div class="event-item">
                    <div class="event-time">${e.date} ${e.start}</div>
                    <div class="event-title">${e.title}</div>
                </div>
            `).join('');
        }

        // Âä†ËΩΩ‰∫ã‰ª∂
        async function loadEvents() {
            try {
                const resp = await fetch('/api/calendar/events');
                const data = await resp.json();
                calendarState.events = data.events || [];
                renderMiniCalendar();
                renderDaySchedule();
            } catch (err) {
                console.error('Failed to load events:', err);
            }
        }

        // Ê∑ªÂä†‰∫ã‰ª∂Ê®°ÊÄÅÊ°Ü
        function showAddEventModal() {
            document.getElementById('event-modal').classList.add('visible');
            document.getElementById('event-title').value = '';
            document.getElementById('event-start').value = '09:00';
            document.getElementById('event-end').value = '10:00';
            document.getElementById('event-notes').value = '';
        }

        function hideEventModal() {
            document.getElementById('event-modal').classList.remove('visible');
        }

        async function saveEvent(e) {
            e.preventDefault();

            const title = document.getElementById('event-title').value;
            const start = document.getElementById('event-start').value;
            const end = document.getElementById('event-end').value;
            const notes = document.getElementById('event-notes').value;
            const date = calendarState.selectedDate.toISOString().split('T')[0];

            try {
                const resp = await fetch('/api/calendar/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, date, start, end, notes })
                });
                const data = await resp.json();
                if (data.success) {
                    calendarState.events.push(data.event);
                    hideEventModal();
                    renderMiniCalendar();
                    renderDaySchedule();
                    showToast('Êó•Á®ãÂ∑≤Ê∑ªÂä†', 'success');
                }
            } catch (err) {
                showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        function showEventDetail(event) {
            alert(`${event.title}\n${event.date} ${event.start} - ${event.end}\n${event.notes || ''}`);
        }

        // ============ Outlook ÈõÜÊàê ============

        // Ê£ÄÊü• Outlook ÈÖçÁΩÆÁä∂ÊÄÅ
        async function checkOutlookStatus() {
            const status = document.getElementById('outlook-status');
            const userInfo = document.getElementById('outlook-user-info');
            const btnSync = document.getElementById('btn-outlook-sync');
            const btnLogin = document.getElementById('btn-outlook-login');
            const btnLogout = document.getElementById('btn-outlook-logout');

            try {
                const resp = await fetch('/api/calendar/outlook/config');
                const data = await resp.json();

                if (!data.configured) {
                    // Êú™ÈÖçÁΩÆ
                    status.textContent = 'ÈúÄË¶ÅÈÖçÁΩÆ';
                    status.classList.remove('connected');
                    userInfo.style.display = 'none';
                    btnSync.style.display = 'none';
                    btnLogin.style.display = 'none';
                    btnLogout.style.display = 'none';
                } else if (!data.authenticated) {
                    // Â∑≤ÈÖçÁΩÆ‰ΩÜÊú™ÁôªÂΩï
                    status.textContent = 'Êú™ÁôªÂΩï';
                    status.classList.remove('connected');
                    userInfo.style.display = 'none';
                    btnSync.style.display = 'none';
                    btnLogin.style.display = 'block';
                    btnLogout.style.display = 'none';
                } else {
                    // Â∑≤ÁôªÂΩï
                    calendarState.outlookConnected = true;
                    status.textContent = 'Â∑≤ËøûÊé•';
                    status.classList.add('connected');
                    if (data.user) {
                        userInfo.textContent = data.user.email || data.user.name;
                        userInfo.style.display = 'block';
                    }
                    btnSync.style.display = 'block';
                    btnLogin.style.display = 'none';
                    btnLogout.style.display = 'block';
                }
            } catch (err) {
                status.textContent = 'Ê£ÄÊü•Áä∂ÊÄÅÂ§±Ë¥•';
            }
        }

        // ÊòæÁ§∫ÈÖçÁΩÆÂºπÁ™ó
        function showOutlookConfig() {
            document.getElementById('outlook-config-modal').style.display = 'flex';
        }

        // ÈöêËóèÈÖçÁΩÆÂºπÁ™ó
        function hideOutlookConfig() {
            document.getElementById('outlook-config-modal').style.display = 'none';
        }

        // ‰øùÂ≠òÈÖçÁΩÆ
        async function saveOutlookConfig() {
            const clientId = document.getElementById('outlook-client-id').value.trim();
            const clientSecret = document.getElementById('outlook-client-secret').value.trim();
            const tenantId = document.getElementById('outlook-tenant-id').value.trim();

            if (!clientId) {
                showToast('ËØ∑ËæìÂÖ• Application ID', 'error');
                return;
            }

            try {
                const resp = await fetch('/api/calendar/outlook/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        tenant_id: tenantId || 'common'
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    hideOutlookConfig();
                    showToast('ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
                    checkOutlookStatus();
                } else {
                    showToast(data.error || '‰øùÂ≠òÂ§±Ë¥•', 'error');
                }
            } catch (err) {
                showToast('ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ÁôªÂΩï Microsoft
        async function loginOutlook() {
            try {
                const resp = await fetch('/api/calendar/outlook/auth');
                const data = await resp.json();

                if (data.success && data.auth_url) {
                    // ÊâìÂºÄÁôªÂΩïÁ™óÂè£
                    const authWindow = window.open(data.auth_url, 'outlook_auth', 'width=600,height=700');

                    // ÁõëÂê¨ÁôªÂΩïÊàêÂäüÊ∂àÊÅØ
                    window.addEventListener('message', function handler(e) {
                        if (e.data && e.data.type === 'outlook_auth_success') {
                            window.removeEventListener('message', handler);
                            checkOutlookStatus();
                            syncOutlook();
                        }
                    });
                } else {
                    showToast(data.error || 'Ëé∑ÂèñÁôªÂΩïÈìæÊé•Â§±Ë¥•', 'error');
                }
            } catch (err) {
                showToast('ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ÁôªÂá∫
        async function logoutOutlook() {
            try {
                await fetch('/api/calendar/outlook/logout', { method: 'POST' });
                calendarState.outlookConnected = false;
                // ÁßªÈô§ Outlook ‰∫ã‰ª∂
                calendarState.events = calendarState.events.filter(e => e.source !== 'outlook');
                renderMiniCalendar();
                renderDaySchedule();
                renderUpcomingEvents();
                checkOutlookStatus();
                showToast('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 'success');
            } catch (err) {
                showToast('ÈÄÄÂá∫Â§±Ë¥•', 'error');
            }
        }

        // ÂêåÊ≠•Êó•ÂéÜ
        async function syncOutlook() {
            const btn = document.getElementById('btn-outlook-sync');
            const status = document.getElementById('outlook-status');

            btn.textContent = '‚è≥ ÂêåÊ≠•‰∏≠...';
            btn.disabled = true;

            try {
                const resp = await fetch('/api/calendar/outlook/sync', { method: 'POST' });
                const data = await resp.json();

                if (data.success) {
                    // ÁßªÈô§ÊóßÁöÑ Outlook ‰∫ã‰ª∂ÔºåÊ∑ªÂä†Êñ∞ÁöÑ
                    calendarState.events = calendarState.events.filter(e => e.source !== 'outlook');
                    if (data.events) {
                        calendarState.events = [...calendarState.events, ...data.events];
                    }
                    renderMiniCalendar();
                    renderDaySchedule();
                    renderUpcomingEvents();
                    showToast(`ÂêåÊ≠•ÊàêÂäüÔºåÂÖ± ${data.count || 0} ‰∏™Êó•Á®ã`, 'success');
                    btn.textContent = 'üîÑ ÂêåÊ≠•Êó•Á®ã';
                } else if (data.error === 'need_config') {
                    showOutlookConfig();
                } else if (data.error === 'need_auth') {
                    loginOutlook();
                } else {
                    showToast(data.error || 'ÂêåÊ≠•Â§±Ë¥•', 'error');
                    btn.textContent = 'üîÑ ÂêåÊ≠•Êó•Á®ã';
                }
            } catch (err) {
                showToast('ÁΩëÁªúÈîôËØØ', 'error');
                btn.textContent = 'üîÑ ÂêåÊ≠•Êó•Á®ã';
            } finally {
                btn.disabled = false;
            }
        }

        // ============ ÂàùÂßãÂåñ ============
        document.addEventListener('DOMContentLoaded', () => {
            initBubbleChart();
            loadBubbles();
            initPPTTranslator();
            initCalendar();
            checkOutlookStatus();
        });
    </script>
{% endblock %}
