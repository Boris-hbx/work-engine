{% extends "base.html" %}

{% block title %}å·¥å…·ç®± - Work Engine{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">å·¥å…·ç®±</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="toolbox-layout">
        <!-- å·¦ä¾§ï¼šå·¥å…·é€‰æ‹©å™¨ -->
        <div class="toolbox-nav">
            <div class="tool-item active" data-tool="bubble" onclick="switchTool('bubble')">
                <span class="tool-icon">ğŸ“Š</span>
                <span class="tool-name">æ°”æ³¡å›¾</span>
            </div>
            <div class="tool-item" data-tool="expense" onclick="switchTool('expense')">
                <span class="tool-icon">ğŸ’°</span>
                <span class="tool-name">æŠ¥é”€å°èƒ½æ‰‹</span>
            </div>
            <div class="tool-item" data-tool="ppt" onclick="switchTool('ppt')">
                <span class="tool-icon">ğŸ¬</span>
                <span class="tool-name">PPTç”Ÿæˆå™¨</span>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="toolbox-content">
            <!-- æ°”æ³¡å›¾å·¥å…· -->
            <div class="tool-panel" id="tool-bubble">
                <div class="bubble-main-layout">
                    <!-- å·¦ä¾§ï¼šå†å²ç‰ˆæœ¬åˆ—è¡¨ -->
                    <div class="bubble-sidebar">
                        <div class="sidebar-header">
                            <h3>æˆ‘çš„å›¾è¡¨</h3>
                            <button class="btn-new" onclick="createNew()">+ æ–°å»º</button>
                        </div>
                        <div class="saved-list" id="saved-list"></div>
                    </div>

                    <!-- å³ä¾§ï¼šä¸»ç¼–è¾‘åŒº -->
                    <div class="bubble-editor">
                        <div class="bubble-meta">
                            <div class="meta-row">
                                <input type="text" class="chart-title-input" id="chart-title" placeholder="è¾“å…¥å›¾è¡¨æ ‡é¢˜..." value="æœªå‘½åå›¾è¡¨">
                                <div class="meta-actions">
                                    <button class="btn-action btn-save" onclick="saveChart()" title="ä¿å­˜">
                                        <span class="btn-icon">ğŸ’¾</span> ä¿å­˜
                                    </button>
                                    <button class="btn-action btn-duplicate" onclick="duplicateChart()" title="å¤åˆ¶" id="btn-duplicate" style="display:none;">
                                        <span class="btn-icon">ğŸ“‹</span> å¤åˆ¶
                                    </button>
                                    <button class="btn-action btn-delete-chart" onclick="deleteChart()" title="åˆ é™¤" id="btn-delete" style="display:none;">
                                        <span class="btn-icon">ğŸ—‘ï¸</span> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            <textarea class="chart-desc-input" id="chart-desc" placeholder="æ·»åŠ å›¾è¡¨ç®€ä»‹ï¼ˆå¯é€‰ï¼‰..." rows="2"></textarea>
                            <div class="chart-info" id="chart-info" style="display:none;">
                                <span class="info-item" id="chart-created"></span>
                                <span class="info-item" id="chart-updated"></span>
                            </div>
                        </div>

                        <div class="bubble-container">
                            <div class="bubble-panel data-panel">
                                <div class="panel-header">
                                    <h3>æ•°æ®è¾“å…¥</h3>
                                    <div class="panel-actions">
                                        <button class="btn-small" onclick="addRow()">+ æ·»åŠ </button>
                                        <button class="btn-small btn-secondary" onclick="loadExample()">åŠ è½½ç¤ºä¾‹</button>
                                        <button class="btn-small btn-secondary" onclick="clearAll()">æ¸…ç©º</button>
                                    </div>
                                </div>
                                <div class="data-table-wrapper">
                                    <table class="data-table" id="data-table">
                                        <thead>
                                            <tr>
                                                <th>åç§°</th>
                                                <th>Xè½´å€¼</th>
                                                <th>Yè½´å€¼</th>
                                                <th>æ°”æ³¡å¤§å°</th>
                                                <th>é¢œè‰²</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-body"></tbody>
                                    </table>
                                </div>
                                <div class="axis-labels">
                                    <div class="axis-input">
                                        <label>Xè½´æ ‡ç­¾ï¼š</label>
                                        <input type="text" id="x-axis-label" value="æŠ•å…¥æˆæœ¬" onchange="updateChart()">
                                    </div>
                                    <div class="axis-input">
                                        <label>Yè½´æ ‡ç­¾ï¼š</label>
                                        <input type="text" id="y-axis-label" value="æ¢å¤æ•ˆæœ" onchange="updateChart()">
                                    </div>
                                </div>
                            </div>

                            <div class="bubble-panel chart-panel">
                                <div class="panel-header">
                                    <h3>æ°”æ³¡å›¾é¢„è§ˆ</h3>
                                    <div class="panel-actions">
                                        <button class="btn-small" onclick="downloadChart()">ä¸‹è½½å›¾ç‰‡</button>
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="bubble-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- è¯„åˆ†ç»´åº¦é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
                        <div class="bubble-panel scoring-panel">
                            <div class="panel-header collapsible" onclick="toggleScoring()">
                                <h3>è¯„åˆ†ç»´åº¦é…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
                                <span class="collapse-icon" id="scoring-icon">â–¼</span>
                            </div>
                            <div class="scoring-content" id="scoring-content" style="display: none;">
                                <div class="scoring-columns">
                                    <div class="scoring-column">
                                        <h4>Xè½´è¯„åˆ†ç»´åº¦</h4>
                                        <div id="x-dimensions">
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="å‡†å¤‡æ—¶é—´">
                                                <input type="number" placeholder="æ»¡åˆ†" value="5" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="å±•å¼€æ—¶é—´">
                                                <input type="number" placeholder="æ»¡åˆ†" value="30" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="å­¦ä¹ æˆæœ¬">
                                                <input type="number" placeholder="æ»¡åˆ†" value="15" min="0">
                                            </div>
                                        </div>
                                        <button class="btn-tiny" onclick="addDimension('x')">+ æ·»åŠ ç»´åº¦</button>
                                    </div>
                                    <div class="scoring-column">
                                        <h4>Yè½´è¯„åˆ†ç»´åº¦</h4>
                                        <div id="y-dimensions">
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="ç²¾åŠ›æ¢å¤ç¨³å®š">
                                                <input type="number" placeholder="æ»¡åˆ†" value="30" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="æƒ…ç»ªè°ƒèŠ‚">
                                                <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="ç¼“è§£å‹åŠ›">
                                                <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                            </div>
                                        </div>
                                        <button class="btn-tiny" onclick="addDimension('y')">+ æ·»åŠ ç»´åº¦</button>
                                    </div>
                                    <div class="scoring-column">
                                        <h4>æ°”æ³¡å¤§å°ç»´åº¦</h4>
                                        <div id="size-dimensions">
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="ä¸Šè‚¢æ¿€æ´»">
                                                <input type="number" placeholder="æ»¡åˆ†" value="15" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="ä¸‹è‚¢æ¿€æ´»">
                                                <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                            </div>
                                            <div class="dimension-item">
                                                <input type="text" placeholder="ç»´åº¦åç§°" value="å…¨èº«æ¿€æ´»">
                                                <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                            </div>
                                        </div>
                                        <button class="btn-tiny" onclick="addDimension('size')">+ æ·»åŠ ç»´åº¦</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ¥é”€å°èƒ½æ‰‹å·¥å…· -->
            <div class="tool-panel" id="tool-expense" style="display: none;">
                <div class="expense-layout">
                    <!-- å·¦ä¾§ï¼šæŠ¥é”€äº‹ä»¶åˆ—è¡¨ -->
                    <div class="expense-sidebar">
                        <div class="sidebar-header">
                            <h3>æŠ¥é”€äº‹é¡¹</h3>
                            <button class="btn-new" onclick="createExpense()">+ æ–°å»º</button>
                        </div>
                        <div class="expense-list" id="expense-list"></div>
                    </div>

                    <!-- å³ä¾§ï¼šæŠ¥é”€è¯¦æƒ… -->
                    <div class="expense-editor" id="expense-editor">
                        <div class="expense-empty" id="expense-empty">
                            <div class="empty-icon">ğŸ’°</div>
                            <p>é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªæŠ¥é”€äº‹é¡¹</p>
                        </div>

                        <div class="expense-detail" id="expense-detail" style="display: none;">
                            <div class="expense-header">
                                <input type="text" class="expense-event-input" id="expense-event" placeholder="æŠ¥é”€äº‹ä»¶åç§°...">
                                <div class="expense-actions">
                                    <button class="btn-action btn-save" onclick="saveExpense()">
                                        <span class="btn-icon">ğŸ’¾</span> ä¿å­˜
                                    </button>
                                    <button class="btn-action btn-delete-expense" onclick="deleteExpense()">
                                        <span class="btn-icon">ğŸ—‘ï¸</span> åˆ é™¤
                                    </button>
                                </div>
                            </div>

                            <div class="expense-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>èµ·å§‹æ—¥æœŸ</label>
                                        <input type="date" id="expense-start-date">
                                    </div>
                                    <div class="form-group">
                                        <label>ç»“æŸæ—¥æœŸ</label>
                                        <input type="date" id="expense-end-date">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group location-group">
                                        <label>åœ°ç‚¹</label>
                                        <div class="location-input-wrapper">
                                            <input type="text" id="expense-location" placeholder="è¾“å…¥æˆ–é€‰æ‹©åœ°ç‚¹">
                                            <div class="location-suggestions" id="location-suggestions"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>å¤‡æ³¨</label>
                                    <textarea id="expense-notes" rows="2" placeholder="æ·»åŠ å¤‡æ³¨..."></textarea>
                                </div>
                            </div>

                            <div class="expense-files-section">
                                <div class="section-header">
                                    <h4>æŠ¥é”€å‡­è¯</h4>
                                    <span class="file-count" id="file-count">0 ä¸ªæ–‡ä»¶</span>
                                </div>

                                <!-- æ–‡ä»¶æ‹–æ‹½åŒºåŸŸ -->
                                <div class="file-drop-zone" id="file-drop-zone">
                                    <div class="drop-icon">ğŸ“</div>
                                    <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                                    <span class="drop-hint">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                                    <input type="file" id="file-input" multiple style="display: none;">
                                </div>

                                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                                <div class="file-list" id="file-list"></div>

                                <!-- åˆ é™¤ç¡®è®¤åƒåœ¾æ¡¶ -->
                                <div class="trash-zone" id="trash-zone">
                                    <span class="trash-icon">ğŸ—‘ï¸</span>
                                    <span>æ‹–åˆ°è¿™é‡Œåˆ é™¤</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PPTç”Ÿæˆå™¨å·¥å…· -->
            <div class="tool-panel" id="tool-ppt" style="display: none;">
                <div class="ppt-layout">
                    <!-- å·¦ä¾§ï¼šPPTåˆ—è¡¨ -->
                    <div class="ppt-sidebar">
                        <div class="sidebar-header">
                            <h3>æˆ‘çš„ PPT</h3>
                            <button class="btn-new" onclick="createPPT()">+ æ–°å»º</button>
                        </div>
                        <div class="ppt-list" id="ppt-list"></div>
                    </div>

                    <!-- å³ä¾§ï¼šPPTç¼–è¾‘åŒº -->
                    <div class="ppt-editor" id="ppt-editor">
                        <div class="ppt-empty" id="ppt-empty">
                            <div class="empty-icon">ğŸ¬</div>
                            <p>é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ª PPT</p>
                        </div>

                        <div class="ppt-detail" id="ppt-detail" style="display: none;">
                            <!-- æ ‡é¢˜å’Œæ“ä½œ -->
                            <div class="ppt-header">
                                <input type="text" class="ppt-title-input" id="ppt-title" placeholder="PPT æ ‡é¢˜...">
                                <div class="ppt-actions">
                                    <button class="btn-action btn-preview" onclick="previewPPT()" title="é¢„è§ˆ">
                                        <span class="btn-icon">ğŸ‘ï¸</span> é¢„è§ˆ
                                    </button>
                                    <button class="btn-action btn-save" onclick="savePPT()">
                                        <span class="btn-icon">ğŸ’¾</span> ä¿å­˜
                                    </button>
                                    <button class="btn-action btn-download" onclick="downloadPPT()">
                                        <span class="btn-icon">ğŸ“¥</span> ä¸‹è½½
                                    </button>
                                    <button class="btn-action btn-delete-ppt" onclick="deletePPT()" id="btn-delete-ppt" style="display:none;">
                                        <span class="btn-icon">ğŸ—‘ï¸</span>
                                    </button>
                                </div>
                            </div>

                            <!-- æ¨¡æ¿é€‰æ‹© -->
                            <div class="ppt-template-section">
                                <label>é€‰æ‹©é£æ ¼ï¼š</label>
                                <div class="template-options" id="template-options">
                                    <div class="template-option active" data-template="dark-statement" onclick="selectTemplate('dark-statement')">
                                        <div class="template-preview dark"></div>
                                        <span>æ·±è‰²å®£è¨€</span>
                                    </div>
                                    <div class="template-option" data-template="dark-columns" onclick="selectTemplate('dark-columns')">
                                        <div class="template-preview dark-cols"></div>
                                        <span>ä¸‰æ å¯¹æ¯”</span>
                                    </div>
                                    <div class="template-option" data-template="light-diagram" onclick="selectTemplate('light-diagram')">
                                        <div class="template-preview light"></div>
                                        <span>æµ…è‰²æµç¨‹</span>
                                    </div>
                                    <div class="template-option" data-template="dark-icon" onclick="selectTemplate('dark-icon')">
                                        <div class="template-preview dark-icon"></div>
                                        <span>å›¾æ ‡è¦ç‚¹</span>
                                    </div>
                                </div>
                            </div>

                            <!-- å†…å®¹ç¼–è¾‘åŒº -->
                            <div class="ppt-content-editor">
                                <div class="editor-section">
                                    <label>ä¸»æ ‡é¢˜</label>
                                    <input type="text" id="ppt-main-title" placeholder="è¾“å…¥ä¸»æ ‡é¢˜..." onchange="updatePPTPreview()">
                                </div>

                                <div class="editor-section">
                                    <label>å‰¯æ ‡é¢˜ / è¯´æ˜</label>
                                    <input type="text" id="ppt-subtitle" placeholder="è¾“å…¥å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰..." onchange="updatePPTPreview()">
                                </div>

                                <div class="editor-section">
                                    <label>æ ¸å¿ƒå†…å®¹å—</label>
                                    <div class="content-blocks" id="content-blocks">
                                        <!-- åŠ¨æ€æ·»åŠ çš„å†…å®¹å— -->
                                    </div>
                                    <button class="btn-add-block" onclick="addContentBlock()">+ æ·»åŠ å†…å®¹å—</button>
                                </div>

                                <div class="editor-section">
                                    <label>åº•éƒ¨é‡‘å¥ï¼ˆå¯é€‰ï¼‰</label>
                                    <input type="text" id="ppt-footer" placeholder="è¾“å…¥åº•éƒ¨æ€»ç»“æˆ–é‡‘å¥..." onchange="updatePPTPreview()">
                                </div>
                            </div>

                            <!-- å®æ—¶é¢„è§ˆ -->
                            <div class="ppt-preview-section">
                                <div class="preview-header">
                                    <h4>å®æ—¶é¢„è§ˆ</h4>
                                    <span class="preview-hint">ç‚¹å‡»"é¢„è§ˆ"å¯å…¨å±æŸ¥çœ‹</span>
                                </div>
                                <div class="preview-container" id="preview-container">
                                    <div class="preview-placeholder">ç¼–è¾‘å†…å®¹åæ˜¾ç¤ºé¢„è§ˆ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <h3>ç¡®è®¤åˆ é™¤</h3>
            <p id="delete-modal-message">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============ å·¥å…·åˆ‡æ¢ ============
        let currentTool = 'bubble';

        function switchTool(tool) {
            currentTool = tool;

            // æ›´æ–°å¯¼èˆªæ ·å¼
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tool === tool);
            });

            // åˆ‡æ¢é¢æ¿
            document.querySelectorAll('.tool-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            document.getElementById('tool-' + tool).style.display = 'block';

            // åˆå§‹åŒ–å¯¹åº”å·¥å…·
            if (tool === 'bubble') {
                loadBubbles();
            } else if (tool === 'expense') {
                loadExpenses();
            } else if (tool === 'ppt') {
                loadPPTs();
            }
        }

        // ============ Toast é€šçŸ¥ ============
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ æ°”æ³¡å›¾åŠŸèƒ½ ============
        let bubbleChart = null;
        let currentBubbleId = null;
        let bubbleData = [];

        const defaultColors = [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)'
        ];

        // è‡ªå®šä¹‰æ’ä»¶ï¼šåœ¨æ°”æ³¡ä¸Šæ˜¾ç¤ºæ–‡å­—æ ‡ç­¾ï¼ˆæ™ºèƒ½é¿è®©ç®—æ³•ï¼‰
        const bubbleLabelPlugin = {
            id: 'bubbleLabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                ctx.save();
                ctx.font = 'bold 11px Arial';

                const chartArea = chart.chartArea;
                const placedLabels = []; // å·²æ”¾ç½®çš„æ ‡ç­¾è¾¹ç•Œæ¡†

                // æ”¶é›†æ‰€æœ‰æ°”æ³¡ä¿¡æ¯
                const bubbles = [];
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    if (!meta.hidden && bubbleData[datasetIndex]) {
                        const element = meta.data[0];
                        bubbles.push({
                            x: element.x,
                            y: element.y,
                            r: element.options.radius || 10,
                            name: bubbleData[datasetIndex].name,
                            dataX: bubbleData[datasetIndex].x,
                            dataY: bubbleData[datasetIndex].y,
                            index: datasetIndex
                        });
                    }
                });

                // æŒ‰æ°”æ³¡å¤§å°æ’åºï¼Œå¤§çš„ä¼˜å…ˆæ”¾ç½®æ ‡ç­¾
                bubbles.sort((a, b) => b.r - a.r);

                // 8ä¸ªå¯é€‰æ–¹å‘
                const directions = [
                    { name: 'right', dx: 1, dy: 0, alignX: 'left' },
                    { name: 'left', dx: -1, dy: 0, alignX: 'right' },
                    { name: 'top', dx: 0, dy: -1, alignX: 'center' },
                    { name: 'bottom', dx: 0, dy: 1, alignX: 'center' },
                    { name: 'top-right', dx: 0.7, dy: -0.7, alignX: 'left' },
                    { name: 'top-left', dx: -0.7, dy: -0.7, alignX: 'right' },
                    { name: 'bottom-right', dx: 0.7, dy: 0.7, alignX: 'left' },
                    { name: 'bottom-left', dx: -0.7, dy: 0.7, alignX: 'right' }
                ];

                // æ ¹æ®æ°”æ³¡ä½ç½®è·å–é¦–é€‰æ–¹å‘
                function getPreferredDirections(bubble) {
                    const relX = (bubble.x - chartArea.left) / (chartArea.right - chartArea.left);
                    const relY = (bubble.y - chartArea.top) / (chartArea.bottom - chartArea.top);

                    let preferred = [];

                    // æ ¹æ®ä½ç½®é€‰æ‹©é¦–é€‰æ–¹å‘
                    if (relX > 0.7) {
                        // æ°”æ³¡åœ¨å³ä¾§ï¼Œæ ‡ç­¾æ”¾å·¦è¾¹
                        preferred.push(directions[1], directions[5], directions[7]); // left, top-left, bottom-left
                    } else if (relX < 0.3) {
                        // æ°”æ³¡åœ¨å·¦ä¾§ï¼Œæ ‡ç­¾æ”¾å³è¾¹
                        preferred.push(directions[0], directions[4], directions[6]); // right, top-right, bottom-right
                    }

                    if (relY > 0.7) {
                        // æ°”æ³¡åœ¨ä¸‹æ–¹ï¼Œæ ‡ç­¾æ”¾ä¸Šè¾¹
                        preferred.push(directions[2], directions[4], directions[5]); // top, top-right, top-left
                    } else if (relY < 0.3) {
                        // æ°”æ³¡åœ¨ä¸Šæ–¹ï¼Œæ ‡ç­¾æ”¾ä¸‹è¾¹
                        preferred.push(directions[3], directions[6], directions[7]); // bottom, bottom-right, bottom-left
                    }

                    // æ·»åŠ å‰©ä½™æ–¹å‘ä½œä¸ºå¤‡é€‰
                    directions.forEach(dir => {
                        if (!preferred.includes(dir)) preferred.push(dir);
                    });

                    return preferred;
                }

                // è®¡ç®—æ ‡ç­¾è¾¹ç•Œæ¡†
                function getLabelBounds(x, y, width, height, dir) {
                    let left, right, top, bottom;

                    if (dir.alignX === 'left') {
                        left = x;
                        right = x + width;
                    } else if (dir.alignX === 'right') {
                        left = x - width;
                        right = x;
                    } else {
                        left = x - width / 2;
                        right = x + width / 2;
                    }

                    if (dir.name.includes('top')) {
                        bottom = y;
                        top = y - height;
                    } else if (dir.name.includes('bottom')) {
                        top = y;
                        bottom = y + height;
                    } else {
                        top = y - height / 2;
                        bottom = y + height / 2;
                    }

                    return { left, right, top, bottom, width, height };
                }

                // æ£€æŸ¥æ˜¯å¦ä¸æ°”æ³¡é‡å 
                function overlapsWithBubbles(labelX, labelY, width, height, currentBubble) {
                    for (const b of bubbles) {
                        if (b.index === currentBubble.index) continue;
                        const dist = Math.sqrt(Math.pow(labelX - b.x, 2) + Math.pow(labelY - b.y, 2));
                        if (dist < b.r + 8) return true;
                    }
                    return false;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸å·²æ”¾ç½®æ ‡ç­¾é‡å 
                function overlapsWithLabels(bounds) {
                    for (const placed of placedLabels) {
                        if (!(bounds.right < placed.left - 2 || bounds.left > placed.right + 2 ||
                              bounds.bottom < placed.top - 2 || bounds.top > placed.bottom + 2)) {
                            return true;
                        }
                    }
                    return false;
                }

                // ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—æœ€ä½³æ ‡ç­¾ä½ç½®
                bubbles.forEach(bubble => {
                    const textWidth = ctx.measureText(bubble.name).width;
                    const textHeight = 12;
                    const offset = bubble.r + 6;

                    const preferredDirs = getPreferredDirections(bubble);
                    let bestPos = null;
                    let bestDir = null;

                    for (const dir of preferredDirs) {
                        const labelX = bubble.x + dir.dx * offset;
                        const labelY = bubble.y + dir.dy * offset;
                        const bounds = getLabelBounds(labelX, labelY, textWidth, textHeight, dir);

                        // è¾¹ç•Œæ£€æŸ¥
                        if (bounds.left < chartArea.left - 5 || bounds.right > chartArea.right + 5 ||
                            bounds.top < chartArea.top - 5 || bounds.bottom > chartArea.bottom + 5) {
                            continue;
                        }

                        // æ£€æŸ¥ä¸æ°”æ³¡é‡å 
                        if (overlapsWithBubbles(labelX, labelY, textWidth, textHeight, bubble)) {
                            continue;
                        }

                        // æ£€æŸ¥ä¸å·²æ”¾ç½®æ ‡ç­¾é‡å 
                        if (overlapsWithLabels(bounds)) {
                            continue;
                        }

                        // æ‰¾åˆ°åˆé€‚ä½ç½®
                        bestPos = { x: labelX, y: labelY, bounds };
                        bestDir = dir;
                        break;
                    }

                    // å¦‚æœæ²¡æ‰¾åˆ°å®Œç¾ä½ç½®ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé¦–é€‰æ–¹å‘
                    if (!bestPos) {
                        const dir = preferredDirs[0];
                        const labelX = bubble.x + dir.dx * offset;
                        const labelY = bubble.y + dir.dy * offset;
                        bestPos = {
                            x: labelX,
                            y: labelY,
                            bounds: getLabelBounds(labelX, labelY, textWidth, textHeight, dir)
                        };
                        bestDir = dir;
                    }

                    // è®°å½•æ ‡ç­¾ä½ç½®
                    placedLabels.push(bestPos.bounds);

                    // è®¡ç®—ç»˜åˆ¶åæ ‡
                    let drawX = bestPos.x;
                    let drawY = bestPos.y;

                    if (bestDir.alignX === 'center') {
                        drawX -= textWidth / 2;
                    } else if (bestDir.alignX === 'right') {
                        drawX -= textWidth;
                    }

                    if (bestDir.name.includes('top')) {
                        drawY -= 2;
                    } else if (bestDir.name.includes('bottom')) {
                        drawY += textHeight;
                    } else {
                        drawY += textHeight / 2 - 2;
                    }

                    // ç»˜åˆ¶æ–‡å­—ï¼ˆæ— è¾¹æ¡†ï¼Œçº¯æ–‡å­—ï¼‰
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(bubble.name, drawX, drawY);
                });

                ctx.restore();
            }
        };

        function initBubbleChart() {
            const ctx = document.getElementById('bubble-chart').getContext('2d');
            bubbleChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'æŠ•å…¥æˆæœ¬' },
                            min: 0, max: 100
                        },
                        y: {
                            title: { display: true, text: 'æ¢å¤æ•ˆæœ' },
                            min: 0, max: 100
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const data = bubbleData[context.datasetIndex];
                                    return data ? `${data.name}: (${data.x}, ${data.y}) å¤§å°:${data.r}` : '';
                                }
                            }
                        }
                    }
                },
                plugins: [bubbleLabelPlugin]
            });
            addRow();
        }

        function addRow(data = null) {
            const tbody = document.getElementById('data-body');
            const row = document.createElement('tr');
            const colorIndex = tbody.children.length % defaultColors.length;

            row.innerHTML = `
                <td><input type="text" class="input-name" value="${data?.name || ''}" onchange="updateChart()"></td>
                <td><input type="number" class="input-x" value="${data?.x || 50}" min="0" max="100" onchange="updateChart()"></td>
                <td><input type="number" class="input-y" value="${data?.y || 50}" min="0" max="100" onchange="updateChart()"></td>
                <td><input type="number" class="input-r" value="${data?.r || 20}" min="5" max="50" onchange="updateChart()"></td>
                <td><input type="color" class="input-color" value="${data?.color || rgbaToHex(defaultColors[colorIndex])}" onchange="updateChart()"></td>
                <td><button class="btn-delete-row" onclick="deleteRow(this)">Ã—</button></td>
            `;
            tbody.appendChild(row);
            updateChart();
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            updateChart();
        }

        function rgbaToHex(rgba) {
            const match = rgba.match(/\d+/g);
            if (match) {
                return '#' + match.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
            }
            return '#3498db';
        }

        function hexToRgba(hex, alpha = 0.7) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function updateChart() {
            bubbleData = [];
            const rows = document.querySelectorAll('#data-body tr');

            rows.forEach(row => {
                const name = row.querySelector('.input-name').value || 'æœªå‘½å';
                const x = parseFloat(row.querySelector('.input-x').value) || 0;
                const y = parseFloat(row.querySelector('.input-y').value) || 0;
                const r = parseFloat(row.querySelector('.input-r').value) || 10;
                const color = row.querySelector('.input-color').value;

                bubbleData.push({ name, x, y, r, color: hexToRgba(color) });
            });

            const datasets = bubbleData.map((item, i) => ({
                label: item.name,
                data: [{ x: item.x, y: item.y, r: item.r }],
                backgroundColor: item.color,
                borderColor: item.color.replace('0.7', '1')
            }));

            bubbleChart.data.datasets = datasets;
            bubbleChart.options.scales.x.title.text = document.getElementById('x-axis-label').value;
            bubbleChart.options.scales.y.title.text = document.getElementById('y-axis-label').value;
            bubbleChart.update();
        }

        function clearAll() {
            document.getElementById('data-body').innerHTML = '';
            addRow();
        }

        function loadExample() {
            const examples = [
                { name: 'ç¡çœ ', x: 10, y: 95, r: 30 },
                { name: 'å†¥æƒ³', x: 20, y: 85, r: 25 },
                { name: 'è¿åŠ¨', x: 40, y: 80, r: 28 },
                { name: 'é˜…è¯»', x: 30, y: 70, r: 22 },
                { name: 'æ¸¸æˆ', x: 60, y: 50, r: 35 }
            ];
            document.getElementById('data-body').innerHTML = '';
            examples.forEach((item, i) => {
                item.color = rgbaToHex(defaultColors[i % defaultColors.length]);
                addRow(item);
            });
        }

        async function loadBubbles() {
            try {
                const res = await fetch('/api/bubbles');
                const data = await res.json();
                renderBubbleList(data.bubbles || []);
            } catch (e) {
                console.error('Load bubbles error:', e);
            }
        }

        function renderBubbleList(bubbles) {
            const list = document.getElementById('saved-list');
            if (bubbles.length === 0) {
                list.innerHTML = '<div class="empty-list">æš‚æ— ä¿å­˜çš„å›¾è¡¨</div>';
                return;
            }

            list.innerHTML = bubbles.map(b => `
                <div class="saved-item ${b.id === currentBubbleId ? 'active' : ''}" onclick="loadBubble('${b.id}')">
                    <div class="item-title">${b.title}</div>
                    <div class="item-date">${formatDate(b.updated_at)}</div>
                </div>
            `).join('');
        }

        async function loadBubble(id) {
            try {
                const res = await fetch(`/api/bubbles/${id}`);
                const data = await res.json();
                if (data.success) {
                    const b = data.bubble;
                    currentBubbleId = b.id;
                    document.getElementById('chart-title').value = b.title;
                    document.getElementById('chart-desc').value = b.description || '';
                    document.getElementById('x-axis-label').value = b.x_label;
                    document.getElementById('y-axis-label').value = b.y_label;
                    document.getElementById('btn-duplicate').style.display = '';
                    document.getElementById('btn-delete').style.display = '';
                    document.getElementById('chart-info').style.display = '';
                    document.getElementById('chart-created').textContent = 'åˆ›å»º: ' + formatDate(b.created_at);
                    document.getElementById('chart-updated').textContent = 'æ›´æ–°: ' + formatDate(b.updated_at);

                    document.getElementById('data-body').innerHTML = '';
                    (b.data || []).forEach(item => addRow(item));
                    if (b.data.length === 0) addRow();

                    loadBubbles();
                }
            } catch (e) {
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        function createNew() {
            currentBubbleId = null;
            document.getElementById('chart-title').value = 'æœªå‘½åå›¾è¡¨';
            document.getElementById('chart-desc').value = '';
            document.getElementById('x-axis-label').value = 'æŠ•å…¥æˆæœ¬';
            document.getElementById('y-axis-label').value = 'æ¢å¤æ•ˆæœ';
            document.getElementById('btn-duplicate').style.display = 'none';
            document.getElementById('btn-delete').style.display = 'none';
            document.getElementById('chart-info').style.display = 'none';
            clearAll();
            document.querySelectorAll('.saved-item').forEach(i => i.classList.remove('active'));
        }

        async function saveChart() {
            const chartData = {
                title: document.getElementById('chart-title').value || 'æœªå‘½åå›¾è¡¨',
                description: document.getElementById('chart-desc').value,
                x_label: document.getElementById('x-axis-label').value,
                y_label: document.getElementById('y-axis-label').value,
                data: bubbleData.map(d => ({ ...d, color: d.color }))
            };

            try {
                const url = currentBubbleId ? `/api/bubbles/${currentBubbleId}` : '/api/bubbles';
                const method = currentBubbleId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chartData)
                });
                const data = await res.json();
                if (data.success) {
                    currentBubbleId = data.bubble.id;
                    showToast('ä¿å­˜æˆåŠŸ');
                    loadBubbles();
                    document.getElementById('btn-duplicate').style.display = '';
                    document.getElementById('btn-delete').style.display = '';
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function deleteChart() {
            if (!currentBubbleId || !confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå›¾è¡¨å—ï¼Ÿ')) return;
            try {
                await fetch(`/api/bubbles/${currentBubbleId}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤');
                createNew();
                loadBubbles();
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        async function duplicateChart() {
            if (!currentBubbleId) return;
            try {
                const res = await fetch(`/api/bubbles/${currentBubbleId}/duplicate`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('å·²å¤åˆ¶');
                    loadBubble(data.bubble.id);
                }
            } catch (e) {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
        }

        function downloadChart() {
            const link = document.createElement('a');
            link.download = (document.getElementById('chart-title').value || 'bubble-chart') + '.png';
            link.href = document.getElementById('bubble-chart').toDataURL();
            link.click();
        }

        function toggleScoring() {
            const content = document.getElementById('scoring-content');
            const icon = document.getElementById('scoring-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        function addDimension(axis) {
            const container = document.getElementById(axis + '-dimensions');
            const div = document.createElement('div');
            div.className = 'dimension-item';
            div.innerHTML = `
                <input type="text" placeholder="ç»´åº¦åç§°">
                <input type="number" placeholder="æ»¡åˆ†" value="10" min="0">
                <button class="btn-delete-small" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(div);
        }

        // ============ æŠ¥é”€å°èƒ½æ‰‹åŠŸèƒ½ ============
        let currentExpenseId = null;
        let expenses = [];
        let commonLocations = [];
        let deleteTarget = null;

        async function loadExpenses() {
            try {
                const res = await fetch('/api/expenses');
                const data = await res.json();
                expenses = data.expenses || [];
                commonLocations = data.common_locations || [];
                renderExpenseList();
                renderLocationSuggestions();
            } catch (e) {
                console.error('Load expenses error:', e);
            }
        }

        function renderExpenseList() {
            const list = document.getElementById('expense-list');
            if (expenses.length === 0) {
                list.innerHTML = '<div class="empty-list">æš‚æ— æŠ¥é”€äº‹é¡¹</div>';
                return;
            }

            list.innerHTML = expenses.map(e => `
                <div class="expense-item ${e.id === currentExpenseId ? 'active' : ''}" onclick="loadExpenseItem('${e.id}')">
                    <div class="expense-item-header">
                        <span class="expense-item-event">${e.event || 'æœªå‘½å'}</span>
                        <span class="expense-item-files">${(e.files || []).length} æ–‡ä»¶</span>
                    </div>
                    <div class="expense-item-info">
                        <span class="expense-item-location">${e.location || '-'}</span>
                        <span class="expense-item-date">${e.start_date || ''} ~ ${e.end_date || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderLocationSuggestions() {
            const container = document.getElementById('location-suggestions');
            container.innerHTML = commonLocations.map(loc =>
                `<div class="location-chip" onclick="selectLocation('${loc}')">${loc}</div>`
            ).join('');
        }

        function selectLocation(loc) {
            document.getElementById('expense-location').value = loc;
        }

        async function loadExpenseItem(id) {
            currentExpenseId = id;
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('expense-empty').style.display = 'none';
            document.getElementById('expense-detail').style.display = 'block';

            document.getElementById('expense-event').value = expense.event || '';
            document.getElementById('expense-start-date').value = expense.start_date || '';
            document.getElementById('expense-end-date').value = expense.end_date || '';
            document.getElementById('expense-location').value = expense.location || '';
            document.getElementById('expense-notes').value = expense.notes || '';

            renderExpenseFiles(expense.files || []);
            renderExpenseList();
        }

        function renderExpenseFiles(files) {
            const list = document.getElementById('file-list');
            document.getElementById('file-count').textContent = files.length + ' ä¸ªæ–‡ä»¶';

            if (files.length === 0) {
                list.innerHTML = '<div class="empty-files">æš‚æ— æ–‡ä»¶ï¼Œæ‹–æ‹½ä¸Šä¼ </div>';
                return;
            }

            list.innerHTML = files.map(f => `
                <div class="file-item" draggable="true" data-file-id="${f.id}"
                     ondragstart="startDragFile(event, '${f.id}')"
                     ondragend="endDragFile(event)">
                    <div class="file-icon">${getFileIcon(f.type)}</div>
                    <div class="file-info">
                        <div class="file-name">${f.filename}</div>
                        <div class="file-meta">
                            <span class="file-size">${f.size_readable}</span>
                            <span class="file-category">${f.analysis?.category || ''}</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-file-action" onclick="viewFile('${f.id}')" title="æŸ¥çœ‹">ğŸ‘ï¸</button>
                        <button class="btn-file-action btn-delete-file" onclick="prepareDeleteFile('${f.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(type) {
            const icons = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'webp': 'ğŸ–¼ï¸',
                'pdf': 'ğŸ“„', 'doc': 'ğŸ“', 'docx': 'ğŸ“',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'csv': 'ğŸ“Š'
            };
            return icons[type] || 'ğŸ“';
        }

        function createExpense() {
            currentExpenseId = null;
            document.getElementById('expense-empty').style.display = 'none';
            document.getElementById('expense-detail').style.display = 'block';
            document.getElementById('expense-event').value = '';
            document.getElementById('expense-start-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-end-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-location').value = '';
            document.getElementById('expense-notes').value = '';
            document.getElementById('file-list').innerHTML = '<div class="empty-files">ä¿å­˜åå¯ä¸Šä¼ æ–‡ä»¶</div>';
            document.getElementById('file-count').textContent = '0 ä¸ªæ–‡ä»¶';
            document.querySelectorAll('.expense-item').forEach(i => i.classList.remove('active'));
        }

        async function saveExpense() {
            const expenseData = {
                event: document.getElementById('expense-event').value,
                location: document.getElementById('expense-location').value,
                start_date: document.getElementById('expense-start-date').value,
                end_date: document.getElementById('expense-end-date').value,
                notes: document.getElementById('expense-notes').value
            };

            try {
                const url = currentExpenseId ? `/api/expenses/${currentExpenseId}` : '/api/expenses';
                const method = currentExpenseId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });
                const data = await res.json();
                if (data.success) {
                    currentExpenseId = data.expense.id;
                    showToast('ä¿å­˜æˆåŠŸ');
                    loadExpenses();
                    loadExpenseItem(currentExpenseId);
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function deleteExpense() {
            if (!currentExpenseId || !confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ¥é”€äº‹é¡¹åŠå…¶æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) return;
            try {
                await fetch(`/api/expenses/${currentExpenseId}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤');
                currentExpenseId = null;
                document.getElementById('expense-empty').style.display = 'block';
                document.getElementById('expense-detail').style.display = 'none';
                loadExpenses();
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
        const dropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone?.addEventListener('click', () => fileInput.click());

        dropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone?.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput?.addEventListener('change', () => handleFiles(fileInput.files));

        async function handleFiles(files) {
            if (!currentExpenseId) {
                showToast('è¯·å…ˆä¿å­˜æŠ¥é”€äº‹é¡¹', 'error');
                return;
            }

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch(`/api/expenses/${currentExpenseId}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`${file.name} ä¸Šä¼ æˆåŠŸ`);
                    } else {
                        showToast(`${file.name} ä¸Šä¼ å¤±è´¥: ${data.error}`, 'error');
                    }
                } catch (e) {
                    showToast(`${file.name} ä¸Šä¼ å¤±è´¥`, 'error');
                }
            }
            loadExpenses();
            loadExpenseItem(currentExpenseId);
        }

        // æ–‡ä»¶æ‹–æ‹½åˆ é™¤
        function startDragFile(e, fileId) {
            e.dataTransfer.setData('text/plain', fileId);
            document.getElementById('trash-zone').classList.add('show');
        }

        function endDragFile(e) {
            document.getElementById('trash-zone').classList.remove('show');
        }

        const trashZone = document.getElementById('trash-zone');
        trashZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            trashZone.classList.add('drag-over');
        });

        trashZone?.addEventListener('dragleave', () => {
            trashZone.classList.remove('drag-over');
        });

        trashZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            const fileId = e.dataTransfer.getData('text/plain');
            trashZone.classList.remove('drag-over', 'show');
            prepareDeleteFile(fileId);
        });

        function prepareDeleteFile(fileId) {
            deleteTarget = { type: 'file', id: fileId };
            document.getElementById('delete-modal-message').textContent = 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚';
            document.getElementById('delete-modal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('show');
            deleteTarget = null;
        }

        async function confirmDelete() {
            if (!deleteTarget) return;

            if (deleteTarget.type === 'file') {
                try {
                    await fetch(`/api/expenses/${currentExpenseId}/files/${deleteTarget.id}`, { method: 'DELETE' });
                    showToast('æ–‡ä»¶å·²åˆ é™¤');
                    loadExpenses();
                    loadExpenseItem(currentExpenseId);
                } catch (e) {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            }
            closeDeleteModal();
        }

        function viewFile(fileId) {
            window.open(`/api/expenses/${currentExpenseId}/file/${fileId}/view`, '_blank');
        }

        // ============ PPT ç”Ÿæˆå™¨åŠŸèƒ½ ============
        let currentPPTId = null;
        let currentTemplate = 'dark-statement';
        let ppts = [];

        async function loadPPTs() {
            try {
                const res = await fetch('/api/ppt');
                const data = await res.json();
                ppts = data.ppts || [];
                renderPPTList();
            } catch (e) {
                console.error('Load PPTs error:', e);
            }
        }

        function renderPPTList() {
            const list = document.getElementById('ppt-list');
            if (ppts.length === 0) {
                list.innerHTML = '<div class="empty-list">æš‚æ—  PPTï¼Œç‚¹å‡»æ–°å»º</div>';
                return;
            }

            list.innerHTML = ppts.map(p => `
                <div class="ppt-item ${p.id === currentPPTId ? 'active' : ''}" onclick="loadPPTItem('${p.id}')">
                    <div class="ppt-item-title">${p.title}</div>
                    <div class="ppt-item-meta">
                        <span>${p.template || 'dark-statement'}</span>
                        <span>${formatDate(p.updated_at)}</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadPPTItem(id) {
            try {
                const res = await fetch(`/api/ppt/${id}`);
                const data = await res.json();
                if (data.success) {
                    const ppt = data.ppt;
                    currentPPTId = ppt.id;

                    document.getElementById('ppt-empty').style.display = 'none';
                    document.getElementById('ppt-detail').style.display = 'flex';
                    document.getElementById('btn-delete-ppt').style.display = '';

                    document.getElementById('ppt-title').value = ppt.title || '';
                    document.getElementById('ppt-main-title').value = ppt.main_title || '';
                    document.getElementById('ppt-subtitle').value = ppt.subtitle || '';
                    document.getElementById('ppt-footer').value = ppt.footer || '';

                    // Set template
                    selectTemplate(ppt.template || 'dark-statement');

                    // Render content blocks
                    const blocksContainer = document.getElementById('content-blocks');
                    blocksContainer.innerHTML = '';
                    (ppt.content_blocks || []).forEach(block => {
                        addContentBlock(block);
                    });

                    renderPPTList();
                    updatePPTPreview();
                }
            } catch (e) {
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        function createPPT() {
            currentPPTId = null;
            document.getElementById('ppt-empty').style.display = 'none';
            document.getElementById('ppt-detail').style.display = 'flex';
            document.getElementById('btn-delete-ppt').style.display = 'none';

            document.getElementById('ppt-title').value = 'æœªå‘½å PPT';
            document.getElementById('ppt-main-title').value = '';
            document.getElementById('ppt-subtitle').value = '';
            document.getElementById('ppt-footer').value = '';

            selectTemplate('dark-statement');
            document.getElementById('content-blocks').innerHTML = '';
            addContentBlock();

            document.querySelectorAll('.ppt-item').forEach(i => i.classList.remove('active'));
            updatePPTPreview();
        }

        function selectTemplate(template) {
            currentTemplate = template;
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.template === template);
            });
            updatePPTPreview();
        }

        function addContentBlock(data = null) {
            const container = document.getElementById('content-blocks');
            const block = document.createElement('div');
            block.className = 'content-block';
            block.innerHTML = `
                <button class="btn-remove-block" onclick="this.parentElement.remove(); updatePPTPreview();">Ã—</button>
                <div class="content-block-header">
                    <input type="text" class="block-title" placeholder="æ ‡é¢˜..." value="${data?.title || ''}" onchange="updatePPTPreview()">
                    <select class="block-type" onchange="updatePPTPreview()">
                        <option value="text" ${data?.type === 'text' ? 'selected' : ''}>æ–‡æœ¬</option>
                        <option value="highlight" ${data?.type === 'highlight' ? 'selected' : ''}>é«˜äº®æ¡†</option>
                        <option value="list" ${data?.type === 'list' ? 'selected' : ''}>åˆ—è¡¨</option>
                    </select>
                </div>
                <textarea class="block-content" placeholder="å†…å®¹ï¼ˆåˆ—è¡¨ç±»å‹æ¯è¡Œä¸€é¡¹ï¼‰..." onchange="updatePPTPreview()">${data?.content || ''}</textarea>
            `;
            container.appendChild(block);
        }

        function getContentBlocks() {
            const blocks = [];
            document.querySelectorAll('.content-block').forEach(block => {
                blocks.push({
                    title: block.querySelector('.block-title').value,
                    type: block.querySelector('.block-type').value,
                    content: block.querySelector('.block-content').value
                });
            });
            return blocks;
        }

        async function savePPT() {
            const pptData = {
                title: document.getElementById('ppt-title').value || 'æœªå‘½å PPT',
                template: currentTemplate,
                main_title: document.getElementById('ppt-main-title').value,
                subtitle: document.getElementById('ppt-subtitle').value,
                content_blocks: getContentBlocks(),
                footer: document.getElementById('ppt-footer').value
            };

            try {
                const url = currentPPTId ? `/api/ppt/${currentPPTId}` : '/api/ppt';
                const method = currentPPTId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pptData)
                });
                const data = await res.json();
                if (data.success) {
                    currentPPTId = data.ppt.id;
                    showToast('ä¿å­˜æˆåŠŸ');
                    loadPPTs();
                    document.getElementById('btn-delete-ppt').style.display = '';
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function deletePPT() {
            if (!currentPPTId || !confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª PPT å—ï¼Ÿ')) return;
            try {
                await fetch(`/api/ppt/${currentPPTId}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤');
                currentPPTId = null;
                document.getElementById('ppt-empty').style.display = 'flex';
                document.getElementById('ppt-detail').style.display = 'none';
                loadPPTs();
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        function updatePPTPreview() {
            const mainTitle = document.getElementById('ppt-main-title').value || 'ä¸»æ ‡é¢˜';
            const subtitle = document.getElementById('ppt-subtitle').value;
            const footer = document.getElementById('ppt-footer').value;
            const blocks = getContentBlocks();

            let blocksHtml = '';
            blocks.forEach(block => {
                if (block.type === 'highlight') {
                    blocksHtml += `<div style="background:rgba(233,69,96,0.15);border-left:4px solid #e94560;padding:15px;border-radius:0 8px 8px 0;margin:10px 0;">
                        <div style="color:#e94560;font-size:12px;font-weight:600;margin-bottom:4px;">${block.title}</div>
                        <div style="color:#fff;font-size:14px;">${block.content}</div>
                    </div>`;
                } else if (block.type === 'list') {
                    const items = block.content.split('\n').filter(i => i.trim());
                    const itemsHtml = items.map(i => `<li style="color:rgba(255,255,255,0.85);font-size:11px;margin:4px 0;">${i}</li>`).join('');
                    blocksHtml += `<div style="margin:10px 0;">
                        <div style="color:#4facfe;font-size:12px;font-weight:600;margin-bottom:4px;">${block.title}</div>
                        <ul style="list-style:disc;padding-left:20px;">${itemsHtml}</ul>
                    </div>`;
                } else {
                    blocksHtml += `<div style="margin:10px 0;">
                        <div style="color:#4facfe;font-size:12px;font-weight:600;margin-bottom:4px;">${block.title}</div>
                        <div style="color:rgba(255,255,255,0.85);font-size:11px;">${block.content}</div>
                    </div>`;
                }
            });

            const previewHtml = `
                <div style="width:100%;height:100%;padding:20px;display:flex;flex-direction:column;">
                    <div style="margin-bottom:15px;">
                        <div style="font-size:18px;font-weight:700;background:linear-gradient(90deg,#fff,#4facfe);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${mainTitle}</div>
                        ${subtitle ? `<div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;">${subtitle}</div>` : ''}
                    </div>
                    <div style="flex:1;overflow:auto;">${blocksHtml}</div>
                    ${footer ? `<div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;font-size:9px;color:rgba(255,255,255,0.4);font-style:italic;">${footer}</div>` : ''}
                </div>
            `;

            const container = document.getElementById('preview-container');
            container.innerHTML = previewHtml;
        }

        function previewPPT() {
            if (!currentPPTId) {
                showToast('è¯·å…ˆä¿å­˜ PPT', 'error');
                return;
            }

            fetch(`/api/ppt/${currentPPTId}/export`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const win = window.open('', '_blank');
                        win.document.write(data.html);
                        win.document.close();
                    }
                });
        }

        function downloadPPT() {
            if (!currentPPTId) {
                showToast('è¯·å…ˆä¿å­˜ PPT', 'error');
                return;
            }

            fetch(`/api/ppt/${currentPPTId}/export`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const blob = new Blob([data.html], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = (document.getElementById('ppt-title').value || 'ppt') + '.html';
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('ä¸‹è½½æˆåŠŸ');
                    }
                });
        }

        // ============ å·¥å…·å‡½æ•° ============
        function formatDate(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            return d.toLocaleDateString('zh-CN');
        }

        function shuffleQuote() {
            fetch('/api/quote/random')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('quote-text').textContent = data.quote;
                });
        }

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            initBubbleChart();
            loadBubbles();
        });
    </script>
{% endblock %}
