{% extends "base.html" %}

{% block title %}æ™ºè„‘ä¸­æ¢ - Time Management{% endblock %}

{% block content %}
    <div class="aichat-container">
        <!-- Left Panel: Model Selection -->
        <div class="model-panel">
            <div class="panel-glow"></div>
            <h3 class="panel-title">é€‰æ‹©æ¨¡å‹</h3>
            <div class="model-list">
                <div class="model-item active" data-model="openai" onclick="selectModel(this)">
                    <div class="model-icon">ğŸ¤–</div>
                    <div class="model-info">
                        <span class="model-name">ChatGPT</span>
                        <span class="model-desc">OpenAI GPT-4</span>
                    </div>
                    <div class="model-status" id="status-openai"></div>
                </div>
                <div class="model-item" data-model="deepseek" onclick="selectModel(this)">
                    <div class="model-icon">ğŸ”</div>
                    <div class="model-info">
                        <span class="model-name">DeepSeek</span>
                        <span class="model-desc">æ·±åº¦æ±‚ç´¢</span>
                    </div>
                    <div class="model-status" id="status-deepseek"></div>
                </div>
            </div>

            <div class="api-config">
                <h4>API é…ç½®</h4>
                <div class="config-item">
                    <label>API Key</label>
                    <input type="password" id="api-key" placeholder="sk-xxxx...">
                </div>
                <button class="btn-save-config" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-model-info">
                    <span class="chat-model-icon">ğŸ¤–</span>
                    <span class="chat-model-name" id="current-model-name">ChatGPT</span>
                    <span class="chat-model-badge">GPT-4</span>
                </div>
                <div class="chat-actions">
                    <button class="btn-clear-chat" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <div class="welcome-icon">âœ¨</div>
                    <h2>æ¬¢è¿ä½¿ç”¨æ™ºè„‘ä¸­æ¢</h2>
                    <p>é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹ï¼Œå¼€å§‹ä½ çš„æ™ºèƒ½å¯¹è¯ä¹‹æ—…</p>
                    <div class="quick-prompts">
                        <button class="quick-prompt" onclick="useQuickPrompt('å¸®æˆ‘åˆ†æä¸€ä¸‹ä»Šå¤©çš„å·¥ä½œå®‰æ’')">ğŸ“‹ åˆ†æå·¥ä½œå®‰æ’</button>
                        <button class="quick-prompt" onclick="useQuickPrompt('ç»™æˆ‘ä¸€äº›æé«˜æ•ˆç‡çš„å»ºè®®')">ğŸ’¡ æ•ˆç‡å»ºè®®</button>
                        <button class="quick-prompt" onclick="useQuickPrompt('å¸®æˆ‘å†™ä¸€å°é‚®ä»¶')">âœ‰ï¸ å†™é‚®ä»¶</button>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-glow"></div>
                <textarea id="chat-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–ä»»åŠ¡..." rows="1" onkeydown="handleInputKeydown(event)"></textarea>
                <button class="btn-send" id="btn-send" onclick="sendMessage()">
                    <span class="send-icon">â¤</span>
                </button>
            </div>
        </div>
    </div>

    <script>
    var currentModel = 'openai';
    var chatMessages = [];  // Conversation history for API
    var isLoading = false;

    var modelConfigs = {
        openai: { name: 'ChatGPT', icon: 'ğŸ¤–', badge: 'GPT-4' },
        deepseek: { name: 'DeepSeek', icon: 'ğŸ”', badge: 'V3' }
    };

    function selectModel(elem) {
        document.querySelectorAll('.model-item').forEach(function(item) {
            item.classList.remove('active');
        });
        elem.classList.add('active');

        currentModel = elem.dataset.model;
        var config = modelConfigs[currentModel];

        document.getElementById('current-model-name').textContent = config.name;
        document.querySelector('.chat-model-icon').textContent = config.icon;
        document.querySelector('.chat-model-badge').textContent = config.badge;

        // Add selection effect
        elem.classList.add('pulse');
        setTimeout(function() {
            elem.classList.remove('pulse');
        }, 300);
    }

    function handleInputKeydown(e) {
        var textarea = e.target;

        // Auto-resize
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';

        // Ctrl+Enter to send
        if (e.ctrlKey && e.key === 'Enter') {
            sendMessage();
        }
    }

    function useQuickPrompt(text) {
        document.getElementById('chat-input').value = text;
        document.getElementById('chat-input').focus();
    }

    function sendMessage() {
        var input = document.getElementById('chat-input');
        var text = input.value.trim();

        if (!text || isLoading) return;

        // Hide welcome message
        var welcome = document.querySelector('.welcome-message');
        if (welcome) {
            welcome.style.display = 'none';
        }

        // Add user message to UI and history
        addMessage('user', text);
        chatMessages.push({ role: 'user', content: text });
        input.value = '';
        input.style.height = 'auto';

        // Show loading
        isLoading = true;
        document.getElementById('btn-send').classList.add('loading');
        addMessage('assistant', 'æ€è€ƒä¸­...', true);

        // Call real API
        fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: currentModel,
                messages: chatMessages
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            removeLoadingMessage();

            if (data.success) {
                var response = data.message;
                addMessage('assistant', response);
                chatMessages.push({ role: 'assistant', content: response });
            } else {
                addMessage('assistant', 'é”™è¯¯: ' + data.error);
            }

            isLoading = false;
            document.getElementById('btn-send').classList.remove('loading');
        })
        .catch(function(err) {
            removeLoadingMessage();
            addMessage('assistant', 'è¯·æ±‚å¤±è´¥: ' + err.message);
            isLoading = false;
            document.getElementById('btn-send').classList.remove('loading');
        });
    }

    function addMessage(role, content, isLoading) {
        var container = document.getElementById('chat-messages');
        var config = modelConfigs[currentModel];

        var messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message ' + role + (isLoading ? ' loading-message' : '');

        var icon = role === 'user' ? 'ğŸ‘¤' : config.icon;

        messageDiv.innerHTML =
            '<div class="message-avatar">' + icon + '</div>' +
            '<div class="message-content">' +
                '<div class="message-text">' + formatMessage(content) + '</div>' +
            '</div>';

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    function removeLoadingMessage() {
        var loading = document.querySelector('.loading-message');
        if (loading) {
            loading.remove();
        }
    }

    function formatMessage(text) {
        // Convert markdown-like formatting
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
    }

    function clearChat() {
        window.AppUtils.showConfirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯å—ï¼Ÿ', function() {
            var container = document.getElementById('chat-messages');
            container.innerHTML =
                '<div class="welcome-message">' +
                    '<div class="welcome-icon">âœ¨</div>' +
                    '<h2>æ¬¢è¿ä½¿ç”¨æ™ºè„‘ä¸­æ¢</h2>' +
                    '<p>é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹ï¼Œå¼€å§‹ä½ çš„æ™ºèƒ½å¯¹è¯ä¹‹æ—…</p>' +
                    '<div class="quick-prompts">' +
                        '<button class="quick-prompt" onclick="useQuickPrompt(\'å¸®æˆ‘åˆ†æä¸€ä¸‹ä»Šå¤©çš„å·¥ä½œå®‰æ’\')">ğŸ“‹ åˆ†æå·¥ä½œå®‰æ’</button>' +
                        '<button class="quick-prompt" onclick="useQuickPrompt(\'ç»™æˆ‘ä¸€äº›æé«˜æ•ˆç‡çš„å»ºè®®\')">ğŸ’¡ æ•ˆç‡å»ºè®®</button>' +
                        '<button class="quick-prompt" onclick="useQuickPrompt(\'å¸®æˆ‘å†™ä¸€å°é‚®ä»¶\')">âœ‰ï¸ å†™é‚®ä»¶</button>' +
                    '</div>' +
                '</div>';

            chatMessages = [];
        }, { confirmText: 'æ¸…ç©º', danger: true });
    }

    function saveConfig() {
        var apiKey = document.getElementById('api-key').value;
        if (!apiKey) {
            alert('è¯·è¾“å…¥ API Key');
            return;
        }

        fetch('/api/chat/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: currentModel,
                api_key: apiKey
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('é…ç½®å·²ä¿å­˜ï¼Œ' + modelConfigs[currentModel].name + ' å·²å¯ç”¨');
                loadModelStatus();
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + data.error);
            }
        });
    }

    // Load model status from server
    function loadModelStatus() {
        fetch('/api/chat/models')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            var models = data.models || {};
            for (var model in models) {
                var statusEl = document.getElementById('status-' + model);
                if (statusEl) {
                    if (models[model].enabled && models[model].configured) {
                        statusEl.className = 'model-status online';
                        statusEl.title = 'å·²é…ç½®';
                    } else {
                        statusEl.className = 'model-status offline';
                        statusEl.title = 'æœªé…ç½®';
                    }
                }
            }
        });
    }

    // Initialize
    loadModelStatus();
    </script>
{% endblock %}
