{% extends "base.html" %}

{% block title %}æ°”æ³¡å›¾å·¥å…· - Time Management{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">æ°”æ³¡å›¾å·¥å…·ç®±</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="bubble-main-layout">
        <!-- å·¦ä¾§ï¼šå†å²ç‰ˆæœ¬åˆ—è¡¨ -->
        <div class="bubble-sidebar">
            <div class="sidebar-header">
                <h3>æˆ‘çš„å›¾è¡¨</h3>
                <button class="btn-new" onclick="createNew()">+ æ–°å»º</button>
            </div>
            <div class="saved-list" id="saved-list">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- å³ä¾§ï¼šä¸»ç¼–è¾‘åŒº -->
        <div class="bubble-editor">
            <!-- å›¾è¡¨æ ‡é¢˜å’Œç®€ä»‹ -->
            <div class="bubble-meta">
                <div class="meta-row">
                    <input type="text" class="chart-title-input" id="chart-title" placeholder="è¾“å…¥å›¾è¡¨æ ‡é¢˜..." value="æœªå‘½åå›¾è¡¨">
                    <div class="meta-actions">
                        <button class="btn-action btn-save" onclick="saveChart()" title="ä¿å­˜">
                            <span class="btn-icon">ğŸ’¾</span> ä¿å­˜
                        </button>
                        <button class="btn-action btn-duplicate" onclick="duplicateChart()" title="å¤åˆ¶ä¸ºæ–°å›¾è¡¨" id="btn-duplicate" style="display:none;">
                            <span class="btn-icon">ğŸ“‹</span> å¤åˆ¶
                        </button>
                        <button class="btn-action btn-delete-chart" onclick="deleteChart()" title="åˆ é™¤" id="btn-delete" style="display:none;">
                            <span class="btn-icon">ğŸ—‘ï¸</span> åˆ é™¤
                        </button>
                    </div>
                </div>
                <textarea class="chart-desc-input" id="chart-desc" placeholder="æ·»åŠ å›¾è¡¨ç®€ä»‹ï¼ˆå¯é€‰ï¼‰..." rows="2"></textarea>
                <div class="chart-info" id="chart-info" style="display:none;">
                    <span class="info-item" id="chart-created"></span>
                    <span class="info-item" id="chart-updated"></span>
                </div>
            </div>

            <div class="bubble-container">
                <!-- å·¦ä¾§ï¼šæ•°æ®è¾“å…¥åŒº -->
                <div class="bubble-panel data-panel">
                    <div class="panel-header">
                        <h3>æ•°æ®è¾“å…¥</h3>
                        <div class="panel-actions">
                            <button class="btn-small" onclick="addRow()">+ æ·»åŠ </button>
                            <button class="btn-small btn-secondary" onclick="loadExample()">åŠ è½½ç¤ºä¾‹</button>
                            <button class="btn-small btn-secondary" onclick="clearAll()">æ¸…ç©º</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table" id="data-table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>Xè½´å€¼</th>
                                    <th>Yè½´å€¼</th>
                                    <th>æ°”æ³¡å¤§å°</th>
                                    <th>é¢œè‰²</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="data-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="axis-labels">
                        <div class="axis-input">
                            <label>Xè½´æ ‡ç­¾ï¼š</label>
                            <input type="text" id="x-axis-label" value="æŠ•å…¥æˆæœ¬" onchange="updateChart()">
                        </div>
                        <div class="axis-input">
                            <label>Yè½´æ ‡ç­¾ï¼š</label>
                            <input type="text" id="y-axis-label" value="æ¢å¤æ•ˆæœ" onchange="updateChart()">
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šå›¾è¡¨å±•ç¤ºåŒº -->
                <div class="bubble-panel chart-panel">
                    <div class="panel-header">
                        <h3>æ°”æ³¡å›¾é¢„è§ˆ</h3>
                        <div class="panel-actions">
                            <button class="btn-small" onclick="downloadChart()">ä¸‹è½½å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="bubble-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- è¯„åˆ†ç»´åº¦é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
            <div class="bubble-panel scoring-panel">
                <div class="panel-header collapsible" onclick="toggleScoring()">
                    <h3>è¯„åˆ†ç»´åº¦é…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
                    <span class="collapse-icon" id="scoring-icon">â–¼</span>
                </div>
                <div class="scoring-content" id="scoring-content" style="display: none;">
                    <div class="scoring-columns">
                        <div class="scoring-column">
                            <h4>Xè½´è¯„åˆ†ç»´åº¦</h4>
                            <div id="x-dimensions">
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å‡†å¤‡æ—¶é—´">
                                    <input type="number" placeholder="æ»¡åˆ†" value="5" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å±•å¼€æ—¶é—´">
                                    <input type="number" placeholder="æ»¡åˆ†" value="30" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å­¦ä¹ æˆæœ¬">
                                    <input type="number" placeholder="æ»¡åˆ†" value="15" min="0">
                                </div>
                            </div>
                            <button class="btn-tiny" onclick="addDimension('x')">+ æ·»åŠ ç»´åº¦</button>
                        </div>
                        <div class="scoring-column">
                            <h4>Yè½´è¯„åˆ†ç»´åº¦</h4>
                            <div id="y-dimensions">
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ç²¾åŠ›æ¢å¤ç¨³å®š">
                                    <input type="number" placeholder="æ»¡åˆ†" value="30" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="æƒ…ç»ªè°ƒèŠ‚">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ç¼“è§£å‹åŠ›">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                            </div>
                            <button class="btn-tiny" onclick="addDimension('y')">+ æ·»åŠ ç»´åº¦</button>
                        </div>
                        <div class="scoring-column">
                            <h4>æ°”æ³¡å¤§å°ç»´åº¦</h4>
                            <div id="size-dimensions">
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ä¸Šè‚¢æ¿€æ´»">
                                    <input type="number" placeholder="æ»¡åˆ†" value="15" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ä¸‹è‚¢æ¿€æ´»">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å…¨èº«æ¿€æ´»">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                            </div>
                            <button class="btn-tiny" onclick="addDimension('size')">+ æ·»åŠ ç»´åº¦</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    var chart = null;
    var currentBubbleId = null;  // å½“å‰ç¼–è¾‘çš„å›¾è¡¨ID
    var colorPalette = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
        '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140',
        '#a8edea', '#fed6e3', '#5ee7df', '#b490ca', '#d299c2'
    ];
    var colorIndex = 0;

    function getNextColor() {
        var color = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
        return color;
    }

    function addRow(name, x, y, size, color) {
        var tbody = document.getElementById('data-body');
        var row = document.createElement('tr');
        var rowColor = color || getNextColor();

        row.innerHTML =
            '<td><input type="text" class="cell-input" value="' + (name || '') + '" onchange="updateChart()"></td>' +
            '<td><input type="number" class="cell-input" value="' + (x || 50) + '" onchange="updateChart()"></td>' +
            '<td><input type="number" class="cell-input" value="' + (y || 50) + '" onchange="updateChart()"></td>' +
            '<td><input type="number" class="cell-input" value="' + (size || 30) + '" onchange="updateChart()"></td>' +
            '<td><input type="color" class="cell-color" value="' + rowColor + '" onchange="updateChart()"></td>' +
            '<td><button class="btn-delete" onclick="deleteRow(this)">Ã—</button></td>';

        tbody.appendChild(row);
        updateChart();
    }

    function deleteRow(btn) {
        btn.closest('tr').remove();
        updateChart();
    }

    function clearAll() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
            document.getElementById('data-body').innerHTML = '';
            colorIndex = 0;
            updateChart();
            showToast('å·²æ¸…ç©º', 'success');
        }
    }

    function getData() {
        var rows = document.querySelectorAll('#data-body tr');
        var data = [];
        rows.forEach(function(row) {
            var inputs = row.querySelectorAll('input');
            var name = inputs[0].value;
            var x = parseFloat(inputs[1].value) || 0;
            var y = parseFloat(inputs[2].value) || 0;
            var size = parseFloat(inputs[3].value) || 10;
            var color = inputs[4].value;

            if (name) {
                data.push({
                    label: name,
                    x: x,
                    y: y,
                    r: Math.max(5, size / 3),
                    backgroundColor: color + '99',
                    borderColor: color,
                    name: name,
                    size: size,
                    color: color
                });
            }
        });
        return data;
    }

    function getTableData() {
        var rows = document.querySelectorAll('#data-body tr');
        var data = [];
        rows.forEach(function(row) {
            var inputs = row.querySelectorAll('input');
            data.push({
                name: inputs[0].value,
                x: parseFloat(inputs[1].value) || 0,
                y: parseFloat(inputs[2].value) || 0,
                size: parseFloat(inputs[3].value) || 10,
                color: inputs[4].value
            });
        });
        return data;
    }

    function updateChart() {
        var ctx = document.getElementById('bubble-chart').getContext('2d');
        var data = getData();

        var datasets = data.map(function(item) {
            return {
                label: item.label,
                data: [{ x: item.x, y: item.y, r: item.r }],
                backgroundColor: item.backgroundColor,
                borderColor: item.borderColor,
                borderWidth: 2
            };
        });

        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'bubble',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var d = context.raw;
                                return context.dataset.label + ': (' + d.x + ', ' + d.y + ')';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: document.getElementById('x-axis-label').value,
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: document.getElementById('y-axis-label').value,
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    }

    function loadExample() {
        document.getElementById('data-body').innerHTML = '';
        colorIndex = 0;

        var examples = [
            ['å†¥æƒ³', 16, 68, 25],
            ['é å¢™é™è¹²', 20, 18, 30],
            ['ç«™æ¡©', 18, 40, 40],
            ['ç«™æ¡©+å†¥æƒ³', 15, 75, 55],
            ['å¤ªæ', 52, 87, 75],
            ['å…«æ®µé”¦', 46, 89, 85],
            ['æ­¦å¼æ˜“ç­‹ç»', 48, 84, 85],
            ['ç¡è§‰', 42, 70, 30],
            ['èººç€', 31, 35, 20],
            ['é æ¤…é—­çœ¼', 22, 30, 15],
            ['èµ°å‡ æ­¥', 15, 30, 20],
            ['å–å’–å•¡', 20, 11, 15],
            ['å¾’æ‰‹æ·±è¹²', 17, 15, 40],
            ['ä¼¸æ‡’è…°', 2, 30, 45],
            ['ç«™ç«‹', 10, 18, 15],
            ['èŠå¤©', 34, 54, 15],
            ['åŠ¨æ€è¸®è„š', 12, 34, 30],
            ['å‘¼å¸å…­å­—è¯€', 16, 49, 40],
            ['ç‘œä¼½', 78, 70, 78],
            ['åˆ·çŸ­è§†é¢‘', 45, 10, 5]
        ];

        examples.forEach(function(item) {
            addRow(item[0], item[1], item[2], item[3]);
        });

        showToast('å·²åŠ è½½ç²¾åŠ›æ¢å¤ç¤ºä¾‹æ•°æ®ï¼ˆå…±20é¡¹ï¼‰', 'success');
    }

    function downloadChart() {
        var canvas = document.getElementById('bubble-chart');
        var link = document.createElement('a');
        var title = document.getElementById('chart-title').value || 'æ°”æ³¡å›¾';
        link.download = title + '_' + new Date().toISOString().slice(0,10) + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('å›¾ç‰‡å·²ä¸‹è½½', 'success');
    }

    function toggleScoring() {
        var content = document.getElementById('scoring-content');
        var icon = document.getElementById('scoring-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = 'â–²';
        } else {
            content.style.display = 'none';
            icon.textContent = 'â–¼';
        }
    }

    function addDimension(axis) {
        var container = document.getElementById(axis + '-dimensions');
        var div = document.createElement('div');
        div.className = 'dimension-item';
        div.innerHTML =
            '<input type="text" placeholder="ç»´åº¦åç§°">' +
            '<input type="number" placeholder="æ»¡åˆ†" value="10" min="0">' +
            '<button class="btn-delete-small" onclick="this.parentElement.remove()">Ã—</button>';
        container.appendChild(div);
    }

    function showToast(message, type) {
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(function() {
            toast.classList.add('toast-hide');
            setTimeout(function() {
                toast.remove();
            }, 300);
        }, 2000);
    }

    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    // ============ ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ ============

    function formatDate(isoString) {
        var date = new Date(isoString);
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return m + '-' + d + ' ' + h + ':' + min;
    }

    function loadSavedList() {
        fetch('/api/bubbles')
            .then(response => response.json())
            .then(data => {
                var list = document.getElementById('saved-list');
                if (data.bubbles.length === 0) {
                    list.innerHTML = '<div class="empty-list">æš‚æ— ä¿å­˜çš„å›¾è¡¨</div>';
                    return;
                }

                list.innerHTML = data.bubbles.map(function(b) {
                    var isActive = b.id === currentBubbleId ? 'active' : '';
                    return '<div class="saved-item ' + isActive + '" onclick="loadBubble(\'' + b.id + '\')">' +
                        '<div class="saved-title">' + escapeHtml(b.title) + '</div>' +
                        '<div class="saved-desc">' + escapeHtml(b.description || 'æš‚æ— ç®€ä»‹') + '</div>' +
                        '<div class="saved-time">æ›´æ–°äº ' + formatDate(b.updated_at) + '</div>' +
                    '</div>';
                }).join('');
            });
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;');
    }

    function createNew() {
        if (currentBubbleId && !confirm('å½“å‰æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦æ–°å»ºå—ï¼Ÿ')) {
            return;
        }
        currentBubbleId = null;
        document.getElementById('chart-title').value = 'æœªå‘½åå›¾è¡¨';
        document.getElementById('chart-desc').value = '';
        document.getElementById('x-axis-label').value = 'æŠ•å…¥æˆæœ¬';
        document.getElementById('y-axis-label').value = 'æ¢å¤æ•ˆæœ';
        document.getElementById('data-body').innerHTML = '';
        document.getElementById('chart-info').style.display = 'none';
        document.getElementById('btn-duplicate').style.display = 'none';
        document.getElementById('btn-delete').style.display = 'none';
        colorIndex = 0;
        addRow('ç¤ºä¾‹1', 30, 60, 40);
        addRow('ç¤ºä¾‹2', 50, 40, 60);
        addRow('ç¤ºä¾‹3', 70, 80, 30);
        loadSavedList();
        showToast('å·²åˆ›å»ºæ–°å›¾è¡¨', 'success');
    }

    function saveChart() {
        var title = document.getElementById('chart-title').value.trim() || 'æœªå‘½åå›¾è¡¨';
        var description = document.getElementById('chart-desc').value.trim();
        var xLabel = document.getElementById('x-axis-label').value;
        var yLabel = document.getElementById('y-axis-label').value;
        var tableData = getTableData();

        var payload = {
            title: title,
            description: description,
            x_label: xLabel,
            y_label: yLabel,
            data: tableData
        };

        var url = currentBubbleId ? '/api/bubbles/' + currentBubbleId : '/api/bubbles';
        var method = currentBubbleId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentBubbleId = data.bubble.id;
                document.getElementById('btn-duplicate').style.display = 'inline-flex';
                document.getElementById('btn-delete').style.display = 'inline-flex';
                updateChartInfo(data.bubble);
                loadSavedList();
                showToast('ä¿å­˜æˆåŠŸ', 'success');
            } else {
                showToast('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('ä¿å­˜å‡ºé”™', 'error');
        });
    }

    function loadBubble(id) {
        fetch('/api/bubbles/' + id)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var b = data.bubble;
                    currentBubbleId = b.id;
                    document.getElementById('chart-title').value = b.title;
                    document.getElementById('chart-desc').value = b.description || '';
                    document.getElementById('x-axis-label').value = b.x_label;
                    document.getElementById('y-axis-label').value = b.y_label;
                    document.getElementById('btn-duplicate').style.display = 'inline-flex';
                    document.getElementById('btn-delete').style.display = 'inline-flex';
                    updateChartInfo(b);

                    // åŠ è½½æ•°æ®
                    document.getElementById('data-body').innerHTML = '';
                    colorIndex = 0;
                    b.data.forEach(function(item) {
                        addRow(item.name, item.x, item.y, item.size, item.color);
                    });

                    loadSavedList();
                    showToast('å·²åŠ è½½: ' + b.title, 'success');
                }
            });
    }

    function duplicateChart() {
        if (!currentBubbleId) {
            showToast('è¯·å…ˆä¿å­˜å½“å‰å›¾è¡¨', 'error');
            return;
        }

        fetch('/api/bubbles/' + currentBubbleId + '/duplicate', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentBubbleId = data.bubble.id;
                    document.getElementById('chart-title').value = data.bubble.title;
                    updateChartInfo(data.bubble);
                    loadSavedList();
                    showToast('å·²åˆ›å»ºå‰¯æœ¬', 'success');
                } else {
                    showToast('å¤åˆ¶å¤±è´¥: ' + data.error, 'error');
                }
            });
    }

    function deleteChart() {
        if (!currentBubbleId) return;

        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå›¾è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }

        fetch('/api/bubbles/' + currentBubbleId, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('å·²åˆ é™¤', 'success');
                    createNew();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            });
    }

    function updateChartInfo(bubble) {
        document.getElementById('chart-info').style.display = 'flex';
        document.getElementById('chart-created').textContent = 'åˆ›å»ºäº ' + formatDate(bubble.created_at);
        document.getElementById('chart-updated').textContent = 'æ›´æ–°äº ' + formatDate(bubble.updated_at);
    }

    // åˆå§‹åŒ–
    addRow('ç¤ºä¾‹1', 30, 60, 40);
    addRow('ç¤ºä¾‹2', 50, 40, 60);
    addRow('ç¤ºä¾‹3', 70, 80, 30);
    loadSavedList();
    </script>
{% endblock %}
