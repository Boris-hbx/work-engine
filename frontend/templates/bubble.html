{% extends "base.html" %}

{% block title %}æ°”æ³¡å›¾å·¥å…· - Time Management{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">æ°”æ³¡å›¾å·¥å…·ç®±</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="bubble-main-layout">
        <!-- å·¦ä¾§ï¼šå†å²ç‰ˆæœ¬åˆ—è¡¨ -->
        <div class="bubble-sidebar">
            <div class="sidebar-header">
                <h3>å·¥å…·æ </h3>
                <button class="btn-new" onclick="createNew()">+ æ–°å»º</button>
            </div>
            <div class="saved-list" id="saved-list">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- å³ä¾§ï¼šä¸»ç¼–è¾‘åŒº -->
        <div class="bubble-editor">
            <!-- å›¾è¡¨æ ‡é¢˜å’Œç®€ä»‹ -->
            <div class="bubble-meta">
                <div class="meta-row">
                    <input type="text" class="chart-title-input" id="chart-title" placeholder="è¾“å…¥å›¾è¡¨æ ‡é¢˜..." value="æœªå‘½åå›¾è¡¨">
                    <div class="meta-actions">
                        <button class="btn-action btn-save" onclick="saveChart()" title="ä¿å­˜">
                            <span class="btn-icon">ğŸ’¾</span> ä¿å­˜
                        </button>
                        <button class="btn-action btn-duplicate" onclick="duplicateChart()" title="å¤åˆ¶ä¸ºæ–°å›¾è¡¨" id="btn-duplicate" style="display:none;">
                            <span class="btn-icon">ğŸ“‹</span> å¤åˆ¶
                        </button>
                        <button class="btn-action btn-delete-chart" onclick="deleteChart()" title="åˆ é™¤" id="btn-delete" style="display:none;">
                            <span class="btn-icon">ğŸ—‘ï¸</span> åˆ é™¤
                        </button>
                    </div>
                </div>
                <textarea class="chart-desc-input" id="chart-desc" placeholder="æ·»åŠ å›¾è¡¨ç®€ä»‹ï¼ˆå¯é€‰ï¼‰..." rows="2"></textarea>
                <div class="chart-info" id="chart-info" style="display:none;">
                    <span class="info-item" id="chart-created"></span>
                    <span class="info-item" id="chart-updated"></span>
                </div>
            </div>

            <div class="bubble-container">
                <!-- å·¦ä¾§ï¼šæ•°æ®è¾“å…¥åŒº -->
                <div class="bubble-panel data-panel">
                    <div class="panel-header">
                        <h3>æ•°æ®è¾“å…¥</h3>
                        <div class="panel-actions">
                            <button class="btn-small" onclick="addRow()">+ æ·»åŠ </button>
                            <button class="btn-small btn-secondary" onclick="loadExample()">åŠ è½½ç¤ºä¾‹</button>
                            <button class="btn-small btn-secondary" onclick="clearAll()">æ¸…ç©º</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table" id="data-table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>Xè½´å€¼</th>
                                    <th>Yè½´å€¼</th>
                                    <th>æ°”æ³¡å¤§å°</th>
                                    <th>é¢œè‰²</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="data-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="axis-labels">
                        <div class="axis-input">
                            <label>Xè½´æ ‡ç­¾ï¼š</label>
                            <input type="text" id="x-axis-label" value="æŠ•å…¥æˆæœ¬" onchange="updateChart()">
                        </div>
                        <div class="axis-input">
                            <label>Yè½´æ ‡ç­¾ï¼š</label>
                            <input type="text" id="y-axis-label" value="æ¢å¤æ•ˆæœ" onchange="updateChart()">
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šå›¾è¡¨å±•ç¤ºåŒº -->
                <div class="bubble-panel chart-panel">
                    <div class="panel-header">
                        <h3>æ°”æ³¡å›¾é¢„è§ˆ</h3>
                        <div class="panel-actions">
                            <button class="btn-small" onclick="downloadChart()">ä¸‹è½½å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="bubble-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- è¯„åˆ†ç»´åº¦é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
            <div class="bubble-panel scoring-panel">
                <div class="panel-header collapsible" onclick="toggleScoring()">
                    <h3>è¯„åˆ†ç»´åº¦é…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
                    <span class="collapse-icon" id="scoring-icon">â–¼</span>
                </div>
                <div class="scoring-content" id="scoring-content" style="display: none;">
                    <div class="scoring-columns">
                        <div class="scoring-column">
                            <h4>Xè½´è¯„åˆ†ç»´åº¦</h4>
                            <div id="x-dimensions">
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å‡†å¤‡æ—¶é—´">
                                    <input type="number" placeholder="æ»¡åˆ†" value="5" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å±•å¼€æ—¶é—´">
                                    <input type="number" placeholder="æ»¡åˆ†" value="30" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å­¦ä¹ æˆæœ¬">
                                    <input type="number" placeholder="æ»¡åˆ†" value="15" min="0">
                                </div>
                            </div>
                            <button class="btn-tiny" onclick="addDimension('x')">+ æ·»åŠ ç»´åº¦</button>
                        </div>
                        <div class="scoring-column">
                            <h4>Yè½´è¯„åˆ†ç»´åº¦</h4>
                            <div id="y-dimensions">
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ç²¾åŠ›æ¢å¤ç¨³å®š">
                                    <input type="number" placeholder="æ»¡åˆ†" value="30" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="æƒ…ç»ªè°ƒèŠ‚">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ç¼“è§£å‹åŠ›">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                            </div>
                            <button class="btn-tiny" onclick="addDimension('y')">+ æ·»åŠ ç»´åº¦</button>
                        </div>
                        <div class="scoring-column">
                            <h4>æ°”æ³¡å¤§å°ç»´åº¦</h4>
                            <div id="size-dimensions">
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ä¸Šè‚¢æ¿€æ´»">
                                    <input type="number" placeholder="æ»¡åˆ†" value="15" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="ä¸‹è‚¢æ¿€æ´»">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                                <div class="dimension-item">
                                    <input type="text" placeholder="ç»´åº¦åç§°" value="å…¨èº«æ¿€æ´»">
                                    <input type="number" placeholder="æ»¡åˆ†" value="20" min="0">
                                </div>
                            </div>
                            <button class="btn-tiny" onclick="addDimension('size')">+ æ·»åŠ ç»´åº¦</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
    var chart = null;
    var currentBubbleId = null;  // å½“å‰ç¼–è¾‘çš„å›¾è¡¨ID
    var colorPalette = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
        '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140',
        '#a8edea', '#fed6e3', '#5ee7df', '#b490ca', '#d299c2'
    ];
    var colorIndex = 0;

    function getNextColor() {
        var color = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
        return color;
    }

    function addRow(name, x, y, size, color) {
        var tbody = document.getElementById('data-body');
        var row = document.createElement('tr');
        var rowColor = color || getNextColor();

        row.innerHTML =
            '<td><input type="text" class="cell-input" value="' + (name || '') + '" onchange="updateChart()"></td>' +
            '<td><input type="number" class="cell-input" value="' + (x || 50) + '" onchange="updateChart()"></td>' +
            '<td><input type="number" class="cell-input" value="' + (y || 50) + '" onchange="updateChart()"></td>' +
            '<td><input type="number" class="cell-input" value="' + (size || 30) + '" onchange="updateChart()"></td>' +
            '<td><input type="color" class="cell-color" value="' + rowColor + '" onchange="updateChart()"></td>' +
            '<td><button class="btn-delete" onclick="deleteRow(this)">Ã—</button></td>';

        tbody.appendChild(row);
        updateChart();
    }

    function deleteRow(btn) {
        btn.closest('tr').remove();
        updateChart();
    }

    function clearAll() {
        window.AppUtils.showConfirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ', function() {
            document.getElementById('data-body').innerHTML = '';
            colorIndex = 0;
            updateChart();
            showToast('å·²æ¸…ç©º', 'success');
        }, { confirmText: 'æ¸…ç©º', danger: true });
    }

    function getData() {
        var rows = document.querySelectorAll('#data-body tr');
        var data = [];
        rows.forEach(function(row) {
            var inputs = row.querySelectorAll('input');
            var name = inputs[0].value;
            var x = parseFloat(inputs[1].value) || 0;
            var y = parseFloat(inputs[2].value) || 0;
            var size = parseFloat(inputs[3].value) || 10;
            var color = inputs[4].value;

            if (name) {
                data.push({
                    label: name,
                    x: x,
                    y: y,
                    r: Math.max(5, size / 3),
                    backgroundColor: color + '99',
                    borderColor: color,
                    name: name,
                    size: size,
                    color: color
                });
            }
        });
        return data;
    }

    function getTableData() {
        var rows = document.querySelectorAll('#data-body tr');
        var data = [];
        rows.forEach(function(row) {
            var inputs = row.querySelectorAll('input');
            data.push({
                name: inputs[0].value,
                x: parseFloat(inputs[1].value) || 0,
                y: parseFloat(inputs[2].value) || 0,
                size: parseFloat(inputs[3].value) || 10,
                color: inputs[4].value
            });
        });
        return data;
    }

    // æ™ºèƒ½æ ‡ç­¾ä½ç½®è®¡ç®—å™¨
    var labelPositionCache = {};

    // 8ä¸ªå¯é€‰æ–¹å‘ï¼šå³ã€å·¦ã€ä¸Šã€ä¸‹ã€å³ä¸Šã€å³ä¸‹ã€å·¦ä¸Šã€å·¦ä¸‹
    var LABEL_DIRECTIONS = [
        { name: 'right',      anchor: 'start', align: 'right',  dx: 1,  dy: 0 },
        { name: 'left',       anchor: 'end',   align: 'left',   dx: -1, dy: 0 },
        { name: 'top',        anchor: 'end',   align: 'top',    dx: 0,  dy: -1 },
        { name: 'bottom',     anchor: 'start', align: 'bottom', dx: 0,  dy: 1 },
        { name: 'top-right',  anchor: 'start', align: 'top',    dx: 0.7, dy: -0.7 },
        { name: 'top-left',   anchor: 'end',   align: 'top',    dx: -0.7, dy: -0.7 },
        { name: 'bottom-right', anchor: 'start', align: 'bottom', dx: 0.7, dy: 0.7 },
        { name: 'bottom-left',  anchor: 'end',   align: 'bottom', dx: -0.7, dy: 0.7 }
    ];

    function calculateOptimalLabelPositions(chartData, scales) {
        var bubbles = chartData.map(function(item, index) {
            return {
                index: index,
                label: item.label,
                x: scales.x.getPixelForValue(item.x),
                y: scales.y.getPixelForValue(item.y),
                r: item.r * 2,  // åƒç´ åŠå¾„
                dataX: item.x,
                dataY: item.y
            };
        });

        var xMin = scales.x.left;
        var xMax = scales.x.right;
        var yMin = scales.y.top;
        var yMax = scales.y.bottom;
        var xRange = scales.x.max - scales.x.min;
        var yRange = scales.y.max - scales.y.min;

        var positions = {};
        var placedLabels = [];  // å·²æ”¾ç½®æ ‡ç­¾çš„è¾¹ç•Œæ¡†

        // æŒ‰æ°”æ³¡å¤§å°æ’åºï¼Œå¤§çš„å…ˆæ”¾ç½®ï¼ˆæ›´é‡è¦ï¼‰
        var sortedBubbles = bubbles.slice().sort(function(a, b) {
            return b.r - a.r;
        });

        sortedBubbles.forEach(function(bubble) {
            var labelWidth = bubble.label.length * 7 + 4;  // ä¼°ç®—æ ‡ç­¾å®½åº¦
            var labelHeight = 14;
            var offset = bubble.r + 6;  // æ ‡ç­¾è·ç¦»æ°”æ³¡ä¸­å¿ƒçš„è·ç¦»

            // æ ¹æ®æ°”æ³¡ä½ç½®ç¡®å®šé¦–é€‰æ–¹å‘
            var preferredDirs = getPreferredDirections(bubble, xMin, xMax, yMin, yMax, xRange, yRange, scales);

            var bestDir = null;
            var minOverlap = Infinity;

            // éå†æ‰€æœ‰æ–¹å‘ï¼Œæ‰¾åˆ°æœ€ä½³ä½ç½®
            for (var i = 0; i < preferredDirs.length; i++) {
                var dir = preferredDirs[i];
                var labelX = bubble.x + dir.dx * offset;
                var labelY = bubble.y + dir.dy * offset;

                // è®¡ç®—æ ‡ç­¾è¾¹ç•Œæ¡†
                var bounds = calculateLabelBounds(labelX, labelY, labelWidth, labelHeight, dir);

                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå›¾è¡¨è¾¹ç•Œ
                if (bounds.left < xMin - 10 || bounds.right > xMax + 10 ||
                    bounds.top < yMin - 10 || bounds.bottom > yMax + 10) {
                    continue;
                }

                // è®¡ç®—ä¸å…¶ä»–æ°”æ³¡çš„é‡å ç¨‹åº¦
                var bubbleOverlap = 0;
                for (var j = 0; j < bubbles.length; j++) {
                    if (bubbles[j].index === bubble.index) continue;
                    var other = bubbles[j];
                    var dist = Math.sqrt(Math.pow(labelX - other.x, 2) + Math.pow(labelY - other.y, 2));
                    if (dist < other.r + 5) {
                        bubbleOverlap += (other.r + 5 - dist);
                    }
                }

                // è®¡ç®—ä¸å·²æ”¾ç½®æ ‡ç­¾çš„é‡å ç¨‹åº¦
                var labelOverlap = 0;
                for (var k = 0; k < placedLabels.length; k++) {
                    var placed = placedLabels[k];
                    var overlapX = Math.max(0, Math.min(bounds.right, placed.right) - Math.max(bounds.left, placed.left));
                    var overlapY = Math.max(0, Math.min(bounds.bottom, placed.bottom) - Math.max(bounds.top, placed.top));
                    labelOverlap += overlapX * overlapY;
                }

                var totalOverlap = bubbleOverlap * 10 + labelOverlap;  // æ°”æ³¡é‡å æƒé‡æ›´é«˜

                if (totalOverlap === 0) {
                    bestDir = dir;
                    placedLabels.push(bounds);
                    break;
                }

                if (totalOverlap < minOverlap) {
                    minOverlap = totalOverlap;
                    bestDir = dir;
                }
            }

            if (!bestDir) {
                bestDir = preferredDirs[0];
            }

            // å¦‚æœæ²¡æ‰¾åˆ°å®Œç¾ä½ç½®ï¼Œè®°å½•æœ€ä½³ä½ç½®çš„è¾¹ç•Œæ¡†
            if (minOverlap > 0 && minOverlap !== Infinity) {
                var labelX = bubble.x + bestDir.dx * offset;
                var labelY = bubble.y + bestDir.dy * offset;
                placedLabels.push(calculateLabelBounds(labelX, labelY, labelWidth, labelHeight, bestDir));
            }

            positions[bubble.index] = bestDir;
        });

        return positions;
    }

    function getPreferredDirections(bubble, xMin, xMax, yMin, yMax, xRange, yRange, scales) {
        // è®¡ç®—æ°”æ³¡åœ¨å›¾è¡¨ä¸­çš„ç›¸å¯¹ä½ç½® (0-1)
        var relX = (bubble.dataX - scales.x.min) / xRange;
        var relY = (bubble.dataY - scales.y.min) / yRange;

        var dirs = [];

        // æ ¹æ®ä½ç½®ç¡®å®šé¦–é€‰æ–¹å‘
        // å³ä¾§åŒºåŸŸ â†’ ä¼˜å…ˆå·¦è¾¹
        // å·¦ä¾§åŒºåŸŸ â†’ ä¼˜å…ˆå³è¾¹
        // ä¸Šæ–¹åŒºåŸŸ â†’ ä¼˜å…ˆä¸‹è¾¹
        // ä¸‹æ–¹åŒºåŸŸ â†’ ä¼˜å…ˆä¸Šè¾¹

        if (relX > 0.7) {
            // æ°”æ³¡åœ¨å³ä¾§ï¼Œæ ‡ç­¾æ”¾å·¦è¾¹
            dirs.push(LABEL_DIRECTIONS[1]);  // left
            dirs.push(LABEL_DIRECTIONS[5]);  // top-left
            dirs.push(LABEL_DIRECTIONS[7]);  // bottom-left
        } else if (relX < 0.3) {
            // æ°”æ³¡åœ¨å·¦ä¾§ï¼Œæ ‡ç­¾æ”¾å³è¾¹
            dirs.push(LABEL_DIRECTIONS[0]);  // right
            dirs.push(LABEL_DIRECTIONS[4]);  // top-right
            dirs.push(LABEL_DIRECTIONS[6]);  // bottom-right
        }

        if (relY > 0.7) {
            // æ°”æ³¡åœ¨ä¸Šæ–¹ï¼Œæ ‡ç­¾æ”¾ä¸‹è¾¹
            dirs.push(LABEL_DIRECTIONS[3]);  // bottom
            if (relX <= 0.5) dirs.push(LABEL_DIRECTIONS[6]);  // bottom-right
            if (relX > 0.5) dirs.push(LABEL_DIRECTIONS[7]);   // bottom-left
        } else if (relY < 0.3) {
            // æ°”æ³¡åœ¨ä¸‹æ–¹ï¼Œæ ‡ç­¾æ”¾ä¸Šè¾¹
            dirs.push(LABEL_DIRECTIONS[2]);  // top
            if (relX <= 0.5) dirs.push(LABEL_DIRECTIONS[4]);  // top-right
            if (relX > 0.5) dirs.push(LABEL_DIRECTIONS[5]);   // top-left
        }

        // æ·»åŠ å‰©ä½™æ–¹å‘ä½œä¸ºå¤‡é€‰
        LABEL_DIRECTIONS.forEach(function(dir) {
            if (dirs.indexOf(dir) === -1) {
                dirs.push(dir);
            }
        });

        return dirs;
    }

    function calculateLabelBounds(x, y, width, height, dir) {
        var left, right, top, bottom;

        // æ ¹æ®å¯¹é½æ–¹å¼è®¡ç®—è¾¹ç•Œæ¡†
        if (dir.align === 'left') {
            right = x - 2;
            left = right - width;
        } else if (dir.align === 'right') {
            left = x + 2;
            right = left + width;
        } else {
            left = x - width / 2;
            right = x + width / 2;
        }

        if (dir.align === 'top' || dir.name.indexOf('top') >= 0) {
            bottom = y - 2;
            top = bottom - height;
        } else if (dir.align === 'bottom' || dir.name.indexOf('bottom') >= 0) {
            top = y + 2;
            bottom = top + height;
        } else {
            top = y - height / 2;
            bottom = y + height / 2;
        }

        return { left: left, right: right, top: top, bottom: bottom };
    }

    function updateChart() {
        var ctx = document.getElementById('bubble-chart').getContext('2d');
        var data = getData();

        var datasets = data.map(function(item, index) {
            return {
                label: item.label,
                data: [{ x: item.x, y: item.y, r: item.r }],
                backgroundColor: item.backgroundColor,
                borderColor: item.borderColor,
                borderWidth: 2,
                dataIndex: index  // ç”¨äºæ ‡ç­¾ä½ç½®æŸ¥æ‰¾
            };
        });

        if (chart) {
            chart.destroy();
        }

        // é‡ç½®æ ‡ç­¾ä½ç½®ç¼“å­˜å’Œæ›´æ–°æ ‡å¿—
        labelPositionCache = {};
        var labelPositionsCalculated = false;

        chart = new Chart(ctx, {
            type: 'bubble',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var d = context.raw;
                                return context.dataset.label + ': (' + d.x + ', ' + d.y + ')';
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#333',
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        // æ— è¾¹æ¡†æ ·å¼
                        backgroundColor: null,
                        borderColor: null,
                        borderRadius: 0,
                        borderWidth: 0,
                        padding: 0,
                        // åŠ¨æ€è®¡ç®—é”šç‚¹å’Œå¯¹é½
                        anchor: function(context) {
                            var idx = context.dataset.dataIndex;
                            var pos = labelPositionCache[idx];
                            return pos ? pos.anchor : 'end';
                        },
                        align: function(context) {
                            var idx = context.dataset.dataIndex;
                            var pos = labelPositionCache[idx];
                            return pos ? pos.align : 'right';
                        },
                        offset: function(context) {
                            var r = context.dataset.data[0].r;
                            return r + 4;  // æ ‡ç­¾è·ç¦»æ°”æ³¡è¾¹ç¼˜çš„è·ç¦»
                        },
                        formatter: function(value, context) {
                            return context.dataset.label;
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: document.getElementById('x-axis-label').value,
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: document.getElementById('y-axis-label').value,
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            },
            plugins: [{
                id: 'labelPositionCalculator',
                afterLayout: function(chartInstance) {
                    // å¸ƒå±€å®Œæˆåè®¡ç®—æœ€ä¼˜æ ‡ç­¾ä½ç½®ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
                    if (!labelPositionsCalculated && chartInstance.scales && chartInstance.scales.x && chartInstance.scales.y) {
                        labelPositionCache = calculateOptimalLabelPositions(data, chartInstance.scales);
                        labelPositionsCalculated = true;
                        // å»¶è¿Ÿé‡ç»˜ä»¥åº”ç”¨æ–°ä½ç½®
                        setTimeout(function() {
                            chartInstance.update('none');
                        }, 0);
                    }
                }
            }]
        });
    }

    function loadExample() {
        document.getElementById('data-body').innerHTML = '';
        colorIndex = 0;

        var examples = [
            ['å†¥æƒ³', 16, 68, 25],
            ['é å¢™é™è¹²', 20, 18, 30],
            ['ç«™æ¡©', 18, 40, 40],
            ['ç«™æ¡©+å†¥æƒ³', 15, 75, 55],
            ['å¤ªæ', 52, 87, 75],
            ['å…«æ®µé”¦', 46, 89, 85],
            ['æ­¦å¼æ˜“ç­‹ç»', 48, 84, 85],
            ['ç¡è§‰', 42, 70, 30],
            ['èººç€', 31, 35, 20],
            ['é æ¤…é—­çœ¼', 22, 30, 15],
            ['èµ°å‡ æ­¥', 15, 30, 20],
            ['å–å’–å•¡', 20, 11, 15],
            ['å¾’æ‰‹æ·±è¹²', 17, 15, 40],
            ['ä¼¸æ‡’è…°', 2, 30, 45],
            ['ç«™ç«‹', 10, 18, 15],
            ['èŠå¤©', 34, 54, 15],
            ['åŠ¨æ€è¸®è„š', 12, 34, 30],
            ['å‘¼å¸å…­å­—è¯€', 16, 49, 40],
            ['ç‘œä¼½', 78, 70, 78],
            ['åˆ·çŸ­è§†é¢‘', 45, 10, 5]
        ];

        examples.forEach(function(item) {
            addRow(item[0], item[1], item[2], item[3]);
        });

        showToast('å·²åŠ è½½ç²¾åŠ›æ¢å¤ç¤ºä¾‹æ•°æ®ï¼ˆå…±20é¡¹ï¼‰', 'success');
    }

    function downloadChart() {
        var canvas = document.getElementById('bubble-chart');
        var link = document.createElement('a');
        var title = document.getElementById('chart-title').value || 'æ°”æ³¡å›¾';
        link.download = title + '_' + new Date().toISOString().slice(0,10) + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('å›¾ç‰‡å·²ä¸‹è½½', 'success');
    }

    function toggleScoring() {
        var content = document.getElementById('scoring-content');
        var icon = document.getElementById('scoring-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = 'â–²';
        } else {
            content.style.display = 'none';
            icon.textContent = 'â–¼';
        }
    }

    function addDimension(axis) {
        var container = document.getElementById(axis + '-dimensions');
        var div = document.createElement('div');
        div.className = 'dimension-item';
        div.innerHTML =
            '<input type="text" placeholder="ç»´åº¦åç§°">' +
            '<input type="number" placeholder="æ»¡åˆ†" value="10" min="0">' +
            '<button class="btn-delete-small" onclick="this.parentElement.remove()">Ã—</button>';
        container.appendChild(div);
    }

    function showToast(message, type) {
        AppUtils.showToast(message, type);
    }

    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    // ============ ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ ============

    function formatDate(isoString) {
        var date = new Date(isoString);
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return m + '-' + d + ' ' + h + ':' + min;
    }

    function loadSavedList() {
        fetch('/api/bubbles')
            .then(response => response.json())
            .then(data => {
                var list = document.getElementById('saved-list');
                if (data.bubbles.length === 0) {
                    list.innerHTML = '<div class="empty-list">æš‚æ— ä¿å­˜çš„å›¾è¡¨</div>';
                    return;
                }

                list.innerHTML = data.bubbles.map(function(b) {
                    var isActive = b.id === currentBubbleId ? 'active' : '';
                    return '<div class="saved-item ' + isActive + '" onclick="loadBubble(\'' + b.id + '\')">' +
                        '<div class="saved-title">' + escapeHtml(b.title) + '</div>' +
                        '<div class="saved-desc">' + escapeHtml(b.description || 'æš‚æ— ç®€ä»‹') + '</div>' +
                        '<div class="saved-time">æ›´æ–°äº ' + formatDate(b.updated_at) + '</div>' +
                    '</div>';
                }).join('');
            });
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;');
    }

    function createNew() {
        var doCreate = function() {
            currentBubbleId = null;
            document.getElementById('chart-title').value = 'æœªå‘½åå›¾è¡¨';
            document.getElementById('chart-desc').value = '';
            document.getElementById('x-axis-label').value = 'æŠ•å…¥æˆæœ¬';
            document.getElementById('y-axis-label').value = 'æ¢å¤æ•ˆæœ';
            document.getElementById('data-body').innerHTML = '';
            document.getElementById('chart-info').style.display = 'none';
            document.getElementById('btn-duplicate').style.display = 'none';
            document.getElementById('btn-delete').style.display = 'none';
            colorIndex = 0;
            addRow('ç¤ºä¾‹1', 30, 60, 40);
            addRow('ç¤ºä¾‹2', 50, 40, 60);
            addRow('ç¤ºä¾‹3', 70, 80, 30);
            loadSavedList();
            showToast('å·²åˆ›å»ºæ–°å›¾è¡¨', 'success');
        };

        if (currentBubbleId) {
            window.AppUtils.showConfirm('å½“å‰æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦æ–°å»ºå—ï¼Ÿ', doCreate, { confirmText: 'æ–°å»º' });
        } else {
            doCreate();
        }
    }

    function saveChart() {
        var title = document.getElementById('chart-title').value.trim() || 'æœªå‘½åå›¾è¡¨';
        var description = document.getElementById('chart-desc').value.trim();
        var xLabel = document.getElementById('x-axis-label').value;
        var yLabel = document.getElementById('y-axis-label').value;
        var tableData = getTableData();

        var payload = {
            title: title,
            description: description,
            x_label: xLabel,
            y_label: yLabel,
            data: tableData
        };

        var url = currentBubbleId ? '/api/bubbles/' + currentBubbleId : '/api/bubbles';
        var method = currentBubbleId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentBubbleId = data.bubble.id;
                document.getElementById('btn-duplicate').style.display = 'inline-flex';
                document.getElementById('btn-delete').style.display = 'inline-flex';
                updateChartInfo(data.bubble);
                loadSavedList();
                showToast('ä¿å­˜æˆåŠŸ', 'success');
            } else {
                showToast('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('ä¿å­˜å‡ºé”™', 'error');
        });
    }

    function loadBubble(id) {
        fetch('/api/bubbles/' + id)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var b = data.bubble;
                    currentBubbleId = b.id;
                    document.getElementById('chart-title').value = b.title;
                    document.getElementById('chart-desc').value = b.description || '';
                    document.getElementById('x-axis-label').value = b.x_label;
                    document.getElementById('y-axis-label').value = b.y_label;
                    document.getElementById('btn-duplicate').style.display = 'inline-flex';
                    document.getElementById('btn-delete').style.display = 'inline-flex';
                    updateChartInfo(b);

                    // åŠ è½½æ•°æ®
                    document.getElementById('data-body').innerHTML = '';
                    colorIndex = 0;
                    b.data.forEach(function(item) {
                        addRow(item.name, item.x, item.y, item.size, item.color);
                    });

                    loadSavedList();
                    showToast('å·²åŠ è½½: ' + b.title, 'success');
                }
            });
    }

    function duplicateChart() {
        if (!currentBubbleId) {
            showToast('è¯·å…ˆä¿å­˜å½“å‰å›¾è¡¨', 'error');
            return;
        }

        fetch('/api/bubbles/' + currentBubbleId + '/duplicate', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentBubbleId = data.bubble.id;
                    document.getElementById('chart-title').value = data.bubble.title;
                    updateChartInfo(data.bubble);
                    loadSavedList();
                    showToast('å·²åˆ›å»ºå‰¯æœ¬', 'success');
                } else {
                    showToast('å¤åˆ¶å¤±è´¥: ' + data.error, 'error');
                }
            });
    }

    function deleteChart() {
        if (!currentBubbleId) return;

        window.AppUtils.showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå›¾è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', function() {
            fetch('/api/bubbles/' + currentBubbleId, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('å·²åˆ é™¤', 'success');
                        createNew();
                    } else {
                        showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                    }
                });
        }, { confirmText: 'åˆ é™¤', danger: true });
    }

    function updateChartInfo(bubble) {
        document.getElementById('chart-info').style.display = 'flex';
        document.getElementById('chart-created').textContent = 'åˆ›å»ºäº ' + formatDate(bubble.created_at);
        document.getElementById('chart-updated').textContent = 'æ›´æ–°äº ' + formatDate(bubble.updated_at);
    }

    // åˆå§‹åŒ–
    addRow('ç¤ºä¾‹1', 30, 60, 40);
    addRow('ç¤ºä¾‹2', 50, 40, 60);
    addRow('ç¤ºä¾‹3', 70, 80, 30);
    loadSavedList();
    </script>
{% endblock %}
