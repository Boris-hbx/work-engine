{% extends "shared/base_core.html" %}

{% block platform_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/desktop.css') }}">
{% endblock %}

{% block body_class %}platform-desktop{% endblock %}

{% block body_content %}
<!-- ç²’å­åŠ¨ç”»ç”»å¸ƒï¼ˆè¦†ç›–é¡¶æ +ä¾§è¾¹æ çš„Lå½¢åŒºåŸŸï¼‰ -->
<canvas id="header-particles" class="particles-canvas-extended"></canvas>

<!-- GitHubé£æ ¼é¡¶éƒ¨å¯¼èˆªæ  -->
<header class="top-header" id="top-header">
    <div class="header-left">
        <button class="header-menu-btn" id="header-menu-btn" title="èœå•">
            <span class="menu-icon">â˜°</span>
        </button>
        <span class="header-logo" id="header-logo" title="ç‚¹å‡»è®¾ç½®å°çƒæ•°é‡" style="cursor:pointer;">âš¡</span>
        <span class="header-title">Boris Life</span>
    </div>
    <div class="header-right">
        <div class="header-user" id="header-user" style="display:none;">
            <span class="user-name" id="user-display-name"></span>
            <button class="logout-btn" onclick="handleLogout()" title="ç™»å‡º">é€€å‡º</button>
        </div>
        <div class="header-avatar" id="header-avatar" onclick="nextAvatarQuote()">
            <span class="avatar-text">B</span>
            <div class="avatar-quote-tooltip" id="avatar-quote-tooltip">
                <div class="quote-content" id="avatar-quote-content">Loading...</div>
                <div class="quote-hint">ç‚¹å‡»æ¢ä¸€å¥</div>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <!-- å·¦ä¾§æç¤ºæ¡ - ä¾§è¾¹æ æ”¶èµ·æ—¶æ˜¾ç¤º -->
    <div class="sidebar-hint" id="sidebar-hint">
        <div class="hint-glow"></div>
    </div>

    <!-- å°å® ç‰© - å§‹ç»ˆå¯è§ -->
    <div class="pet" id="pet">
        <div class="pet-eye"></div>
        <div class="pet-eye"></div>
        <div class="pet-eye"></div>
    </div>

    <!-- Left Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-links">
            <a href="{{ url_for('main') }}" class="nav-link {% if current_page == 'main' %}active{% endif %}">ä¸»é¡µ</a>
            <a href="{{ url_for('todo') }}" class="nav-link {% if current_page == 'todo' %}active{% endif %}">Todo</a>
            <a href="{{ url_for('motivation') }}" class="nav-link {% if current_page == 'motivation' %}active{% endif %}">ç¨‹åºå‘˜é¼“åŠ±å¤§å¸ˆ</a>
            <a href="{{ url_for('bubble') }}" class="nav-link {% if current_page == 'bubble' %}active{% endif %}">æ°”æ³¡å›¾å·¥å…·</a>
            <a href="{{ url_for('game') }}" class="nav-link {% if current_page == 'game' %}active{% endif %}">æ¾å¼€ä½ çš„å¤§è„‘</a>
            <a href="{{ url_for('leader') }}" class="nav-link {% if current_page == 'leader' %}active{% endif %}">é¢†è¢–åŸ¹è®­ç­</a>
            <a href="{{ url_for('english') }}" class="nav-link {% if current_page == 'english' %}active{% endif %}">è‹±æ–‡å­¦ä¹ å¤©åœ°</a>
            <a href="{{ url_for('aichat') }}" class="nav-link ai-link {% if current_page == 'aichat' %}active{% endif %}">
                <span class="ai-glow"></span>
                æ™ºè„‘ä¸­æ¢
            </a>
        </div>

        <!-- åº•éƒ¨åŒºåŸŸï¼šå¾…æ‰§è¡Œprompt + promptå†å²è®°å½• -->
        <div class="sidebar-bottom">
            <a href="{{ url_for('prompt_todo') }}" class="prompt-log-link {% if current_page == 'prompt_todo' %}active{% endif %}">
                <span class="prompt-icon">ğŸ“‹</span>
                <span>å¾…æ‰§è¡Œprompt</span>
            </a>
            <a href="{{ url_for('prompts') }}" class="prompt-log-link {% if current_page == 'prompts' %}active{% endif %}">
                <span class="prompt-icon">ğŸ“œ</span>
                <span>promptå†å²è®°å½•</span>
            </a>
            <div class="sidebar-divider"></div>
        </div>

        <!-- æ—¶åŒºæ˜¾ç¤º -->
        <div class="timezone-panel" id="timezone-panel">
            <div class="timezone-item">
                <span class="tz-city">åŒ—äº¬</span>
                <div class="tz-info">
                    <span class="tz-datetime" id="tz-beijing-date"></span>
                    <span class="tz-time" id="tz-beijing-time"></span>
                </div>
            </div>
            <div class="timezone-item">
                <span class="tz-city">æ»‘é“å¢</span>
                <div class="tz-info">
                    <span class="tz-datetime" id="tz-waterloo-date"></span>
                    <span class="tz-time" id="tz-waterloo-time"></span>
                </div>
            </div>
            <div class="timezone-item">
                <span class="tz-city">æ¸©å“¥å</span>
                <div class="tz-info">
                    <span class="tz-datetime" id="tz-vancouver-date"></span>
                    <span class="tz-time" id="tz-vancouver-time"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Right Main Content -->
    <main class="main-content" id="main-content">
        {% block content %}{% endblock %}
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
// å¤´åƒåè¨€åŠŸèƒ½
(function() {
    var avatarQuotes = [
        "ä»£ç å¦‚è¯—ï¼Œä¼˜é›…è€Œç®€æ´ã€‚",
        "ä»Šå¤©çš„bugï¼Œæ˜¯æ˜å¤©çš„featureã€‚",
        "å…ˆè®©å®ƒå·¥ä½œï¼Œå†è®©å®ƒä¼˜é›…ã€‚",
        "ç®€å•æ˜¯æœ€ç»ˆçš„å¤æ‚ã€‚",
        "å¥½çš„ä»£ç æ˜¯è‡ªå·±çš„æœ€ä½³æ–‡æ¡£ã€‚",
        "è°ƒè¯•æ˜¯å†™ä»£ç æ—¶æ²¡åšçš„äº‹ã€‚",
        "ä¿æŒå­¦ä¹ ï¼Œä¿æŒè°¦é€Šã€‚",
        "ä¸€æ¬¡åªåšä¸€ä»¶äº‹ï¼Œåšåˆ°æè‡´ã€‚",
        "è½¯ä»¶å¼€å‘æ˜¯ä¸€åœºé©¬æ‹‰æ¾ï¼Œä¸æ˜¯çŸ­è·‘ã€‚",
        "æœ€å¥½çš„é”™è¯¯å¤„ç†æ˜¯ä¸è®©é”™è¯¯å‘ç”Ÿã€‚",
        "é‡æ„æ˜¯å¼€å‘è€…çš„æ—¥å¸¸ä¿®è¡Œã€‚",
        "æµ‹è¯•ä¸æ˜¯æ‰¾bugï¼Œæ˜¯è¯æ˜ä»£ç æ­£ç¡®ã€‚",
        "ä»£ç å†™ç»™äººçœ‹ï¼Œé¡ºä¾¿è®©æœºå™¨æ‰§è¡Œã€‚",
        "æ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥ã€‚",
        "æå‰ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚",
        "å¤åˆ¶ç²˜è´´æ˜¯æŠ€æœ¯å€ºçš„å¼€å§‹ã€‚"
    ];
    var currentQuoteIndex = Math.floor(Math.random() * avatarQuotes.length);
    var quoteContent = document.getElementById('avatar-quote-content');

    function updateQuote() {
        if (quoteContent) {
            quoteContent.textContent = '"' + avatarQuotes[currentQuoteIndex] + '"';
        }
    }

    window.nextAvatarQuote = function() {
        currentQuoteIndex = (currentQuoteIndex + 1) % avatarQuotes.length;
        updateQuote();
    };

    updateQuote();
})();

// Top Header - æ»šåŠ¨éšè—
(function() {
    var header = document.getElementById('top-header');
    var menuBtn = document.getElementById('header-menu-btn');
    var lastScrollTop = 0;
    var scrollThreshold = 60;

    window.addEventListener('scroll', function() {
        var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop && scrollTop > scrollThreshold) {
            header.classList.add('hidden');
        } else {
            header.classList.remove('hidden');
        }
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }, { passive: true });

    if (menuBtn) {
        menuBtn.addEventListener('click', function() {
            var pet = document.getElementById('pet');
            if (pet) pet.click();
        });
    }
})();

// Header Particles Animation (å®Œæ•´ç‰ˆï¼šå°¾å·´+æ’æ–¥+ææƒ§+çˆ†ç‚¸+æ±‡åˆ+ä¾§è¾¹æ è´¯é€š)
(function() {
    var canvas = document.getElementById('header-particles');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var header = document.getElementById('top-header');
    var sidebar = document.getElementById('sidebar');
    var logo = document.getElementById('header-logo');

    // åŒºåŸŸé…ç½® - Lå½¢åŒºåŸŸï¼šé¡¶æ å…¨å®½ + ä¾§è¾¹æ 
    var headerHeight = 48;
    var sidebarWidth = 220;

    var particles = [];
    var fragments = [];
    var fishes = [];
    var fishFragments = [];
    var particleCount = parseInt(localStorage.getItem('particleCount')) || 6;
    var fishCount = 0; // å°é±¼åŠŸèƒ½å·²éšè—

    // ===== å°çƒå¯è°ƒå‚æ•°ï¼ˆå¯åœ¨æ§åˆ¶å°ä¿®æ”¹ï¼‰ =====
    window.ballConfig = {
        repelRadius: 180,    // é¼ æ ‡æ„Ÿåº”åŠå¾„
        repelForce: 12,      // æ’æ–¥åŠ›åº¦ (1-15)
        maxSpeed: 10,        // æœ€å¤§é€Ÿåº¦
        friction: 0.97,      // æ‘©æ“¦åŠ› (0.9-0.999, è¶Šå¤§è¶Šæ»‘)
        tailLength: 5        // å°¾å·´é•¿åº¦
    };
    // ä½¿ç”¨æ–¹æ³•: åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å…¥ ballConfig.repelForce = 8 ç„¶åå›è½¦
    var maxTailLength = 12; // ç¼©çŸ­å°¾å·´æœ€å¤§é•¿åº¦
    var colors = ['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa', '#f472b6'];
    var fishColors = ['#ff9966', '#66ccff', '#99ff99'];

    var mouse = { x: -1000, y: -1000 };

    var fearThreshold = 15;      // æ›´å¿«å¼€å§‹é¢¤æŠ–
    var explodeThreshold = 45;   // æ›´å¿«åˆ†è£‚
    var reuniteDelay = 60;       // æ›´å¿«åˆæˆ

    // ä»é—ªç”µç”Ÿæˆçš„å°çƒé˜Ÿåˆ—
    var spawningParticles = [];
    var spawnCheckInterval = 30; // æ¯30å¸§æ£€æŸ¥ä¸€æ¬¡
    var spawnCheckCounter = 0;

    function resizeCanvas() {
        // å…¨å±å®½åº¦ä»¥æ”¯æŒLå½¢åŒºåŸŸ
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨Lå½¢åŒºåŸŸå†…
    function isInLShape(x, y) {
        // Lå½¢åŒºåŸŸï¼šé¡¶æ å…¨å®½(y<=headerHeight) + ä¾§è¾¹æ (x<=sidebarWidth)
        return y <= headerHeight || x <= sidebarWidth;
    }

    // è·å–Lå½¢åŒºåŸŸçš„æœ‰æ•ˆè¾¹ç•Œ
    function getLShapeBounds(y) {
        if (y <= headerHeight) {
            // åœ¨é¡¶æ åŒºåŸŸï¼šå¯ä»¥ç”¨å…¨å®½
            return { minX: 0, maxX: canvas.width };
        } else {
            // åœ¨ä¾§è¾¹æ åŒºåŸŸï¼šåªèƒ½ç”¨ä¾§è¾¹æ å®½åº¦
            return { minX: 0, maxX: sidebarWidth };
        }
    }

    function createParticle(index, x, y, radius) {
        // éšæœºåˆå§‹è§’åº¦ï¼ˆåå‘æ¨ªå‘ï¼Œåƒé±¼åœ¨æµ´ç¼¸æ¸¸åŠ¨ï¼‰
        var baseAngle = Math.random() < 0.5 ? 0 : Math.PI;
        var angle = baseAngle + (Math.random() - 0.5) * Math.PI / 3;
        var speed = 1.5 + Math.random() * 1.0; // æ›´å¼ºçš„åˆå§‹é€Ÿåº¦ï¼Œä¿è¯ä¸ä¼šé™æ­¢
        // å¤§éƒ¨åˆ†ç²’å­ç”Ÿæˆåœ¨é¡¶æ åŒºåŸŸï¼ˆ80%æ¦‚ç‡ï¼‰
        var spawnInHeader = Math.random() < 0.8;
        var spawnX = x !== undefined ? x : (spawnInHeader ? Math.random() * canvas.width : Math.random() * sidebarWidth);
        var spawnY = y !== undefined ? y : (spawnInHeader ? Math.random() * headerHeight : headerHeight + Math.random() * (canvas.height - headerHeight));
        return {
            x: spawnX,
            y: spawnY,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            radius: radius || (4 + Math.random() * 3),
            color: colors[index % colors.length],
            alpha: 0.7 + Math.random() * 0.2,
            trail: [],
            stuckTime: 0,
            isShaking: false,
            shakeOffset: { x: 0, y: 0 },
            targetAngle: angle,
            turnSpeed: 0.015 + Math.random() * 0.015,
            nextTurnTime: 100 + Math.floor(Math.random() * 150)
        };
    }

    function initParticles() {
        particles = [];
        fragments = [];
        fishes = [];
        fishFragments = [];
        spawningParticles = [];
        for (var i = 0; i < particleCount; i++) {
            particles.push(createParticle(i));
        }
        for (var i = 0; i < fishCount; i++) {
            fishes.push(createFish(i));
        }
    }

    // ä»é—ªç”µå›¾æ ‡ç”Ÿæˆæ–°å°çƒï¼ˆèºæ—‹é£å‡ºæ•ˆæœï¼‰
    function spawnFromLightning() {
        var logo = document.getElementById('app-logo');
        var logoRect = logo ? logo.getBoundingClientRect() : { left: 30, top: 24, width: 24, height: 24 };
        var centerX = logoRect.left + logoRect.width / 2;
        var centerY = logoRect.top + logoRect.height / 2;

        var index = particles.length + spawningParticles.length;
        var sp = {
            x: centerX,
            y: centerY,
            centerX: centerX,
            centerY: centerY,
            angle: Math.random() * Math.PI * 2,
            radius: 5,
            spiralSpeed: 0.15 + Math.random() * 0.05,
            expandSpeed: 0.8,
            rotations: 0,
            maxRotations: 2,
            color: colors[index % colors.length],
            size: 4 + Math.random() * 2,
            alpha: 0.9,
            trail: []
        };
        spawningParticles.push(sp);
    }

    // æ›´æ–°èºæ—‹ç”Ÿæˆä¸­çš„å°çƒ
    function updateSpawningParticle(sp) {
        sp.trail.push({ x: sp.x, y: sp.y });
        if (sp.trail.length > 10) sp.trail.shift();

        sp.angle += sp.spiralSpeed;
        sp.radius += sp.expandSpeed;
        sp.rotations += sp.spiralSpeed / (Math.PI * 2);

        sp.x = sp.centerX + Math.cos(sp.angle) * sp.radius;
        sp.y = sp.centerY + Math.sin(sp.angle) * sp.radius;

        // å®Œæˆèºæ—‹åè½¬ä¸ºæ­£å¸¸å°çƒ
        if (sp.rotations >= sp.maxRotations) {
            var newP = createParticle(particles.length, sp.x, sp.y);
            newP.vx = Math.cos(sp.angle) * 3;
            newP.vy = Math.sin(sp.angle) * 3;
            newP.color = sp.color;
            newP.trail = sp.trail.slice();
            particles.push(newP);
            return false; // ç§»é™¤spawning
        }
        return true;
    }

    // ç»˜åˆ¶èºæ—‹ç”Ÿæˆä¸­çš„å°çƒ
    function drawSpawningParticle(sp) {
        // å°¾å·´
        for (var i = 0; i < sp.trail.length; i++) {
            var t = sp.trail[i];
            var progress = (i + 1) / sp.trail.length;
            ctx.beginPath();
            ctx.arc(t.x, t.y, sp.size * progress * 0.6, 0, Math.PI * 2);
            ctx.fillStyle = sp.color;
            ctx.globalAlpha = sp.alpha * progress * 0.5;
            ctx.fill();
        }
        // ä¸»ä½“
        ctx.beginPath();
        ctx.arc(sp.x, sp.y, sp.size, 0, Math.PI * 2);
        ctx.fillStyle = sp.color;
        ctx.globalAlpha = sp.alpha;
        ctx.shadowColor = sp.color;
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
    }

    // æ£€æŸ¥å¹¶è¡¥å……å°çƒæ•°é‡
    function checkParticleCount() {
        var totalActive = particles.length + spawningParticles.length;
        if (totalActive < particleCount) {
            spawnFromLightning();
        }
    }

    function createFish(index, x, y, size) {
        var direction = Math.random() < 0.5 ? 1 : -1;
        // å¤§éƒ¨åˆ†é±¼ç”Ÿæˆåœ¨é¡¶æ åŒºåŸŸï¼ˆ80%æ¦‚ç‡ï¼‰
        var spawnInHeader = Math.random() < 0.8;
        var spawnX = x !== undefined ? x : (spawnInHeader ? Math.random() * canvas.width : Math.random() * sidebarWidth);
        var spawnY = y !== undefined ? y : (spawnInHeader ? 8 + Math.random() * (headerHeight - 16) : headerHeight + Math.random() * (canvas.height - headerHeight - 16));
        var fishSize = size || (6 + Math.random() * 3);
        return {
            x: spawnX,
            y: spawnY,
            vx: direction * (0.5 + Math.random() * 0.3),
            vy: (Math.random() - 0.5) * 0.2,
            size: fishSize,
            color: fishColors[index % fishColors.length],
            tailPhase: Math.random() * Math.PI * 2,
            // è¾¹ç•Œæ£€æµ‹å’Œçˆ†ç‚¸ç›¸å…³
            stuckTime: 0,
            isShaking: false,
            shakeOffset: { x: 0, y: 0 }
        };
    }

    // æ£€æµ‹é±¼æ˜¯å¦è¢«å›°åœ¨è¾¹ç¼˜
    function isFishStuckAtEdge(f) {
        var edgeMargin = f.size + 5;
        var bounds = getLShapeBounds(f.y);
        var nearEdge = f.x < edgeMargin || f.x > bounds.maxX - edgeMargin ||
                       f.y < edgeMargin || f.y > canvas.height - edgeMargin;
        var dx = f.x - mouse.x;
        var dy = f.y - mouse.y;
        var nearMouse = Math.sqrt(dx * dx + dy * dy) < mouseRepelRadius + 20;
        return nearEdge && nearMouse;
    }

    // å°é±¼çˆ†ç‚¸åˆ†è£‚ä¸º3æ¡å°é±¼
    function explodeFish(f, index) {
        for (var i = 0; i < 3; i++) {
            var angle = (Math.PI * 2 / 3) * i + Math.random() * 0.5;
            var speed = 2 + Math.random() * 1.5;
            fishFragments.push({
                x: f.x, y: f.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                size: f.size * 0.5,
                color: f.color,
                tailPhase: Math.random() * Math.PI * 2,
                angle: angle,
                life: reuniteDelay,
                parentIndex: index,
                ignoreMouseTime: 40
            });
        }
        fishes.splice(index, 1);
    }

    // å°é±¼ç¢ç‰‡æ±‡åˆé‡ç»„
    function reuniteFishFragments() {
        var groups = {};
        fishFragments.forEach(function(f, i) {
            if (!groups[f.parentIndex]) groups[f.parentIndex] = [];
            groups[f.parentIndex].push({ fragment: f, index: i });
        });

        var toRemove = [];
        for (var parentIndex in groups) {
            var group = groups[parentIndex];
            if (group.length > 0 && group[0].fragment.life <= 0) {
                var cx = 0, cy = 0;
                group.forEach(function(g) { cx += g.fragment.x; cy += g.fragment.y; });
                cx /= group.length; cy /= group.length;

                var newFish = createFish(parseInt(parentIndex), cx, cy);
                newFish.vx = (Math.random() - 0.5) * 1.5;
                newFish.vy = (Math.random() - 0.5) * 1.5;
                fishes.push(newFish);

                group.forEach(function(g) { toRemove.push(g.index); });
            }
        }
        toRemove.sort(function(a, b) { return b - a; });
        toRemove.forEach(function(i) { fishFragments.splice(i, 1); });
    }

    // æ ‡å‡†åŒ–è§’åº¦åˆ° [-PI, PI]
    function normalizeAngle(angle) {
        while (angle > Math.PI) angle -= Math.PI * 2;
        while (angle < -Math.PI) angle += Math.PI * 2;
        return angle;
    }

    function updateFish(f, index) {
        f.tailPhase += 0.15;

        // é¼ æ ‡æ’æ–¥ - ç®€å•ç›´æ¥
        var dx = f.x - mouse.x;
        var dy = f.y - mouse.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < mouseRepelRadius && dist > 0) {
            var force = (mouseRepelRadius - dist) / mouseRepelRadius * mouseRepelForce;
            f.vx += (dx / dist) * force;
            f.vy += (dy / dist) * force;
        }

        // æ£€æµ‹æ˜¯å¦è¢«å›°åœ¨è¾¹ç¼˜
        if (isFishStuckAtEdge(f)) {
            f.stuckTime++;
            if (f.stuckTime > fearThreshold) {
                f.isShaking = true;
                f.shakeOffset = { x: (Math.random() - 0.5) * 3, y: (Math.random() - 0.5) * 3 };
            }
            if (f.stuckTime > explodeThreshold) {
                explodeFish(f, index);
                return false;
            }
        } else {
            f.stuckTime = Math.max(0, f.stuckTime - 2);
            f.isShaking = false;
            f.shakeOffset = { x: 0, y: 0 };
        }

        var inHeader = f.y <= headerHeight;

        // éšæœºæ¸¸åŠ¨
        if (inHeader) {
            f.vy += (Math.random() - 0.5) * 0.02;
            f.vy *= 0.95;
        } else {
            f.vx += (Math.random() - 0.5) * 0.03;
            f.vy += (Math.random() - 0.5) * 0.03;
        }

        // æ›´æ–°ä½ç½®
        f.x += f.vx;
        f.y += f.vy;

        // é€Ÿåº¦æ§åˆ¶
        var speed = Math.sqrt(f.vx * f.vx + f.vy * f.vy);
        if (speed < 0.3) {
            var angle = inHeader ? (Math.random() < 0.5 ? 0 : Math.PI) : Math.random() * Math.PI * 2;
            f.vx = Math.cos(angle) * 0.5;
            f.vy = Math.sin(angle) * 0.5;
        }
        var maxSpeed = 4;
        if (speed > maxSpeed) {
            f.vx = (f.vx / speed) * maxSpeed;
            f.vy = (f.vy / speed) * maxSpeed;
        }
        f.vx *= 0.99;
        f.vy *= 0.99;

        // ä¸¥æ ¼è¾¹ç•Œå¤„ç† - ç¡®ä¿ä¸è¶…å‡ºLå½¢åŒºåŸŸ
        var margin = f.size + 2; // ç•™å‡ºè¾¹è·

        // é¡¶éƒ¨è¾¹ç•Œ
        if (f.y < margin) {
            f.y = margin;
            f.vy = Math.abs(f.vy) * 0.8;
        }

        // åº•éƒ¨è¾¹ç•Œï¼ˆåªåœ¨ä¾§è¾¹æ åŒºåŸŸæœ‰æ•ˆï¼‰
        if (f.y > canvas.height - margin) {
            f.y = canvas.height - margin;
            f.vy = -Math.abs(f.vy) * 0.8;
        }

        // å·¦è¾¹ç•Œ
        if (f.x < margin) {
            f.x = margin;
            f.vx = Math.abs(f.vx) * 0.8;
        }

        // å³è¾¹ç•Œ - æ ¹æ®Yä½ç½®å†³å®š
        if (f.y <= headerHeight) {
            // åœ¨é¡¶æ åŒºåŸŸï¼šå¯ä»¥ç”¨å…¨å®½
            if (f.x > canvas.width - margin) {
                f.x = canvas.width - margin;
                f.vx = -Math.abs(f.vx) * 0.8;
            }
        } else {
            // åœ¨ä¾§è¾¹æ åŒºåŸŸï¼šé™åˆ¶åœ¨ä¾§è¾¹æ å®½åº¦å†…
            if (f.x > sidebarWidth - margin) {
                f.x = sidebarWidth - margin;
                f.vx = -Math.abs(f.vx) * 0.8;
            }
        }

        // Lå½¢æ‹è§’å¤„ç† - é˜²æ­¢è¿›å…¥ç¦åŒº
        if (f.y > headerHeight && f.x > sidebarWidth - margin) {
            // æ¨å›åˆ°æœ€è¿‘çš„è¾¹ç•Œ
            var overY = f.y - headerHeight;
            var overX = f.x - (sidebarWidth - margin);
            if (overY < overX) {
                f.y = headerHeight - margin;
                f.vy = -Math.abs(f.vy) * 0.5;
            } else {
                f.x = sidebarWidth - margin;
                f.vx = -Math.abs(f.vx) * 0.5;
            }
        }

        return true;
    }

    function updateFishFragment(ff) {
        ff.tailPhase += 0.2;

        if (ff.ignoreMouseTime > 0) {
            ff.ignoreMouseTime--;
        } else {
            var dx = ff.x - mouse.x;
            var dy = ff.y - mouse.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < mouseRepelRadius && dist > 0) {
                var force = (mouseRepelRadius - dist) / mouseRepelRadius * 0.5;
                ff.vx += (dx / dist) * force;
                ff.vy += (dy / dist) * force;
            }
        }

        ff.vx *= 0.98;
        ff.vy *= 0.98;
        ff.x += ff.vx;
        ff.y += ff.vy;
        ff.life--;
        ff.angle = Math.atan2(ff.vy, ff.vx);

        // ä¸¥æ ¼è¾¹ç•Œå¤„ç†
        var margin = ff.size + 2;

        if (ff.y < margin) { ff.y = margin; ff.vy = Math.abs(ff.vy); }
        if (ff.y > canvas.height - margin) { ff.y = canvas.height - margin; ff.vy = -Math.abs(ff.vy); }
        if (ff.x < margin) { ff.x = margin; ff.vx = Math.abs(ff.vx); }

        if (ff.y <= headerHeight) {
            if (ff.x > canvas.width - margin) { ff.x = canvas.width - margin; ff.vx = -Math.abs(ff.vx); }
        } else {
            if (ff.x > sidebarWidth - margin) { ff.x = sidebarWidth - margin; ff.vx = -Math.abs(ff.vx); }
        }

        if (ff.y > headerHeight && ff.x > sidebarWidth - margin) {
            ff.x = sidebarWidth - margin;
            ff.vx = -Math.abs(ff.vx);
        }
    }

    // è®¡ç®—é€æ˜åº¦ç³»æ•°ï¼ˆåœ¨ä¾§è¾¹æ åŒºåŸŸæ—¶å˜é€æ˜ï¼‰
    function getTransparencyMultiplier(y) {
        if (y <= headerHeight) return 1;
        var fadeStart = headerHeight;
        var fadeEnd = headerHeight + 50;
        if (y < fadeEnd) return 1 - 0.5 * ((y - fadeStart) / (fadeEnd - fadeStart));
        return 0.5;
    }

    function drawFish(f) {
        var transMult = getTransparencyMultiplier(f.y);
        var drawX = f.x + (f.shakeOffset ? f.shakeOffset.x : 0);
        var drawY = f.y + (f.shakeOffset ? f.shakeOffset.y : 0);
        ctx.save();
        ctx.translate(drawX, drawY);

        // ç®€åŒ–æœå‘é€»è¾‘ï¼šæ ¹æ®æ°´å¹³é€Ÿåº¦æ–¹å‘å†³å®šé±¼å¤´æœå‘
        var goingLeft = f.vx < 0;
        var tiltAngle = Math.atan2(f.vy, Math.abs(f.vx)); // å€¾æ–œè§’åº¦ï¼ˆåŸºäºæ­£å‘é€Ÿåº¦ï¼‰

        if (goingLeft) {
            ctx.scale(-1, 1); // æ°´å¹³ç¿»è½¬ï¼Œé±¼å¤´æœå·¦
        }
        ctx.rotate(tiltAngle); // æ ¹æ®å‚ç›´é€Ÿåº¦å€¾æ–œ

        var s = f.size;
        var tailSwing = Math.sin(f.tailPhase) * 0.3;

        // é±¼èº«ï¼ˆæ¤­åœ†ï¼‰
        ctx.beginPath();
        ctx.ellipse(0, 0, s * 1.2, s * 0.6, 0, 0, Math.PI * 2);
        ctx.fillStyle = f.color;
        ctx.globalAlpha = 0.85 * transMult;
        if (f.isShaking) {
            ctx.shadowColor = '#ff0000';
            ctx.shadowBlur = 15;
        }
        ctx.fill();
        ctx.shadowBlur = 0;

        // å°¾å·´
        ctx.beginPath();
        ctx.moveTo(-s * 1.1, 0);
        ctx.lineTo(-s * 2, -s * 0.5 + tailSwing * s);
        ctx.lineTo(-s * 2, s * 0.5 + tailSwing * s);
        ctx.closePath();
        ctx.fillStyle = f.color;
        ctx.globalAlpha = 0.7 * transMult;
        ctx.fill();

        // çœ¼ç™½
        ctx.beginPath();
        ctx.arc(s * 0.5, -s * 0.15, s * 0.18, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.globalAlpha = 1 * transMult;
        ctx.fill();

        // çœ¼ç 
        ctx.beginPath();
        ctx.arc(s * 0.55, -s * 0.15, s * 0.09, 0, Math.PI * 2);
        ctx.fillStyle = '#333333';
        ctx.fill();

        ctx.restore();
        ctx.globalAlpha = 1;
    }

    function drawFishFragment(ff) {
        var transMult = getTransparencyMultiplier(ff.y) * (ff.life / reuniteDelay);
        ctx.save();
        ctx.translate(ff.x, ff.y);

        // ç®€åŒ–æœå‘é€»è¾‘
        var goingLeft = ff.vx < 0;
        var tiltAngle = Math.atan2(ff.vy, Math.abs(ff.vx));
        if (goingLeft) {
            ctx.scale(-1, 1);
        }
        ctx.rotate(tiltAngle);

        var s = ff.size;
        var tailSwing = Math.sin(ff.tailPhase) * 0.4;
        ctx.beginPath();
        ctx.ellipse(0, 0, s * 1.2, s * 0.6, 0, 0, Math.PI * 2);
        ctx.fillStyle = ff.color;
        ctx.globalAlpha = 0.8 * transMult;
        ctx.shadowColor = ff.color;
        ctx.shadowBlur = 8;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.beginPath();
        ctx.moveTo(-s * 1.1, 0);
        ctx.lineTo(-s * 2, -s * 0.5 + tailSwing * s);
        ctx.lineTo(-s * 2, s * 0.5 + tailSwing * s);
        ctx.closePath();
        ctx.globalAlpha = 0.6 * transMult;
        ctx.fill();
        ctx.restore();
        ctx.globalAlpha = 1;
    }

    function isStuckAtEdge(p) {
        var edgeMargin = p.radius + 5;
        var bounds = getLShapeBounds(p.y);
        var nearEdge = p.x < edgeMargin || p.x > bounds.maxX - edgeMargin ||
                       p.y < edgeMargin || p.y > canvas.height - edgeMargin;
        var dx = p.x - mouse.x;
        var dy = p.y - mouse.y;
        var nearMouse = Math.sqrt(dx * dx + dy * dy) < window.ballConfig.repelRadius + 20;
        return nearEdge && nearMouse;
    }

    function explodeParticle(p, index) {
        var fragmentColors = [colors[(index) % colors.length], colors[(index + 2) % colors.length], colors[(index + 4) % colors.length]];
        for (var i = 0; i < 3; i++) {
            var angle = (Math.PI * 2 / 3) * i + Math.random() * 0.5;
            var speed = 3 + Math.random() * 2;
            fragments.push({
                x: p.x, y: p.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                radius: p.radius * 0.5,
                color: fragmentColors[i],
                alpha: 0.9,
                trail: [],
                life: reuniteDelay,
                parentIndex: index,
                ignoreMouseTime: 40
            });
        }
        particles.splice(index, 1);
    }

    function reuniteFragments() {
        var groups = {};
        fragments.forEach(function(f, i) {
            if (!groups[f.parentIndex]) groups[f.parentIndex] = [];
            groups[f.parentIndex].push({ fragment: f, index: i });
        });

        var toRemove = [];
        for (var parentIndex in groups) {
            var group = groups[parentIndex];
            if (group.length > 0 && group[0].fragment.life <= 0) {
                var cx = 0, cy = 0;
                group.forEach(function(g) { cx += g.fragment.x; cy += g.fragment.y; });
                cx /= group.length; cy /= group.length;

                var newP = createParticle(particles.length, cx, cy);
                // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆå§‹é€Ÿåº¦
                var angle = Math.random() * Math.PI * 2;
                var speed = 1.5 + Math.random() * 1.0;
                newP.vx = Math.cos(angle) * speed;
                newP.vy = Math.sin(angle) * speed;
                particles.push(newP);

                group.forEach(function(g) { toRemove.push(g.index); });
            }
        }
        toRemove.sort(function(a, b) { return b - a; });
        toRemove.forEach(function(i) { fragments.splice(i, 1); });
    }

    function updateParticle(p, index) {
        var speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
        var cfg = window.ballConfig;

        // å°¾å·´é•¿åº¦ï¼šåŸºç¡€é•¿åº¦ + é€Ÿåº¦åŠ æˆ
        var dynamicTailLength = Math.floor(5 + speed * 2);
        dynamicTailLength = Math.max(5, Math.min(cfg.tailLength, dynamicTailLength));

        p.trail.push({ x: p.x, y: p.y });
        while (p.trail.length > dynamicTailLength) p.trail.shift();

        if (isStuckAtEdge(p)) {
            p.stuckTime++;
            if (p.stuckTime > fearThreshold) {
                p.isShaking = true;
                p.shakeOffset.x = (Math.random() - 0.5) * 3;
                p.shakeOffset.y = (Math.random() - 0.5) * 3;
            }
            if (p.stuckTime > explodeThreshold) {
                explodeParticle(p, index);
                return false;
            }
        } else {
            p.stuckTime = Math.max(0, p.stuckTime - 2);
            p.isShaking = false;
            p.shakeOffset.x = 0;
            p.shakeOffset.y = 0;
        }

        var cfg = window.ballConfig;
        var inHeader = p.y <= headerHeight;

        // ===== é¼ æ ‡æ’æ–¥ - æœ€é«˜ä¼˜å…ˆçº§ =====
        var dx = p.x - mouse.x;
        var dy = p.y - mouse.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        var isEscaping = false;

        if (dist < cfg.repelRadius && dist > 0) {
            isEscaping = true;
            // è·ç¦»è¶Šè¿‘ï¼ŒåŠ›è¶Šå¤§ï¼ˆäºŒæ¬¡æ–¹å…³ç³»ï¼Œæ›´æ•æ„Ÿï¼‰
            var ratio = 1 - dist / cfg.repelRadius;
            var force = ratio * ratio * cfg.repelForce * 1.5;
            p.vx += (dx / dist) * force;
            p.vy += (dy / dist) * force;
        }

        // è‡ªç”±æ¸¸åŠ¨ï¼ˆä»…åœ¨ä¸é€ƒè·‘æ—¶ç”Ÿæ•ˆï¼‰
        if (!isEscaping) {
            p.nextTurnTime--;
            if (p.nextTurnTime <= 0) {
                var currentAngle = Math.atan2(p.vy, p.vx);
                if (inHeader) {
                    // é¡¶æ ï¼šä¸»è¦å·¦å³æ¸¸åŠ¨ï¼Œå¶å°”è½¬å‘
                    if (Math.random() < 0.6) {
                        var baseAngle = Math.cos(currentAngle) > 0 ? 0 : Math.PI;
                        if (Math.random() < 0.2) baseAngle += Math.PI; // 20%æ¦‚ç‡æ‰å¤´
                        p.targetAngle = baseAngle + (Math.random() - 0.5) * Math.PI / 2;
                    } else {
                        p.targetAngle = currentAngle + (Math.random() - 0.5) * Math.PI * 0.6;
                    }
                } else {
                    // ä¾§è¾¹æ ï¼šè‡ªç”±æ–¹å‘
                    p.targetAngle = Math.random() * Math.PI * 2;
                }
                // æ›´é¢‘ç¹åœ°æ”¹å˜æ–¹å‘ï¼Œè®©è¿åŠ¨æ›´æ´»æ³¼
                p.nextTurnTime = 40 + Math.floor(Math.random() * 80);
            }

            var currentAngle = Math.atan2(p.vy, p.vx);
            var angleDiff = p.targetAngle - currentAngle;
            while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
            while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;

            // æ›´å¿«çš„è½¬å‘é€Ÿåº¦
            var newAngle = currentAngle + angleDiff * p.turnSpeed * 1.5;
            // ä¿æŒä¸€å®šçš„æ¸¸åŠ¨é€Ÿåº¦
            var targetSpeed = 1.0 + Math.random() * 1.0;
            var newSpeed = Math.max(speed, targetSpeed);
            p.vx = Math.cos(newAngle) * newSpeed;
            p.vy = Math.sin(newAngle) * newSpeed;
        }

        if (inHeader && !isEscaping) p.vy *= 0.92; // ç¨å¾®é™åˆ¶å‚ç›´è¿åŠ¨

        // é€Ÿåº¦æ§åˆ¶
        speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
        var maxSpeed = isEscaping ? cfg.maxSpeed * 1.5 : cfg.maxSpeed;
        var minSpeed = 1.0; // æé«˜æœ€ä½é€Ÿåº¦ï¼Œä¿æŒæ´»è·ƒ
        if (speed > maxSpeed) {
            p.vx = (p.vx / speed) * maxSpeed;
            p.vy = (p.vy / speed) * maxSpeed;
        } else if (speed < minSpeed) {
            // é€Ÿåº¦å¤ªæ…¢æ—¶ï¼Œç»™ä¸€ä¸ªéšæœºæ¨åŠ›
            var angle = inHeader ? (Math.random() < 0.5 ? 0 : Math.PI) + (Math.random() - 0.5) * 0.5 : Math.random() * Math.PI * 2;
            var boost = minSpeed + Math.random() * 0.5;
            p.vx = Math.cos(angle) * boost;
            p.vy = Math.sin(angle) * boost;
        }

        // æ‘©æ“¦åŠ›ï¼ˆé€ƒè·‘æ—¶å‡å°‘æ‘©æ“¦ï¼Œå¹³æ—¶ä¹Ÿä¿æŒè¾ƒä½æ‘©æ“¦è®©è¿åŠ¨æ›´æµç•…ï¼‰
        var friction = isEscaping ? 0.96 : 0.995;
        p.vx *= friction;
        p.vy *= friction;

        // ===== å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿é€Ÿåº¦æœ‰æ•ˆ =====
        if (isNaN(p.vx) || isNaN(p.vy) || !isFinite(p.vx) || !isFinite(p.vy)) {
            var safeAngle = Math.random() * Math.PI * 2;
            p.vx = Math.cos(safeAngle) * 1.5;
            p.vy = Math.sin(safeAngle) * 1.5;
        }

        // è¾¹ç•Œå®‰å…¨è·ç¦»
        var margin = p.radius + 2;

        // ===== é¢„æµ‹å¼è¾¹ç•Œæ£€æŸ¥ - åœ¨ç§»åŠ¨å‰æ£€æŸ¥ç›®æ ‡ä½ç½® =====
        var nextX = p.x + p.vx;
        var nextY = p.y + p.vy;

        // æ£€æŸ¥æ˜¯å¦ä¼šè¿›å…¥Lå½¢ç¦åŒºï¼ˆä¸»å†…å®¹åŒºåŸŸï¼‰
        var wouldEnterForbidden = nextY > headerHeight - margin && nextX > sidebarWidth - margin;
        var currentlyInHeader = p.y <= headerHeight;
        var currentlyInSidebar = p.x <= sidebarWidth;

        if (wouldEnterForbidden) {
            if (currentlyInHeader && nextY > headerHeight - margin) {
                // ä»é¡¶æ å‘ä¸‹ç§»åŠ¨ï¼Œé˜»æ­¢
                p.vy = -Math.abs(p.vy) * 0.5;
                nextY = headerHeight - margin;
            }
            if (currentlyInSidebar && nextX > sidebarWidth - margin) {
                // ä»ä¾§è¾¹æ å‘å³ç§»åŠ¨ï¼Œé˜»æ­¢
                p.vx = -Math.abs(p.vx) * 0.5;
                nextX = sidebarWidth - margin;
            }
        }

        // å¤–è¾¹ç•Œæ£€æŸ¥
        if (nextX < margin) { nextX = margin; p.vx = Math.abs(p.vx) * 0.8; }
        if (nextY < margin) { nextY = margin; p.vy = Math.abs(p.vy) * 0.8; }

        // æ ¹æ®å½“å‰åŒºåŸŸæ£€æŸ¥å³è¾¹ç•Œå’Œåº•è¾¹ç•Œ
        if (nextY <= headerHeight) {
            // åœ¨é¡¶æ åŒºåŸŸ
            if (nextX > canvas.width - margin) { nextX = canvas.width - margin; p.vx = -Math.abs(p.vx) * 0.8; }
        } else {
            // åœ¨ä¾§è¾¹æ åŒºåŸŸ
            if (nextX > sidebarWidth - margin) { nextX = sidebarWidth - margin; p.vx = -Math.abs(p.vx) * 0.8; }
            if (nextY > canvas.height - margin) { nextY = canvas.height - margin; p.vy = -Math.abs(p.vy) * 0.8; }
        }

        // åº”ç”¨ä½ç½®
        p.x = nextX;
        p.y = nextY;

        // ===== æœ€ç»ˆå®‰å…¨æ£€æŸ¥ - å¼ºåˆ¶å°†ä»»ä½•è¶Šç•Œç²’å­æ¨å› =====
        if (p.y > headerHeight && p.x > sidebarWidth) {
            // å·²ç»åœ¨ç¦åŒºå†…ï¼Œç«‹å³æ¨å›
            if (p.y - headerHeight < p.x - sidebarWidth) {
                p.y = headerHeight - margin;
                p.vy = -Math.abs(p.vy);
            } else {
                p.x = sidebarWidth - margin;
                p.vx = -Math.abs(p.vx);
            }
        }

        p.targetAngle = Math.atan2(p.vy, p.vx);
        return true;
    }

    function updateFragment(f) {
        f.trail.push({ x: f.x, y: f.y });
        if (f.trail.length > 8) f.trail.shift();

        if (f.ignoreMouseTime > 0) {
            f.ignoreMouseTime--;
        } else {
            var dx = f.x - mouse.x;
            var dy = f.y - mouse.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < mouseRepelRadius && dist > 0) {
                var force = (mouseRepelRadius - dist) / mouseRepelRadius * 0.5;
                f.vx += (dx / dist) * force;
                f.vy += (dy / dist) * force;
            }
        }

        f.vx *= 0.98;
        f.vy *= 0.98;
        f.x += f.vx;
        f.y += f.vy;
        f.life--;

        // ä¸¥æ ¼è¾¹ç•Œå¤„ç†
        var margin = f.radius + 2;

        if (f.y < margin) { f.y = margin; f.vy = Math.abs(f.vy); }
        if (f.y > canvas.height - margin) { f.y = canvas.height - margin; f.vy = -Math.abs(f.vy); }
        if (f.x < margin) { f.x = margin; f.vx = Math.abs(f.vx); }

        if (f.y <= headerHeight) {
            if (f.x > canvas.width - margin) { f.x = canvas.width - margin; f.vx = -Math.abs(f.vx); }
        } else {
            if (f.x > sidebarWidth - margin) { f.x = sidebarWidth - margin; f.vx = -Math.abs(f.vx); }
        }

        if (f.y > headerHeight && f.x > sidebarWidth - margin) {
            f.x = sidebarWidth - margin;
            f.vx = -Math.abs(f.vx);
        }
    }

    function drawParticle(p) {
        var drawX = p.x + (p.shakeOffset ? p.shakeOffset.x : 0);
        var drawY = p.y + (p.shakeOffset ? p.shakeOffset.y : 0);
        var transMult = getTransparencyMultiplier(drawY);

        // å¹³æ»‘å½—æ˜Ÿå°¾å·´æ•ˆæœï¼šä½¿ç”¨æ¸å˜è·¯å¾„
        if (p.trail.length > 2) {
            // ä»å°¾éƒ¨åˆ°å¤´éƒ¨ç»˜åˆ¶å¹³æ»‘æ¸å˜
            for (var i = 1; i < p.trail.length; i++) {
                var t0 = p.trail[i - 1];
                var t1 = p.trail[i];
                var progress = i / p.trail.length;
                var nextProgress = (i + 1) / p.trail.length;

                // çº¿æ¡å®½åº¦ï¼šä»ç»†åˆ°ç²—
                var width0 = p.radius * 2 * (progress - 1/p.trail.length) * 0.9;
                var width1 = p.radius * 2 * progress * 0.9;

                // é€æ˜åº¦ï¼šä»æ·¡åˆ°æµ“ï¼Œä½¿ç”¨ä¸‰æ¬¡æ–¹è®©æ¸å˜æ›´å¹³æ»‘
                var alpha = p.alpha * progress * progress * progress * 0.6;
                var trailTrans = getTransparencyMultiplier((t0.y + t1.y) / 2);

                // ç»˜åˆ¶æ¸å˜çº¿æ®µ
                ctx.beginPath();
                ctx.moveTo(t0.x, t0.y);
                ctx.lineTo(t1.x, t1.y);
                ctx.strokeStyle = p.color;
                ctx.lineWidth = Math.max(1, (width0 + width1) / 2);
                ctx.lineCap = 'round';
                ctx.globalAlpha = alpha * trailTrans;
                ctx.stroke();
            }

            // è¿æ¥å°¾å·´æœ«ç«¯åˆ°çƒä½“ï¼Œç¡®ä¿å¹³æ»‘è¿‡æ¸¡
            if (p.trail.length > 0) {
                var lastTrail = p.trail[p.trail.length - 1];
                ctx.beginPath();
                ctx.moveTo(lastTrail.x, lastTrail.y);
                ctx.lineTo(drawX, drawY);
                ctx.strokeStyle = p.color;
                ctx.lineWidth = p.radius * 1.6;
                ctx.lineCap = 'round';
                ctx.globalAlpha = p.alpha * 0.5 * transMult;
                ctx.stroke();
            }
        }

        // ä¸»çƒä½“ï¼ˆå¸¦å…‰æ™•ï¼‰
        ctx.beginPath();
        ctx.arc(drawX, drawY, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.alpha * transMult;
        ctx.shadowColor = p.isShaking ? '#ff0000' : p.color;
        ctx.shadowBlur = p.isShaking ? 15 : 10;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
    }

    function drawFragment(f) {
        var transMult = getTransparencyMultiplier(f.y);
        for (var i = 0; i < f.trail.length; i++) {
            var t = f.trail[i];
            var progress = i / f.trail.length;
            var trailTrans = getTransparencyMultiplier(t.y);
            ctx.beginPath();
            ctx.arc(t.x, t.y, f.radius * progress * 0.6, 0, Math.PI * 2);
            ctx.fillStyle = f.color;
            ctx.globalAlpha = f.alpha * progress * 0.4 * trailTrans;
            ctx.fill();
        }
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
        ctx.fillStyle = f.color;
        ctx.globalAlpha = f.alpha * (f.life / reuniteDelay) * transMult;
        ctx.shadowColor = f.color;
        ctx.shadowBlur = 8;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
    }

    function animate() {
        try {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ===== æ¯å¸§å¼€å§‹æ—¶ï¼šå¼ºåˆ¶éªŒè¯æ‰€æœ‰ç²’å­é€Ÿåº¦ =====
            for (var j = 0; j < particles.length; j++) {
                var p = particles[j];
                var spd = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
                // ä¿®å¤æ— æ•ˆé€Ÿåº¦æˆ–é™æ­¢ç²’å­
                if (isNaN(spd) || !isFinite(spd) || spd < 0.5) {
                    var angle = Math.random() * Math.PI * 2;
                    var newSpeed = 1.5 + Math.random() * 1.0;
                    p.vx = Math.cos(angle) * newSpeed;
                    p.vy = Math.sin(angle) * newSpeed;
                }
            }

            // å®šæœŸæ£€æŸ¥å°çƒæ•°é‡
            spawnCheckCounter++;
            if (spawnCheckCounter >= spawnCheckInterval) {
                spawnCheckCounter = 0;
                checkParticleCount();
            }

            // èºæ—‹ç”Ÿæˆä¸­çš„å°çƒ
            for (var i = spawningParticles.length - 1; i >= 0; i--) {
                if (updateSpawningParticle(spawningParticles[i])) {
                    drawSpawningParticle(spawningParticles[i]);
                } else {
                    spawningParticles.splice(i, 1);
                }
            }

            // ç²’å­ - å¤åˆ¶æ•°ç»„é¿å…spliceé—®é¢˜
            var particlesToProcess = particles.slice();
            var indicesToRemove = [];

            for (var i = 0; i < particlesToProcess.length; i++) {
                var p = particlesToProcess[i];
                // æ‰¾åˆ°å½“å‰å®é™…ç´¢å¼•
                var actualIndex = particles.indexOf(p);
                if (actualIndex === -1) continue; // å·²è¢«ç§»é™¤

                if (updateParticle(p, actualIndex)) {
                    drawParticle(p);
                }
            }

            // ç²’å­ç¢ç‰‡
            for (var i = 0; i < fragments.length; i++) {
                updateFragment(fragments[i]);
                drawFragment(fragments[i]);
            }
            reuniteFragments();

        } catch (e) {
            console.error('Animation error:', e);
        }

        requestAnimationFrame(animate);
    }

    resizeCanvas();
    initParticles();
    animate();

    window.addEventListener('resize', resizeCanvas);

    // é¼ æ ‡è¿½è¸ªï¼šåœ¨Lå½¢åŒºåŸŸå†…ç”Ÿæ•ˆï¼ˆé¡¶æ å…¨å®½ + ä¾§è¾¹æ ï¼‰+ è¾¹ç¼˜æ‰©å±•
    document.addEventListener('mousemove', function(e) {
        var extend = 120; // æ‰©å±•æ£€æµ‹èŒƒå›´ï¼Œè®©é¼ æ ‡æ›´å®¹æ˜“è§¦å‘å°çƒé€ƒé€¸
        var inLShape = (e.clientY <= headerHeight + extend) || (e.clientX <= sidebarWidth + extend);
        if (inLShape) {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        } else {
            mouse.x = -1000;
            mouse.y = -1000;
        }
    }, { passive: true });

    document.addEventListener('mouseleave', function() {
        mouse.x = -1000;
        mouse.y = -1000;
    }, { passive: true });

    // ç‚¹å‡»é—ªç”µè®¾ç½®å°çƒå‚æ•° - è¡¨æ ¼å½¢å¼
    if (logo) {
        logo.addEventListener('click', function(e) {
            e.stopPropagation();

            // åˆ›å»ºè®¾ç½®å¼¹çª—
            var overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;';

            var cfg = window.ballConfig;
            var dialog = document.createElement('div');
            dialog.style.cssText = 'background:#1a1a2e;border:1px solid #333;border-radius:8px;padding:16px;min-width:280px;color:#fff;font-size:14px;';
            dialog.innerHTML =
                '<div style="font-size:16px;font-weight:bold;margin-bottom:12px;color:#fbbf24;">âš¡ å°çƒè®¾ç½®</div>' +
                '<table style="width:100%;border-collapse:collapse;">' +
                '<tr><td style="padding:6px 8px;color:#aaa;">æ•°é‡</td><td><input id="cfg-count" type="number" min="1" max="20" value="' + particleCount + '" style="width:60px;padding:4px;background:#2a2a3e;border:1px solid #444;color:#fff;border-radius:4px;"></td><td style="padding:6px 8px;color:#666;font-size:12px;">å»ºè®®: 6</td></tr>' +
                '<tr><td style="padding:6px 8px;color:#aaa;">æ„Ÿåº”åŠå¾„</td><td><input id="cfg-radius" type="number" min="50" max="200" value="' + cfg.repelRadius + '" style="width:60px;padding:4px;background:#2a2a3e;border:1px solid #444;color:#fff;border-radius:4px;"></td><td style="padding:6px 8px;color:#666;font-size:12px;">å»ºè®®: 180</td></tr>' +
                '<tr><td style="padding:6px 8px;color:#aaa;">æ’æ–¥åŠ›åº¦</td><td><input id="cfg-force" type="number" min="1" max="15" value="' + cfg.repelForce + '" style="width:60px;padding:4px;background:#2a2a3e;border:1px solid #444;color:#fff;border-radius:4px;"></td><td style="padding:6px 8px;color:#666;font-size:12px;">å»ºè®®: 12</td></tr>' +
                '<tr><td style="padding:6px 8px;color:#aaa;">æœ€å¤§é€Ÿåº¦</td><td><input id="cfg-speed" type="number" min="3" max="12" value="' + cfg.maxSpeed + '" style="width:60px;padding:4px;background:#2a2a3e;border:1px solid #444;color:#fff;border-radius:4px;"></td><td style="padding:6px 8px;color:#666;font-size:12px;">å»ºè®®: 10</td></tr>' +
                '<tr><td style="padding:6px 8px;color:#aaa;">æ‘©æ“¦åŠ›</td><td><input id="cfg-friction" type="number" min="0.9" max="0.999" step="0.01" value="' + cfg.friction + '" style="width:60px;padding:4px;background:#2a2a3e;border:1px solid #444;color:#fff;border-radius:4px;"></td><td style="padding:6px 8px;color:#666;font-size:12px;">å»ºè®®: 0.97</td></tr>' +
                '<tr><td style="padding:6px 8px;color:#aaa;">å°¾å·´é•¿åº¦</td><td><input id="cfg-tail" type="number" min="3" max="25" value="' + cfg.tailLength + '" style="width:60px;padding:4px;background:#2a2a3e;border:1px solid #444;color:#fff;border-radius:4px;"></td><td style="padding:6px 8px;color:#666;font-size:12px;">å»ºè®®: 5</td></tr>' +
                '</table>' +
                '<div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">' +
                '<button id="cfg-cancel" style="padding:6px 12px;background:#444;border:none;color:#fff;border-radius:4px;cursor:pointer;">å–æ¶ˆ</button>' +
                '<button id="cfg-save" style="padding:6px 12px;background:#fbbf24;border:none;color:#000;border-radius:4px;cursor:pointer;font-weight:bold;">ä¿å­˜</button>' +
                '</div>';

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', function(ev) {
                if (ev.target === overlay) document.body.removeChild(overlay);
            });

            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cfg-cancel').addEventListener('click', function() {
                document.body.removeChild(overlay);
            });

            // ä¿å­˜æŒ‰é’®
            document.getElementById('cfg-save').addEventListener('click', function() {
                var newCount = Math.max(1, Math.min(20, parseInt(document.getElementById('cfg-count').value) || 5));
                cfg.repelRadius = Math.max(50, Math.min(200, parseInt(document.getElementById('cfg-radius').value) || 100));
                cfg.repelForce = Math.max(1, Math.min(15, parseInt(document.getElementById('cfg-force').value) || 5));
                cfg.maxSpeed = Math.max(3, Math.min(12, parseInt(document.getElementById('cfg-speed').value) || 5));
                cfg.friction = Math.max(0.9, Math.min(0.999, parseFloat(document.getElementById('cfg-friction').value) || 0.99));
                cfg.tailLength = Math.max(5, Math.min(25, parseInt(document.getElementById('cfg-tail').value) || 12));

                if (newCount !== particleCount) {
                    particleCount = newCount;
                    localStorage.setItem('particleCount', newCount);
                    initParticles();
                }

                document.body.removeChild(overlay);
            });
        });
    }
})();

// Desktop-specific sidebar and pet logic
(function() {
    var sidebar = document.getElementById('sidebar');
    var mainContent = document.getElementById('main-content');
    var pet = document.getElementById('pet');
    var navLinks = document.querySelector('.nav-links');
    var sidebarHint = document.getElementById('sidebar-hint');

    var isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    var targetY = window.innerHeight / 2;
    var currentY = targetY;
    var petHeight = 80;
    var sidebarWidth = 220;
    var isFollowing = false;
    var returnTimer = null;
    var isReturning = false;
    var closeDistance = 20;
    var rushEasing = 0.3;
    var gentleEasing = 0.1;

    function getAvoidZones() {
        var zones = [];
        if (navLinks && !isCollapsed) {
            var rect = navLinks.getBoundingClientRect();
            zones.push({ top: rect.top - 10, bottom: rect.bottom + 10 });
        }
        return zones;
    }

    function isInAvoidZone(y) {
        var zones = getAvoidZones();
        var petTop = y - petHeight / 2;
        var petBottom = y + petHeight / 2;
        for (var i = 0; i < zones.length; i++) {
            if (petBottom > zones[i].top && petTop < zones[i].bottom) return true;
        }
        return false;
    }

    function collapseSidebar() {
        isCollapsed = true;
        sidebar.classList.add('collapsed');
        mainContent.classList.add('expanded');
        pet.classList.add('at-edge');
        pet.classList.remove('at-sidebar', 'slim');
        sidebarHint.classList.add('visible');
        localStorage.setItem('sidebarCollapsed', 'true');
        var quickAddBar = document.querySelector('.quick-add-bar');
        if (quickAddBar) quickAddBar.classList.add('expanded');
    }

    function expandSidebar() {
        isCollapsed = false;
        sidebar.classList.remove('collapsed');
        mainContent.classList.remove('expanded');
        pet.classList.remove('at-edge');
        pet.classList.add('at-sidebar');
        sidebarHint.classList.remove('visible');
        localStorage.setItem('sidebarCollapsed', 'false');
        var quickAddBar = document.querySelector('.quick-add-bar');
        if (quickAddBar) quickAddBar.classList.remove('expanded');
    }

    if (isCollapsed) collapseSidebar();
    else pet.classList.add('at-sidebar');

    pet.addEventListener('click', function() {
        if (isCollapsed) expandSidebar();
        else collapseSidebar();
    });

    document.addEventListener('mousemove', function(e) {
        var petX = isCollapsed ? 0 : sidebarWidth;
        var activeZone = petX + 100;
        if (e.clientX < activeZone) {
            isFollowing = true;
            isReturning = false;
            targetY = e.clientY;
            pet.classList.add('active');
            if (returnTimer) { clearTimeout(returnTimer); returnTimer = null; }
        } else if (isFollowing) {
            isFollowing = false;
            pet.classList.remove('active', 'excited');
            returnTimer = setTimeout(function() {
                isReturning = true;
                targetY = window.innerHeight / 2;
            }, 600);
        }
    });

    function animatePet() {
        var distance = targetY - currentY;
        var absDistance = Math.abs(distance);
        var moveAmount = 0;
        if (isFollowing) {
            if (absDistance > closeDistance) {
                moveAmount = distance * rushEasing;
                pet.classList.add('excited');
            } else {
                moveAmount = distance * gentleEasing;
                pet.classList.remove('excited');
            }
        } else if (isReturning) {
            moveAmount = distance * 0.04;
            pet.classList.remove('excited');
        }
        currentY += moveAmount;
        var minY = petHeight / 2 + 48 + 10; // è€ƒè™‘48pxé¡¶éƒ¨å¯¼èˆªæ 
        var maxY = window.innerHeight - petHeight / 2 - 20;
        currentY = Math.max(minY, Math.min(maxY, currentY));
        if (isInAvoidZone(currentY)) pet.classList.add('slim');
        else pet.classList.remove('slim');
        pet.style.top = currentY + 'px';
        requestAnimationFrame(animatePet);
    }
    animatePet();

    window.addEventListener('resize', function() {
        if (!isFollowing) targetY = window.innerHeight / 2;
    });
})();

// Timezone updates
(function() {
    var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    function formatTz(date) {
        var m = date.getMonth() + 1;
        var d = date.getDate();
        var w = weekdays[date.getDay()];
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return { date: m + '/' + d + ' å‘¨' + w, time: h + ':' + min };
    }
    function updateTimezones() {
        var now = new Date();
        var beijing = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
        var bjFmt = formatTz(beijing);
        document.getElementById('tz-beijing-date').textContent = bjFmt.date;
        document.getElementById('tz-beijing-time').textContent = bjFmt.time;
        var waterloo = new Date(now.toLocaleString('en-US', { timeZone: 'America/Toronto' }));
        var wtFmt = formatTz(waterloo);
        document.getElementById('tz-waterloo-date').textContent = wtFmt.date;
        document.getElementById('tz-waterloo-time').textContent = wtFmt.time;
        var vancouver = new Date(now.toLocaleString('en-US', { timeZone: 'America/Vancouver' }));
        var vcFmt = formatTz(vancouver);
        document.getElementById('tz-vancouver-date').textContent = vcFmt.date;
        document.getElementById('tz-vancouver-time').textContent = vcFmt.time;
    }
    updateTimezones();
    setInterval(updateTimezones, 1000);
})();
</script>
{% endblock %}
