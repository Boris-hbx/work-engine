{% extends "base.html" %}

{% block title %}Promptå†å²è®°å½• - Time Management{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">Promptå†å²è®°å½•</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="prompts-container">
        <!-- Add New Prompt Form -->
        <div class="prompt-input-section">
            <div class="prompt-input-header">
                <span class="input-title">æ·»åŠ æ–°è®°å½•</span>
                <span class="auto-time" id="current-time"></span>
            </div>
            <textarea class="prompt-input" id="prompt-input" placeholder="è¾“å…¥Promptå†…å®¹..." rows="3"></textarea>
            <div class="prompt-input-footer">
                <div class="auto-tags" id="auto-tags">
                    <span class="tags-label">è‡ªåŠ¨æ ‡ç­¾ï¼š</span>
                    <span class="tags-preview" id="tags-preview">è¾“å…¥å†…å®¹åè‡ªåŠ¨ç”Ÿæˆ</span>
                </div>
                <button class="btn-add-prompt" onclick="addPrompt()">æ·»åŠ </button>
            </div>
        </div>

        <div class="prompt-stats">
            <span class="stat-item">å…± <strong id="prompt-count">0</strong> æ¡è®°å½•</span>
        </div>

        <!-- Prompt List -->
        <div class="prompt-list" id="prompt-list">
            <!-- Prompts will be rendered here -->
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal" style="display:none;" onclick="hideDeleteModal(event)">
        <div class="modal-content modal-small" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="delete-warning">åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è¾“å…¥å¯†ç ç¡®è®¤ï¼š</p>
                <input type="password" id="delete-password" class="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
                <p class="password-hint">* å¯†ç å¯åœ¨ data/config.json ä¸­ä¿®æ”¹</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button class="btn-delete" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
    var allPrompts = [];
    var deleteTargetId = null;

    // Update current time display
    function updateCurrentTime() {
        var now = new Date();
        var y = now.getFullYear();
        var m = (now.getMonth() + 1).toString().padStart(2, '0');
        var d = now.getDate().toString().padStart(2, '0');
        var h = now.getHours().toString().padStart(2, '0');
        var min = now.getMinutes().toString().padStart(2, '0');
        var sec = now.getSeconds().toString().padStart(2, '0');
        document.getElementById('current-time').textContent = y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec;
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    // Auto-generate tags based on content
    function generateTags(content) {
        if (!content || content.trim().length < 5) return [];

        var tags = [];
        var text = content.toLowerCase();

        // Keyword-based tag generation
        var tagRules = [
            { keywords: ['bug', 'ä¿®å¤', 'fix', 'é”™è¯¯', 'error'], tag: 'é—®é¢˜ä¿®å¤' },
            { keywords: ['åŠŸèƒ½', 'feature', 'æ–°å¢', 'æ·»åŠ ', 'add'], tag: 'æ–°åŠŸèƒ½' },
            { keywords: ['ä¼˜åŒ–', 'æ”¹è¿›', 'improve', 'optimize', 'æ€§èƒ½'], tag: 'ä¼˜åŒ–' },
            { keywords: ['ui', 'ç•Œé¢', 'æ ·å¼', 'css', 'style', 'å¸ƒå±€'], tag: 'UIè®¾è®¡' },
            { keywords: ['api', 'æ¥å£', 'backend', 'åç«¯', 'æœåŠ¡'], tag: 'åç«¯' },
            { keywords: ['å‰ç«¯', 'frontend', 'js', 'javascript', 'html'], tag: 'å‰ç«¯' },
            { keywords: ['æ‹–æ‹½', 'drag', 'drop', 'äº¤äº’'], tag: 'äº¤äº’' },
            { keywords: ['åŠ¨ç”»', 'animation', 'åŠ¨æ•ˆ', 'è¿‡æ¸¡'], tag: 'åŠ¨ç”»' },
            { keywords: ['é…ç½®', 'config', 'è®¾ç½®', 'setting'], tag: 'é…ç½®' },
            { keywords: ['æµ‹è¯•', 'test', 'è°ƒè¯•', 'debug'], tag: 'æµ‹è¯•' },
            { keywords: ['todo', 'ä»»åŠ¡', 'task', 'å¾…åŠ'], tag: 'Todo' },
            { keywords: ['prompt', 'æ—¥å¿—', 'log'], tag: 'Prompt' },
            { keywords: ['æ•°æ®', 'data', 'å­˜å‚¨', 'save', 'ä¿å­˜'], tag: 'æ•°æ®' }
        ];

        tagRules.forEach(function(rule) {
            for (var i = 0; i < rule.keywords.length; i++) {
                if (text.indexOf(rule.keywords[i]) !== -1) {
                    if (tags.indexOf(rule.tag) === -1) {
                        tags.push(rule.tag);
                    }
                    break;
                }
            }
        });

        // Limit to 3 tags
        return tags.slice(0, 3);
    }

    // Update tag preview as user types
    document.getElementById('prompt-input').addEventListener('input', function(e) {
        var content = e.target.value;
        var tags = generateTags(content);
        var preview = document.getElementById('tags-preview');

        if (tags.length > 0) {
            preview.innerHTML = tags.map(function(tag) {
                return '<span class="preview-tag">' + tag + '</span>';
            }).join('');
        } else {
            preview.textContent = 'è¾“å…¥å†…å®¹åè‡ªåŠ¨ç”Ÿæˆ';
        }
    });

    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    function loadPrompts() {
        fetch('/api/prompts')
            .then(response => response.json())
            .then(data => {
                allPrompts = data.prompts || [];
                document.getElementById('prompt-count').textContent = allPrompts.length;
                renderPrompts();
            });
    }

    function renderPrompts() {
        var container = document.getElementById('prompt-list');

        if (allPrompts.length === 0) {
            container.innerHTML = '<div class="empty-prompts">æš‚æ— è®°å½•ï¼Œæ·»åŠ ç¬¬ä¸€æ¡å§ï¼</div>';
            return;
        }

        var html = '';
        var total = allPrompts.length;
        allPrompts.forEach(function(prompt, index) {
            // å€’åºç¼–å·ï¼šæœ€æ–°çš„(index=0)æ˜¾ç¤ºæœ€å¤§æ•°å­—ï¼Œæœ€æ—§çš„æ˜¾ç¤º#1
            html += createPromptHtml(prompt, total - index);
        });
        container.innerHTML = html;
    }

    function createPromptHtml(prompt, index) {
        var tagsHtml = '';
        if (prompt.tags && prompt.tags.length > 0) {
            tagsHtml = '<div class="prompt-tags">' +
                prompt.tags.map(function(tag) {
                    return '<span class="prompt-tag">' + escapeHtml(tag) + '</span>';
                }).join('') +
            '</div>';
        }

        var dateStr = formatDateTime(prompt.created_at);

        return '<div class="prompt-item" data-id="' + prompt.id + '">' +
            '<div class="prompt-header">' +
                '<span class="prompt-index">#' + index + '</span>' +
                '<span class="prompt-time">' + dateStr + '</span>' +
                '<div class="prompt-actions">' +
                    '<button class="btn-copy-prompt" onclick="copyPrompt(\'' + prompt.id + '\')" title="å¤åˆ¶å†…å®¹">ğŸ“‹</button>' +
                    '<button class="btn-copy-to-todo" onclick="copyToTodo(\'' + prompt.id + '\')" title="å¤åˆ¶åˆ°å¾…æ‰§è¡Œ">ğŸ“¤</button>' +
                    '<button class="btn-delete-prompt" onclick="showDeleteModal(\'' + prompt.id + '\')" title="åˆ é™¤">Ã—</button>' +
                '</div>' +
            '</div>' +
            '<div class="prompt-content">' + escapeHtml(prompt.content) + '</div>' +
            tagsHtml +
        '</div>';
    }

    function addPrompt() {
        var content = document.getElementById('prompt-input').value.trim();
        if (!content) {
            showToast('è¯·è¾“å…¥å†…å®¹', 'error');
            return;
        }

        var tags = generateTags(content);

        fetch('/api/prompts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content, tags: tags })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('prompt-input').value = '';
                document.getElementById('tags-preview').textContent = 'è¾“å…¥å†…å®¹åè‡ªåŠ¨ç”Ÿæˆ';
                loadPrompts();
                showToast('æ·»åŠ æˆåŠŸ', 'success');
            } else {
                showToast('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    // Delete Modal
    function showDeleteModal(id) {
        deleteTargetId = id;
        document.getElementById('delete-password').value = '';
        document.getElementById('delete-modal').style.display = 'flex';
        document.getElementById('delete-password').focus();
    }

    function hideDeleteModal(e) {
        if (e && e.target !== document.getElementById('delete-modal')) return;
        document.getElementById('delete-modal').style.display = 'none';
        deleteTargetId = null;
    }

    function confirmDelete() {
        var password = document.getElementById('delete-password').value;
        if (!password) {
            showToast('è¯·è¾“å…¥å¯†ç ', 'error');
            return;
        }

        fetch('/api/prompts/' + deleteTargetId, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                hideDeleteModal();
                loadPrompts();
                showToast('åˆ é™¤æˆåŠŸ', 'success');
            } else {
                showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        });
    }

    function copyPrompt(id) {
        var prompt = allPrompts.find(function(p) { return p.id === id; });
        if (!prompt) return;

        navigator.clipboard.writeText(prompt.content).then(function() {
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(function() {
            var textarea = document.createElement('textarea');
            textarea.value = prompt.content;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
    }

    function copyToTodo(id) {
        var prompt = allPrompts.find(function(p) { return p.id === id; });
        if (!prompt) return;

        fetch('/api/prompt-todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: prompt.content, status: 'å¾…ä¿®æ”¹' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('å·²å¤åˆ¶åˆ°å¾…æ‰§è¡Œåˆ—è¡¨', 'success');
            } else {
                showToast('å¤åˆ¶å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    // Enter key to submit
    document.getElementById('delete-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') confirmDelete();
    });

    document.getElementById('prompt-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            addPrompt();
        }
    });

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/\n/g, '<br>');
    }

    function formatDateTime(isoString) {
        var date = new Date(isoString);
        var y = date.getFullYear();
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return y + '-' + m + '-' + d + ' ' + h + ':' + min;
    }

    function showToast(message, type) {
        AppUtils.showToast(message, type);
    }

    // Initialize
    loadPrompts();
    </script>
{% endblock %}
