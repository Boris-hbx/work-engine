{% extends "base.html" %}

{% block title %}å¾…æ‰§è¡ŒPrompt - Time Management{% endblock %}

{% block content %}
<style>
/* å·¥å…·æ æ ·å¼ */
.prompt-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    gap: 12px;
}

.toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* æ¨¡æ¿ä¸‹æ‹‰èœå• */
.template-dropdown {
    position: relative;
}

.btn-template {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-template:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.template-icon {
    font-size: 14px;
}

.dropdown-arrow {
    font-size: 10px;
    transition: transform 0.2s ease;
}

.template-dropdown.open .dropdown-arrow {
    transform: rotate(180deg);
}

.template-menu {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    width: 300px;
    background: var(--card-bg, white);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
}

.template-dropdown.open .template-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.template-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    border-bottom: 1px solid var(--border-light, #eee);
}

.template-item:last-child {
    border-bottom: none;
}

.template-item:first-child {
    border-radius: 12px 12px 0 0;
}

.template-item:last-child {
    border-radius: 0 0 12px 12px;
}

.template-item:hover {
    background: var(--hover-bg, #f5f7fa);
}

.template-item-icon {
    font-size: 20px;
    flex-shrink: 0;
}

.template-item-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.template-item-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-primary, #333);
}

.template-item-desc {
    font-size: 12px;
    color: var(--text-secondary, #666);
}

/* æ¨¡å‹é€‰æ‹©å™¨ */
.model-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.model-selector-label {
    font-size: 12px;
    color: var(--text-secondary, #666);
    white-space: nowrap;
}

.model-select {
    padding: 6px 28px 6px 10px;
    border: 1px solid var(--border-light, #ddd);
    border-radius: 6px;
    background: var(--card-bg, white);
    font-size: 13px;
    color: var(--text-primary, #333);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    min-width: 140px;
    transition: all 0.2s ease;
}

.model-select:hover {
    border-color: #667eea;
}

.model-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
}

.model-select option {
    padding: 8px;
}

.model-select option[data-default] {
    font-weight: 600;
}

/* AI ä¼˜åŒ–æŒ‰é’® */
.btn-ai-optimize {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-ai-optimize:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
}

.btn-ai-optimize:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-ai-optimize.loading {
    background: linear-gradient(135deg, #a0a0a0 0%, #808080 100%);
}

.btn-ai-optimize.loading .ai-icon {
    animation: sparkle 1s ease-in-out infinite;
}

@keyframes sparkle {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

.ai-icon {
    font-size: 14px;
}

/* AI ä¼˜åŒ–å¼¹çª— */
.ai-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.ai-modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.ai-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    background: var(--card-bg, white);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 2001;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
}

.ai-modal.visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}

.ai-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-light, #eee);
}

.ai-modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: var(--text-primary, #333);
}

.ai-modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--hover-bg, #f5f5f5);
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-secondary, #666);
    transition: all 0.2s ease;
}

.ai-modal-close:hover {
    background: #ff4757;
    color: white;
}

.ai-modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}

.ai-modal-section {
    margin-bottom: 20px;
}

.ai-modal-section:last-child {
    margin-bottom: 0;
}

.ai-modal-section label {
    display: block;
    font-weight: 600;
    font-size: 14px;
    color: var(--text-primary, #333);
    margin-bottom: 8px;
}

.ai-original-prompt {
    padding: 12px 16px;
    background: var(--hover-bg, #f5f7fa);
    border-radius: 8px;
    font-size: 13px;
    color: var(--text-secondary, #666);
    white-space: pre-wrap;
    max-height: 120px;
    overflow-y: auto;
}

.ai-optimized-prompt {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-light, #e0e0e0);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    min-height: 200px;
    transition: border-color 0.2s ease;
}

.ai-optimized-prompt:focus {
    outline: none;
    border-color: #667eea;
}

.ai-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid var(--border-light, #eee);
}

.btn-ai-cancel {
    padding: 10px 20px;
    border: 1px solid var(--border-light, #ddd);
    background: white;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-ai-cancel:hover {
    background: var(--hover-bg, #f5f5f5);
}

.btn-ai-apply {
    padding: 10px 20px;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-ai-apply:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* å“åº”å¼ */
@media (max-width: 600px) {
    .prompt-toolbar {
        flex-direction: column;
        align-items: stretch;
    }

    .toolbar-left, .toolbar-right {
        justify-content: center;
    }

    .template-menu {
        width: 100%;
        left: 0;
        right: 0;
    }
}
</style>
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">å¾…æ‰§è¡ŒPrompt</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="prompts-container">
        <!-- Copyable Instruction -->
        <div class="copy-instruction-section">
            <div class="copy-instruction-box" id="instruction-box">
                <div class="instruction-content" onclick="copyInstruction()">
                    <span class="copy-icon">ğŸ“‹</span>
                    <span class="copy-text" id="instruction-text">è¯·æ‰§è¡Œ prompt-todo.json ä¸­çŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"çš„ prompt å‘½ä»¤ã€‚å®Œæˆæ‰§è¡Œåå°†å…¶çŠ¶æ€è®¾ç½®ä¸º"å·²æ‰§è¡Œ"ã€‚æ‰§è¡Œé¡ºåºå¯ç”±ä½ ç»¼åˆåˆ†æåå†³ç­–ã€‚</span>
                </div>
                <div class="instruction-actions">
                    <span class="copy-hint" onclick="copyInstruction()">ç‚¹å‡»å¤åˆ¶</span>
                    <span class="edit-hint" onclick="editInstruction(event)">ç¼–è¾‘</span>
                </div>
            </div>
        </div>

        <!-- Add New Prompt Todo -->
        <div class="prompt-input-section">
            <div class="prompt-input-header">
                <span class="input-title">æ·»åŠ å¾…æ‰§è¡ŒPrompt</span>
                <span class="auto-time" id="current-time"></span>
            </div>
            <!-- å·¥å…·æ ï¼šæ¨¡æ¿å’Œ AI ä¼˜åŒ– -->
            <div class="prompt-toolbar">
                <div class="toolbar-left">
                    <div class="template-dropdown">
                        <button class="btn-template" onclick="toggleTemplateDropdown()">
                            <span class="template-icon">ğŸ“</span>
                            <span>æ’å…¥æ¨¡æ¿</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div class="template-menu" id="template-menu">
                            <div class="template-item" onclick="insertTemplate('feature')">
                                <span class="template-item-icon">ğŸš€</span>
                                <div class="template-item-info">
                                    <span class="template-item-title">æ–°åŠŸèƒ½å¼€å‘</span>
                                    <span class="template-item-desc">åŒ…å«åŠŸèƒ½æè¿°ã€éªŒæ”¶æ ‡å‡†ã€æŠ€æœ¯çº¦æŸ</span>
                                </div>
                            </div>
                            <div class="template-item" onclick="insertTemplate('bugfix')">
                                <span class="template-item-icon">ğŸ›</span>
                                <div class="template-item-info">
                                    <span class="template-item-title">Bug ä¿®å¤</span>
                                    <span class="template-item-desc">åŒ…å«é—®é¢˜æè¿°ã€å¤ç°æ­¥éª¤ã€æœŸæœ›ç»“æœ</span>
                                </div>
                            </div>
                            <div class="template-item" onclick="insertTemplate('optimize')">
                                <span class="template-item-icon">âš¡</span>
                                <div class="template-item-info">
                                    <span class="template-item-title">æ€§èƒ½ä¼˜åŒ–</span>
                                    <span class="template-item-desc">åŒ…å«ä¼˜åŒ–ç›®æ ‡ã€å½“å‰çŠ¶æ€ã€æµ‹é‡æ–¹å¼</span>
                                </div>
                            </div>
                            <div class="template-item" onclick="insertTemplate('ui')">
                                <span class="template-item-icon">ğŸ¨</span>
                                <div class="template-item-info">
                                    <span class="template-item-title">UI/æ ·å¼è°ƒæ•´</span>
                                    <span class="template-item-desc">åŒ…å«è°ƒæ•´ä½ç½®ã€æœŸæœ›æ•ˆæœã€å…¼å®¹è¦æ±‚</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="toolbar-right">
                    <div class="model-selector">
                        <span class="model-selector-label">æ¨¡å‹:</span>
                        <select class="model-select" id="model-select" onchange="saveModelChoice()">
                            <option value="deepseek" data-default>DeepSeek (é»˜è®¤)</option>
                            <option value="doubao">è±†åŒ…</option>
                            <option value="openai">OpenAI GPT</option>
                        </select>
                    </div>
                    <button class="btn-ai-optimize" onclick="aiOptimizePrompt()" id="btn-ai-optimize">
                        <span class="ai-icon">âœ¨</span>
                        <span>AI ä¼˜åŒ– Prompt</span>
                    </button>
                </div>
            </div>
            <textarea class="prompt-input" id="prompt-input" placeholder="è¾“å…¥å¾…æ‰§è¡Œçš„Promptå†…å®¹..." rows="3"></textarea>
            <div class="prompt-input-footer">
                <div class="auto-tags">
                    <span class="tags-label">æç¤ºï¼š</span>
                    <span class="tags-preview">æŒ‰ Ctrl+Enter å¿«é€Ÿæ·»åŠ </span>
                </div>
                <button class="btn-add-prompt" onclick="addPromptTodo()">æ·»åŠ </button>
            </div>
        </div>

        <!-- AI ä¼˜åŒ–é¢„è§ˆå¼¹çª— -->
        <div class="ai-modal-overlay" id="ai-modal-overlay" onclick="closeAiModal()"></div>
        <div class="ai-modal" id="ai-modal">
            <div class="ai-modal-header">
                <h3>AI ä¼˜åŒ–ç»“æœ</h3>
                <button class="ai-modal-close" onclick="closeAiModal()">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-modal-section">
                    <label>åŸå§‹ Promptï¼š</label>
                    <div class="ai-original-prompt" id="ai-original-prompt"></div>
                </div>
                <div class="ai-modal-section">
                    <label>ä¼˜åŒ–å Promptï¼ˆå¯ç¼–è¾‘ï¼‰ï¼š</label>
                    <textarea class="ai-optimized-prompt" id="ai-optimized-prompt" rows="10"></textarea>
                </div>
            </div>
            <div class="ai-modal-footer">
                <button class="btn-ai-cancel" onclick="closeAiModal()">å–æ¶ˆ</button>
                <button class="btn-ai-apply" onclick="applyOptimizedPrompt()">åº”ç”¨ä¼˜åŒ–ç»“æœ</button>
            </div>
        </div>

        <!-- Prompt List Header with Stats -->
        <div class="prompt-list-header">
            <h3 class="prompt-list-title">Prompt åˆ—è¡¨</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="filterByStatus('all')">å…¨éƒ¨ <strong id="all-count">0</strong></button>
                <button class="filter-btn filter-pending" data-filter="å¾…ä¿®æ”¹" onclick="filterByStatus('å¾…ä¿®æ”¹')">å¾…ä¿®æ”¹ <strong id="pending-count">0</strong></button>
                <button class="filter-btn filter-ready" data-filter="å¾…æ‰§è¡Œ" onclick="filterByStatus('å¾…æ‰§è¡Œ')">å¾…æ‰§è¡Œ <strong id="todo-count">0</strong></button>
                <button class="filter-btn filter-running" data-filter="æ‰§è¡Œä¸­" onclick="filterByStatus('æ‰§è¡Œä¸­')">æ‰§è¡Œä¸­ <strong id="running-count">0</strong></button>
                <button class="filter-btn filter-done" data-filter="å·²æ‰§è¡Œ" onclick="filterByStatus('å·²æ‰§è¡Œ')">å·²æ‰§è¡Œ <strong id="done-count">0</strong></button>
            </div>
            <button class="btn-refresh" onclick="loadTodos()" title="åˆ·æ–°åˆ—è¡¨">ğŸ”„ åˆ·æ–°</button>
        </div>

        <!-- Prompt Todo List -->
        <div class="prompt-list" id="prompt-todo-list">
            <!-- Todos will be rendered here -->
        </div>
    </div>

    <script>
    var allTodos = [];
    var currentFilter = 'all';

    // Prompt æ¨¡æ¿å®šä¹‰
    var promptTemplates = {
        feature: `ã€åŠŸèƒ½åç§°ã€‘: [ç®€çŸ­åç§°]

ã€åŠŸèƒ½æè¿°ã€‘:
[è¯¦ç»†æè¿°è¦å®ç°ä»€ä¹ˆåŠŸèƒ½ï¼Œè§£å†³ä»€ä¹ˆé—®é¢˜]

ã€éªŒæ”¶æ ‡å‡†ã€‘:
1. [å¯éªŒè¯çš„å…·ä½“æ¡ä»¶1]
2. [å¯éªŒè¯çš„å…·ä½“æ¡ä»¶2]
3. [å¯éªŒè¯çš„å…·ä½“æ¡ä»¶3]

ã€æŠ€æœ¯çº¦æŸã€‘:
- [æŠ€æœ¯é™åˆ¶æˆ–è¦æ±‚]
- [å…¼å®¹æ€§è¦æ±‚]
- [æ€§èƒ½è¦æ±‚]

ã€å‚è€ƒèµ„æ–™ã€‘:
- ç›¸ä¼¼åŠŸèƒ½: [å‚è€ƒä½ç½®]
- æˆªå›¾: PrtSc/xxx.png`,

        bugfix: `ã€é—®é¢˜æè¿°ã€‘: [ç®€è¦æè¿°é—®é¢˜]

ã€å¤ç°æ­¥éª¤ã€‘:
1. [æ­¥éª¤1]
2. [æ­¥éª¤2]
3. [æ­¥éª¤3]

ã€å®é™…ç»“æœã€‘: [æè¿°å‡ºé”™çš„æƒ…å†µ]

ã€æœŸæœ›ç»“æœã€‘: [æè¿°æ­£ç¡®çš„è¡Œä¸º]

ã€å½±å“èŒƒå›´ã€‘: [å“ªäº›åŠŸèƒ½/é¡µé¢å—å½±å“]

ã€å‚è€ƒæˆªå›¾ã€‘: PrtSc/error_xxx.png`,

        optimize: `ã€ä¼˜åŒ–ç›®æ ‡ã€‘: [è¦ä¼˜åŒ–ä»€ä¹ˆ]

ã€å½“å‰çŠ¶æ€ã€‘: [ç°åœ¨çš„æ€§èƒ½æŒ‡æ ‡]

ã€ç›®æ ‡æŒ‡æ ‡ã€‘: [æœŸæœ›è¾¾åˆ°çš„æ€§èƒ½]

ã€å¯æ¥å—æ–¹æ¡ˆã€‘:
- [æ–¹æ¡ˆ1]
- [æ–¹æ¡ˆ2]

ã€æµ‹é‡æ–¹å¼ã€‘: [å¦‚ä½•éªŒè¯ä¼˜åŒ–æ•ˆæœ]`,

        ui: `ã€è°ƒæ•´ä½ç½®ã€‘: [å…·ä½“é¡µé¢å’Œå…ƒç´ ]

ã€å½“å‰çŠ¶æ€ã€‘: [ç°åœ¨çš„æ ·å¼]

ã€æœŸæœ›æ•ˆæœã€‘: [æƒ³è¦çš„æ ·å¼]

ã€å…·ä½“è¦æ±‚ã€‘:
- é¢œè‰²: [è‰²å€¼]
- å°ºå¯¸: [å…·ä½“æ•°å€¼]
- åŠ¨ç”»: [æ•ˆæœæè¿°]

ã€å…¼å®¹è¦æ±‚ã€‘:
- [ ] æ·±è‰²æ¨¡å¼
- [ ] ç§»åŠ¨ç«¯é€‚é…

ã€å‚è€ƒæˆªå›¾ã€‘: PrtSc/style_xxx.png`
    };

    // æ¨¡æ¿ä¸‹æ‹‰èœå•åˆ‡æ¢
    function toggleTemplateDropdown() {
        var dropdown = document.querySelector('.template-dropdown');
        dropdown.classList.toggle('open');
    }

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', function(e) {
        var dropdown = document.querySelector('.template-dropdown');
        if (dropdown && !dropdown.contains(e.target)) {
            dropdown.classList.remove('open');
        }
    });

    // æ’å…¥æ¨¡æ¿
    function insertTemplate(type) {
        var template = promptTemplates[type];
        if (template) {
            var input = document.getElementById('prompt-input');
            var currentValue = input.value.trim();
            if (currentValue) {
                input.value = currentValue + '\n\n' + template;
            } else {
                input.value = template;
            }
            input.focus();
            showToast('å·²æ’å…¥æ¨¡æ¿', 'success');
        }
        // å…³é—­ä¸‹æ‹‰èœå•
        document.querySelector('.template-dropdown').classList.remove('open');
    }

    // æ¨¡å‹é€‰æ‹©ç›¸å…³
    function saveModelChoice() {
        var select = document.getElementById('model-select');
        localStorage.setItem('ai_optimize_model', select.value);
    }

    function loadModelChoice() {
        var saved = localStorage.getItem('ai_optimize_model');
        if (saved) {
            var select = document.getElementById('model-select');
            select.value = saved;
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤æ¨¡å‹é€‰æ‹©
    loadModelChoice();

    // AI ä¼˜åŒ– Prompt
    function aiOptimizePrompt() {
        var content = document.getElementById('prompt-input').value.trim();
        if (!content) {
            showToast('è¯·å…ˆè¾“å…¥ Prompt å†…å®¹', 'error');
            return;
        }

        if (content.length < 10) {
            showToast('Prompt å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•ä¼˜åŒ–', 'error');
            return;
        }

        var selectedModel = document.getElementById('model-select').value;
        var btn = document.getElementById('btn-ai-optimize');
        btn.classList.add('loading');
        btn.disabled = true;
        btn.querySelector('span:last-child').textContent = 'ä¼˜åŒ–ä¸­...';

        fetch('/api/prompt/optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content, model: selectedModel })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.querySelector('span:last-child').textContent = 'AI ä¼˜åŒ– Prompt';

            if (data.success) {
                // æ˜¾ç¤ºé¢„è§ˆå¼¹çª—
                document.getElementById('ai-original-prompt').textContent = content;
                document.getElementById('ai-optimized-prompt').value = data.optimized;
                document.getElementById('ai-modal-overlay').classList.add('visible');
                document.getElementById('ai-modal').classList.add('visible');
            } else {
                showToast('ä¼˜åŒ–å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        })
        .catch(function(err) {
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.querySelector('span:last-child').textContent = 'AI ä¼˜åŒ– Prompt';
            showToast('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // å…³é—­ AI å¼¹çª—
    function closeAiModal() {
        document.getElementById('ai-modal-overlay').classList.remove('visible');
        document.getElementById('ai-modal').classList.remove('visible');
    }

    // åº”ç”¨ä¼˜åŒ–ç»“æœ
    function applyOptimizedPrompt() {
        var optimized = document.getElementById('ai-optimized-prompt').value;
        document.getElementById('prompt-input').value = optimized;
        closeAiModal();
        showToast('å·²åº”ç”¨ä¼˜åŒ–ç»“æœ', 'success');
    }

    // ESC é”®å…³é—­å¼¹çª—
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAiModal();
        }
    });

    // Filter by status
    function filterByStatus(status) {
        currentFilter = status;
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.getAttribute('data-filter') === status) {
                btn.classList.add('active');
            }
        });
        renderTodos();
    }

    // Update current time display
    function updateCurrentTime() {
        var now = new Date();
        var y = now.getFullYear();
        var m = (now.getMonth() + 1).toString().padStart(2, '0');
        var d = now.getDate().toString().padStart(2, '0');
        var h = now.getHours().toString().padStart(2, '0');
        var min = now.getMinutes().toString().padStart(2, '0');
        var sec = now.getSeconds().toString().padStart(2, '0');
        document.getElementById('current-time').textContent = y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec;
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    function copyInstruction() {
        var text = document.getElementById('instruction-text').textContent;
        navigator.clipboard.writeText(text).then(function() {
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(function() {
            // Fallback for older browsers
            var textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
    }

    function editInstruction(event) {
        event.stopPropagation();
        var textSpan = document.getElementById('instruction-text');
        var currentText = textSpan.textContent;
        var box = document.getElementById('instruction-box');

        box.innerHTML = '<textarea id="instruction-edit" class="instruction-textarea">' + currentText + '</textarea>' +
            '<div class="instruction-edit-buttons">' +
                '<button class="btn-save-instruction" onclick="saveInstruction()">ä¿å­˜</button>' +
                '<button class="btn-cancel-instruction" onclick="cancelInstructionEdit()">å–æ¶ˆ</button>' +
            '</div>';

        document.getElementById('instruction-edit').focus();
    }

    function saveInstruction() {
        var textarea = document.getElementById('instruction-edit');
        var newText = textarea.value.trim();
        if (!newText) {
            showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        restoreInstructionBox(newText);
        showToast('å·²ä¿å­˜', 'success');
    }

    function cancelInstructionEdit() {
        var defaultText = 'è¯·æ‰§è¡Œ prompt-todo.json ä¸­çŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"çš„ prompt å‘½ä»¤ã€‚å®Œæˆæ‰§è¡Œåå°†å…¶çŠ¶æ€è®¾ç½®ä¸º"å·²æ‰§è¡Œ"ã€‚æ‰§è¡Œé¡ºåºå¯ç”±ä½ ç»¼åˆåˆ†æåå†³ç­–ã€‚';
        restoreInstructionBox(localStorage.getItem('instructionText') || defaultText);
    }

    function restoreInstructionBox(text) {
        localStorage.setItem('instructionText', text);
        var box = document.getElementById('instruction-box');
        box.innerHTML = '<div class="instruction-content" onclick="copyInstruction()">' +
                '<span class="copy-icon">ğŸ“‹</span>' +
                '<span class="copy-text" id="instruction-text">' + text + '</span>' +
            '</div>' +
            '<div class="instruction-actions">' +
                '<span class="copy-hint" onclick="copyInstruction()">ç‚¹å‡»å¤åˆ¶</span>' +
                '<span class="edit-hint" onclick="editInstruction(event)">ç¼–è¾‘</span>' +
            '</div>';
    }

    // Load saved instruction on page load
    (function() {
        var saved = localStorage.getItem('instructionText');
        if (saved) {
            document.getElementById('instruction-text').textContent = saved;
        }
    })();

    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    function loadTodos() {
        fetch('/api/prompt-todos')
            .then(response => response.json())
            .then(data => {
                allTodos = data.todos || [];
                var todoCount = allTodos.filter(function(t) { return t.status === 'å¾…æ‰§è¡Œ' || !t.status; }).length;
                var pendingCount = allTodos.filter(function(t) { return t.status === 'å¾…ä¿®æ”¹'; }).length;
                var runningCount = allTodos.filter(function(t) { return t.status === 'æ‰§è¡Œä¸­'; }).length;
                var doneCount = allTodos.filter(function(t) { return t.status === 'å·²æ‰§è¡Œ'; }).length;
                document.getElementById('all-count').textContent = allTodos.length;
                document.getElementById('todo-count').textContent = todoCount;
                document.getElementById('pending-count').textContent = pendingCount;
                document.getElementById('running-count').textContent = runningCount;
                document.getElementById('done-count').textContent = doneCount;
                renderTodos();
            });
    }

    function renderTodos() {
        var container = document.getElementById('prompt-todo-list');

        // Filter todos based on currentFilter
        var filteredTodos = allTodos;
        if (currentFilter !== 'all') {
            filteredTodos = allTodos.filter(function(t) {
                var status = t.status || 'å¾…æ‰§è¡Œ';
                return status === currentFilter;
            });
        }

        if (filteredTodos.length === 0) {
            var emptyMsg = currentFilter === 'all' ? 'æš‚æ— å¾…æ‰§è¡Œçš„Prompt' : 'æ²¡æœ‰ã€Œ' + currentFilter + 'ã€çŠ¶æ€çš„Prompt';
            container.innerHTML = '<div class="empty-prompts">' + emptyMsg + '</div>';
            return;
        }

        var html = '';
        filteredTodos.forEach(function(todo, index) {
            html += createTodoHtml(todo, index + 1);
        });
        container.innerHTML = html;
    }

    function createTodoHtml(todo, index) {
        var dateStr = formatDateTime(todo.created_at);
        var status = todo.status || 'å¾…æ‰§è¡Œ';

        var statuses = [
            { name: 'å¾…ä¿®æ”¹', class: 'status-pending' },
            { name: 'å¾…æ‰§è¡Œ', class: 'status-ready' },
            { name: 'æ‰§è¡Œä¸­', class: 'status-running' },
            { name: 'å·²æ‰§è¡Œ', class: 'status-done' }
        ];

        var statusButtonsHtml = '<div class="status-buttons">';
        statuses.forEach(function(s) {
            var isActive = s.name === status;
            statusButtonsHtml += '<button class="status-btn ' + s.class + (isActive ? ' active' : '') + '" onclick="setStatus(\'' + todo.id + '\', \'' + s.name + '\')">' + s.name + '</button>';
        });
        statusButtonsHtml += '</div>';

        var content = todo.content || '';
        var isLong = content.length > 150;
        var contentHtml = '';

        if (isLong) {
            contentHtml = '<div class="prompt-content collapsed" data-id="' + todo.id + '">' +
                '<div class="content-preview">' + escapeHtml(content.substring(0, 150)) + '...</div>' +
                '<div class="content-full" style="display:none;">' + escapeHtml(content) + '</div>' +
                '<span class="expand-btn" onclick="toggleContent(\'' + todo.id + '\')">å±•å¼€ â–¼</span>' +
            '</div>';
        } else {
            contentHtml = '<div class="prompt-content">' + escapeHtml(content) + '</div>';
        }

        return '<div class="prompt-item prompt-todo-item" data-id="' + todo.id + '">' +
            '<div class="prompt-header">' +
                '<span class="prompt-index">#' + index + '</span>' +
                statusButtonsHtml +
                '<span class="prompt-time">' + dateStr + '</span>' +
                '<div class="prompt-actions">' +
                    '<div class="action-btn" onclick="editTodo(\'' + todo.id + '\')">' +
                        '<span class="action-icon">âœï¸</span>' +
                        '<span class="action-label">ç¼–è¾‘</span>' +
                    '</div>' +
                    '<div class="action-btn' + (status === 'å·²æ‰§è¡Œ' ? ' action-ready' : '') + '" onclick="archiveTodo(\'' + todo.id + '\')">' +
                        '<span class="action-icon">ğŸ“¥</span>' +
                        '<span class="action-label">å½’æ¡£</span>' +
                    '</div>' +
                    '<div class="action-btn" onclick="copyPrompt(\'' + todo.id + '\')">' +
                        '<span class="action-icon">ğŸ“‹</span>' +
                        '<span class="action-label">å¤åˆ¶</span>' +
                    '</div>' +
                    '<div class="action-btn action-delete" onclick="deleteTodo(\'' + todo.id + '\')">' +
                        '<span class="action-icon">ğŸ—‘ï¸</span>' +
                        '<span class="action-label">åˆ é™¤</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            contentHtml +
        '</div>';
    }

    function toggleContent(id) {
        var contentDiv = document.querySelector('.prompt-content[data-id="' + id + '"]');
        if (!contentDiv) return;

        var preview = contentDiv.querySelector('.content-preview');
        var full = contentDiv.querySelector('.content-full');
        var btn = contentDiv.querySelector('.expand-btn');

        if (contentDiv.classList.contains('collapsed')) {
            preview.style.display = 'none';
            full.style.display = 'block';
            btn.textContent = 'æ”¶èµ· â–²';
            contentDiv.classList.remove('collapsed');
        } else {
            preview.style.display = 'block';
            full.style.display = 'none';
            btn.textContent = 'å±•å¼€ â–¼';
            contentDiv.classList.add('collapsed');
        }
    }

    function setStatus(id, newStatus) {
        fetch('/api/prompt-todos/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTodos();
                showToast('çŠ¶æ€å·²æ›´æ–°ä¸º: ' + newStatus, 'success');
            } else {
                showToast('æ›´æ–°å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function addPromptTodo() {
        var content = document.getElementById('prompt-input').value.trim();
        if (!content) {
            showToast('è¯·è¾“å…¥å†…å®¹', 'error');
            return;
        }

        fetch('/api/prompt-todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('prompt-input').value = '';
                loadTodos();
                showToast('æ·»åŠ æˆåŠŸ', 'success');
            } else {
                showToast('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function deleteTodo(id) {
        window.AppUtils.showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¾…æ‰§è¡ŒPromptå—ï¼Ÿ', function() {
            fetch('/api/prompt-todos/' + id, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTodos();
                    showToast('å·²åˆ é™¤', 'success');
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            });
        }, { confirmText: 'åˆ é™¤', danger: true });
    }

    function archiveTodo(id) {
        var todo = allTodos.find(function(t) { return t.id === id; });
        if (!todo) return;

        var status = todo.status || 'å¾…æ‰§è¡Œ';
        if (status !== 'å·²æ‰§è¡Œ') {
            showToast('å½“å‰çŠ¶æ€ä¸º"' + status + '"ï¼Œè¯·å…ˆå°†çŠ¶æ€è®¾ä¸º"å·²æ‰§è¡Œ"åå†å½’æ¡£', 'error');
            return;
        }

        window.AppUtils.showConfirm('ç¡®è®¤å°†æ­¤promptå½’æ¡£è‡³å†å²è®°å½•ï¼Ÿ', function() {
            // Auto-generate tags
            var tags = generateTags(todo.content);

            fetch('/api/prompt-todos/' + id + '/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags: tags })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTodos();
                    showToast('å·²å½’æ¡£è‡³å†å²è®°å½•', 'success');
                } else {
                    showToast('æ“ä½œå¤±è´¥: ' + data.error, 'error');
                }
            });
        }, { confirmText: 'å½’æ¡£' });
    }

    function editTodo(id) {
        var todo = allTodos.find(function(t) { return t.id === id; });
        if (!todo) return;

        var item = document.querySelector('.prompt-item[data-id="' + id + '"]');
        if (!item) return;

        var contentDiv = item.querySelector('.prompt-content');
        var originalContent = todo.content;

        // Replace content div with textarea
        var textarea = document.createElement('textarea');
        textarea.className = 'prompt-edit-textarea';
        textarea.value = originalContent;
        textarea.rows = 4;

        var btnContainer = document.createElement('div');
        btnContainer.className = 'prompt-edit-buttons';
        btnContainer.innerHTML = '<button class="btn-save-edit" onclick="saveEdit(\'' + id + '\')">ä¿å­˜</button>' +
                                 '<button class="btn-cancel-edit" onclick="loadTodos()">å–æ¶ˆ</button>';

        contentDiv.innerHTML = '';
        contentDiv.appendChild(textarea);
        contentDiv.appendChild(btnContainer);
        textarea.focus();
    }

    function saveEdit(id) {
        var item = document.querySelector('.prompt-item[data-id="' + id + '"]');
        if (!item) return;

        var textarea = item.querySelector('.prompt-edit-textarea');
        if (!textarea) return;

        var newContent = textarea.value.trim();
        if (!newContent) {
            showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        fetch('/api/prompt-todos/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newContent })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTodos();
                showToast('å·²ä¿å­˜', 'success');
            } else {
                showToast('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function copyPrompt(id) {
        var todo = allTodos.find(function(t) { return t.id === id; });
        if (!todo) return;

        navigator.clipboard.writeText(todo.content).then(function() {
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(function() {
            var textarea = document.createElement('textarea');
            textarea.value = todo.content;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
    }

    // Auto-generate tags based on content
    function generateTags(content) {
        if (!content || content.trim().length < 5) return [];

        var tags = [];
        var text = content.toLowerCase();

        var tagRules = [
            { keywords: ['bug', 'ä¿®å¤', 'fix', 'é”™è¯¯', 'error'], tag: 'é—®é¢˜ä¿®å¤' },
            { keywords: ['åŠŸèƒ½', 'feature', 'æ–°å¢', 'æ·»åŠ ', 'add'], tag: 'æ–°åŠŸèƒ½' },
            { keywords: ['ä¼˜åŒ–', 'æ”¹è¿›', 'improve', 'optimize', 'æ€§èƒ½'], tag: 'ä¼˜åŒ–' },
            { keywords: ['ui', 'ç•Œé¢', 'æ ·å¼', 'css', 'style', 'å¸ƒå±€'], tag: 'UIè®¾è®¡' },
            { keywords: ['api', 'æ¥å£', 'backend', 'åç«¯', 'æœåŠ¡'], tag: 'åç«¯' },
            { keywords: ['å‰ç«¯', 'frontend', 'js', 'javascript', 'html'], tag: 'å‰ç«¯' },
            { keywords: ['æ‹–æ‹½', 'drag', 'drop', 'äº¤äº’'], tag: 'äº¤äº’' },
            { keywords: ['åŠ¨ç”»', 'animation', 'åŠ¨æ•ˆ', 'è¿‡æ¸¡'], tag: 'åŠ¨ç”»' },
            { keywords: ['é…ç½®', 'config', 'è®¾ç½®', 'setting'], tag: 'é…ç½®' },
            { keywords: ['æµ‹è¯•', 'test', 'è°ƒè¯•', 'debug'], tag: 'æµ‹è¯•' },
            { keywords: ['todo', 'ä»»åŠ¡', 'task', 'å¾…åŠ'], tag: 'Todo' },
            { keywords: ['prompt', 'æ—¥å¿—', 'log'], tag: 'Prompt' },
            { keywords: ['æ•°æ®', 'data', 'å­˜å‚¨', 'save', 'ä¿å­˜'], tag: 'æ•°æ®' }
        ];

        tagRules.forEach(function(rule) {
            for (var i = 0; i < rule.keywords.length; i++) {
                if (text.indexOf(rule.keywords[i]) !== -1) {
                    if (tags.indexOf(rule.tag) === -1) {
                        tags.push(rule.tag);
                    }
                    break;
                }
            }
        });

        return tags.slice(0, 3);
    }

    // Enter key to submit
    document.getElementById('prompt-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            addPromptTodo();
        }
    });

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/\n/g, '<br>');
    }

    function formatDateTime(isoString) {
        var date = new Date(isoString);
        var y = date.getFullYear();
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return y + '-' + m + '-' + d + ' ' + h + ':' + min;
    }

    function showToast(message, type) {
        AppUtils.showToast(message, type);
    }

    // Initialize
    loadTodos();
    </script>
{% endblock %}
