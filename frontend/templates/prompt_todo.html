{% extends "base.html" %}

{% block title %}å¾…æ‰§è¡ŒPrompt - Time Management{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">å¾…æ‰§è¡ŒPrompt</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="prompts-container">
        <!-- Copyable Instruction -->
        <div class="copy-instruction-section">
            <div class="copy-instruction-box" id="instruction-box">
                <div class="instruction-content" onclick="copyInstruction()">
                    <span class="copy-icon">ğŸ“‹</span>
                    <span class="copy-text" id="instruction-text">è¯·æ‰§è¡Œ prompt-todo.json ä¸­çŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"çš„ prompt å‘½ä»¤ã€‚å®Œæˆæ‰§è¡Œåå°†å…¶çŠ¶æ€è®¾ç½®ä¸º"å·²æ‰§è¡Œ"ã€‚æ‰§è¡Œé¡ºåºå¯ç”±ä½ ç»¼åˆåˆ†æåå†³ç­–ã€‚</span>
                </div>
                <div class="instruction-actions">
                    <span class="copy-hint" onclick="copyInstruction()">ç‚¹å‡»å¤åˆ¶</span>
                    <span class="edit-hint" onclick="editInstruction(event)">ç¼–è¾‘</span>
                </div>
            </div>
        </div>

        <!-- Add New Prompt Todo -->
        <div class="prompt-input-section">
            <div class="prompt-input-header">
                <span class="input-title">æ·»åŠ å¾…æ‰§è¡ŒPrompt</span>
                <span class="auto-time" id="current-time"></span>
            </div>
            <textarea class="prompt-input" id="prompt-input" placeholder="è¾“å…¥å¾…æ‰§è¡Œçš„Promptå†…å®¹..." rows="3"></textarea>
            <div class="prompt-input-footer">
                <div class="auto-tags">
                    <span class="tags-label">æç¤ºï¼š</span>
                    <span class="tags-preview">æŒ‰ Ctrl+Enter å¿«é€Ÿæ·»åŠ </span>
                </div>
                <button class="btn-add-prompt" onclick="addPromptTodo()">æ·»åŠ </button>
            </div>
        </div>

        <!-- Prompt List Header with Stats -->
        <div class="prompt-list-header">
            <h3 class="prompt-list-title">Prompt åˆ—è¡¨</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="filterByStatus('all')">å…¨éƒ¨ <strong id="all-count">0</strong></button>
                <button class="filter-btn filter-pending" data-filter="å¾…ä¿®æ”¹" onclick="filterByStatus('å¾…ä¿®æ”¹')">å¾…ä¿®æ”¹ <strong id="pending-count">0</strong></button>
                <button class="filter-btn filter-ready" data-filter="å¾…æ‰§è¡Œ" onclick="filterByStatus('å¾…æ‰§è¡Œ')">å¾…æ‰§è¡Œ <strong id="todo-count">0</strong></button>
                <button class="filter-btn filter-running" data-filter="æ‰§è¡Œä¸­" onclick="filterByStatus('æ‰§è¡Œä¸­')">æ‰§è¡Œä¸­ <strong id="running-count">0</strong></button>
                <button class="filter-btn filter-done" data-filter="å·²æ‰§è¡Œ" onclick="filterByStatus('å·²æ‰§è¡Œ')">å·²æ‰§è¡Œ <strong id="done-count">0</strong></button>
            </div>
            <button class="btn-refresh" onclick="loadTodos()" title="åˆ·æ–°åˆ—è¡¨">ğŸ”„ åˆ·æ–°</button>
        </div>

        <!-- Prompt Todo List -->
        <div class="prompt-list" id="prompt-todo-list">
            <!-- Todos will be rendered here -->
        </div>
    </div>

    <script>
    var allTodos = [];
    var currentFilter = 'all';

    // Filter by status
    function filterByStatus(status) {
        currentFilter = status;
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.getAttribute('data-filter') === status) {
                btn.classList.add('active');
            }
        });
        renderTodos();
    }

    // Update current time display
    function updateCurrentTime() {
        var now = new Date();
        var y = now.getFullYear();
        var m = (now.getMonth() + 1).toString().padStart(2, '0');
        var d = now.getDate().toString().padStart(2, '0');
        var h = now.getHours().toString().padStart(2, '0');
        var min = now.getMinutes().toString().padStart(2, '0');
        var sec = now.getSeconds().toString().padStart(2, '0');
        document.getElementById('current-time').textContent = y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec;
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    function copyInstruction() {
        var text = document.getElementById('instruction-text').textContent;
        navigator.clipboard.writeText(text).then(function() {
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(function() {
            // Fallback for older browsers
            var textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
    }

    function editInstruction(event) {
        event.stopPropagation();
        var textSpan = document.getElementById('instruction-text');
        var currentText = textSpan.textContent;
        var box = document.getElementById('instruction-box');

        box.innerHTML = '<textarea id="instruction-edit" class="instruction-textarea">' + currentText + '</textarea>' +
            '<div class="instruction-edit-buttons">' +
                '<button class="btn-save-instruction" onclick="saveInstruction()">ä¿å­˜</button>' +
                '<button class="btn-cancel-instruction" onclick="cancelInstructionEdit()">å–æ¶ˆ</button>' +
            '</div>';

        document.getElementById('instruction-edit').focus();
    }

    function saveInstruction() {
        var textarea = document.getElementById('instruction-edit');
        var newText = textarea.value.trim();
        if (!newText) {
            showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        restoreInstructionBox(newText);
        showToast('å·²ä¿å­˜', 'success');
    }

    function cancelInstructionEdit() {
        var defaultText = 'è¯·æ‰§è¡Œ prompt-todo.json ä¸­çŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"çš„ prompt å‘½ä»¤ã€‚å®Œæˆæ‰§è¡Œåå°†å…¶çŠ¶æ€è®¾ç½®ä¸º"å·²æ‰§è¡Œ"ã€‚æ‰§è¡Œé¡ºåºå¯ç”±ä½ ç»¼åˆåˆ†æåå†³ç­–ã€‚';
        restoreInstructionBox(localStorage.getItem('instructionText') || defaultText);
    }

    function restoreInstructionBox(text) {
        localStorage.setItem('instructionText', text);
        var box = document.getElementById('instruction-box');
        box.innerHTML = '<div class="instruction-content" onclick="copyInstruction()">' +
                '<span class="copy-icon">ğŸ“‹</span>' +
                '<span class="copy-text" id="instruction-text">' + text + '</span>' +
            '</div>' +
            '<div class="instruction-actions">' +
                '<span class="copy-hint" onclick="copyInstruction()">ç‚¹å‡»å¤åˆ¶</span>' +
                '<span class="edit-hint" onclick="editInstruction(event)">ç¼–è¾‘</span>' +
            '</div>';
    }

    // Load saved instruction on page load
    (function() {
        var saved = localStorage.getItem('instructionText');
        if (saved) {
            document.getElementById('instruction-text').textContent = saved;
        }
    })();

    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    function loadTodos() {
        fetch('/api/prompt-todos')
            .then(response => response.json())
            .then(data => {
                allTodos = data.todos || [];
                var todoCount = allTodos.filter(function(t) { return t.status === 'å¾…æ‰§è¡Œ' || !t.status; }).length;
                var pendingCount = allTodos.filter(function(t) { return t.status === 'å¾…ä¿®æ”¹'; }).length;
                var runningCount = allTodos.filter(function(t) { return t.status === 'æ‰§è¡Œä¸­'; }).length;
                var doneCount = allTodos.filter(function(t) { return t.status === 'å·²æ‰§è¡Œ'; }).length;
                document.getElementById('all-count').textContent = allTodos.length;
                document.getElementById('todo-count').textContent = todoCount;
                document.getElementById('pending-count').textContent = pendingCount;
                document.getElementById('running-count').textContent = runningCount;
                document.getElementById('done-count').textContent = doneCount;
                renderTodos();
            });
    }

    function renderTodos() {
        var container = document.getElementById('prompt-todo-list');

        // Filter todos based on currentFilter
        var filteredTodos = allTodos;
        if (currentFilter !== 'all') {
            filteredTodos = allTodos.filter(function(t) {
                var status = t.status || 'å¾…æ‰§è¡Œ';
                return status === currentFilter;
            });
        }

        if (filteredTodos.length === 0) {
            var emptyMsg = currentFilter === 'all' ? 'æš‚æ— å¾…æ‰§è¡Œçš„Prompt' : 'æ²¡æœ‰ã€Œ' + currentFilter + 'ã€çŠ¶æ€çš„Prompt';
            container.innerHTML = '<div class="empty-prompts">' + emptyMsg + '</div>';
            return;
        }

        var html = '';
        filteredTodos.forEach(function(todo, index) {
            html += createTodoHtml(todo, index + 1);
        });
        container.innerHTML = html;
    }

    function createTodoHtml(todo, index) {
        var dateStr = formatDateTime(todo.created_at);
        var status = todo.status || 'å¾…æ‰§è¡Œ';

        var statuses = [
            { name: 'å¾…ä¿®æ”¹', class: 'status-pending' },
            { name: 'å¾…æ‰§è¡Œ', class: 'status-ready' },
            { name: 'æ‰§è¡Œä¸­', class: 'status-running' },
            { name: 'å·²æ‰§è¡Œ', class: 'status-done' }
        ];

        var statusButtonsHtml = '<div class="status-buttons">';
        statuses.forEach(function(s) {
            var isActive = s.name === status;
            statusButtonsHtml += '<button class="status-btn ' + s.class + (isActive ? ' active' : '') + '" onclick="setStatus(\'' + todo.id + '\', \'' + s.name + '\')">' + s.name + '</button>';
        });
        statusButtonsHtml += '</div>';

        var content = todo.content || '';
        var isLong = content.length > 150;
        var contentHtml = '';

        if (isLong) {
            contentHtml = '<div class="prompt-content collapsed" data-id="' + todo.id + '">' +
                '<div class="content-preview">' + escapeHtml(content.substring(0, 150)) + '...</div>' +
                '<div class="content-full" style="display:none;">' + escapeHtml(content) + '</div>' +
                '<span class="expand-btn" onclick="toggleContent(\'' + todo.id + '\')">å±•å¼€ â–¼</span>' +
            '</div>';
        } else {
            contentHtml = '<div class="prompt-content">' + escapeHtml(content) + '</div>';
        }

        return '<div class="prompt-item prompt-todo-item" data-id="' + todo.id + '">' +
            '<div class="prompt-header">' +
                '<span class="prompt-index">#' + index + '</span>' +
                statusButtonsHtml +
                '<span class="prompt-time">' + dateStr + '</span>' +
                '<div class="prompt-actions">' +
                    '<div class="action-btn" onclick="editTodo(\'' + todo.id + '\')">' +
                        '<span class="action-icon">âœï¸</span>' +
                        '<span class="action-label">ç¼–è¾‘</span>' +
                    '</div>' +
                    '<div class="action-btn' + (status === 'å·²æ‰§è¡Œ' ? ' action-ready' : '') + '" onclick="archiveTodo(\'' + todo.id + '\')">' +
                        '<span class="action-icon">ğŸ“¥</span>' +
                        '<span class="action-label">å½’æ¡£</span>' +
                    '</div>' +
                    '<div class="action-btn" onclick="copyPrompt(\'' + todo.id + '\')">' +
                        '<span class="action-icon">ğŸ“‹</span>' +
                        '<span class="action-label">å¤åˆ¶</span>' +
                    '</div>' +
                    '<div class="action-btn action-delete" onclick="deleteTodo(\'' + todo.id + '\')">' +
                        '<span class="action-icon">ğŸ—‘ï¸</span>' +
                        '<span class="action-label">åˆ é™¤</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            contentHtml +
        '</div>';
    }

    function toggleContent(id) {
        var contentDiv = document.querySelector('.prompt-content[data-id="' + id + '"]');
        if (!contentDiv) return;

        var preview = contentDiv.querySelector('.content-preview');
        var full = contentDiv.querySelector('.content-full');
        var btn = contentDiv.querySelector('.expand-btn');

        if (contentDiv.classList.contains('collapsed')) {
            preview.style.display = 'none';
            full.style.display = 'block';
            btn.textContent = 'æ”¶èµ· â–²';
            contentDiv.classList.remove('collapsed');
        } else {
            preview.style.display = 'block';
            full.style.display = 'none';
            btn.textContent = 'å±•å¼€ â–¼';
            contentDiv.classList.add('collapsed');
        }
    }

    function setStatus(id, newStatus) {
        fetch('/api/prompt-todos/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTodos();
                showToast('çŠ¶æ€å·²æ›´æ–°ä¸º: ' + newStatus, 'success');
            } else {
                showToast('æ›´æ–°å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function addPromptTodo() {
        var content = document.getElementById('prompt-input').value.trim();
        if (!content) {
            showToast('è¯·è¾“å…¥å†…å®¹', 'error');
            return;
        }

        fetch('/api/prompt-todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('prompt-input').value = '';
                loadTodos();
                showToast('æ·»åŠ æˆåŠŸ', 'success');
            } else {
                showToast('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function deleteTodo(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¾…æ‰§è¡ŒPromptå—ï¼Ÿ')) return;

        fetch('/api/prompt-todos/' + id, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTodos();
                showToast('å·²åˆ é™¤', 'success');
            } else {
                showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function archiveTodo(id) {
        var todo = allTodos.find(function(t) { return t.id === id; });
        if (!todo) return;

        var status = todo.status || 'å¾…æ‰§è¡Œ';
        if (status !== 'å·²æ‰§è¡Œ') {
            showToast('å½“å‰çŠ¶æ€ä¸º"' + status + '"ï¼Œè¯·å…ˆå°†çŠ¶æ€è®¾ä¸º"å·²æ‰§è¡Œ"åå†å½’æ¡£', 'error');
            return;
        }

        if (!confirm('ç¡®è®¤å°†æ­¤promptå½’æ¡£è‡³å†å²è®°å½•ï¼Ÿ')) return;

        // Auto-generate tags
        var tags = generateTags(todo.content);

        fetch('/api/prompt-todos/' + id + '/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tags: tags })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTodos();
                showToast('å·²å½’æ¡£è‡³å†å²è®°å½•', 'success');
            } else {
                showToast('æ“ä½œå¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function editTodo(id) {
        var todo = allTodos.find(function(t) { return t.id === id; });
        if (!todo) return;

        var item = document.querySelector('.prompt-item[data-id="' + id + '"]');
        if (!item) return;

        var contentDiv = item.querySelector('.prompt-content');
        var originalContent = todo.content;

        // Replace content div with textarea
        var textarea = document.createElement('textarea');
        textarea.className = 'prompt-edit-textarea';
        textarea.value = originalContent;
        textarea.rows = 4;

        var btnContainer = document.createElement('div');
        btnContainer.className = 'prompt-edit-buttons';
        btnContainer.innerHTML = '<button class="btn-save-edit" onclick="saveEdit(\'' + id + '\')">ä¿å­˜</button>' +
                                 '<button class="btn-cancel-edit" onclick="loadTodos()">å–æ¶ˆ</button>';

        contentDiv.innerHTML = '';
        contentDiv.appendChild(textarea);
        contentDiv.appendChild(btnContainer);
        textarea.focus();
    }

    function saveEdit(id) {
        var item = document.querySelector('.prompt-item[data-id="' + id + '"]');
        if (!item) return;

        var textarea = item.querySelector('.prompt-edit-textarea');
        if (!textarea) return;

        var newContent = textarea.value.trim();
        if (!newContent) {
            showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        fetch('/api/prompt-todos/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newContent })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTodos();
                showToast('å·²ä¿å­˜', 'success');
            } else {
                showToast('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
            }
        });
    }

    function copyPrompt(id) {
        var todo = allTodos.find(function(t) { return t.id === id; });
        if (!todo) return;

        navigator.clipboard.writeText(todo.content).then(function() {
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(function() {
            var textarea = document.createElement('textarea');
            textarea.value = todo.content;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
    }

    // Auto-generate tags based on content
    function generateTags(content) {
        if (!content || content.trim().length < 5) return [];

        var tags = [];
        var text = content.toLowerCase();

        var tagRules = [
            { keywords: ['bug', 'ä¿®å¤', 'fix', 'é”™è¯¯', 'error'], tag: 'é—®é¢˜ä¿®å¤' },
            { keywords: ['åŠŸèƒ½', 'feature', 'æ–°å¢', 'æ·»åŠ ', 'add'], tag: 'æ–°åŠŸèƒ½' },
            { keywords: ['ä¼˜åŒ–', 'æ”¹è¿›', 'improve', 'optimize', 'æ€§èƒ½'], tag: 'ä¼˜åŒ–' },
            { keywords: ['ui', 'ç•Œé¢', 'æ ·å¼', 'css', 'style', 'å¸ƒå±€'], tag: 'UIè®¾è®¡' },
            { keywords: ['api', 'æ¥å£', 'backend', 'åç«¯', 'æœåŠ¡'], tag: 'åç«¯' },
            { keywords: ['å‰ç«¯', 'frontend', 'js', 'javascript', 'html'], tag: 'å‰ç«¯' },
            { keywords: ['æ‹–æ‹½', 'drag', 'drop', 'äº¤äº’'], tag: 'äº¤äº’' },
            { keywords: ['åŠ¨ç”»', 'animation', 'åŠ¨æ•ˆ', 'è¿‡æ¸¡'], tag: 'åŠ¨ç”»' },
            { keywords: ['é…ç½®', 'config', 'è®¾ç½®', 'setting'], tag: 'é…ç½®' },
            { keywords: ['æµ‹è¯•', 'test', 'è°ƒè¯•', 'debug'], tag: 'æµ‹è¯•' },
            { keywords: ['todo', 'ä»»åŠ¡', 'task', 'å¾…åŠ'], tag: 'Todo' },
            { keywords: ['prompt', 'æ—¥å¿—', 'log'], tag: 'Prompt' },
            { keywords: ['æ•°æ®', 'data', 'å­˜å‚¨', 'save', 'ä¿å­˜'], tag: 'æ•°æ®' }
        ];

        tagRules.forEach(function(rule) {
            for (var i = 0; i < rule.keywords.length; i++) {
                if (text.indexOf(rule.keywords[i]) !== -1) {
                    if (tags.indexOf(rule.tag) === -1) {
                        tags.push(rule.tag);
                    }
                    break;
                }
            }
        });

        return tags.slice(0, 3);
    }

    // Enter key to submit
    document.getElementById('prompt-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            addPromptTodo();
        }
    });

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/\n/g, '<br>');
    }

    function formatDateTime(isoString) {
        var date = new Date(isoString);
        var y = date.getFullYear();
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return y + '-' + m + '-' + d + ' ' + h + ':' + min;
    }

    function showToast(message, type) {
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(function() {
            toast.classList.add('toast-hide');
            setTimeout(function() {
                toast.remove();
            }, 300);
        }, 2000);
    }

    // Initialize
    loadTodos();
    </script>
{% endblock %}
