{% extends "mobile/base.html" %}

{% block title %}Promptå†å² - Boris Life{% endblock %}
{% block page_title %}Promptå†å²è®°å½•{% endblock %}

{% block header_actions %}
<button class="header-btn" onclick="loadPrompts()">ğŸ”„</button>
{% endblock %}

{% block content %}
<div class="toast-container" id="toast-container"></div>

<!-- Stats -->
<div class="stats-bar">
    å…± <strong id="prompt-count">0</strong> æ¡è®°å½•
</div>

<!-- Prompt List -->
<div id="prompt-list">
    <!-- Prompts rendered here -->
</div>

<style>
.stats-bar {
    padding: 10px 16px;
    background: rgba(255,255,255,0.8);
    border-radius: 10px;
    margin-bottom: 12px;
    font-size: 0.85rem;
    color: var(--text-muted);
}

.stats-bar strong {
    color: var(--primary-color);
}

.prompt-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 10px;
}

.prompt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.prompt-index {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 600;
}

.prompt-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.prompt-content {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-primary);
    word-break: break-word;
}

.prompt-content.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.prompt-expand {
    color: var(--primary-color);
    font-size: 0.8rem;
    margin-top: 8px;
    cursor: pointer;
}

.prompt-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
}

.prompt-tag {
    padding: 3px 8px;
    background: rgba(102,126,234,0.1);
    color: var(--primary-color);
    border-radius: 10px;
    font-size: 0.7rem;
}

.prompt-actions {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid rgba(0,0,0,0.05);
}

.prompt-action {
    font-size: 0.85rem;
    color: var(--text-muted);
    cursor: pointer;
}

.mobile-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}
</style>

<script>
var allPrompts = [];

function loadPrompts() {
    fetch('/api/prompts')
        .then(r => r.json())
        .then(data => {
            allPrompts = data.prompts || [];
            document.getElementById('prompt-count').textContent = allPrompts.length;
            renderPrompts();
        });
}

function renderPrompts() {
    var container = document.getElementById('prompt-list');

    if (allPrompts.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— å†å²è®°å½•</div>';
        return;
    }

    var html = '';
    allPrompts.forEach(function(prompt, index) {
        html += createPromptHtml(prompt, allPrompts.length - index);
    });
    container.innerHTML = html;
}

function createPromptHtml(prompt, index) {
    var content = prompt.content || '';
    var isLong = content.length > 100;
    var dateStr = formatDateTime(prompt.created_at);

    var tagsHtml = '';
    if (prompt.tags && prompt.tags.length > 0) {
        tagsHtml = '<div class="prompt-tags">';
        prompt.tags.forEach(function(tag) {
            tagsHtml += '<span class="prompt-tag">' + escapeHtml(tag) + '</span>';
        });
        tagsHtml += '</div>';
    }

    var contentHtml = '<div class="prompt-content' + (isLong ? ' collapsed' : '') + '" id="content-' + prompt.id + '">' + escapeHtml(content) + '</div>';
    if (isLong) {
        contentHtml += '<div class="prompt-expand" onclick="toggleContent(\'' + prompt.id + '\')">å±•å¼€æ›´å¤š</div>';
    }

    return '<div class="prompt-card">' +
        '<div class="prompt-header">' +
            '<span class="prompt-index">#' + index + '</span>' +
            '<span class="prompt-time">' + dateStr + '</span>' +
        '</div>' +
        contentHtml +
        tagsHtml +
        '<div class="prompt-actions">' +
            '<span class="prompt-action" onclick="copyPrompt(\'' + prompt.id + '\')">ğŸ“‹ å¤åˆ¶</span>' +
            '<span class="prompt-action" onclick="copyToTodo(\'' + prompt.id + '\')">ğŸ“¤ åˆ°å¾…æ‰§è¡Œ</span>' +
        '</div>' +
    '</div>';
}

function toggleContent(id) {
    var content = document.getElementById('content-' + id);
    var expand = content.nextElementSibling;
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        expand.textContent = 'æ”¶èµ·';
    } else {
        content.classList.add('collapsed');
        expand.textContent = 'å±•å¼€æ›´å¤š';
    }
}

function copyPrompt(id) {
    var prompt = allPrompts.find(p => p.id === id);
    if (!prompt) return;
    navigator.clipboard.writeText(prompt.content).then(function() {
        showToast('å·²å¤åˆ¶', 'success');
    });
}

function copyToTodo(id) {
    var prompt = allPrompts.find(p => p.id === id);
    if (!prompt) return;

    fetch('/api/prompt-todos', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: prompt.content, status: 'å¾…ä¿®æ”¹'})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showToast('å·²æ·»åŠ åˆ°å¾…æ‰§è¡Œ', 'success');
        }
    });
}

function formatDateTime(isoString) {
    var date = new Date(isoString);
    var m = (date.getMonth() + 1).toString().padStart(2, '0');
    var d = date.getDate().toString().padStart(2, '0');
    var h = date.getHours().toString().padStart(2, '0');
    var min = date.getMinutes().toString().padStart(2, '0');
    return m + '-' + d + ' ' + h + ':' + min;
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
}

function showToast(msg, type) {
    AppUtils.showToast(msg, type, 'toast-container');
}

window.refreshContent = loadPrompts;
loadPrompts();
</script>
{% endblock %}
