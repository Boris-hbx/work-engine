{% extends "mobile/base.html" %}

{% block title %}å¾…æ‰§è¡ŒPrompt - Boris Life{% endblock %}

{% block page_title %}å¾…æ‰§è¡ŒPrompt{% endblock %}

{% block header_actions %}
<button class="header-btn" onclick="loadTodos()" title="åˆ·æ–°">ğŸ”„</button>
{% endblock %}

{% block content %}
<div class="toast-container" id="toast-container"></div>

<!-- Filter Tabs -->
<div class="mobile-filter-tabs">
    <button class="filter-tab active" data-filter="all" onclick="filterByStatus('all')">
        å…¨éƒ¨ <span id="all-count">0</span>
    </button>
    <button class="filter-tab filter-pending" data-filter="å¾…ä¿®æ”¹" onclick="filterByStatus('å¾…ä¿®æ”¹')">
        å¾…ä¿®æ”¹ <span id="pending-count">0</span>
    </button>
    <button class="filter-tab filter-ready" data-filter="å¾…æ‰§è¡Œ" onclick="filterByStatus('å¾…æ‰§è¡Œ')">
        å¾…æ‰§è¡Œ <span id="todo-count">0</span>
    </button>
    <button class="filter-tab filter-running" data-filter="æ‰§è¡Œä¸­" onclick="filterByStatus('æ‰§è¡Œä¸­')">
        æ‰§è¡Œä¸­ <span id="running-count">0</span>
    </button>
    <button class="filter-tab filter-done" data-filter="å·²æ‰§è¡Œ" onclick="filterByStatus('å·²æ‰§è¡Œ')">
        å·²æ‰§è¡Œ <span id="done-count">0</span>
    </button>
</div>

<!-- Prompt List -->
<div class="mobile-section">
    <div id="prompt-todo-list">
        <!-- Todos will be rendered here -->
    </div>
</div>

<!-- Add FAB -->
<button class="mobile-fab" onclick="showAddModal()">+</button>

<!-- Add Modal -->
<div class="mobile-modal" id="add-modal" style="display:none;">
    <div class="mobile-modal-overlay" onclick="hideAddModal()"></div>
    <div class="mobile-modal-content">
        <div class="mobile-modal-header">
            <h3>æ·»åŠ å¾…æ‰§è¡ŒPrompt</h3>
            <button class="mobile-modal-close" onclick="hideAddModal()">Ã—</button>
        </div>
        <div class="mobile-modal-body">
            <textarea class="mobile-input mobile-textarea" id="prompt-input" placeholder="è¾“å…¥å¾…æ‰§è¡Œçš„Promptå†…å®¹..." rows="4"></textarea>
        </div>
        <div class="mobile-modal-footer">
            <button class="mobile-btn mobile-btn-primary" onclick="addPromptTodo()">æ·»åŠ </button>
        </div>
    </div>
</div>

<style>
/* Mobile Filter Tabs */
.mobile-filter-tabs {
    display: flex;
    gap: 8px;
    padding: 0 0 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.filter-tab {
    flex-shrink: 0;
    padding: 8px 14px;
    border: none;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.8);
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-tab.active {
    background: var(--primary-color);
    color: white;
}

.filter-tab.filter-pending.active {
    background: var(--warning-color);
}

.filter-tab.filter-running.active {
    background: #9b59b6;
}

.filter-tab.filter-done.active {
    background: var(--success-color);
}

.filter-tab span {
    margin-left: 4px;
    opacity: 0.8;
}

/* Prompt Card */
.prompt-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.prompt-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.prompt-card-index {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 600;
}

.prompt-card-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.prompt-card-content {
    font-size: 0.95rem;
    color: var(--text-primary);
    line-height: 1.6;
    margin-bottom: 12px;
    word-break: break-word;
}

.prompt-card-content.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.prompt-card-expand {
    color: var(--primary-color);
    font-size: 0.85rem;
    cursor: pointer;
    margin-bottom: 12px;
}

.prompt-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.status-pills {
    display: flex;
    gap: 6px;
}

.status-pill {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    opacity: 0.4;
    background: rgba(128, 128, 128, 0.1);
    color: #888;
    transition: all 0.2s;
}

.status-pill.active {
    opacity: 1;
}

.status-pill.status-pending.active {
    background: rgba(230, 126, 34, 0.15);
    color: var(--warning-color);
}

.status-pill.status-ready.active {
    background: rgba(102, 126, 234, 0.15);
    color: var(--primary-color);
}

.status-pill.status-done.active {
    background: rgba(39, 174, 96, 0.15);
    color: var(--success-color);
}

.status-pill.status-running.active {
    background: rgba(155, 89, 182, 0.15);
    color: #9b59b6;
}

.action-icons {
    display: flex;
    gap: 12px;
}

.action-icon {
    font-size: 1.1rem;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.action-icon:active {
    opacity: 1;
}

/* Mobile Modal */
.mobile-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: flex-end;
}

.mobile-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
}

.mobile-modal-content {
    position: relative;
    width: 100%;
    background: white;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    animation: slideUp 0.3s ease;
}

.mobile-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.mobile-modal-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
}

.mobile-modal-close {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.05);
    font-size: 1.2rem;
    cursor: pointer;
}

.mobile-modal-body {
    margin-bottom: 16px;
}

.mobile-modal-footer {
    display: flex;
    gap: 12px;
}

/* Empty State */
.mobile-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.mobile-empty-icon {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.3;
}
</style>

<script>
var allTodos = [];
var currentFilter = 'all';

function filterByStatus(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-tab').forEach(function(tab) {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
            tab.classList.add('active');
        }
    });
    renderTodos();
}

function loadTodos() {
    fetch('/api/prompt-todos')
        .then(response => response.json())
        .then(data => {
            allTodos = data.todos || [];
            var todoCount = allTodos.filter(t => t.status === 'å¾…æ‰§è¡Œ' || !t.status).length;
            var pendingCount = allTodos.filter(t => t.status === 'å¾…ä¿®æ”¹').length;
            var runningCount = allTodos.filter(t => t.status === 'æ‰§è¡Œä¸­').length;
            var doneCount = allTodos.filter(t => t.status === 'å·²æ‰§è¡Œ').length;
            document.getElementById('all-count').textContent = allTodos.length;
            document.getElementById('todo-count').textContent = todoCount;
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('running-count').textContent = runningCount;
            document.getElementById('done-count').textContent = doneCount;
            renderTodos();
        });
}

function renderTodos() {
    var container = document.getElementById('prompt-todo-list');
    var filteredTodos = allTodos;

    if (currentFilter !== 'all') {
        filteredTodos = allTodos.filter(function(t) {
            var status = t.status || 'å¾…æ‰§è¡Œ';
            return status === currentFilter;
        });
    }

    if (filteredTodos.length === 0) {
        container.innerHTML = '<div class="mobile-empty"><div class="mobile-empty-icon">ğŸ“‹</div><div>æš‚æ— ' + (currentFilter === 'all' ? '' : currentFilter) + 'Prompt</div></div>';
        return;
    }

    var html = '';
    filteredTodos.forEach(function(todo, index) {
        html += createTodoHtml(todo, index + 1);
    });
    container.innerHTML = html;
}

function createTodoHtml(todo, index) {
    var status = todo.status || 'å¾…æ‰§è¡Œ';
    var content = todo.content || '';
    var isLong = content.length > 100;
    var dateStr = formatDateTime(todo.created_at);

    var statuses = [
        { name: 'å¾…ä¿®æ”¹', class: 'status-pending' },
        { name: 'å¾…æ‰§è¡Œ', class: 'status-ready' },
        { name: 'æ‰§è¡Œä¸­', class: 'status-running' },
        { name: 'å·²æ‰§è¡Œ', class: 'status-done' }
    ];

    var statusHtml = '<div class="status-pills">';
    statuses.forEach(function(s) {
        var isActive = s.name === status;
        statusHtml += '<button class="status-pill ' + s.class + (isActive ? ' active' : '') + '" onclick="setStatus(\'' + todo.id + '\', \'' + s.name + '\')">' + s.name + '</button>';
    });
    statusHtml += '</div>';

    var contentHtml = '<div class="prompt-card-content' + (isLong ? ' collapsed' : '') + '" id="content-' + todo.id + '">' + escapeHtml(content) + '</div>';
    if (isLong) {
        contentHtml += '<div class="prompt-card-expand" onclick="toggleContent(\'' + todo.id + '\')">å±•å¼€æ›´å¤š</div>';
    }

    return '<div class="prompt-card">' +
        '<div class="prompt-card-header">' +
            '<span class="prompt-card-index">#' + index + '</span>' +
            '<span class="prompt-card-time">' + dateStr + '</span>' +
        '</div>' +
        contentHtml +
        '<div class="prompt-card-footer">' +
            statusHtml +
            '<div class="action-icons">' +
                '<span class="action-icon" onclick="copyPrompt(\'' + todo.id + '\')">ğŸ“‹</span>' +
                '<span class="action-icon" onclick="deleteTodo(\'' + todo.id + '\')">ğŸ—‘ï¸</span>' +
            '</div>' +
        '</div>' +
    '</div>';
}

function toggleContent(id) {
    var content = document.getElementById('content-' + id);
    var expand = content.nextElementSibling;
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        expand.textContent = 'æ”¶èµ·';
    } else {
        content.classList.add('collapsed');
        expand.textContent = 'å±•å¼€æ›´å¤š';
    }
}

function setStatus(id, newStatus) {
    fetch('/api/prompt-todos/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadTodos();
            showToast('çŠ¶æ€å·²æ›´æ–°', 'success');
        }
    });
}

function showAddModal() {
    document.getElementById('add-modal').style.display = 'flex';
}

function hideAddModal() {
    document.getElementById('add-modal').style.display = 'none';
    document.getElementById('prompt-input').value = '';
}

function addPromptTodo() {
    var content = document.getElementById('prompt-input').value.trim();
    if (!content) {
        showToast('è¯·è¾“å…¥å†…å®¹', 'error');
        return;
    }

    fetch('/api/prompt-todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideAddModal();
            loadTodos();
            showToast('æ·»åŠ æˆåŠŸ', 'success');
        }
    });
}

function copyPrompt(id) {
    var todo = allTodos.find(t => t.id === id);
    if (!todo) return;
    navigator.clipboard.writeText(todo.content).then(function() {
        showToast('å·²å¤åˆ¶', 'success');
    });
}

function deleteTodo(id) {
    window.AppUtils.showConfirm('ç¡®å®šåˆ é™¤ï¼Ÿ', function() {
        fetch('/api/prompt-todos/' + id, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTodos();
                    showToast('å·²åˆ é™¤', 'success');
                }
            });
    }, { confirmText: 'åˆ é™¤', danger: true });
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/\n/g, '<br>');
}

function formatDateTime(isoString) {
    var date = new Date(isoString);
    var m = (date.getMonth() + 1).toString().padStart(2, '0');
    var d = date.getDate().toString().padStart(2, '0');
    var h = date.getHours().toString().padStart(2, '0');
    var min = date.getMinutes().toString().padStart(2, '0');
    return m + '-' + d + ' ' + h + ':' + min;
}

function showToast(message, type) {
    AppUtils.showToast(message, type, 'toast-container');
}

// Refresh function for pull-to-refresh
window.refreshContent = loadTodos;

// Initialize
loadTodos();
</script>
{% endblock %}
