<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff6b6b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Boris Life">
    <title>{% block title %}Boris Life{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æç¤ºæ¡ - ä¾§è¾¹æ æ”¶èµ·æ—¶æ˜¾ç¤º -->
        <div class="sidebar-hint" id="sidebar-hint">
            <div class="hint-glow"></div>
        </div>

        <!-- å°å® ç‰© - å§‹ç»ˆå¯è§ -->
        <div class="pet" id="pet">
            <div class="pet-eye"></div>
            <div class="pet-eye"></div>
            <div class="pet-eye"></div>
        </div>

        <!-- Left Sidebar -->
        <nav class="sidebar" id="sidebar">
            <!-- å¤´åƒåŒºåŸŸ -->
            <div class="sidebar-profile">
                <div class="avatar-wrapper">
                    <img src="{{ url_for('static', filename='images/avatar.jpg') }}" alt="Boris" class="avatar" width="60" height="60" loading="eager">
                </div>
                <span class="profile-name">æ— ä¸ä¼¦æ¯”çš„Boris</span>
            </div>

            <div class="nav-links">
                <a href="{{ url_for('todo') }}" class="nav-link {% if current_page == 'todo' %}active{% endif %}">Todo</a>
                <a href="{{ url_for('motivation') }}" class="nav-link {% if current_page == 'motivation' %}active{% endif %}">æ¿€åŠ±è‡ªå·±</a>
                <a href="{{ url_for('bubble') }}" class="nav-link {% if current_page == 'bubble' %}active{% endif %}">æ°”æ³¡å›¾å·¥å…·</a>
                <a href="{{ url_for('aichat') }}" class="nav-link ai-link {% if current_page == 'aichat' %}active{% endif %}">
                    <span class="ai-glow"></span>
                    æ™ºè„‘ä¸­æ¢
                </a>
            </div>

            <!-- åº•éƒ¨åŒºåŸŸï¼špromptæ—¥å¿— + æ—¶åŒº -->
            <div class="sidebar-bottom">
                <a href="{{ url_for('prompts') }}" class="prompt-log-link {% if current_page == 'prompts' %}active{% endif %}">
                    <span class="prompt-icon">ğŸ“</span>
                    <span>å¼€å‘promptæ—¥å¿—</span>
                </a>
                <div class="sidebar-divider"></div>
            </div>

            <!-- æ—¶åŒºæ˜¾ç¤º - ä¾§è¾¹æ åº•éƒ¨ -->
            <div class="timezone-panel" id="timezone-panel">
                <div class="timezone-item">
                    <span class="tz-city">åŒ—äº¬</span>
                    <div class="tz-info">
                        <span class="tz-datetime" id="tz-beijing-date"></span>
                        <span class="tz-time" id="tz-beijing-time"></span>
                    </div>
                </div>
                <div class="timezone-item">
                    <span class="tz-city">æ»‘é“å¢</span>
                    <div class="tz-info">
                        <span class="tz-datetime" id="tz-waterloo-date"></span>
                        <span class="tz-time" id="tz-waterloo-time"></span>
                    </div>
                </div>
                <div class="timezone-item">
                    <span class="tz-city">æ¸©å“¥å</span>
                    <div class="tz-info">
                        <span class="tz-datetime" id="tz-vancouver-date"></span>
                        <span class="tz-time" id="tz-vancouver-time"></span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Right Main Content -->
        <main class="main-content" id="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
    (function() {
        var sidebar = document.getElementById('sidebar');
        var mainContent = document.getElementById('main-content');
        var pet = document.getElementById('pet');
        var navLinks = document.querySelector('.nav-links');
        var sidebarHint = document.getElementById('sidebar-hint');

        var isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

        // å°å® ç‰©çŠ¶æ€
        var targetY = window.innerHeight / 2;
        var currentY = targetY;
        var petHeight = 80;
        var sidebarWidth = 220;
        var isFollowing = false;
        var returnTimer = null;
        var isReturning = false;

        // å‚æ•°
        var closeDistance = 20;
        var rushEasing = 0.3;      // å†²åˆºæ—¶æ¯å¸§ç§»åŠ¨30%çš„å‰©ä½™è·ç¦»
        var gentleEasing = 0.1;    // é è¿‘æ—¶æ¯å¸§ç§»åŠ¨10%çš„å‰©ä½™è·ç¦»

        // è·å–éœ€è¦é¿è®©çš„åŒºåŸŸï¼ˆå¯¼èˆªæŒ‰é’®åŒºåŸŸï¼‰
        function getAvoidZones() {
            var zones = [];
            if (navLinks && !isCollapsed) {
                var rect = navLinks.getBoundingClientRect();
                zones.push({ top: rect.top - 10, bottom: rect.bottom + 10 });
            }
            return zones;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨é¿è®©åŒºåŸŸ
        function isInAvoidZone(y) {
            var zones = getAvoidZones();
            var petTop = y - petHeight / 2;
            var petBottom = y + petHeight / 2;
            for (var i = 0; i < zones.length; i++) {
                if (petBottom > zones[i].top && petTop < zones[i].bottom) {
                    return true;
                }
            }
            return false;
        }

        function collapseSidebar() {
            isCollapsed = true;
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
            pet.classList.add('at-edge');
            pet.classList.remove('at-sidebar');
            pet.classList.remove('slim');
            sidebarHint.classList.add('visible');
            localStorage.setItem('sidebarCollapsed', 'true');
        }

        function expandSidebar() {
            isCollapsed = false;
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('expanded');
            pet.classList.remove('at-edge');
            pet.classList.add('at-sidebar');
            sidebarHint.classList.remove('visible');
            localStorage.setItem('sidebarCollapsed', 'false');
        }

        // åˆå§‹åŒ–
        if (isCollapsed) {
            collapseSidebar();
        } else {
            pet.classList.add('at-sidebar');
        }

        pet.addEventListener('click', function() {
            if (isCollapsed) {
                expandSidebar();
            } else {
                collapseSidebar();
            }
        });

        // é¼ æ ‡è·Ÿè¸ª
        document.addEventListener('mousemove', function(e) {
            var petX = isCollapsed ? 0 : sidebarWidth;
            var activeZone = petX + 100;

            if (e.clientX < activeZone) {
                isFollowing = true;
                isReturning = false;
                targetY = e.clientY;
                pet.classList.add('active');

                if (returnTimer) {
                    clearTimeout(returnTimer);
                    returnTimer = null;
                }
            } else if (isFollowing) {
                isFollowing = false;
                pet.classList.remove('active');
                pet.classList.remove('excited');

                returnTimer = setTimeout(function() {
                    isReturning = true;
                    targetY = window.innerHeight / 2;
                }, 600);
            }
        });

        // åŠ¨ç”»å¾ªç¯
        function animatePet() {
            var distance = targetY - currentY;
            var absDistance = Math.abs(distance);
            var moveAmount = 0;

            if (isFollowing) {
                if (absDistance > closeDistance) {
                    // ç–¯ç‹‚å†²åˆºï¼šæ¯å¸§ç§»åŠ¨30%çš„å‰©ä½™è·ç¦»ï¼Œæé€Ÿå“åº”
                    moveAmount = distance * rushEasing;
                    pet.classList.add('excited');
                } else {
                    // æ¸©æŸ”é è¿‘ï¼šæ¯å¸§ç§»åŠ¨10%çš„å‰©ä½™è·ç¦»
                    moveAmount = distance * gentleEasing;
                    pet.classList.remove('excited');
                }
            } else if (isReturning) {
                // è¿”å›ä¸­å¿ƒï¼šç¼“æ…¢ç§»åŠ¨
                moveAmount = distance * 0.04;
                pet.classList.remove('excited');
            }

            currentY += moveAmount;

            // è¾¹ç•Œ
            var minY = petHeight / 2 + 20;
            var maxY = window.innerHeight - petHeight / 2 - 20;
            currentY = Math.max(minY, Math.min(maxY, currentY));

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç˜¦èº«é¿è®©
            if (isInAvoidZone(currentY)) {
                pet.classList.add('slim');
            } else {
                pet.classList.remove('slim');
            }

            pet.style.top = currentY + 'px';
            requestAnimationFrame(animatePet);
        }

        animatePet();

        window.addEventListener('resize', function() {
            if (!isFollowing) {
                targetY = window.innerHeight / 2;
            }
        });
    })();

    // TabæŒ‰é’®å‘¼å¸æ•ˆæœ
    (function() {
        var tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(function(btn) {
            btn.addEventListener('mouseenter', function() {
                btn.classList.remove('fade-out');
                btn.classList.add('breathing');
            });
            btn.addEventListener('mouseleave', function() {
                btn.classList.remove('breathing');
                btn.classList.add('fade-out');
                setTimeout(function() {
                    btn.classList.remove('fade-out');
                }, 2000);
            });
        });
    })();

    // æ—¶åŒºæ›´æ–°
    (function() {
        var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        function formatTz(date) {
            var m = date.getMonth() + 1;
            var d = date.getDate();
            var w = weekdays[date.getDay()];
            var h = date.getHours().toString().padStart(2, '0');
            var min = date.getMinutes().toString().padStart(2, '0');
            return {
                date: m + '/' + d + ' å‘¨' + w,
                time: h + ':' + min
            };
        }

        function updateTimezones() {
            var now = new Date();

            // åŒ—äº¬æ—¶é—´
            var beijing = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            var bjFmt = formatTz(beijing);
            document.getElementById('tz-beijing-date').textContent = bjFmt.date;
            document.getElementById('tz-beijing-time').textContent = bjFmt.time;

            // æ»‘é“å¢æ—¶é—´
            var waterloo = new Date(now.toLocaleString('en-US', { timeZone: 'America/Toronto' }));
            var wtFmt = formatTz(waterloo);
            document.getElementById('tz-waterloo-date').textContent = wtFmt.date;
            document.getElementById('tz-waterloo-time').textContent = wtFmt.time;

            // æ¸©å“¥åæ—¶é—´
            var vancouver = new Date(now.toLocaleString('en-US', { timeZone: 'America/Vancouver' }));
            var vcFmt = formatTz(vancouver);
            document.getElementById('tz-vancouver-date').textContent = vcFmt.date;
            document.getElementById('tz-vancouver-time').textContent = vcFmt.time;
        }

        updateTimezones();
        setInterval(updateTimezones, 1000);
    })();

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(function(reg) {
                console.log('Service Worker registered:', reg.scope);
            })
            .catch(function(err) {
                console.log('Service Worker registration failed:', err);
            });
    }
    </script>
</body>
</html>
