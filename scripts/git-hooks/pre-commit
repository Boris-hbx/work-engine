#!/bin/bash
# ==============================================================================
# Pre-commit Hook: 防止敏感数据被提交
# ==============================================================================

# 敏感文件/目录模式列表
SENSITIVE_PATTERNS=(
    "private-data/"
    "config/"
    "*.env"
    "*credentials*"
    "*secret*"
    "*password*"
    "*.pem"
    "*.key"
)

# 敏感数据文件列表（在 data/ 目录下）
SENSITIVE_DATA_FILES=(
    "data/todolist.txt"
    "data/todos.json"
    "data/motivation.txt"
    "data/prompts.json"
    "data/bubbles.json"
    "data/prompt-todo.json"
    "data/config.json"
)

# 颜色定义
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${GREEN}[Pre-commit Hook]${NC} 检查敏感文件..."

# 获取已暂存的文件列表
STAGED_FILES=$(git diff --cached --name-only)

BLOCKED=0

# 检查敏感模式
for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    matches=$(echo "$STAGED_FILES" | grep -E "$pattern" 2>/dev/null)
    if [ -n "$matches" ]; then
        echo -e "${RED}[BLOCKED]${NC} 检测到敏感文件模式: $pattern"
        echo "$matches" | while read file; do
            echo -e "  - $file"
        done
        BLOCKED=1
    fi
done

# 检查具体的敏感数据文件
for file in "${SENSITIVE_DATA_FILES[@]}"; do
    if echo "$STAGED_FILES" | grep -q "^$file$"; then
        echo -e "${RED}[BLOCKED]${NC} 检测到敏感数据文件: $file"
        BLOCKED=1
    fi
done

# 检查是否有包含 API key、token 等关键词的内容
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # 检查文件内容是否包含敏感关键词
        if git diff --cached "$file" 2>/dev/null | grep -iE "(api_key|apikey|secret_key|password|token|credential)" > /dev/null 2>&1; then
            echo -e "${YELLOW}[WARNING]${NC} 文件可能包含敏感信息: $file"
            echo -e "  请确认是否真的要提交此文件"
        fi
    fi
done

if [ $BLOCKED -eq 1 ]; then
    echo ""
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}  提交已阻止：检测到敏感文件${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo -e "如果你确定要提交这些文件，请使用:"
    echo -e "  ${YELLOW}git commit --no-verify${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}[Pre-commit Hook]${NC} 检查通过！"
exit 0
