# TRC攻防大师 1.0 - 游戏设计文档
## TRC Attack & Defense Master 1.0

## 1. 游戏概述

### 1.1 游戏名称
- **中文名**: TRC攻防大师 1.0
- **英文名**: TRC Attack & Defense Master 1.0

### 1.2 游戏背景
《TRC攻防大师》是一款单人网页塔防游戏，玩家需要通过放置不同类型的防御塔来阻止敌人入侵基地。游戏以消灭 Bug 为主题，寓意团队协作消除问题，守护产品质量。

### 1.3 核心玩法
- 玩家在地图上放置防御塔
- 敌人沿固定路径向基地移动
- 防御塔自动攻击范围内的敌人
- 生存10波敌人进攻即为胜利

### 1.4 技术选型
- **渲染引擎**: HTML5 Canvas (原生JS)
- **无外部依赖**: 纯 Vanilla JavaScript
- **模块化设计**: 便于扩展和维护

---

## 2. 游戏元素

### 2.1 防御塔类型

| 塔类型 | 图标 | 费用 | 射程 | 伤害 | 攻速 | 特殊效果 |
|--------|------|------|------|------|------|----------|
| 基础塔 | 🔫 | 50 | 100 | 10 | 60帧 | 无 |
| 冰冻塔 | ❄️ | 75 | 80 | 5 | 90帧 | 减速50%，持续120帧 |
| 溅射塔 | 💥 | 100 | 90 | 8 | 80帧 | 40像素范围溅射 |
| 狙击塔 | 🎯 | 150 | 180 | 40 | 150帧 | 超远射程 |

### 2.2 敌人类型

| 敌人类型 | 标签 | 生命值 | 速度 | 击杀奖励 | 出现波次 |
|----------|------|--------|------|----------|----------|
| 基础Bug | Bug | 30 | 1 | 10 | 第1波起 |
| 快速Bug | 快Bug | 20 | 2 | 15 | 第3波起 |
| 强化Bug | 坦克 | 100 | 0.5 | 30 | 第5波起 |
| Boss | Boss | 300 | 0.3 | 100 | 第10波 |

### 2.3 波次配置

```
波次 N: 敌人数量 = 3 + N × 2
- 第1波: 5个基础Bug
- 第3波起: 30%概率出现快速Bug
- 第5波起: 20%概率出现强化Bug
- 第10波: 最后一个敌人为Boss
```

---

## 3. 游戏机制

### 3.1 经济系统
- 初始金币: 100
- 击杀敌人获得金币奖励
- 放置防御塔消耗金币

### 3.2 生命值系统
- 初始生命: 10
- 敌人到达基地: 生命值 -1
- 生命值归零: 游戏失败

### 3.3 路径系统
敌人沿以下路径点移动:
```
入口(0,200) → (150,200) → (150,350) → (400,350) → (400,100) → (600,100) → (600,400) → 基地(700,400)
```

---

## 4. UI 布局

```
┌──────────────────────────────────────────────────────┐
│  💰 金币: 100  ❤️ 生命: 10  🌊 波次: 0/10  💀 击杀: 0  │
│  [开始波次] [调试模式] [重新开始]                      │
├────────┬─────────────────────────────────────────────┤
│ 选择塔  │                                             │
│ ┌────┐ │           游戏画布 (700×500)                 │
│ │🔫  │ │                                             │
│ │基础│ │     ┌入口┐                                  │
│ │💰50│ │     │    └──────┐                           │
│ ├────┤ │     │           │                           │
│ │❄️  │ │     └───────────┼──────┐                    │
│ │冰冻│ │                 │      │                    │
│ │💰75│ │                 └──────┼────┐               │
│ ├────┤ │                        │    └──────┐基地┐   │
│ │💥  │ │                        └───────────┴────┘   │
│ │溅射│ │                                             │
│ │💰100│ │                                             │
│ ├────┤ │                                             │
│ │🎯  │ │                                             │
│ │狙击│ │                                             │
│ │💰150│ │                                             │
│ └────┘ │                                             │
├────────┴─────────────────────────────────────────────┤
│                     游戏状态提示                       │
└──────────────────────────────────────────────────────┘
```

---

## 5. 操作逻辑

### 5.1 PC端操作
1. 点击左侧防御塔选项选择塔类型
2. 点击游戏画布空白区域放置防御塔
3. 点击"开始波次"按钮启动敌人进攻

### 5.2 移动端操作
1. 触摸左侧防御塔选项选择塔类型
2. 触摸游戏画布空白区域放置防御塔
3. 触摸"开始波次"按钮启动敌人进攻

---

## 6. 扩展接口

### 6.1 团队元素接口

#### 防御塔绑定
```javascript
TOWER_TYPES.basic.teamLabel = "张三";
TOWER_TYPES.basic.teamAvatar = "/images/avatar1.png";
TOWER_TYPES.basic.teamLogo = "/images/logo.png";
```

#### 敌人绑定
```javascript
ENEMY_TYPES.basic.label = "需求变更";
ENEMY_TYPES.fast.label = "紧急Bug";
ENEMY_TYPES.tank.label = "技术债务";
ENEMY_TYPES.boss.label = "重大事故";
```

### 6.2 多人模式接口

#### 状态同步
```javascript
// 获取当前游戏状态
var state = TowerDefense.getState();
// { gold, lives, wave, kills, towers, enemies }

// 设置游戏状态（用于网络同步）
TowerDefense.setState(state);
```

#### 事件系统
```javascript
// 监听塔放置事件
TowerDefense.onTowerPlaced = function(tower) {
    socket.emit('tower_placed', tower);
};

// 监听敌人击杀事件
TowerDefense.onEnemyKilled = function(enemy) {
    socket.emit('enemy_killed', enemy);
};

// 监听波次完成事件
TowerDefense.onWaveComplete = function(waveNum) {
    socket.emit('wave_complete', waveNum);
};
```

### 6.3 移动端适配

#### 响应式画布
```javascript
// Canvas 已设置为 flex 布局自适应
// 触摸事件已预留处理
canvas.addEventListener('touchstart', handleTouch, { passive: false });
```

#### 触控友好
- 防御塔选择区域足够大
- 点击/触摸放置塔
- 无键盘依赖

---

## 7. 代码结构

```
TowerDefense (IIFE模块)
├── 配置常量
│   ├── TOWER_TYPES - 防御塔定义
│   ├── ENEMY_TYPES - 敌人定义
│   └── PATH - 路径点
├── 状态变量
│   ├── gold, lives, wave, kills
│   ├── towers[], enemies[], bullets[], particles[]
│   └── gameOver, waveInProgress, debugMode
├── 核心函数
│   ├── init() - 初始化
│   ├── restart() - 重新开始
│   ├── startWave() - 开始波次
│   ├── updateTowers() - 更新塔状态
│   ├── updateEnemies() - 更新敌人
│   ├── updateBullets() - 更新子弹
│   └── updateParticles() - 更新粒子
├── 绘制函数
│   ├── draw() - 主绘制
│   ├── drawPath() - 绘制路径
│   ├── drawTowers() - 绘制塔
│   ├── drawEnemies() - 绘制敌人
│   ├── drawBullets() - 绘制子弹
│   └── drawParticles() - 绘制粒子
└── 公共API
    ├── init, restart, selectTower, startWave
    ├── getState, setState (网络同步)
    └── onTowerPlaced, onEnemyKilled, onWaveComplete (事件)
```

---

## 8. 视觉效果

### 8.1 动画效果
- **塔放置**: 粒子爆发动画
- **子弹飞行**: 带颜色的圆形子弹
- **敌人受击**: 白色闪烁效果
- **敌人死亡**: 粒子消散动画
- **溅射攻击**: 橙色粒子爆炸
- **冰冻效果**: 蓝色光环

### 8.2 调试模式
- 显示防御塔射程范围
- 显示敌人类型标签
- 显示实时对象数量统计

---

## 9. v1.1 新增需求 (2025-12-28)

### 9.1 拖拽放置与攻击范围预览
- **需求描述**: 拖动防御塔时，实时显示该塔的攻击范围
- **交互方式**:
  - 点击左侧防御塔选项开始拖拽
  - 鼠标/手指移动时显示塔的预览位置和攻击范围圆圈
  - 松开时放置防御塔
- **视觉效果**: 半透明的攻击范围圆圈

### 9.2 防御塔升级系统
- **等级范围**: 0级 ~ 3级（共4个等级）
- **升级条件**: 基于击杀敌人数量自动升级
- **升级阈值**:
  | 等级 | 击杀数 | 伤害加成 | 射程加成 | 攻速加成 |
  |------|--------|----------|----------|----------|
  | 0级 | 0 | 100% | 100% | 100% |
  | 1级 | 5 | 120% | 105% | 95% |
  | 2级 | 15 | 150% | 110% | 90% |
  | 3级 | 30 | 200% | 120% | 80% |
- **视觉标识**: 等级星星显示 (☆/★)

### 9.3 防御塔回收系统
- **回收价格**: 原价的 70%
- **操作方式**: 点击已放置的塔，显示回收按钮
- **回收确认**: 点击回收按钮后立即回收，金币返还

---

## 10. v2.0 功能特性规划 (50项)

### 10.1 用户体验优化 (25项)

#### 显示与界面
| # | 特性名称 | 描述 | 优先级 |
|---|----------|------|--------|
| 1 | 全屏模式 | 点击按钮进入/退出全屏游戏，沉浸式体验 | 高 |
| 2 | 快进功能 | 1x/2x/4x 游戏速度切换，加快波次进程 | 高 |
| 3 | 进度保存 | LocalStorage 保存游戏进度，刷新不丢失 | 高 |
| 4 | 云端存档 | 登录后同步存档到服务器 | 中 |
| 5 | 小地图 | 右下角显示全局缩略图和敌人分布 | 中 |
| 6 | 画质设置 | 低/中/高画质选项，适配不同设备 | 中 |
| 7 | 夜间模式 | 暗色主题，护眼模式 | 低 |
| 8 | 色盲模式 | 调整配色方案，照顾色弱玩家 | 低 |

#### 操作与控制
| # | 特性名称 | 描述 | 优先级 |
|---|----------|------|--------|
| 9 | 拖拽优化 | 长按防御塔显示详细属性面板 | 高 |
| 10 | 快捷键 | 1-4选塔，Space开始波次，Esc暂停 | 高 |
| 11 | 触控手势 | 双指缩放画布，单指拖动视角 | 中 |
| 12 | 撤销操作 | Ctrl+Z 撤销上一次放塔操作（限3秒内） | 中 |
| 13 | 批量放塔 | 按住Shift连续放置同类型塔 | 中 |
| 14 | 智能放置 | 自动吸附到最优位置建议 | 低 |
| 15 | 手柄支持 | 游戏手柄控制器支持 | 低 |

#### 信息反馈
| # | 特性名称 | 描述 | 优先级 |
|---|----------|------|--------|
| 16 | 伤害数字 | 攻击时显示飘动伤害数字 | 高 |
| 17 | 击杀统计 | 每个塔的击杀数实时显示 | 高 |
| 18 | DPS面板 | 显示每个塔的每秒伤害统计 | 中 |
| 19 | 波次预告 | 提前显示下一波敌人构成 | 高 |
| 20 | 敌人路径 | 显示敌人行进路线高亮 | 中 |
| 21 | 金币预算 | 显示当前金币能买的塔列表 | 低 |
| 22 | 游戏日志 | 可展开的事件日志面板 | 低 |

#### 音效与反馈
| # | 特性名称 | 描述 | 优先级 |
|---|----------|------|--------|
| 23 | 背景音乐 | 循环播放的游戏BGM | 中 |
| 24 | 音效系统 | 放塔、攻击、击杀、升级等音效 | 高 |
| 25 | 震动反馈 | 移动端触觉震动反馈 | 低 |

---

### 10.2 游戏丰富性扩展 (25项)

#### 新防御塔类型
| # | 塔名称 | 图标 | 费用 | 特殊效果 |
|---|--------|------|------|----------|
| 26 | 激光塔 | ⚡ | 200 | 持续光束伤害，穿透敌人 |
| 27 | 毒气塔 | ☠️ | 120 | 范围毒雾，持续掉血 |
| 28 | 电磁塔 | 🔌 | 180 | 链式闪电，跳跃攻击3个敌人 |
| 29 | 火焰塔 | 🔥 | 150 | 燃烧效果，DOT伤害 |
| 30 | 导弹塔 | 🚀 | 250 | 追踪导弹，必中目标 |
| 31 | 黑洞塔 | 🕳️ | 300 | 吸引敌人减速聚集 |
| 32 | 金矿塔 | 💎 | 100 | 不攻击，每波产出金币 |
| 33 | 治疗塔 | 💚 | 150 | 恢复周围塔的"耐久度" |

#### 新敌人类型
| # | 敌人名称 | 标签 | 特性 |
|---|----------|------|------|
| 34 | 隐形Bug | 隐身 | 周期性隐身，无法被攻击 |
| 35 | 分裂Bug | 分裂 | 死亡时分裂成2个小虫 |
| 36 | 治愈Bug | 治愈 | 为周围敌人回血 |
| 37 | 护盾Bug | 护盾 | 自带护盾，需先打破护盾 |
| 38 | 飞行Bug | 飞行 | 无视地形，走最短路径 |
| 39 | 变异Boss | 变异 | 随机继承其他敌人技能 |
| 40 | 召唤者 | 召唤 | 定期召唤小型敌人 |

#### 地图与关卡
| # | 特性名称 | 描述 |
|---|----------|------|
| 41 | 多地图系统 | 5+种不同路径布局的地图 |
| 42 | 地图编辑器 | 玩家自定义地图路径 |
| 43 | 章节系统 | 3个章节，每章10关 |
| 44 | 无尽模式 | 无限波次，挑战最高记录 |
| 45 | 挑战模式 | 限定条件挑战（限金币、限塔等） |

#### 系统机制
| # | 特性名称 | 描述 |
|---|----------|------|
| 46 | 技能系统 | 主动技能：陨石雨、冰封、时间减速 |
| 47 | 天赋树 | 解锁永久加成（伤害+5%等） |
| 48 | 成就系统 | 50+成就解锁徽章奖励 |
| 49 | 排行榜 | 全服/好友击杀数、通关时间排行 |
| 50 | 每日挑战 | 每天随机生成挑战任务 |

---

### 10.3 特性实现路线图

```
Phase 1 (v1.2) - 基础体验优化 ✅ 已实现 (2025-12-28)
├── #1 全屏模式 ✅
├── #2 快进功能 (1x/2x/4x) ✅
├── #3 进度保存 (LocalStorage) ✅
├── #16 伤害数字 (飘动显示) ✅
├── #17 击杀统计 (塔下方显示) ✅
├── #19 波次预告 (敌人构成预览) ✅
└── #24 音效系统 (Web Audio API) ✅

Phase 2 (v1.3) - 操作与内容扩展 ✅ 已实现 (2025-12-28)
├── #10 快捷键 ✅
├── #26-28 新防御塔 (激光/毒气/电磁) ✅
├── #34-36 新敌人 (隐形/分裂/治愈) ✅
├── #41 多地图系统 (3张地图) ✅
└── #44 无尽模式 ✅

Phase 3 (v2.0) - 完整游戏体验 ✅ 已完成
├── #46 技能系统 ✅ (陨石雨/冰封/时间减速)
├── #48 成就系统 ✅ (12个成就，弹窗通知)
├── #49 排行榜 ✅ (普通/无尽模式，本地存储)
├── #47 天赋树 ✅ (10个永久天赋加成，击杀获得天赋点)
└── #50 每日挑战 ✅ (每日3个随机挑战任务，天赋点奖励)

```

---

## 11. 未来扩展计划

### 11.1 团队元素集成
- 用团队成员头像替换塔图标
- 用业务术语替换敌人类型名称
- 添加团队 Logo 水印
- 显示团队成员姓名

### 11.2 多人协作模式
- WebSocket 实时同步
- 多玩家共同放置防御塔
- 金币共享或分离模式
- 实时排行榜

### 11.3 移动端适配
- 响应式 Canvas 尺寸
- 优化触摸区域大小
- 添加虚拟按键
- 横屏/竖屏适配

### 11.4 功能增强
- ~~塔升级系统~~ (已在 v1.1 实现)
- 更多塔类型 (详见 10.2 新防御塔)
- 特殊技能 (详见 #46 技能系统)
- 无尽模式 (详见 #44)
- 成就系统 (详见 #48)

---

## 12. 文件清单

| 文件 | 描述 |
|------|------|
| `frontend/templates/game.html` | 游戏主页面（包含所有游戏） |
| `docs/tower-defense-design.md` | 本设计文档 |

---

*文档版本: v1.3*
*创建日期: 2025-12-28*
*最后更新: 2025-12-28*
*Designed by Boris Huai*
