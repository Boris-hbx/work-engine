# 小球动画规格文档

## 概述
小球（彗星粒子）是 Work Engine 界面的装饰动画元素，在顶栏和侧边栏的 L 形区域内自由漫游，对鼠标有逃逸反应。

## 运动区域
- **L 形区域**：顶栏（全宽，高度 48px）+ 左侧边栏（宽度 220px，全高）
- 小球**不能**进入主内容区域（headerHeight 以下且 sidebarWidth 右侧的矩形区域）
- 边界处理采用预测式检查，防止穿越

## 默认参数（可通过闪电图标调整）

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 数量 | 6 | 1-20 | 同时存在的小球数量 |
| 感应半径 | 180 | 50-200 | 鼠标多远开始逃逸 |
| 排斥力度 | 12 | 1-15 | 逃逸的力度（二次方关系，越近越强） |
| 最大速度 | 10 | 3-12 | 正常最大速度，逃逸时可达 1.5 倍 |
| 摩擦力 | 0.97 | 0.9-0.999 | 越大越滑，逃逸时为 0.96 |
| 尾巴长度 | 5 | 3-25 | 彗星尾巴的长度 |

## 运动行为

### 1. 自由漫游
- 最低速度 1.0，始终保持运动，**不能静止**
- 每 40-120 帧随机改变方向
- 顶栏内主要左右游动，20% 概率掉头
- 侧边栏内自由方向
- 摩擦力 0.995（几乎无阻力）

### 2. 鼠标逃逸
- 鼠标进入感应半径时立即逃逸
- 力度公式：`(1 - dist/radius)² × repelForce × 1.5`（二次方，越近越强）
- 逃逸时**跳过**平滑转向逻辑，直接响应
- 逃逸时速度上限提高 50%
- 逃逸时摩擦力降低（0.96）

### 3. 边缘颤抖与分裂
- 被鼠标逼到边缘时，15 帧后开始颤抖
- 颤抖 30 帧后（共 45 帧）分裂成 3 个碎片
- 碎片飞散 60 帧后自动合成新小球
- 如果合成失败或小球丢失，系统会自动补充

### 4. 从闪电生成
- 每 30 帧检查小球数量
- 数量不足时从闪电图标生成新小球
- 新小球绕闪电螺旋旋转 2 圈后飞出
- 飞出后进入正常漫游模式

## 视觉效果

### 彗星尾巴
- 使用连续线段绘制，`lineCap = 'round'`
- 线条宽度从尾部细到头部粗
- 透明度用三次方曲线（`progress³`），渐变平滑
- 尾巴末端与球体无缝连接
- **不是分离的圆点**，要平滑渐变

### 主球体
- 带光晕效果（shadowBlur: 10）
- 颤抖时光晕变红（shadowBlur: 15）
- 在侧边栏深处透明度降低到 50%

### 颜色
```javascript
['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa', '#f472b6']
// 蓝、绿、红、黄、紫、粉
```

## 设置界面
- 点击闪电图标打开设置弹窗
- 表格形式，三列：参数名 | 输入框 | 建议值
- 深色主题，与界面风格一致
- 点击背景或取消按钮关闭

## 技术实现

### 相关文件
- `frontend/templates/desktop/base.html` - 桌面端
- `frontend/templates/base.html` - 通用版

### 关键变量
```javascript
window.ballConfig = {
    repelRadius: 180,
    repelForce: 12,
    maxSpeed: 10,
    friction: 0.97,
    tailLength: 5
};

var fearThreshold = 15;      // 开始颤抖
var explodeThreshold = 45;   // 分裂
var reuniteDelay = 60;       // 合成延迟
```

### 关键函数
- `createParticle(index, x, y)` - 创建小球
- `updateParticle(p, index)` - 更新位置和状态
- `drawParticle(p)` - 绘制小球和尾巴
- `explodeParticle(p, index)` - 分裂成碎片
- `reuniteFragments()` - 碎片合成
- `spawnFromLightning()` - 从闪电生成
- `checkParticleCount()` - 检查数量并补充

## 注意事项

1. **不要静止** - 小球必须始终保持运动
2. **响应灵敏** - 鼠标逃逸必须立即响应，不能迟钝
3. **边界严格** - 绝对不能穿越到主内容区域
4. **尾巴平滑** - 彗星尾巴要渐变，不能有颗粒感
5. **数量恒定** - 丢失的小球必须自动补充

## 安全机制

### 每帧速度强制验证
在 `animate()` 函数开头，对所有粒子进行速度检查：
- 如果速度 < 0.5 或为 NaN/Infinity，强制重置为 1.5-2.5 的随机速度
- 这确保即使发生任何异常，粒子也不会卡死

### 数组复制避免 splice 问题
粒子更新时使用 `particles.slice()` 复制数组，避免分裂删除时影响循环：
```javascript
var particlesToProcess = particles.slice();
for (var i = 0; i < particlesToProcess.length; i++) {
    var p = particlesToProcess[i];
    var actualIndex = particles.indexOf(p);
    if (actualIndex === -1) continue; // 已被移除
    // ...
}
```

### 初始速度保证
`createParticle()` 初始速度设为 1.5-2.5（之前是 0.3-0.6），确保新创建的小球立即活跃。

### try-catch 保护
`animate()` 函数用 try-catch 包裹，防止异常导致动画循环停止。

## 更新日志

- 2026-01-01: 创建规格文档
- 2026-01-01: 修复分裂后所有小球静止的bug（速度有效性检查、合成时速度初始化）
- 2026-01-01: 彻底修复分裂卡死问题（每帧强制速度验证、数组复制避免splice问题、初始速度提升、try-catch保护）
- 初始版本包含：自由漫游、鼠标逃逸、边缘分裂、闪电生成、彗星尾巴
