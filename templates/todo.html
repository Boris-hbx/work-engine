{% extends "base.html" %}

{% block title %}Todo - Time Management{% endblock %}

{% block content %}
    <div class="page-header compact">
        <div class="header-left">
            <h1 class="page-title">My Tasks</h1>
            <p class="quote-text" id="quote-text">{{ quote }}</p>
        </div>
        <button class="btn-shuffle" onclick="shuffleQuote()">æ¢ä¸€ä¸ª</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="todo-matrix-container">
        <!-- Tab Navigation -->
        <div class="matrix-tabs">
            <button class="matrix-tab active" data-tab="today" onclick="switchTab('today')">
                Today
                <span class="tab-count" id="count-today">0</span>
            </button>
            <button class="matrix-tab" data-tab="week" onclick="switchTab('week')">
                This Week
                <span class="tab-count" id="count-week">0</span>
            </button>
            <button class="matrix-tab" data-tab="month" onclick="switchTab('month')">
                Next 30 Days
                <span class="tab-count" id="count-month">0</span>
            </button>
            <div class="tab-actions">
                <button class="btn-add-task" onclick="showAddModal()">+ æ·»åŠ ä»»åŠ¡</button>
                <label class="show-completed-toggle">
                    <input type="checkbox" id="show-completed" onchange="toggleShowCompleted()">
                    <span>æ˜¾ç¤ºå·²å®Œæˆ</span>
                </label>
            </div>
        </div>

        <!-- Drop zone for moving to other tabs with quadrant options -->
        <div class="tab-drop-zones" id="tab-drop-zones" style="display:none;">
            <div class="tab-drop-zone" data-target-tab="today">
                <div class="drop-zone-title">æ‹–åˆ° Today</div>
                <div class="drop-zone-quadrants">
                    <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="important-urgent">ğŸ”¥ é‡è¦ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="important-not-urgent">ğŸ¯ é‡è¦ä¸ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="not-important-urgent">ğŸ“ ä¸é‡è¦ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="not-important-not-urgent">ğŸ® ä¸é‡è¦ä¸ç´§æ€¥</div>
                </div>
            </div>
            <div class="tab-drop-zone" data-target-tab="week">
                <div class="drop-zone-title">æ‹–åˆ° This Week</div>
                <div class="drop-zone-quadrants">
                    <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="important-urgent">ğŸ”¥ é‡è¦ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="important-not-urgent">ğŸ¯ é‡è¦ä¸ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="not-important-urgent">ğŸ“ ä¸é‡è¦ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="not-important-not-urgent">ğŸ® ä¸é‡è¦ä¸ç´§æ€¥</div>
                </div>
            </div>
            <div class="tab-drop-zone" data-target-tab="month">
                <div class="drop-zone-title">æ‹–åˆ° Next 30 Days</div>
                <div class="drop-zone-quadrants">
                    <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="important-urgent">ğŸ”¥ é‡è¦ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="important-not-urgent">ğŸ¯ é‡è¦ä¸ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="not-important-urgent">ğŸ“ ä¸é‡è¦ç´§æ€¥</div>
                    <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="not-important-not-urgent">ğŸ® ä¸é‡è¦ä¸ç´§æ€¥</div>
                </div>
            </div>
        </div>

        <!-- Eisenhower Matrix -->
        <div class="eisenhower-matrix">
            <!-- Y-axis label -->
            <div class="matrix-y-label">
                <span>é‡è¦</span>
                <div class="axis-arrow"></div>
                <span>ä¸é‡è¦</span>
            </div>

            <!-- Matrix Grid -->
            <div class="matrix-grid">
                <!-- X-axis label -->
                <div class="matrix-x-label">
                    <span>ç´§æ€¥</span>
                    <div class="axis-arrow-h"></div>
                    <span>ä¸ç´§æ€¥</span>
                </div>

                <!-- Quadrant 1: Important & Urgent -->
                <div class="quadrant q1" data-quadrant="important-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-icon">ğŸ”¥</span>
                        <span class="quadrant-title">é‡è¦ä¸”ç´§æ€¥</span>
                        <span class="quadrant-hint">ç«‹å³åš</span>
                        <button class="btn-quadrant-add" onclick="showAddModalForQuadrant('important-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-important-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>

                <!-- Quadrant 2: Important & Not Urgent -->
                <div class="quadrant q2" data-quadrant="important-not-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-icon">ğŸ¯</span>
                        <span class="quadrant-title">é‡è¦ä¸ç´§æ€¥</span>
                        <span class="quadrant-hint">è®¡åˆ’åš</span>
                        <button class="btn-quadrant-add" onclick="showAddModalForQuadrant('important-not-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-important-not-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>

                <!-- Quadrant 3: Not Important & Urgent -->
                <div class="quadrant q3" data-quadrant="not-important-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-icon">ğŸ“</span>
                        <span class="quadrant-title">ä¸é‡è¦ä½†ç´§æ€¥</span>
                        <span class="quadrant-hint">å§”æ‰˜åš</span>
                        <button class="btn-quadrant-add" onclick="showAddModalForQuadrant('not-important-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-not-important-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>

                <!-- Quadrant 4: Not Important & Not Urgent -->
                <div class="quadrant q4" data-quadrant="not-important-not-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-icon">ğŸ®</span>
                        <span class="quadrant-title">ä¸é‡è¦ä¸ç´§æ€¥</span>
                        <span class="quadrant-hint">å°‘åšæˆ–ä¸åš</span>
                        <button class="btn-quadrant-add" onclick="showAddModalForQuadrant('not-important-not-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-not-important-not-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>
            </div>
        </div>

        <!-- Completed Tasks Section -->
        <div class="completed-section" id="completed-section" style="display:none;">
            <div class="completed-header" onclick="toggleCompletedList()">
                <h3>å·²å®Œæˆçš„ä»»åŠ¡</h3>
                <span class="collapse-icon" id="completed-icon">â–¼</span>
            </div>
            <div class="completed-list" id="completed-list"></div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="add-modal" style="display:none;" onclick="hideAddModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°ä»»åŠ¡</h3>
                <button class="modal-close" onclick="hideAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ä»»åŠ¡å†…å®¹</label>
                    <input type="text" id="new-task-text" placeholder="è¾“å…¥ä»»åŠ¡å†…å®¹..." autofocus>
                </div>
                <div class="form-group">
                    <label>æ‰€å±æ—¶é—´æ®µ</label>
                    <div class="tab-selector" id="tab-selector">
                        <button type="button" class="tab-option active" data-tab="today">Today</button>
                        <button type="button" class="tab-option" data-tab="week">This Week</button>
                        <button type="button" class="tab-option" data-tab="month">Next 30 Days</button>
                    </div>
                    <input type="hidden" id="new-task-tab" value="today">
                </div>
                <div class="form-group">
                    <label>ä¼˜å…ˆçº§è±¡é™</label>
                    <div class="quadrant-selector">
                        <label class="quadrant-option selected" data-q="important-urgent">
                            <input type="radio" name="quadrant" value="important-urgent" checked>
                            <span class="option-icon">ğŸ”¥</span>
                            <span class="option-text">é‡è¦ä¸”ç´§æ€¥</span>
                        </label>
                        <label class="quadrant-option" data-q="important-not-urgent">
                            <input type="radio" name="quadrant" value="important-not-urgent">
                            <span class="option-icon">ğŸ¯</span>
                            <span class="option-text">é‡è¦ä¸ç´§æ€¥</span>
                        </label>
                        <label class="quadrant-option" data-q="not-important-urgent">
                            <input type="radio" name="quadrant" value="not-important-urgent">
                            <span class="option-icon">ğŸ“</span>
                            <span class="option-text">ä¸é‡è¦ä½†ç´§æ€¥</span>
                        </label>
                        <label class="quadrant-option" data-q="not-important-not-urgent">
                            <input type="radio" name="quadrant" value="not-important-not-urgent">
                            <span class="option-icon">ğŸ®</span>
                            <span class="option-text">ä¸é‡è¦ä¸ç´§æ€¥</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="hideAddModal()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="addTask()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
    var currentTab = 'today';
    var allItems = [];
    var showCompleted = false;
    var draggedItem = null;

    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.matrix-tab').forEach(function(t) {
            t.classList.remove('active');
            if (t.dataset.tab === tab) {
                t.classList.add('active');
            }
        });
        document.getElementById('new-task-tab').value = tab;
        renderItems();
    }

    function loadItems() {
        fetch('/api/todos')
            .then(response => response.json())
            .then(data => {
                allItems = data.items || [];
                updateCounts();
                renderItems();
            });
    }

    function updateCounts() {
        var counts = { today: 0, week: 0, month: 0 };
        allItems.forEach(function(item) {
            if (!item.completed) {
                counts[item.tab] = (counts[item.tab] || 0) + 1;
            }
        });
        document.getElementById('count-today').textContent = counts.today;
        document.getElementById('count-week').textContent = counts.week;
        document.getElementById('count-month').textContent = counts.month;
    }

    function renderItems() {
        var quadrants = ['important-urgent', 'important-not-urgent', 'not-important-urgent', 'not-important-not-urgent'];

        quadrants.forEach(function(q) {
            document.getElementById('items-' + q).innerHTML = '';
        });

        var completedHtml = '';
        var hasCompleted = false;

        allItems.forEach(function(item) {
            if (item.tab !== currentTab) return;

            if (item.completed) {
                hasCompleted = true;
                if (showCompleted) {
                    completedHtml += createCompletedItemHtml(item);
                }
            } else {
                var container = document.getElementById('items-' + item.quadrant);
                if (container) {
                    container.innerHTML += createItemHtml(item);
                }
            }
        });

        document.getElementById('completed-list').innerHTML = completedHtml;
        document.getElementById('completed-section').style.display = hasCompleted ? 'block' : 'none';
    }

    function createItemHtml(item) {
        return '<div class="task-item" data-id="' + item.id + '" onmousedown="startCustomDrag(event)">' +
            '<div class="drag-handle">â‹®â‹®</div>' +
            '<div class="task-checkbox" onclick="toggleComplete(\'' + item.id + '\')" onmousedown="event.stopPropagation()"></div>' +
            '<div class="task-text" ondblclick="editTask(\'' + item.id + '\')">' + escapeHtml(item.text) + '</div>' +
            '<button class="task-delete" onclick="deleteTask(\'' + item.id + '\')" onmousedown="event.stopPropagation()">&times;</button>' +
        '</div>';
    }

    function createCompletedItemHtml(item) {
        var completedAt = item.completed_at ? formatDate(item.completed_at) : '';
        return '<div class="task-item completed" data-id="' + item.id + '">' +
            '<div class="task-checkbox checked" onclick="toggleComplete(\'' + item.id + '\')">âœ“</div>' +
            '<div class="task-text">' + escapeHtml(item.text) + '</div>' +
            '<div class="task-completed-time">' + completedAt + '</div>' +
            '<button class="task-delete" onclick="deleteTask(\'' + item.id + '\')">&times;</button>' +
        '</div>';
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;');
    }

    function formatDate(isoString) {
        var date = new Date(isoString);
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return m + '-' + d + ' ' + h + ':' + min;
    }

    // Custom Drag and Drop (more reliable than HTML5 drag-drop)
    var isDragging = false;
    var dragClone = null;
    var dragItemId = null;
    var dragStartX = 0;
    var dragStartY = 0;
    var dragThreshold = 5; // pixels to move before starting drag

    function startCustomDrag(e) {
        // Only left mouse button
        if (e.button !== 0) return;

        var taskItem = e.target.closest('.task-item');
        if (!taskItem || taskItem.classList.contains('completed')) return;

        dragItemId = taskItem.dataset.id;
        draggedItem = taskItem;
        dragStartX = e.clientX;
        dragStartY = e.clientY;

        // Add listeners for drag
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);

        e.preventDefault();
    }

    function onMouseMove(e) {
        var dx = e.clientX - dragStartX;
        var dy = e.clientY - dragStartY;

        // Check if we've moved enough to start dragging
        if (!isDragging && (Math.abs(dx) > dragThreshold || Math.abs(dy) > dragThreshold)) {
            isDragging = true;
            startDragVisual(e);
        }

        if (isDragging && dragClone) {
            // Move the clone
            dragClone.style.left = e.clientX + 'px';
            dragClone.style.top = e.clientY + 'px';

            // Highlight quadrant under cursor
            highlightQuadrantUnderCursor(e.clientX, e.clientY);
        }
    }

    function startDragVisual(e) {
        if (!draggedItem) return;

        // Create visual clone
        dragClone = document.createElement('div');
        dragClone.className = 'drag-clone';
        dragClone.textContent = draggedItem.querySelector('.task-text').textContent;
        dragClone.style.left = e.clientX + 'px';
        dragClone.style.top = e.clientY + 'px';
        document.body.appendChild(dragClone);

        // Mark original as dragging
        draggedItem.classList.add('dragging');

        // Show tab drop zones
        document.getElementById('tab-drop-zones').style.display = 'flex';
        document.querySelectorAll('.tab-drop-zone').forEach(function(zone) {
            zone.style.display = zone.dataset.targetTab === currentTab ? 'none' : 'flex';
        });
    }

    function highlightQuadrantUnderCursor(x, y) {
        // Remove all highlights first
        document.querySelectorAll('.quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.drop-quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.tab-drop-zone.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });

        var tabDropZones = document.getElementById('tab-drop-zones');
        var matrix = document.querySelector('.eisenhower-matrix');
        var isOverDropZone = false;

        // Find element under cursor
        var elements = document.elementsFromPoint(x, y);
        for (var i = 0; i < elements.length; i++) {
            // Check for drop-quadrant first (most specific)
            var dropQuadrant = elements[i].closest('.drop-quadrant');
            if (dropQuadrant) {
                dropQuadrant.classList.add('drag-over');
                dropQuadrant.closest('.tab-drop-zone').classList.add('drag-over');
                isOverDropZone = true;
                break;
            }

            // Check for tab-drop-zone
            var dropZone = elements[i].closest('.tab-drop-zone');
            if (dropZone) {
                dropZone.classList.add('drag-over');
                isOverDropZone = true;
                break;
            }

            // Check for matrix quadrant
            var quadrant = elements[i].closest('.quadrant');
            if (quadrant) {
                quadrant.classList.add('drag-over');
                break;
            }
        }

        // Add/remove focus effect classes
        if (isOverDropZone) {
            tabDropZones.classList.add('has-focus');
            matrix.classList.add('dimmed');
        } else {
            tabDropZones.classList.remove('has-focus');
            matrix.classList.remove('dimmed');
        }
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);

        if (isDragging) {
            // Find target
            var elements = document.elementsFromPoint(e.clientX, e.clientY);
            var targetQuadrant = null;
            var targetTab = null;

            for (var i = 0; i < elements.length; i++) {
                // Check for drop-quadrant first (cross-tab with specific quadrant)
                var dq = elements[i].closest('.drop-quadrant');
                if (dq) {
                    targetTab = dq.dataset.targetTab;
                    targetQuadrant = dq.dataset.targetQuadrant;
                    break;
                }

                // Check for tab-drop-zone (cross-tab, keep same quadrant)
                var tz = elements[i].closest('.tab-drop-zone');
                if (tz && !elements[i].closest('.drop-quadrant')) {
                    targetTab = tz.dataset.targetTab;
                    break;
                }

                // Check for matrix quadrant (same tab)
                var q = elements[i].closest('.quadrant');
                if (q) {
                    targetQuadrant = q.dataset.quadrant;
                    break;
                }
            }

            if (targetTab && targetQuadrant) {
                // Move to different tab AND different quadrant
                moveToTabAndQuadrant(dragItemId, targetTab, targetQuadrant);
            } else if (targetTab) {
                // Move to different tab, keep same quadrant
                moveToTab(dragItemId, targetTab);
            } else if (targetQuadrant) {
                // Move to different quadrant, same tab
                moveToQuadrant(dragItemId, targetQuadrant);
            }

            // Cleanup
            endDrag();
        }

        isDragging = false;
        dragItemId = null;
        draggedItem = null;
    }

    function endDrag() {
        // Remove clone
        if (dragClone) {
            dragClone.remove();
            dragClone = null;
        }

        // Remove dragging class
        document.querySelectorAll('.task-item.dragging').forEach(function(item) {
            item.classList.remove('dragging');
        });

        // Hide drop zones and remove focus effects
        var tabDropZones = document.getElementById('tab-drop-zones');
        tabDropZones.style.display = 'none';
        tabDropZones.classList.remove('has-focus');

        // Remove matrix dimming
        var matrix = document.querySelector('.eisenhower-matrix');
        if (matrix) matrix.classList.remove('dimmed');

        // Remove all highlights
        document.querySelectorAll('.quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.drop-quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.tab-drop-zone.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
    }

    function moveToQuadrant(itemId, newQuadrant) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item || item.quadrant === newQuadrant) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quadrant: newQuadrant })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) i.quadrant = newQuadrant;
                    return i;
                });
                renderItems();
                showToast('å·²ç§»åŠ¨åˆ°' + getQuadrantName(newQuadrant), 'success');
            }
        });
    }

    function moveToTab(itemId, newTab) {
        if (newTab === currentTab) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tab: newTab })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) i.tab = newTab;
                    return i;
                });
                updateCounts();
                renderItems();
                showToast('å·²ç§»åŠ¨åˆ° ' + getTabName(newTab), 'success');
            }
        });
    }

    function moveToTabAndQuadrant(itemId, newTab, newQuadrant) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item) return;

        // Check if anything actually changes
        if (item.tab === newTab && item.quadrant === newQuadrant) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tab: newTab, quadrant: newQuadrant })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) {
                        i.tab = newTab;
                        i.quadrant = newQuadrant;
                    }
                    return i;
                });
                updateCounts();
                renderItems();
                showToast('å·²ç§»åŠ¨åˆ° ' + getTabName(newTab) + ' - ' + getQuadrantName(newQuadrant), 'success');
            }
        });
    }

    function getQuadrantName(q) {
        var names = {
            'important-urgent': 'é‡è¦ä¸”ç´§æ€¥',
            'important-not-urgent': 'é‡è¦ä¸ç´§æ€¥',
            'not-important-urgent': 'ä¸é‡è¦ä½†ç´§æ€¥',
            'not-important-not-urgent': 'ä¸é‡è¦ä¸ç´§æ€¥'
        };
        return names[q] || q;
    }

    function dropToTab(e, targetTab) {
        e.preventDefault();
        var itemId = e.dataTransfer.getData('text/plain');

        if (!itemId || targetTab === currentTab) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tab: targetTab })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(item) {
                    if (item.id === itemId) {
                        item.tab = targetTab;
                    }
                    return item;
                });
                updateCounts();
                renderItems();
                showToast('å·²ç§»åŠ¨åˆ° ' + getTabName(targetTab), 'success');
            }
        });
    }

    function getTabName(tab) {
        var names = { today: 'Today', week: 'This Week', month: 'Next 30 Days' };
        return names[tab] || tab;
    }

    // Task Actions
    function toggleComplete(itemId) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item) return;

        var newCompleted = !item.completed;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ completed: newCompleted })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) {
                        return data.item;
                    }
                    return i;
                });
                updateCounts();
                renderItems();
                showToast(newCompleted ? 'å·²å®Œæˆ' : 'å·²æ¢å¤', 'success');
            }
        });
    }

    function deleteTask(itemId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;

        fetch('/api/todos/' + itemId, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allItems = allItems.filter(function(i) { return i.id !== itemId; });
                    updateCounts();
                    renderItems();
                    showToast('å·²åˆ é™¤', 'success');
                }
            });
    }

    function editTask(itemId) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item) return;

        var newText = prompt('ç¼–è¾‘ä»»åŠ¡å†…å®¹:', item.text);
        if (newText === null || newText.trim() === '') return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: newText.trim() })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) {
                        i.text = newText.trim();
                    }
                    return i;
                });
                renderItems();
                showToast('å·²æ›´æ–°', 'success');
            }
        });
    }

    // Modal
    function showAddModal() {
        document.getElementById('add-modal').style.display = 'flex';
        document.getElementById('new-task-text').value = '';
        // Sync tab selector with current tab
        setModalTab(currentTab);
        document.getElementById('new-task-text').focus();
    }

    function showAddModalForQuadrant(quadrant) {
        document.getElementById('add-modal').style.display = 'flex';
        document.getElementById('new-task-text').value = '';
        // Sync tab selector with current tab
        setModalTab(currentTab);
        // Select the quadrant
        document.querySelectorAll('.quadrant-option').forEach(function(opt) {
            opt.classList.remove('selected');
            if (opt.dataset.q === quadrant) {
                opt.classList.add('selected');
                opt.querySelector('input').checked = true;
            }
        });
        document.getElementById('new-task-text').focus();
    }

    function setModalTab(tab) {
        document.getElementById('new-task-tab').value = tab;
        document.querySelectorAll('.tab-option').forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.dataset.tab === tab) {
                btn.classList.add('active');
            }
        });
    }

    function hideAddModal(e) {
        if (e && e.target !== document.getElementById('add-modal')) return;
        document.getElementById('add-modal').style.display = 'none';
    }

    function addTask() {
        var text = document.getElementById('new-task-text').value.trim();
        var tab = document.getElementById('new-task-tab').value;
        var quadrant = document.querySelector('input[name="quadrant"]:checked').value;

        if (!text) {
            showToast('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹', 'error');
            return;
        }

        fetch('/api/todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text, tab: tab, quadrant: quadrant })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems.push(data.item);
                updateCounts();
                renderItems();
                hideAddModal();
                showToast('å·²æ·»åŠ ', 'success');
            }
        });
    }

    // Quadrant selector
    document.querySelectorAll('.quadrant-option').forEach(function(opt) {
        opt.addEventListener('click', function() {
            document.querySelectorAll('.quadrant-option').forEach(function(o) {
                o.classList.remove('selected');
            });
            opt.classList.add('selected');
            opt.querySelector('input').checked = true;
        });
    });

    // Tab selector in modal
    document.querySelectorAll('.tab-option').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-option').forEach(function(b) {
                b.classList.remove('active');
            });
            btn.classList.add('active');
            document.getElementById('new-task-tab').value = btn.dataset.tab;
        });
    });

    // Enter key to add task
    document.getElementById('new-task-text').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addTask();
        }
    });

    function toggleShowCompleted() {
        showCompleted = document.getElementById('show-completed').checked;
        renderItems();
    }

    function toggleCompletedList() {
        var list = document.getElementById('completed-list');
        var icon = document.getElementById('completed-icon');
        if (list.style.display === 'none') {
            list.style.display = 'block';
            icon.textContent = 'â–²';
        } else {
            list.style.display = 'none';
            icon.textContent = 'â–¼';
        }
    }

    function showToast(message, type) {
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(function() {
            toast.classList.add('toast-hide');
            setTimeout(function() {
                toast.remove();
            }, 300);
        }, 2000);
    }

    // Initialize
    console.log('=== Todo page loaded (v10 - header border animation) ===');
    loadItems();
    </script>
{% endblock %}
